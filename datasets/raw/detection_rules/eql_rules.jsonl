{"task": "eql", "domain": "security", "instruction": "Identifies an outbound network connection attempt followed by a session id change as the root user by the same process\nentity. This particular instant...", "output": "sequence by process.entity_id with maxspan=1m\n[network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and user.id == \"0\" and\n    not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\", \"/usr/sbin/sshd\",\"/usr/bin/ssh\",\"/usr/bin/sshpass\")]\n[process where host.os.type == \"linux\" and event.action == \"session_id_change\" and user.id == \"0\" and\n    not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\", \"/usr/sbin/sshd\",\"/usr/bin/ssh\",\"/usr/bin/sshpass\")]\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Monitors for a sequence of network activity on atypical ports, prior to receiving a single packet on such a non-standard\nport, which potentially indic...", "output": "sequence by host.id with maxspan=10s\n  [network where host.os.type == \"linux\" and event.action in (\"connection_accepted\", \"connection_attempted\") and \n    event.type == \"start\" and process.name : \"*\" and (\n      process.name : (\n        \"python*\", \"php*\", \"perl*\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\",\n        \"awk\", \"gawk\", \"mawk\", \"nawk\", \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\"\n      ) or not process.executable : (\"/usr/bin/*\", \"/bin/*\")\n    ) and not (\n       cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\") or destination.port in (\n         20, 21, 22, 23, 25, 53, 67, 68, 69, 80, 110, 123, 137, 138, 139, 143, 161, 162, 179, 443, 445, 465, 514, 515,\n         587,636, 989, 990, 993, 995, 1025, 1026, 1080, 1194, 1433, 1434, 1521, 1701, 1723, 1812, 1813, 2082, 2083, 2086,\n         2087, 2095, 2096, 2121, 2483, 2484, 3306, 3389, 3478, 3497, 3544, 3689, 3784, 3785, 389, 3998, 5060, 5061, 5190,\n         5222, 5223, 5228, 5432, 5500, 554, 5631, 5632, 5800, 5801, 5900, 5901, 8000, 8008, 8080, 8081, 8443, 8888, 9100,\n         9200, 9443, 10000\n       ) or source.port in (\n         20, 21, 22, 23, 25, 53, 67, 68, 69, 80, 110, 123, 137, 138, 139, 143, 161, 162, 179, 443, 445, 465, 514, 515,\n         587, 636, 989, 990, 993, 995, 1025, 1026, 1080, 1194, 1433, 1434, 1521, 1701, 1723, 1812, 1813, 2082, 2083, 2086,\n         2087, 2095, 2096, 2121, 2483, 2484, 3306, 3389, 3478, 3497, 3544, 3689, 3784, 3785, 389, 3998, 5060, 5061, 5190,\n         5222, 5223, 5228, 5432, 5500, 554, 5631, 5632, 5800, 5801, 5900, 5901, 8000, 8008, 8080, 8081, 8443, 8888, 9100,\n         9200, 9443, 10000)\n      )\n  ] by destination.ip\n  [network where event.dataset == \"network_traffic.flow\" and host.os.type == \"linux\" and event.action == \"network_flow\"\n    and event.type == \"connection\" and source.packets == 1 and flow.final == false and not (\n      cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\") or destination.port in (\n        20, 21, 22, 23, 25, 53, 67, 68, 69, 80, 110, 123, 137, 138, 139, 143, 161, 162, 179, 443, 445, 465, 514, 515,\n        587,636, 989, 990, 993, 995, 1025, 1026, 1080, 1194, 1433, 1434, 1521, 1701, 1723, 1812, 1813, 2082, 2083, 2086,\n        2087, 2095, 2096, 2121, 2483, 2484, 3306, 3389, 3478, 3497, 3544, 3689, 3784, 3785, 389, 3998, 5060, 5061, 5190,\n        5222, 5223, 5228, 5432, 5500, 554, 5631, 5632, 5800, 5801, 5900, 5901, 8000, 8008, 8080, 8081, 8443, 8888, 9100,\n        9200, 9443, 10000\n      ) or source.port in (\n        20, 21, 22, 23, 25, 53, 67, 68, 69, 80, 110, 123, 137, 138, 139, 143, 161, 162, 179, 443, 445, 465, 514, 515,\n        587, 636, 989, 990, 993, 995, 1025, 1026, 1080, 1194, 1433, 1434, 1521, 1701, 1723, 1812, 1813, 2082, 2083, 2086,\n        2087, 2095, 2096, 2121, 2483, 2484, 3306, 3389, 3478, 3497, 3544, 3689, 3784, 3785, 389, 3998, 5060, 5061, 5190,\n        5222, 5223, 5228, 5432, 5500, 554, 5631, 5632, 5800, 5801, 5900, 5901, 8000, 8008, 8080, 8081, 8443, 8888, 9100,\n        9200, 9443, 10000)\n      )\n  ] by source.ip\n", "source": "detection-rules/_deprecated", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the use of system search utilities like grep and find to search for AWS credentials inside a\ncontainer. Unauthorized access to these...", "output": "process where event.module == \"cloud_defend\" and\n  event.type == \"start\" and\n\n/*account for tools that execute utilities as a subprocess, in this case the target utility name will appear as a process arg*/\n(process.name : (\"grep\", \"egrep\", \"fgrep\", \"find\", \"locate\", \"mlocate\") or process.args : (\"grep\", \"egrep\", \"fgrep\", \"find\", \"locate\", \"mlocate\")) and\nprocess.args : (\"*aws_access_key_id*\", \"*aws_secret_access_key*\", \"*aws_session_token*\", \"*accesskeyid*\", \"*secretaccesskey*\", \"*access_key*\", \"*.aws/credentials*\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the use of a compression utility to collect known files containing sensitive information, such as credentials\nand system configurations ins...", "output": "process where container.id: \"*\" and event.type== \"start\" and\n\n/*account for tools that execute utilities as a subprocess, in this case the target utility name will appear as a process arg*/\n(process.name: (\"zip\", \"tar\", \"gzip\", \"hdiutil\", \"7z\") or process.args: (\"zip\", \"tar\", \"gzip\", \"hdiutil\", \"7z\"))\nand process.args: (\n\"/root/.ssh/id_rsa\",\n\"/root/.ssh/id_rsa.pub\",\n\"/root/.ssh/id_ed25519\",\n\"/root/.ssh/id_ed25519.pub\",\n\"/root/.ssh/authorized_keys\",\n\"/root/.ssh/authorized_keys2\",\n\"/root/.ssh/known_hosts\",\n\"/root/.bash_history\",\n\"/etc/hosts\",\n\"/home/*/.ssh/id_rsa\",\n\"/home/*/.ssh/id_rsa.pub\",\n\"/home/*/.ssh/id_ed25519\",\n\"/home/*/.ssh/id_ed25519.pub\",\n\"/home/*/.ssh/authorized_keys\",\n\"/home/*/.ssh/authorized_keys2\",\n\"/home/*/.ssh/known_hosts\",\n\"/home/*/.bash_history\",\n\"/root/.aws/credentials\",\n\"/root/.aws/config\",\n\"/home/*/.aws/credentials\",\n\"/home/*/.aws/config\",\n\"/root/.docker/config.json\",\n\"/home/*/.docker/config.json\",\n\"/etc/group\",\n\"/etc/passwd\",\n\"/etc/shadow\",\n\"/etc/gshadow\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies multiple consecutive login failures targeting a root user account from the same source address and within a\nshort time interval. Adversarie...", "output": "sequence by host.id, source.ip with maxspan=10s\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"failure\" and source.ip != null and source.ip != \"0.0.0.0\" and\n   source.ip != \"::\" and  user.name : (\"*root*\" , \"*admin*\")] with runs=3\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects the use of system search utilities like grep and find to search for private SSH keys or passwords\ninside a container. Unauthorized a...", "output": "process where container.id: \"*\" and event.type== \"start\" and\n((\n/*account for tools that execute utilities as a subprocess, in this case the target utility name will appear as a process arg*/\n  (process.name in (\"grep\", \"egrep\", \"fgrep\") or process.args in (\"grep\", \"egrep\", \"fgrep\"))\n    and process.args : (\"*BEGIN PRIVATE*\", \"*BEGIN OPENSSH PRIVATE*\", \"*BEGIN RSA PRIVATE*\",\n\"*BEGIN DSA PRIVATE*\", \"*BEGIN EC PRIVATE*\", \"*pass*\", \"*ssh*\", \"*user*\")\n)\nor\n(\n/*account for tools that execute utilities as a subprocess, in this case the target utility name will appear as a process arg*/\n  (process.name in (\"find\", \"locate\", \"mlocate\") or process.args in (\"find\", \"locate\", \"mlocate\"))\n    and process.args : (\"*id_rsa*\", \"*id_dsa*\")\n))\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies a suspicious Conhost child process which may be an indication of code injection activity.", "output": "process where event.type in (\"start\", \"process_started\") and\n  process.parent.name : \"conhost.exe\" and\n  not process.executable : (\"?:\\\\Windows\\\\splwow64.exe\", \"?:\\\\Windows\\\\System32\\\\WerFault.exe\", \"?:\\\\Windows\\\\System32\\\\conhost.exe\")\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects the execution of a process where the LD_PRELOAD environment variable is set. LD_PRELOAD can be used to\ninject a shared library into ...", "output": "process where host.os.type == \"linux\" and event.action == \"exec\" and process.env_vars : (\"LD_PRELOAD=?*\", \"LD_LIBRARY_PATH=?*\")\n", "source": "detection-rules/_deprecated", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the creation or modification of the dynamic linker preload shared object (ld.so.preload) inside a\ncontainer. The Linux dynamic linke...", "output": "file where event.module== \"cloud_defend\" and event.type != \"deletion\" and file.path== \"/etc/ld.so.preload\"\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies mshta.exe making a network connection. This may indicate adversarial activity, as mshta.exe is often\nleveraged by adversaries to execute ma...", "output": "/* duplicate of Mshta Making Network Connections - c2d90150-0133-451c-a783-533e736c12d7 */\n\nsequence by process.entity_id\n  [process where process.name : \"mshta.exe\" and event.type == \"start\"]\n  [network where process.name : \"mshta.exe\"]\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies process execution followed by a file overwrite of an executable by the same parent process. This may indicate\nan evasion attempt to execute...", "output": "sequence with maxspan=5s\n   [process where host.os.type == \"windows\" and event.type == \"start\" and not process.parent.executable :\n      (\n         \"?:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\",\n         \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\*.exe\",\n         \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*.exe\"\n      )\n   ] by host.id, process.executable, process.parent.entity_id\n   [file where host.os.type == \"windows\" and event.type == \"change\" and event.action == \"overwrite\" and file.extension == \"exe\"] by host.id, file.path, process.entity_id\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies process execution events where the command line value contains a long sequence of whitespace characters or\nmultiple occurrences of contiguo...", "output": "process where event.type in (\"start\", \"process_started\") and\n  process.command_line regex \".*[ ]{20,}.*\" or\n\n  /* this will match on 3 or more separate occurrences of 3+ contiguous whitespace characters */\n  process.command_line regex \"([^ ]+[ ]{3,}[^ ]*){3,}.*\"\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Enumeration of files and directories using built-in tools. Adversaries may use the information discovered to plan\nfollow-on activity.\n", "output": "sequence by agent.id, user.name with maxspan=1m\n[process where event.type in (\"start\", \"process_started\") and\n  ((process.name : \"cmd.exe\" or process.pe.original_file_name == \"Cmd.Exe\") and process.args : \"dir\") or\n    process.name : \"tree.com\"]\n[process where event.type in (\"start\", \"process_started\") and\n  ((process.name : \"cmd.exe\" or process.pe.original_file_name == \"Cmd.Exe\") and process.args : \"dir\") or\n    process.name : \"tree.com\"]\n[process where event.type in (\"start\", \"process_started\") and\n  ((process.name : \"cmd.exe\" or process.pe.original_file_name == \"Cmd.Exe\") and process.args : \"dir\") or\n    process.name : \"tree.com\"]\n", "source": "detection-rules/_deprecated", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Enumeration or discovery of the Windows registry using reg.exe. This information can be used to perform follow-on\nactivities.\n", "output": "process where event.type in (\"start\", \"process_started\") and\n  (process.name : \"reg.exe\" or process.pe.original_file_name == \"reg.exe\") and\n  process.args == \"query\"\n", "source": "detection-rules/_deprecated", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects commonly abused network utilities running inside a container. Network utilities like nc, nmap, dig,\ntcpdump, ngrep, telnet, mitmprox...", "output": "process where container.id: \"*\" and event.type== \"start\" and\n(\n(process.name: (\"nc\", \"ncat\", \"nmap\", \"dig\", \"nslookup\", \"tcpdump\", \"tshark\", \"ngrep\", \"telnet\", \"mitmproxy\", \"socat\", \"zmap\", \"masscan\", \"zgrab\")) or\n/*account for tools that execute utilities as a subprocess, in this case the target utility name will appear as a process arg*/\n(process.args: (\"nc\", \"ncat\", \"nmap\", \"dig\", \"nslookup\", \"tcpdump\", \"tshark\", \"ngrep\", \"telnet\", \"mitmproxy\", \"socat\", \"zmap\", \"masscan\", \"zgrab\"))\n)\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies Linux binary apt/apt-get abuse to breakout out of restricted shells or environments by spawning an\ninteractive system shell. The apt utilit...", "output": "process where event.type == \"start\" and process.name == \"sensible-pager\" and\n  process.args in (\"/bin/sh\", \"/bin/bash\", \"/bin/dash\", \"sh\", \"bash\", \"dash\") and\n  process.parent.name in (\"apt\", \"apt-get\") and process.parent.args == \"changelog\"\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies Linux binary awk abuse to breakout out of restricted shells or environments by spawning an interactive system\nshell. The awk utility is a t...", "output": "process where event.type == \"start\" and process.name in (\"sh\", \"bash\", \"dash\") and\n  process.parent.name in (\"nawk\", \"mawk\", \"awk\", \"gawk\") and process.parent.args : \"BEGIN {system(*)}\"\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies Linux binary busybox abuse to break out from restricted environments by spawning an interactive system\nshell.The busybox is software utilit...", "output": "process where event.type == \"start\" and process.name == \"busybox\" and process.args_count == 2 and process.args in (\"/bin/sh\", \"/bin/ash\", \"sh\", \"ash\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies Linux binary c89/c99 abuse to break out from restricted environments by spawning an interactive system\nshell.The c89/c99 utility is an inte...", "output": "process where event.type == \"start\" and process.name in (\"sh\", \"dash\", \"bash\") and\n  process.parent.name in (\"c89\",\"c99\") and process.parent.args == \"-wrapper\" and\n  process.parent.args in (\"sh,-s\", \"bash,-s\", \"dash,-s\", \"/bin/sh,-s\", \"/bin/bash,-s\", \"/bin/dash,-s\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects when a container management binary is run from inside a container. These binaries are critical\ncomponents of many containerized envi...", "output": "process where container.id: \"*\" and event.type== \"start\"\n  and process.name: (\"dockerd\", \"docker\", \"kubelet\", \"kube-proxy\", \"kubectl\", \"containerd\", \"runc\", \"systemd\", \"crictl\")\n", "source": "detection-rules/_deprecated", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies Linux binary cpulimit abuse to break out from restricted environments by spawning an interactive system\nshell. The cpulimit utility is used...", "output": "process where event.type == \"start\" and process.name in (\"bash\", \"sh\", \"dash\") and\n  process.parent.name == \"cpulimit\" and process.parent.args == \"-f\" and\n  process.parent.args in (\"/bin/sh\", \"/bin/bash\", \"/bin/dash\", \"sh\", \"bash\", \"dash\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies Linux binary crash abuse to break out from restricted environments by spawning an interactive system shell.\nThe crash utility helps analyze...", "output": "process where event.type == \"start\" and process.parent.name == \"crash\" and process.parent.args == \"-h\" and process.name == \"sh\"\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies Linux binary env abuse to break out from restricted environments by spawning an interactive system shell. The\nenv utility is a shell comman...", "output": "process where event.type == \"start\" and process.name : \"env\" and process.args_count == 2 and process.args : (\"/bin/sh\", \"/bin/bash\", \"sh\", \"bash\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies Linux binary expect command abuse to break out from restricted environments by spawning an interactive system\nshell. The expect utility all...", "output": "process where event.type == \"start\" and process.name in (\"bash\", \"sh\", \"dash\") and\n  process.parent.name == \"expect\" and process.parent.args == \"-c\" and\n  process.parent.args in (\"spawn /bin/sh;interact\", \"spawn /bin/bash;interact\", \"spawn /bin/dash;interact\", \"spawn sh;interact\", \"spawn bash;interact\", \"spawn dash;interact\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects when chmod is used to add the execute permission to a file inside a container. Modifying file\npermissions to make a file executable ...", "output": "file where container.id: \"*\" and event.type in (\"change\", \"creation\") and\n\n/*account for tools that execute utilities as a subprocess, in this case the target utility name will appear as a process arg*/\n(process.name : \"chmod\" or process.args : \"chmod\") and\nprocess.args : (\"*x*\", \"777\", \"755\", \"754\", \"700\") and not process.args: \"-x\"\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies Linux binary find abuse to break out from restricted environments by spawning an interactive system shell.\nThe find command in Unix is a co...", "output": "process where event.type == \"start\" and process.name in (\"bash\", \"sh\") and\n  process.parent.name == \"find\" and process.parent.args == \"-exec\" and\n  process.parent.args == \";\" and process.parent.args in (\"/bin/bash\", \"/bin/sh\", \"bash\", \"sh\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies Linux binary flock abuse to break out from restricted environments by spawning an interactive system shell.\nThe flock utility allows users ...", "output": "process where event.type == \"start\" and process.parent.name == \"flock\" and process.parent.args == \"-u\" and process.parent.args == \"/\" and process.parent.args in (\"/bin/sh\", \"/bin/bash\", \"/bin/dash\", \"sh\", \"bash\", \"dash\") and process.name in (\"bash\", \"dash\", \"sh\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies Linux binary gcc abuse to break out from restricted environments by spawning an interactive system shell. The\ngcc utility is a complier sys...", "output": "process where event.type == \"start\" and process.name in (\"sh\", \"dash\", \"bash\")  and\n  process.parent.name == \"gcc\" and process.parent.args == \"-wrapper\" and\n  process.parent.args in (\"sh,-s\", \"bash,-s\", \"dash,-s\", \"/bin/sh,-s\", \"/bin/bash,-s\", \"/bin/dash,-s\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects interactive 'exec' events launched against a container using the 'exec' command. Using the 'exec'\ncommand in a pod allows a user to ...", "output": "process where container.id : \"*\" and event.type== \"start\" and\n\n/* use of kubectl exec to enter a container */\nprocess.entry_leader.entry_meta.type : \"container\" and\n\n/* process is the inital process run in a container */\nprocess.entry_leader.same_as_process== true and\n\n/* interactive process */\nprocess.interactive == true\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects when an interactive shell is spawned inside a running container. This could indicate a potential\ncontainer breakout attempt or an at...", "output": "process where container.id: \"*\" and\nevent.type== \"start\" and\n\n/*D4C consolidates closely spawned event.actions, this excludes end actions to only capture ongoing processes*/\nevent.action in (\"fork\", \"exec\") and\n process.entry_leader.same_as_process== false and\n(\n(process.executable: \"*/*sh\" and process.args: (\"-i\", \"-it\")) or\nprocess.args: \"*/*sh\"\n)\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies MySQL server abuse to break out from restricted environments by spawning an interactive system shell. The\nMySQL server is an open source re...", "output": "process where event.type == \"start\" and process.name in (\"bash\", \"sh\", \"dash\") and\n  process.parent.name == \"mysql\" and process.parent.args == \"-e\" and\n  process.parent.args : (\"\\\\!*sh\", \"\\\\!*bash\", \"\\\\!*dash\", \"\\\\!*/bin/sh\", \"\\\\!*/bin/bash\", \"\\\\!*/bin/dash\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects an established netcat listener running inside a container. Netcat is a utility used for reading and\nwriting data across network conn...", "output": "process where container.id: \"*\" and event.type== \"start\"\nand event.action in (\"fork\", \"exec\") and\n(\nprocess.name:(\"nc\",\"ncat\",\"netcat\",\"netcat.openbsd\",\"netcat.traditional\") or\n/*account for tools that execute utilities as a subprocess, in this case the target utility name will appear as a process arg*/\nprocess.args: (\"nc\",\"ncat\",\"netcat\",\"netcat.openbsd\",\"netcat.traditional\")\n) and (\n          /* bind shell to echo for command execution */\n          (process.args:(\"-*l*\", \"--listen\", \"-*p*\", \"--source-port\") and process.args:(\"-c\", \"--sh-exec\", \"-e\", \"--exec\", \"echo\",\"$*\"))\n          /* bind shell to specific port */\n          or process.args:(\"-*l*\", \"--listen\", \"-*p*\", \"--source-port\")\n          )\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a reverse shell via the abuse of named pipes on Linux with the help of OpenSSL or Netcat. First in, first out\n(FIFO) files are special file...", "output": "sequence by host.id with maxspan = 5s\n    [process where host.os.type == \"linux\" and event.type == \"start\" and process.executable : (\"/usr/bin/mkfifo\",\"/usr/bin/mknod\") and process.args:(\"/tmp/*\",\"$*\")]\n    [process where host.os.type == \"linux\" and process.executable : (\"/bin/sh\",\"/bin/bash\") and process.args:(\"-i\") or\n        (process.executable: (\"/usr/bin/openssl\") and process.args: (\"-connect\"))]\n    [process where host.os.type == \"linux\" and (process.name:(\"nc\",\"ncat\",\"netcat\",\"netcat.openbsd\",\"netcat.traditional\") or\n                    (process.name: \"openssl\" and process.executable: \"/usr/bin/openssl\"))]\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This detection rule detects the creation of a shell through a suspicious parent child relationship. Any reverse shells\nspawned by the specified utilit...", "output": "sequence by host.id, process.parent.entity_id with maxspan=1s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"fork\" and (\n  (process.name : \"python*\" and process.args == \"-c\" and not process.args == \"/usr/bin/supervisord\") or\n  (process.name : \"php*\" and process.args == \"-r\") or\n  (process.name : \"perl\" and process.args == \"-e\") or\n  (process.name : \"ruby\" and process.args in (\"-e\", \"-rsocket\")) or\n  (process.name : \"lua*\" and process.args == \"-e\") or\n  (process.name : \"openssl\" and process.args : \"-connect\") or\n  (process.name : (\"nc\", \"ncat\", \"netcat\") and process.args_count >= 3 and not process.args == \"-z\") or\n  (process.name : \"telnet\" and process.args_count >= 3) or\n  (process.name : \"awk\")) and \n  process.parent.name : (\"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\") ]\n[ network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and \n  process.name : (\"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\") and\n  destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" ]\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies Linux binary SSH abuse to break out from restricted environments by spawning an interactive system shell. The\nSSH protocol is a network pro...", "output": "process where event.type == \"start\" and process.name : (\"bash\", \"sh\", \"dash\") and\n  process.parent.name == \"ssh\" and process.parent.args == \"-o\" and\n  process.parent.args in (\"ProxyCommand=;sh 0<&2 1>&2\", \"ProxyCommand=;bash 0<&2 1>&2\", \"ProxyCommand=;dash 0<&2 1>&2\", \"ProxyCommand=;/bin/sh 0<&2 1>&2\", \"ProxyCommand=;/bin/bash 0<&2 1>&2\", \"ProxyCommand=;/bin/dash 0<&2 1>&2\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies Linux binary find abuse to break out from restricted environments by spawning an interactive system shell.\nThe vi/vim editor is the standar...", "output": "process where event.type == \"start\" and process.parent.name in (\"vi\", \"vim\") and process.parent.args == \"-c\" and process.parent.args in (\":!/bin/bash\", \":!/bin/sh\", \":!bash\", \":!sh\") and process.name in (\"bash\", \"sh\")\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule identifies a sequence of 100 file extension rename events within a set of common file paths by the same\nprocess in a timespan of 1 second. R...", "output": "sequence by process.entity_id, host.id with maxspan=1s\n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\" \n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\", \"/srv/*\", \"/run/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\"\n   ) and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\"\n    )\n   ] with runs=25\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Cross-Site Scripting (XSS) is a type of attack in which malicious scripts are injected into trusted websites. In XSS\nattacks, an attacker uses a benig...", "output": "any where processor.name == \"transaction\" and\nurl.fragment : (\"<iframe*\", \"*prompt(*)*\", \"<script*>\", \"<svg*>\", \"*onerror=*\", \"*javascript*alert*\", \"*eval*(*)*\", \"*onclick=*\",\n\"*alert(document.cookie)*\", \"*alert(document.domain)*\",\"*onresize=*\",\"*onload=*\",\"*onmouseover=*\")\n", "source": "detection-rules/_deprecated", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects an incoming SSH connection established inside a running container. Running an ssh daemon inside a\ncontainer should be avoided and mo...", "output": "process where container.id: \"*\" and event.type == \"start\" and\n\n/* use of sshd to enter a container*/\nprocess.entry_leader.entry_meta.type: \"sshd\"  and\n\n/* process is the initial process run in a container or start of a new session*/\n(process.entry_leader.same_as_process== true or process.session_leader.same_as_process== true) and\n\n/* interactive process*/\nprocess.interactive== true\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Malicious remote file creation, which can be an indicator of lateral movement activity.", "output": "sequence by host.name\n[file where event.action == \"creation\" and process.name : (\"System\", \"scp\", \"sshd\", \"smbd\", \"vsftpd\", \"sftp-server\")]\n[file where event.category == \"malware\" or event.category == \"intrusion_detection\"\nand process.name:(\"System\", \"scp\", \"sshd\", \"smbd\", \"vsftpd\", \"sftp-server\")]\n", "source": "detection-rules/_deprecated", "severity": "critical", "risk_score": 99}
{"task": "eql", "domain": "security", "instruction": "Discovery of files created by a remote host on sensitive directories and folders. Remote file creation in these\ndirectories could indicate a malicious...", "output": "file where event.action in (\"creation\", \"modification\") and\n  not user.name:(\"SYSTEM\", \"root\") and\n  process.name in (\"System\", \"scp\", \"sshd\", \"smbd\", \"vsftpd\", \"sftp-server\") and\n  (\n    file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming*\", \"?:\\\\Program Files*\",\n        \"?:\\\\Windows\\\\*\", \"?:\\\\Windows\\\\System\\\\*\",\n        \"?:\\\\Windows\\\\System32\\\\*\", \"/etc/*\", \"/tmp*\",\n        \"/var/tmp*\", \"/home/*/.*\", \"/home/.*\", \"/usr/bin/*\",\n        \"/sbin/*\", \"/bin/*\", \"/usr/lib/*\", \"/usr/sbin/*\",\n        \"/usr/share/*\", \"/usr/local/*\", \"/var/lib/dpkg/*\",\n        \"/lib/systemd/*\"\n    )\n)\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects an SSH or SSHD process executed from inside a container. This includes both the client ssh binary and\nserver ssh daemon process. SSH...", "output": "process where container.id: \"*\" and event.type== \"start\" and\nevent.action in (\"fork\", \"exec\") and\nprocess.name: (\"sshd\", \"ssh\", \"autossh\")\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the manual creation of files in specific etc directories, via user root, used by Linux malware to persist and\nelevate privileges on compromise...", "output": "file where host.os.type == \"linux\" and event.type in (\"creation\", \"file_create_event\") and user.id == \"0\" and\nfile.path : (\"/etc/ld.so.conf.d/*\", \"/etc/cron.d/*\", \"/etc/sudoers.d/*\", \"/etc/init.d/*\", \"/etc/systemd/system/*\",\n\"/usr/lib/systemd/system/*\") and not (\n  (process.name : (\n    \"chef-client\", \"ruby\", \"pacman\", \"packagekitd\", \"python*\", \"platform-python\", \"dpkg\", \"yum\", \"apt\", \"dnf\", \"rpm\",\n    \"systemd\", \"snapd\", \"dnf-automatic\", \"yum-cron\", \"elastic-agent\", \"dnfdaemon-system\", \"dockerd\", \"executor\",\n    \"rhn_check\"\n    )\n  ) or \n  (file.extension in (\"swp\", \"swpx\", \"tmp\"))\n)\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the creation or modification of an authorized_keys or sshd_config file inside a container. The Secure\nShell (SSH) authorized_keys fi...", "output": "file where container.id:\"*\" and\n  event.type in (\"change\", \"creation\") and file.name: (\"authorized_keys\", \"authorized_keys2\", \"sshd_config\")\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects the use of the built-in Linux DebugFS utility from inside a privileged container. DebugFS is a special\nfile system debugging utility...", "output": "process where event.module == \"cloud_defend\" and\n  event.type == \"start\" and process.name == \"debugfs\" and\n  process.args : \"/dev/sd*\" and not process.args == \"-R\" and\n  container.security_context.privileged == true\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to\nlocalhost, and the target user ...", "output": "authentication where\n\n /* event 4624 need to be logged */\n event.action == \"logged-in\" and event.outcome == \"success\" and\n\n /* authenticate locally via relayed kerberos ticket */\n winlog.event_data.AuthenticationPackageName : \"Kerberos\" and winlog.logon.type == \"Network\" and\n source.ip == \"127.0.0.1\" and source.port > 0 and\n\n /* Impersonate Administrator user via S4U2Self service ticket */\n winlog.event_data.TargetUserSid : \"S-1-5-21-*-500\"\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects the use of the mount utility from inside a privileged container. The mount command is used to make a\ndevice or file system accessibl...", "output": "process where event.module == \"cloud_defend\" and  event.type== \"start\" and\n(process.name== \"mount\" or process.args== \"mount\") and container.security_context.privileged == true\n", "source": "detection-rules/_deprecated", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects modification of the cgroup notify_on_release file from inside a container. When the notify_on_release\nflag is enabled (1) in a cgrou...", "output": "file where event.module == \"cloud_defend\" and event.action == \"open\" and\nevent.type == \"change\" and file.name : \"notify_on_release\"\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects modification of the CGroup release_agent file from inside a privileged container. The release_agent is\na script that is executed at ...", "output": "file where event.module == \"cloud_defend\" and event.action == \"open\" and\nevent.type == \"change\" and file.name : \"release_agent\"\n", "source": "detection-rules/_deprecated", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the creation or modification of a print driver with an unusual file name. This may indicate attempts to exploit\nprivilege escalation vulnerabi...", "output": "/* This rule is compatible with both Sysmon and Elastic Endpoint */\n\nfile where process.name : \"spoolsv.exe\" and \n file.name : (\"kernelbase.dll\", \"ntdll.dll\", \"kernel32.dll\", \"winhttp.dll\", \"user32.dll\") and\n file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*\"\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service. For more\ninformation refer to CVE-2021-34527 an...", "output": "/* This rule is not compatible with Sysmon due to schema issues */\n\nregistry where process.name : \"spoolsv.exe\" and\n  (registry.path : \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Drivers\\\\Version-3\\\\mimikatz*\\\\Data File\" or\n  (registry.path : \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Drivers\\\\Version-3\\\\*\\\\Configuration File\" and\n   registry.data.strings : (\"kernelbase.dll\", \"ntdll.dll\", \"kernel32.dll\", \"winhttp.dll\", \"user32.dll\")))\n", "source": "detection-rules/_deprecated", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies suspicious file download activity from a Google Drive URL. This could indicate an attempt to deliver phishing\npayloads via a trusted webser...", "output": "process where\n\n    /* common browser processes  */\n    event.action in (\"exec\", \"fork\", \"start\") and\n\n    process.name : (\"Microsoft Edge\", \"chrome.exe\", \"Google Chrome\", \"google-chrome-stable\",\n                    \"google-chrome-beta\", \"google-chrome\", \"msedge.exe\", \"firefox.exe\", \"brave.exe\",\n                    \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\", \"firefox\",\n                    \"powershell.exe\", \"curl\", \"curl.exe\", \"wget\", \"wget.exe\") and\n\n    /* Look for Google Drive download URL with AV flag skipping */\n    (process.command_line : \"*drive.google.com*\" and process.command_line : \"*export=download*\" and process.command_line : \"*confirm=no_antivirus*\")\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. For\nexample, SSH over port 2200 or port ...", "output": "sequence by process.entity_id with maxspan=1m\n  [process where event.action == \"exec\" and process.name in (\"ssh\", \"sshd\") and not process.parent.name in (\n   \"rsync\", \"pyznap\", \"git\", \"ansible-playbook\", \"scp\", \"pgbackrest\", \"git-lfs\", \"expect\", \"Sourcetree\", \"ssh-copy-id\",\n   \"run\"\n   )\n  ]\n  [network where process.name:\"ssh\" and event.action in (\"connection_attempted\", \"connection_accepted\") and\n   destination.port != 22 and network.transport == \"tcp\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\"\n     )\n   )\n  ]\n", "source": "detection-rules/cross-platform", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of a Chromium based browser with the debugging process argument, which may indicate an attempt\nto steal authentication cookie...", "output": "process where event.type in (\"start\", \"process_started\", \"info\") and\n  process.name in (\n             \"Microsoft Edge\",\n             \"chrome.exe\",\n             \"Google Chrome\",\n             \"google-chrome-stable\",\n             \"google-chrome-beta\",\n             \"google-chrome\",\n             \"msedge.exe\") and\n   process.args : (\"--remote-debugging-port=*\",\n                   \"--remote-debugging-targets=*\",\n                   \"--remote-debugging-pipe=*\") and\n   process.args : \"--user-data-dir=*\" and not process.args:\"--remote-debugging-port=0\"\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies a potential forced authentication using related SMB named pipes. Attackers may attempt to force targets to\nauthenticate to a host controlle...", "output": "sequence with maxspan=15s\n[network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and destination.port == 445 and not startswith~(string(destination.ip), string(host.ip))] by host.ip, data_stream.namespace\n[file where host.os.type == \"windows\" and event.code == \"5145\" and file.name : (\"Spoolss\", \"netdfs\", \"lsarpc\", \"lsass\", \"netlogon\", \"samr\", \"efsrpc\", \"FssagentRpc\")] by source.ip, data_stream.namespace\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the execution of TruffleHog, a tool used to search for high-entropy strings and secrets\nin code repositories, which may indicate an ...", "output": "process where event.type == \"start\" and process.name : (\"trufflehog.exe\", \"trufflehog\") and\nprocess.args == \"--results=verified\" and process.args == \"--json\" and process.args == \"filesystem\"\n", "source": "detection-rules/cross-platform", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the deletion of WebServer access logs. This may indicate an attempt to evade detection or destroy forensic\nevidence on a system.\n", "output": "file where event.type == \"deletion\" and\n  file.path : (\"C:\\\\inetpub\\\\logs\\\\LogFiles\\\\*.log\",\n               \"/var/log/apache*/access.log\",\n               \"/etc/httpd/logs/access_log\",\n               \"/var/log/httpd/access_log\",\n               \"/var/www/*/logs/access.log\")\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Adversaries may attempt to clear or disable the Bash command-line history in an attempt to evade detection or forensic\ninvestigations.\n", "output": "process where event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and event.type == \"start\" and\n (\n  ((process.args : (\"rm\", \"echo\") or\n    (process.args : \"ln\" and process.args : \"-sf\" and process.args : \"/dev/null\") or\n    (process.args : \"truncate\" and process.args : \"-s0\"))\n    and process.args : (\".bash_history\", \"/root/.bash_history\", \"/home/*/.bash_history\",\"/Users/.bash_history\", \"/Users/*/.bash_history\",\n                        \".zsh_history\", \"/root/.zsh_history\", \"/home/*/.zsh_history\", \"/Users/.zsh_history\", \"/Users/*/.zsh_history\")) or\n  (process.args : \"history\" and process.args : \"-c\") or\n  (process.args : \"export\" and process.args : (\"HISTFILE=/dev/null\", \"HISTFILESIZE=0\")) or\n  (process.args : \"unset\" and process.args : \"HISTFILE\") or\n  (process.args : \"set\" and process.args : \"history\" and process.args : \"+o\")\n )\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to\ndisable security monitoring tools i...", "output": "process where\n/* net, sc or wmic stopping or deleting Elastic Agent on Windows */\n(event.type == \"start\" and\n  process.name : (\"net.exe\", \"sc.exe\", \"wmic.exe\",\"powershell.exe\",\"taskkill.exe\",\"PsKill.exe\",\"ProcessHacker.exe\") and\n  process.args : (\"stopservice\",\"uninstall\", \"stop\", \"disabled\",\"Stop-Process\",\"terminate\",\"suspend\") and\n  process.args : (\"elasticendpoint\", \"Elastic Agent\",\"elastic-agent\",\"elastic-endpoint\"))\nor\n/* service or systemctl used to stop Elastic Agent on Linux */\n(event.type == \"end\" and\n  (process.name : (\"systemctl\", \"service\") and\n    process.args : \"elastic-agent\" and\n    process.args : (\"stop\", \"disable\"))\n  or\n  /* pkill , killall used to stop Elastic Agent on Linux */\n  ( event.type == \"end\" and process.name : (\"pkill\", \"killall\") and process.args: \"elastic-agent\")\n  or\n  /* Unload Elastic Agent extension on MacOS */\n  (process.name : \"kextunload\" and\n    process.args : \"com.apple.iokit.EndpointSecurity\" and\n    event.action : \"end\"))\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of a Python script that uses the ROT cipher for letters substitution. Adversaries may\nuse this method to encode and obfuscate...", "output": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type in (\"windows\", \"macos\") and event.type == \"start\" and process.name : \"python*\"]\n [file where host.os.type in (\"windows\", \"macos\") and\n  event.action != \"deletion\" and process.name : \"python*\" and file.name : \"rot_??.cpython-*.pyc*\"]\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rules identifies a process created from an executable with a space appended to the end of the filename. This may\nindicate an attempt to masquerad...", "output": "process where host.os.type:(\"linux\",\"macos\") and event.type == \"start\" and\nprocess.executable regex~ \"\"\"/[a-z0-9\\s_\\-\\\\./]+\\s\"\"\" and not (\n  process.name in (\"ls\", \"find\", \"grep\", \"xkbcomp\") or\n  process.executable like (\"/opt/nessus_agent/*\", \"/opt/gitlab/sv/gitlab-exporter/*\", \"/tmp/ansible-admin/*\") or\n  process.parent.args in (\n    \"./check_rubrik\", \"/usr/bin/check_mk_agent\", \"/etc/rubrik/start_stop_bootstrap.sh\", \"/etc/rubrik/start_stop_agent.sh\"\n  )\n)\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Timestomping is an anti-forensics technique which is used to modify the timestamps of a file, often to mimic files that\nare in the same folder.\n", "output": "process where event.type == \"start\" and\n process.name : \"touch\" and user.id != \"0\" and\n process.args : (\"-r\", \"-t\", \"-a*\",\"-m*\") and\n not process.args : (\n   \"/usr/lib/go-*/bin/go\", \"/usr/lib/dracut/dracut-functions.sh\", \"/tmp/KSInstallAction.*/m/.patch/*\"\n) and not process.parent.name in (\"pmlogger_daily\", \"pmlogger_janitor\", \"systemd\")\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the use of the grep command to discover known third-party macOS and Linux security tools, such as Antivirus\nor Host Firewall details.\n", "output": "process where event.type == \"start\" and\nprocess.name : \"grep\" and user.id != \"0\" and\n not process.parent.executable : (\"/Library/Application Support/*\", \"/opt/McAfee/agent/scripts/ma\") and\n   process.args :\n         (\"Little Snitch*\",\n          \"Avast*\",\n          \"Avira*\",\n          \"ESET*\",\n          \"BlockBlock*\",\n          \"360Sec*\",\n          \"LuLu*\",\n          \"KnockKnock*\",\n          \"kav\",\n          \"KIS\",\n          \"RTProtectionDaemon*\",\n          \"Malware*\",\n          \"VShieldScanner*\",\n          \"WebProtection*\",\n          \"webinspectord*\",\n          \"McAfee*\",\n          \"isecespd*\",\n          \"macmnsvc*\",\n          \"masvc*\",\n          \"kesl*\",\n          \"avscan*\",\n          \"guard*\",\n          \"rtvscand*\",\n          \"symcfgd*\",\n          \"scmdaemon*\",\n          \"symantec*\",\n          \"sophos*\",\n          \"osquery*\",\n          \"elastic-endpoint*\"\n          ) and\n   not (\n     (process.args : \"Avast\" and process.args : \"Passwords\") or\n     (process.args == \"osquery.conf\") or \n     (process.parent.args : \"/opt/McAfee/agent/scripts/ma\" and process.parent.args : \"checkhealth\") or\n     (process.command_line : (\n       \"grep ESET Command-line scanner, version %s -A2\",\n       \"grep -i McAfee Web Gateway Core version:\",\n       \"grep --color=auto ESET Command-line scanner, version %s -A2\"\n       )\n     ) or\n     (process.parent.command_line : (\n       \"\"\"sh -c printf \"command_start_%s\"*; perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1; printf \"command_done_%s*\"\"\",\n       \"\"\"bash -c perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1 \"\"\"       )\n     )\n    )\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "An adversary may attempt to get detailed information about the operating system and hardware. This rule identifies\ncommon locations used to discover v...", "output": "process where event.type == \"start\" and\n process.name in (\"grep\", \"egrep\") and user.id != \"0\" and\n process.args : (\"parallels*\", \"vmware*\", \"virtualbox*\") and process.args : \"Manufacturer*\" and\n not process.parent.executable in (\"/Applications/Docker.app/Contents/MacOS/Docker\", \"/usr/libexec/kcare/virt-what\")\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of a shell process with suspicious arguments which may be indicative of reverse shell activity.", "output": "process where event.type in (\"start\", \"process_started\") and\n  process.name in (\"sh\", \"bash\", \"zsh\", \"dash\", \"zmodload\") and\n  process.args : (\"*/dev/tcp/*\", \"*/dev/udp/*\", \"*zsh/net/tcp*\", \"*zsh/net/udp*\") and\n\n  /* noisy FPs */\n  not (process.parent.name : \"timeout\" and process.executable : \"/var/lib/docker/overlay*\") and\n  not process.command_line : (\n    \"*/dev/tcp/sirh_db/*\", \"*/dev/tcp/remoteiot.com/*\", \"*dev/tcp/elk.stag.one/*\", \"*dev/tcp/kafka/*\",\n    \"*/dev/tcp/$0/$1*\", \"*/dev/tcp/127.*\", \"*/dev/udp/127.*\", \"*/dev/tcp/localhost/*\", \"*/dev/tcp/itom-vault/*\") and\n  not process.parent.command_line : \"runc init\"\n", "source": "detection-rules/cross-platform", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies an outbound network connection by JAVA to LDAP, RMI or DNS standard ports followed by a suspicious JAVA child\nprocesses. This may indicate ...", "output": "sequence by host.id with maxspan=1m\n [network where event.action == \"connection_attempted\" and\n  process.name : \"java\" and\n  /*\n     outbound connection attempt to\n     LDAP, RMI or DNS standard ports\n     by JAVA process\n   */\n  destination.port in (1389, 389, 1099, 53, 5353)] by process.pid\n [process where event.type == \"start\" and\n\n  /* Suspicious JAVA child process */\n  process.parent.name : \"java\" and\n   process.name : (\"sh\",\n                   \"bash\",\n                   \"dash\",\n                   \"ksh\",\n                   \"tcsh\",\n                   \"zsh\",\n                   \"curl\",\n                   \"perl*\",\n                   \"python*\",\n                   \"ruby*\",\n                   \"php*\",\n                   \"wget\") and\n    not process.command_line like~ (\n      \"bash -c ulimit -u\",\n      \"bash /opt/flutter/bin/flutter*\",\n      \"bash -c echo $$\",\n      \"/bin/bash /opt/python3/bin/jira*\",\n      \"/bin/sh -c env LC_ALL=C /usr/sbin/lpc status*\"\n    )] by process.parent.pid\n", "source": "detection-rules/cross-platform", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "The hosts file on endpoints is used to control manual IP address to hostname resolutions. The hosts file is the first\npoint of lookup for DNS hostname...", "output": "any where\n\n  /* file events for creation; file change events are not captured by some of the included sources for linux and so may\n     miss this, which is the purpose of the process + command line args logic below */\n  (\n   event.category == \"file\" and event.type in (\"change\", \"creation\") and\n     file.path : (\"/private/etc/hosts\", \"/etc/hosts\", \"?:\\\\Windows\\\\System32\\\\drivers\\\\etc\\\\hosts\") and \n     not process.name in (\"dockerd\", \"rootlesskit\", \"podman\", \"crio\")\n  )\n  or\n\n  /* process events for change targeting linux only */\n  (\n   event.category == \"process\" and event.type in (\"start\") and\n     process.name in (\"nano\", \"vim\", \"vi\", \"emacs\", \"echo\", \"sed\") and\n     process.args : (\"/etc/hosts\") and \n     not process.parent.name in (\"dhclient-script\", \"google_set_hostname\")\n  )\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: An adversary may add the setuid or setgid bit to a file or directory in order to run a file with the privileges of the\nowning user or group. An advers...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.name == \"chmod\" and (process.args : (\"+s\", \"u+s\", \"g+s\") or process.args regex \"[24][0-9]{3}\")) or\n  (process.name == \"install\" and process.args : \"-m\" and\n  (process.args : (\"+s\", \"u+s\", \"g+s\") or process.args regex \"[24][0-9]{3}\"))\n) and not (\n  process.parent.executable : (\n    \"/usr/NX/*\", \"/var/lib/docker/*\", \"/var/lib/dpkg/info*\", \"/tmp/newroot/*\",\n    \"/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service\"\n  ) or\n  process.args : (\n    \"/run/*\", \"/var/run/*\", \"/usr/bin/keybase-redirector\", \"/usr/local/share/fonts\", \"/usr/bin/ssh-agent\"\n  )\n)\n", "source": "detection-rules/cross-platform", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: A sudoers file specifies the commands that users or groups can run and from which terminals. Adversaries can take\nadvantage of these configurations to...", "output": "file where host.os.type in (\"linux\", \"macos\") and event.type in (\"creation\", \"change\") and\nfile.path like (\"/etc/sudoers*\", \"/private/etc/sudoers*\") and not (\n  process.name in (\"dpkg\", \"platform-python\", \"puppet\", \"yum\", \"dnf\") or\n  process.executable in (\"/opt/chef/embedded/bin/ruby\", \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/bin/dockerd\")\n)\n", "source": "detection-rules/cross-platform", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors for the execution of the cat command, followed by a connection attempt by the same process. Cat is\ncapable of transfering data via ...", "output": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name == \"cat\" and process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [network where host.os.type == \"linux\" and event.action in (\"connection_attempted\", \"disconnect_received\") and\n   process.name == \"cat\" and not (destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n     )\n   )]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-...", "output": "sequence by host.id with maxspan=10s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"foomatic-rip\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and\n   event.action == \"connection_attempted\"] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects the use of the `curl` command-line tool with SOCKS proxy options, launched from an unusual parent\nprocess. Attackers may use `curl` ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"curl\" and (\n  process.parent.executable like (\n    \"/dev/shm/*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/run/*\", \"/root/*\", \"/boot/*\", \"/var/www/html/*\", \"/opt/.*\"\n  ) or\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n) and (\n  process.args like (\"--socks5-hostname\", \"--proxy\", \"--preproxy\", \"socks5*\") or\n  process.args == \"-x\" or\n  process.env_vars like (\"http_proxy=socks5h://*\", \"HTTPS_PROXY=socks5h://*\", \"ALL_PROXY=socks5h://*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects when Node.js, directly or via a shell, spawns the curl or wget command. This may indicate\ncommand and control behavior. Adversaries ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name == \"node\" and (\n  (\n    process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n    process.args == \"-c\" and process.command_line like~ (\"*curl*\", \"*wget*\")\n  ) or \n  (\n    process.name in (\"curl\", \"wget\")\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the use of git to clone a repository or download files from GitHub using wget or curl, followed by\nthe creation of files in suspicio...", "output": "sequence by process.entity_id, host.id with maxspan=10s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n     (process.name == \"git\" and process.args == \"clone\") or\n     (process.name in (\"wget\", \"curl\") and process.command_line like~ \"*github*\")\n  )]\n  [file where host.os.type == \"linux\" and event.type == \"creation\" and file.path like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\")]\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for the execution of commands that enable IPv4 and IPv6 forwarding on Linux systems. Enabling IP\nforwarding can be used to route ne...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\", \"exec_event\") and\nprocess.parent.executable != null and process.command_line like (\n  \"*net.ipv4.ip_forward*\", \"*/proc/sys/net/ipv4/ip_forward*\", \"*net.ipv6.conf.all.forwarding*\",\n  \"*/proc/sys/net/ipv6/conf/all/forwarding*\"\n) and (\n  (process.name == \"sysctl\" and process.args like (\"*-w*\", \"*--write*\", \"*=*\")) or\n  (\n    process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.args == \"-c\" and\n    process.command_line like \"*echo *\"\n  )\n) and\nnot process.parent.name like~ (\"privsep-helper\", \"platform-python*\", \"init.ipv6-global\", \"wsl-bootstrap\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects potential kubectl network configuration modification activity by monitoring for process events\nwhere the kubectl command is executed...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"kubectl\" and (\n  process.args == \"port-forward\" and process.command_line like \"*:*\" or\n  process.args in (\"proxy\", \"expose\")\n) and (\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") or\n  (\n    process.parent.executable like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/root/*\", \"/home/*\") or\n    process.parent.name like (\".*\", \"*.sh\")\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for common command line flags leveraged by the Chisel client utility followed by a connection\nattempt. Chisel is a command-line uti...", "output": "sequence by host.id, process.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args == \"client\" and process.args : (\"R*\", \"*:*\", \"*socks*\", \"*.*\") and process.args_count >= 4 and \n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.name in (\"velociraptor\", \"nbemmcmd\", \"redis-cli\", \"ipa\")]\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and \n   destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" and \n   not process.name : (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\",\n     \"ftp\", \"socat\", \"curl\", \"wget\", \"dpkg\", \"docker\", \"dockerd\", \"yum\", \"apt\", \"rpm\", \"dnf\", \"ssh\", \"sshd\")]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for common command line flags leveraged by the Chisel server utility followed by a received\nconnection within a timespan of 1 minut...", "output": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args == \"server\" and process.args in (\"--port\", \"-p\", \"--reverse\", \"--backend\", \"--socks5\") and \n   process.args_count >= 3 and process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_accepted\" and \n   destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" and \n   not process.name : (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\",\n     \"ftp\", \"socat\", \"curl\", \"wget\", \"dpkg\", \"docker\", \"dockerd\", \"yum\", \"apt\", \"rpm\", \"dnf\", \"ssh\", \"sshd\", \"hugo\")]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for the execution of the ProxyChains utility. ProxyChains is a command-line tool that enables the\nrouting of network connections th...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"proxychains\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for X11 forwarding via SSH. X11 forwarding is a feature that allows users to run graphical\napplications on a remote server and disp...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"ssh\", \"sshd\") and process.args in (\"-X\", \"-Y\") and process.args_count >= 3 and\nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for the execution of suspicious linux tools through ProxyChains. ProxyChains is a command-line tool\nthat enables the routing of net...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"proxychains\" and process.args : (\n  \"ssh\", \"sshd\", \"sshuttle\", \"socat\", \"iodine\", \"iodined\", \"dnscat\", \"hans\", \"hans-ubuntu\", \"ptunnel-ng\",\n  \"ssf\", \"3proxy\", \"ngrok\", \"gost\", \"pivotnacci\", \"chisel*\", \"nmap\", \"ping\", \"python*\", \"php*\", \"perl\", \"ruby\",\n  \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\", \"ftp\", \"curl\", \"wget\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for a set of Linux utilities that can be used for tunneling and port forwarding. Attackers can\nleverage tunneling and port forwardi...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and (\n  (\n    // gost & pivotnacci - spawned without process.parent.name\n    (process.name == \"gost\" and process.args : (\"-L*\", \"-C*\", \"-R*\")) or (process.name == \"pivotnacci\")) or (\n    // ssh\n    (process.name == \"ssh\" and (process.args in (\"-R\", \"-L\", \"-D\", \"-w\") and process.args_count >= 4 and \n     not process.args : \"chmod\")) or\n    // sshuttle\n    (process.name == \"sshuttle\" and process.args in (\"-r\", \"--remote\", \"-l\", \"--listen\") and process.args_count >= 4) or\n    // socat\n    (process.name == \"socat\" and process.args : (\"TCP4-LISTEN:*\", \"SOCKS*\") and process.args_count >= 3) or\n    // chisel\n    (process.name : \"chisel*\" and process.args in (\"client\", \"server\")) or\n    // iodine(d), dnscat, hans, ptunnel-ng, ssf, 3proxy & ngrok \n    (process.name in (\"iodine\", \"iodined\", \"dnscat\", \"hans\", \"hans-ubuntu\", \"ptunnel-ng\", \"ssf\", \"3proxy\", \"ngrok\"))\n  ) and process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the use of SSH options that may indicate tunneling or port forwarding on Linux systems. This behavior\nis commonly associated with ma...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"ssh\", \"sshd\") and process.args == \"-o\" and\nprocess.command_line like~ (\n  \"*ProxyCommand*\", \"*LocalForward*\", \"*RemoteForward*\", \"*DynamicForward*\", \"*Tunnel*\", \"*GatewayPorts*\",\n  \"*ExitOnForwardFailure*\", \"*ProxyCommand*\", \"*ProxyJump*\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects when a process executes the curl or wget command with an argument that includes the\napi.telegram.org domain. This may indicate comma...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name in (\"curl\", \"wget\") and process.command_line like \"*api.telegram.org*\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the execution of the EarthWorm tunneler. Adversaries may tunnel network communications to and from a victim\nsystem within a separate protoc...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n process.args : \"-s\" and process.args : \"-d\" and process.args : \"rssocks\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the use of system search utilities like grep and find to search for AWS credentials inside a\ncontainer. Unauthorized access to these...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and\nprocess.name in (\"grep\", \"egrep\", \"fgrep\", \"find\", \"locate\", \"mlocate\") and\nprocess.command_line like~ (\n  \"*aws_access_key_id*\", \"*aws_secret_access_key*\", \"*aws_session_token*\", \"*accesskeyid*\", \"*secretaccesskey*\",\n  \"*access_key*\", \"*.aws/credentials*\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the use of a compression utility to collect known files containing sensitive information, such as credentials\nand system configurations ins...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\"zip\", \"tar\", \"gzip\", \"hdiutil\", \"7z\") and\nprocess.command_line like~ (\n  \"*/root/.ssh/*\", \"*/home/*/.ssh/*\", \"*/root/.bash_history*\", \"*/etc/hosts*\", \"*/root/.aws/*\", \"*/home/*/.aws/*\",\n  \"*/root/.docker/*\", \"*/home/*/.docker/*\", \"*/etc/group*\", \"*/etc/passwd*\", \"*/etc/shadow*\", \"*/etc/gshadow*\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of the unshadow utility which is part of John the Ripper, a password-cracking tool on the host\nmachine. Malicious actors can ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"unshadow\" and process.args_count >= 3\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for the potential memory dump of the init process (PID 1) through gdb. Attackers may leverage memory\ndumping techniques to attempt ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"gdb\" and process.args in (\"--pid\", \"-p\") and process.args == \"1\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors for potential memory dumping through gdb. Attackers may leverage memory dumping techniques to attempt\nsecret extraction from privil...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"gdb\" and process.args in (\"--pid\", \"-p\") and\n/* Covered by d4ff2f53-c802-4d2e-9fb9-9ecc08356c3f */\nprocess.args != \"1\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects when the Node.js runtime spawns a shell to execute the GitHub CLI (gh) command to retrieve\na GitHub authentication token. The GitHub...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name == \"node\" and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.args == \"gh auth token\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects when a process accesses Kubernetes service account secrets. Kubernetes service\naccount secrets are files that contain sensitive info...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.command_line like (\n    \"*/run/secrets/kubernetes.io/serviceaccount*\",\n    \"*/var/run/secrets/kubernetes.io/serviceaccount*\",\n    \"*/secrets/kubernetes.io/serviceaccount*\"\n  ) or (\n    process.working_directory like (\n      \"/run/secrets/kubernetes.io/serviceaccount\",\n      \"/var/run/secrets/kubernetes.io/serviceaccount\",\n      \"/secrets/kubernetes.io/serviceaccount\"\n    ) and\n    process.args in (\"ca.crt\", \"token\", \"namespace\")\n  )\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for manual memory dumping via the proc filesystem. The proc filesystem in Linux provides a virtual filesystem\nthat contains informa...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"cat\", \"grep\", \"tail\", \"less\", \"more\", \"egrep\", \"fgrep\") and process.command_line like \"/proc/*/mem\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies multiple consecutive login attempts executed by one process targeting a local linux user account within a\nshort time interval. Adversaries ...", "output": "sequence by host.id, process.parent.executable, user.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"su\" and\n   not process.parent.name in (\n     \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"clickhouse-server\", \"ma\", \"gitlab-runner\",\n     \"updatedb.findutils\", \"cron\", \"perl\", \"sudo\", \"java\", \"cloud-app-identify\", \"ambari-sudo.sh\"\n   )\n  ] with runs=10\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies multiple external consecutive login failures targeting a user account from the same source address within a\nshort time interval. Adversarie...", "output": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [ authentication where host.os.type == \"linux\" and \n   event.action in (\"ssh_login\", \"user_login\") and event.outcome == \"failure\" and\n   not cidrmatch(source.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \n       \"::1\", \"FE80::/10\", \"FF00::/8\") ] with runs = 10\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies multiple internal consecutive login failures targeting a user account from the same source address within a\nshort time interval. Adversarie...", "output": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [ authentication where host.os.type == \"linux\" and \n   event.action in (\"ssh_login\", \"user_login\") and event.outcome == \"failure\" and\n   cidrmatch(source.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \n       \"::1\", \"FE80::/10\", \"FF00::/8\") ] with runs = 10\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "An FTP (file transfer protocol) brute force attack is a method where an attacker systematically tries different\ncombinations of usernames and password...", "output": "sequence by host.id, auditd.data.addr, related.user with maxspan=5s\n  [authentication where host.os.type == \"linux\" and event.action == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"failure\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] with runs=10\n  [authentication where host.os.type == \"linux\" and event.action  == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"success\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] | tail 1\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "An RDP (Remote Desktop Protocol) brute force attack involves an attacker repeatedly attempting various username and\npassword combinations to gain unau...", "output": "sequence by host.id, related.user with maxspan=5s\n  [authentication where host.os.type == \"linux\" and event.action == \"authenticated\" and\n   auditd.data.terminal : \"*rdp*\" and event.outcome == \"failure\"] with runs=10\n  [authentication where host.os.type == \"linux\" and event.action  == \"authenticated\" and\n   auditd.data.terminal : \"*rdp*\" and event.outcome == \"success\"] | tail 1\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies multiple SSH login failures followed by a successful one from the same source address. Adversaries can\nattempt to login into multiple users...", "output": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"failure\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ] with runs=10\n\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"success\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ]\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of the mimipenguin exploit script which is linux adaptation of Windows tool mimikatz.\nMimipenguin exploit script is used to d...", "output": "sequence by host.id, process.parent.name with maxspan=1m\n  [process where host.os.type == \"linux\" and process.name == \"ps\" and event.action in (\"exec\", \"start\", \"exec_event\")\n   and process.args in (\"-eo\", \"pid\", \"command\")]\n  [process where host.os.type == \"linux\" and process.name == \"strings\" and event.action in (\"exec\", \"start\", \"exec_event\")\n   and process.args : \"/tmp/*\"]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the use of system search utilities like grep and find to search for private SSH keys or passwords\ninside a container. Unauthorized a...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and\nprocess.name in (\"grep\", \"egrep\", \"fgrep\", \"find\", \"locate\", \"mlocate\") and\nprocess.command_line like~ (\n  \"*BEGIN PRIVATE*\", \"*BEGIN OPENSSH PRIVATE*\", \"*BEGIN RSA PRIVATE*\", \"*BEGIN DSA PRIVATE*\", \"*BEGIN EC PRIVATE*\",\n  \"*pass*\", \"*ssh*\", \"*user*\", \"*id_rsa*\", \"*id_dsa*\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies a Secure Shell (SSH) client or server process creating or writing to a known SSH backdoor log file.\nAdversaries may modify SSH related bina...", "output": "file where host.os.type == \"linux\" and event.type == \"change\" and process.executable : (\"/usr/sbin/sshd\", \"/usr/bin/ssh\") and\n  (\n    (file.name : (\".*\", \"~*\", \"*~\") and not file.name : (\".cache\", \".viminfo\", \".bash_history\", \".google_authenticator\",\n      \".jelenv\", \".csvignore\", \".rtreport\")) or\n    file.extension : (\"in\", \"out\", \"ini\", \"h\", \"gz\", \"so\", \"sock\", \"sync\", \"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\") or\n    file.path :\n    (\n      \"/private/etc/*--\",\n      \"/usr/share/*\",\n      \"/usr/include/*\",\n      \"/usr/local/include/*\",\n      \"/private/tmp/*\",\n      \"/private/var/tmp/*\",\n      \"/usr/tmp/*\",\n      \"/usr/share/man/*\",\n      \"/usr/local/share/*\",\n      \"/usr/lib/*.so.*\",\n      \"/private/etc/ssh/.sshd_auth\",\n      \"/usr/bin/ssd\",\n      \"/private/var/opt/power\",\n      \"/private/etc/ssh/ssh_known_hosts\",\n      \"/private/var/html/lol\",\n      \"/private/var/log/utmp\",\n      \"/private/var/lib\",\n      \"/var/run/sshd/sshd.pid\",\n      \"/var/run/nscd/ns.pid\",\n      \"/var/run/udev/ud.pid\",\n      \"/var/run/udevd.pid\"\n    )\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule identifies potentially malicious processes attempting to access the cloud service provider's instance metadata\nservice (IMDS) API endpoint, ...", "output": "sequence by host.id, process.parent.entity_id with maxspan=3s\n[\n    process\n    where host.os.type == \"linux\"\n        and event.type == \"start\"\n        and event.action == \"exec\"\n        and process.parent.executable != null\n\n        // common tooling / suspicious names (keep broad)\n        and (\n            process.name : (\n                \"curl\", \"wget\", \"python*\", \"perl*\", \"php*\", \"ruby*\", \"lua*\", \"telnet\", \"pwsh\",\n                \"openssl\", \"nc\", \"ncat\", \"netcat\", \"awk\", \"gawk\", \"mawk\", \"nawk\", \"socat\", \"node\",\n                \"bash\", \"sh\"\n            )\n            or\n            // suspicious execution locations (dropped binaries / temp execution)\n            process.executable : (\n                \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n                \"/etc/cron*\", \"/etc/update-motd.d/*\", \"/boot/*\", \"/srv/*\", \"/run/*\", \"/etc/rc.local\"\n            )\n            or\n            // threat-relevant IMDS / metadata endpoints (inclusion list)\n            process.command_line : (\n                \"*169.254.169.254/latest/api/token*\",\n                \"*169.254.169.254/latest/meta-data/iam/security-credentials*\",\n                \"*169.254.169.254/latest/meta-data/local-ipv4*\",\n                \"*169.254.169.254/latest/meta-data/local-hostname*\",\n                \"*169.254.169.254/latest/meta-data/public-ipv4*\",\n                \"*169.254.169.254/latest/user-data*\",\n                \"*169.254.169.254/latest/dynamic/instance-identity/document*\",\n                \"*169.254.169.254/latest/meta-data/instance-id*\",\n                \"*169.254.169.254/latest/meta-data/public-keys*\",\n                \"*computeMetadata/v1/instance/service-accounts/*/token*\",\n                \"*/metadata/identity/oauth2/token*\",\n                \"*169.254.169.254/opc/v*/instance*\",\n                \"*169.254.169.254/opc/v*/vnics*\"\n            )\n        )\n\n        // global working-dir / executable / parent exclusions for known benign agents\n        and not process.working_directory : (\n            \"/opt/rapid7*\",\n            \"/opt/nessus*\",\n            \"/snap/amazon-ssm-agent*\",\n            \"/var/snap/amazon-ssm-agent/*\",\n            \"/var/log/amazon/ssm/*\",\n            \"/srv/snp/docker/overlay2*\",\n            \"/opt/nessus_agent/var/nessus/*\"\n        )\n\n        and not process.executable : (\n            \"/opt/rumble/bin/rumble-agent*\",\n            \"/opt/aws/inspector/bin/inspectorssmplugin\",\n            \"/snap/oracle-cloud-agent/*\",\n            \"/lusr/libexec/oracle-cloud-agent/*\"\n        )\n\n        and not process.parent.executable : (\n            \"/usr/bin/setup-policy-routes\",\n            \"/usr/share/ec2-instance-connect/*\",\n            \"/var/lib/amazon/ssm/*\",\n            \"/etc/update-motd.d/30-banner\",\n            \"/usr/sbin/dhclient-script\",\n            \"/usr/local/bin/uwsgi\",\n            \"/usr/lib/skylight/al-extras\",\n            \"/usr/bin/cloud-init\",\n            \"/usr/sbin/waagent\",\n            \"/usr/bin/google_osconfig_agent\",\n            \"/usr/bin/docker\",\n            \"/usr/bin/containerd-shim\",\n            \"/usr/bin/runc\"\n        )\n\n        and not process.entry_leader.executable : (\n            \"/usr/local/qualys/cloud-agent/bin/qualys-cloud-agent\",\n            \"/opt/Elastic/Agent/data/elastic-agent-*/elastic-agent\",\n            \"/opt/nessus_agent/sbin/nessus-service\"\n        )\n\n        // carve-out: safe /usr/bin/curl usage (suppress noisy, legitimate agent patterns)\n        and not (\n            process.executable == \"/usr/bin/curl\"\n            and (\n                // AWS IMDSv2 token PUT that includes ttl header\n                (process.command_line : \"*-X PUT*169.254.169.254/latest/api/token*\" and process.command_line : \"*X-aws-ec2-metadata-token-ttl-seconds*\")\n                or\n                // Any IMDSv2 GET that includes token header for any /latest/* path\n                process.command_line : \"*-H X-aws-ec2-metadata-token:*169.254.169.254/latest/*\"\n                or\n                // Common amazon tooling UA\n                process.command_line : \"*-A amazon-ec2-net-utils/*\"\n                or\n                // Azure metadata legitimate header\n                process.command_line : \"*-H Metadata:true*169.254.169.254/metadata/*\"\n                or\n                // Oracle IMDS legitimate header\n                process.command_line : \"*-H Authorization:*Oracle*169.254.169.254/opc/*\"\n            )\n        )\n]\n[\n    network where host.os.type == \"linux\"\n        and event.action == \"connection_attempted\"\n        and destination.ip == \"169.254.169.254\"\n]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects Linux Access Control List (ACL) modification via the setfacl command.\n", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\nprocess.name == \"setfacl\" and not (\n  process.command_line == \"/bin/setfacl --restore=-\" or\n  process.args == \"/var/log/journal/\" or\n  process.parent.name in (\"stats.pl\", \"perl\", \"find\") or\n  process.parent.command_line like~ \"/bin/sh -c *ansible*\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Adversaries may attempt to disable the Auditd service to evade detection. Auditd is a Linux service that provides system\nauditing and logging. Disabli...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and (\n  (process.name == \"service\" and process.args == \"stop\") or\n  (process.name == \"chkconfig\" and process.args == \"off\") or\n  (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))\n) and\nprocess.args in (\"auditd\", \"auditd.service\") and \nnot process.parent.name == \"auditd.prerm\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Adversaries may attempt to disable the iptables or firewall service in an attempt to affect how a host is allowed to\nreceive or send network traffic.\n", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n  (\n   /* disable FW */\n   (\n     (process.name == \"ufw\" and process.args == \"disable\") or\n     (process.name == \"iptables\" and process.args in (\"-F\", \"--flush\", \"-X\", \"--delete-chain\") and process.args_count == 2) or\n     (process.name in (\"iptables\", \"ip6tables\") and process.parent.args == \"force-stop\")\n   ) or\n\n   /* stop FW service */\n   (\n     ((process.name == \"service\" and process.args == \"stop\") or\n       (process.name == \"chkconfig\" and process.args == \"off\") or\n       (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))) and\n    process.args in (\"firewalld\", \"ip6tables\", \"iptables\", \"firewalld.service\", \"ip6tables.service\", \"iptables.service\")\n    )\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Adversaries may attempt to disable the syslog service in an attempt to an attempt to disrupt event logging and evade\ndetection by security controls.\n", "output": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n ( (process.name == \"service\" and process.args == \"stop\") or\n   (process.name == \"chkconfig\" and process.args == \"off\") or\n   (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))\n ) and process.args in (\"syslog\", \"rsyslog\", \"syslog-ng\", \"syslog.service\", \"rsyslog.service\", \"syslog-ng.service\") and\nnot (\n  process.parent.name == \"rsyslog-rotate\" or\n  process.args == \"HUP\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the deletion of the authorized_keys or authorized_keys2 files on Linux systems. These files\nare used to store public keys for SSH au...", "output": "file where host.os.type == \"linux\" and event.type == \"deletion\" and file.name in (\"authorized_keys\", \"authorized_keys2\") and\nnot (\n  process.executable in (\n    \"/usr/bin/google_guest_agent\", \"/usr/bin/dockerd\", \"/bin/dockerd\", \"/usr/bin/containerd\"\n  ) or\n  process.executable like~ \"/nix/store/*\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Adversaries may encode/decode data in an attempt to evade detection by host- or network-based security controls.", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name in (\"base16\", \"base32\", \"base32plain\", \"base32hex\") and\nnot process.args in (\"--help\", \"--version\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors for the copying or moving of a system binary. Adversaries may copy/move and rename system binaries to\nevade detection. Copying a sy...", "output": "file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and process.name != null and\nfile.Ext.original.path : (\n  \"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/bin/update-alternatives\", \"/bin/update-alternatives\", \"/usr/sbin/update-alternatives\",\n    \"/sbin/update-alternatives\", \"/usr/bin/pip3\", \"/bin/pip3\", \"/usr/local/bin/pip3\", \"/usr/local/bin/node\",\n    \"/bin/node\", \"/usr/bin/node\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/pip\", \"/bin/pip\",\n    \"/usr/local/bin/pip\", \"/usr/libexec/platform-python\", \"/usr/bin/platform-python\", \"/bin/platform-python\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/sshd\", \"/sbin/sshd\", \"/usr/local/sbin/sshd\", \"/usr/sbin/crond\", \"/sbin/crond\",\n    \"/usr/local/sbin/crond\", \"/usr/sbin/gdm\"\n  ) or\n  process.name like (\n    \"python*\", \"packagekitd\", \"systemd\", \"ln\", \"platform-python\", \"dnf_install\", \"runc\", \"apt-get\", \"ssm-agent-worker\",\n    \"convert-usrmerge\", \"updatenow.static-cpanelsync\", \"apk\", \"exe\", \"php\", \"containerd-shim-runc-v2\", \"dpkg\", \"sed\",\n    \"platform-python*\", \"gedit\", \"crond\", \"sshd\", \"ruby\", \"sudo\", \"chainctl\", \"update-alternatives\", \"pip*\", \"microdnf\",\n    \"rsync\", \"convert2rhel\", \"convert-usr-merge\"\n  ) or\n  file.Ext.original.path : (\n    \"/bin/*.tmp\", \"/usr/bin/*.tmp\", \"/usr/local/bin/*.tmp\", \"/sbin/*.tmp\", \"/usr/sbin/*.tmp\", \"/usr/local/sbin/*.tmp\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects a file being made immutable using the chattr binary. Making a file immutable means it cannot be deleted or\nrenamed, no link can be created to ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and process.parent.executable != null and\nprocess.executable : \"/usr/bin/chattr\" and process.args : (\"-*i*\", \"+*i*\") and not (\n  process.parent.executable: (\"/lib/systemd/systemd\", \"/usr/local/uems_agent/bin/*\", \"/usr/lib/systemd/systemd\") or\n  process.parent.name in (\n    \"systemd\", \"cf-agent\", \"ntpdate\", \"xargs\", \"px\", \"preinst\", \"auth\", \"cf-agent\", \"dcservice\", \"dcagentupgrader\",\n    \"sudo\", \"ephemeral-disk-warning\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Monitors for the deletion of the kernel ring buffer events through dmesg. Attackers may clear kernel ring buffer events\nto evade detection after insta...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"dmesg\" and process.args in (\"-c\", \"--clear\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identify activity related where adversaries can add the 'hidden' flag to files to hide them from the user in an attempt\nto evade detection.\n", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.name == \"chflags\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule identifies the creation of directories in the /bin directory. The /bin directory contains essential binary\nfiles that are required for the s...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"start\", \"ProcessRollup2\", \"exec_event\") and process.name == \"mkdir\" and\n  process.args like (\"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\") and\nnot process.args in (\"/bin/mkdir\", \"/usr/bin/mkdir\", \"/usr/local/bin/mkdir\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for potential attempts to disable AppArmor. AppArmor is a Linux security module that enforces\nfine-grained access control policies ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n (\n  (process.name == \"systemctl\" and process.args in (\"stop\", \"disable\", \"kill\") and process.args in (\"apparmor\", \"apparmor.service\")) or\n  (process.name == \"service\" and process.args == \"apparmor\" and process.args == \"stop\") or\n  (process.name == \"chkconfig\" and process.args == \"apparmor\" and process.args == \"off\") or\n  (process.name == \"ln\" and process.args : \"/etc/apparmor.d/*\" and process.args == \"/etc/apparmor.d/disable/\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies potential attempts to disable Security-Enhanced Linux (SELinux), which is a Linux kernel security feature to\nsupport access control policie...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name == \"setenforce\" and process.args == \"0\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects the creation or rename of the Doas configuration file on a Linux system. Adversaries may create or\nmodify the Doas configuration fil...", "output": "file where host.os.type == \"linux\" and event.type != \"deletion\" and file.path == \"/etc/doas.conf\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects the creation or modification of files related to the configuration of the dynamic linker on Linux systems.\nThe dynamic linker is a shared libr...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and\nfile.path : (\"/etc/ld.so.preload\", \"/etc/ld.so.conf.d/*\", \"/etc/ld.so.conf\") and\nnot (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\",\n    \"/usr/lib/snapd/snap-update-ns\", \"/usr/bin/vmware-config-tools.pl\", \"./usr/bin/podman\", \"/bin/nvidia-cdi-hook\",\n    \"/usr/lib/dracut/dracut-install\", \"./usr/bin/nvidia-cdi-hook\", \"/.envbuilder/bin/envbuilder\", \"/usr/bin/buildah\",\n    \"/usr/sbin/dnf\", \"/usr/bin/pamac\", \"/sbin/pacman\", \"/usr/bin/crio\", \"/usr/sbin/yum-cron\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\", \"/opt/dynatrace/oneagent/*\",\n    \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"java\", \"executor\", \"ssm-agent-worker\", \"packagekitd\", \"crio\", \"dockerd-entrypoint.sh\",\n    \"docker-init\", \"BootTimeChecker\", \"dockerd (deleted)\", \"dockerd\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") or\n  (process.name == \"init\" and file.name == \"ld.wsl.conf\") or\n  (process.name == \"sshd\" and file.extension == \"dpkg-new\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies instances where the 'touch' command is executed on a Linux system with the \"-r\" flag, which is used to modify\nthe timestamp of a file based...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name == \"touch\" and process.args == \"-r\" and process.args : (\"/etc/vmware/*\", \"/usr/lib/vmware/*\", \"/vmfs/*\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Malware or other files dropped or created on a system by an adversary may leave traces behind as to what was done within\na network and how. Adversarie...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and process.name == \"shred\" and process.args in (\n  \"-u\", \"--remove\", \"-z\", \"--zero\"\n) and not process.parent.name == \"logrotate\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects when a process executes a command line containing hexadecimal characters. Malware authors may use\nhexadecimal encoding to obfuscate ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.parent.executable != null and\nprocess.command_line : \"*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\" and\nlength(process.command_line) > 50\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects potential hex payload execution on Linux systems. Adversaries may use hex encoding to obfuscate\npayloads and evade detection mechani...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name == \"xxd\" and process.args like (\"-r*\", \"-p*\")) or\n    (process.name like \"python*\" and process.command_line like \"*fromhex*\" and process.command_line like (\"*decode*\", \"*encode*\")) or\n    (process.name like \"php*\" and process.command_line like \"*hex2bin*\") or\n    (process.name like \"ruby*\" and process.command_line like \"*].pack(\\\"H*\\\")*\") or\n    (process.name like \"perl*\" and process.command_line like \"*pack(\\\"H*\\\",*\") or\n    (process.name like \"lua*\" and process.command_line like \"*tonumber(cc, 16)*\")\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects the creation of a hidden directory via an unusual parent executable. Hidden directories are\ndirectories that are not visible to the ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\", \"exec_event\") and\nprocess.name == \"mkdir\" and process.parent.executable like (\n  \"/dev/shm/*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/run/*\", \"/root/*\", \"/boot/*\", \"/var/www/html/*\", \"/opt/.*\"\n) and process.args like (\".*\", \"/*/.*\") and process.args_count <= 3 and not (\n  process.parent.executable like (\"/tmp/newroot/*\", \"/run/containerd/*\") or\n  process.command_line like (\"mkdir -p .\", \"mkdir ./*\") or\n  process.args == \"/root/.ssh\" or\n  process.parent.executable like (\n    \"/tmp/pear/temp/*\", \"/var/tmp/buildah*\", \"/tmp/python-build.*\", \"/tmp/cliphist-wofi-img\", \"/tmp/snap.rootfs_*\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Users can mark specific files as hidden simply by putting a \".\" as the first character in the file or folder name.\nAdversaries can use this to their a...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.working_directory in (\"/tmp\", \"/var/tmp\", \"/dev/shm\") and\nprocess.args regex~ \"\"\"\\.[a-z0-9_\\-][a-z0-9_\\-\\.]{1,254}\"\"\" and\nnot process.name in (\n  \"ls\", \"find\", \"grep\", \"git\", \"jq\", \"basename\", \"check_snmp\", \"snmpget\", \"snmpwalk\", \"cc1plus\", \"snap\",\n  \"command-not-found\", \"sqlite\", \"apk\", \"fgrep\", \"locate\", \"objdump\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation of a hidden shared object (.so) file. Users can mark specific files as hidden simply by putting\na \".\" as the first character i...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.extension == \"so\" and file.name : \".*.so\" and\nnot process.name in (\"dockerd\", \"azcopy\", \"podman\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects when a base64 decoded payload is piped to an interpreter on Linux systems. Adversaries may use\nbase64 encoding to obfuscate data and...", "output": "sequence by host.id, process.parent.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n    (process.name in (\"base64\", \"base64plain\", \"base64url\", \"base64mime\", \"base64pem\", \"base32\", \"base16\") and process.command_line like~ \"*-*d*\") or\n    (process.name == \"openssl\" and process.args == \"enc\" and process.args in (\"-d\", \"-base64\", \"-a\")) or\n    (process.name like \"python*\" and\n    (process.args == \"base64\" and process.args in (\"-d\", \"-u\", \"-t\")) or\n    (process.args == \"-c\" and process.args like \"*base64*\" and process.command_line like~ \"*b64decode*\")\n    ) or\n    (process.name like \"perl*\" and process.command_line like~ \"*decode_base64*\") or\n    (process.name like \"ruby*\" and process.args == \"-e\" and process.command_line like~ \"*Base64.decode64*\")\n  )]\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name like~ (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"perl*\", \"ruby*\", \"lua*\", \"php*\"\n )]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for attempts to clear logs using the \"journalctl\" command on Linux systems. Adversaries may use this\ntechnique to cover their track...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\nprocess.name == \"journalctl\" and process.args like (\"--vacuum-time=*\", \"--vacuum-size=*\", \"--vacuum-files=*\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Kernel modules are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the\nfunctionality of the kernel without the...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    process.name == \"rmmod\" or\n    (process.name == \"modprobe\" and process.args in (\"--remove\", \"-r\"))\n  ) and\n  process.parent.name in (\"sudo\", \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Monitors for kernel processes with associated process executable fields that are not empty. Unix kernel processes such\nas kthreadd and kworker typical...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name : (\"kworker*\", \"kthread*\") and process.executable != null\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the creation of the dynamic linker (ld.so). The dynamic linker is used to load shared libraries\nneeded by an executable. Attackers m...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.path like~ (\"/lib/ld-linux*.so*\", \"/lib64/ld-linux*.so*\", \"/usr/lib/ld-linux*.so*\", \"/usr/lib64/ld-linux*.so*\") and\nnot process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\",\n    \"/usr/lib/snapd/snap-update-ns\", \"./usr/bin/podman\", \"/usr/bin/crio\", \"/usr/bin/buildah\", \"/bin/dnf5\",\n    \"/usr/bin/dnf5\", \"/usr/bin/pamac\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the deletion of sensitive Linux system logs. This may indicate an attempt to evade detection or destroy\nforensic evidence on a system.\n", "output": "file where host.os.type == \"linux\" and event.type == \"deletion\" and\n  file.path :\n    (\n    \"/var/run/utmp\",\n    \"/var/log/wtmp\",\n    \"/var/log/btmp\",\n    \"/var/log/lastlog\",\n    \"/var/log/faillog\",\n    \"/var/log/syslog\",\n    \"/var/log/messages\",\n    \"/var/log/secure\",\n    \"/var/log/auth.log\",\n    \"/var/log/boot.log\",\n    \"/var/log/kern.log\",\n    \"/var/log/dmesg\"\n    ) and\n    not process.name in (\"gzip\", \"executor\", \"dockerd\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the execution of mount process with hidepid parameter, which can make processes invisible to other users from\nthe system. Adversaries using...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\n  process.name == \"mount\" and process.args == \"/proc\" and process.args == \"-o\" and process.args : \"*hidepid=2*\" and\n  not process.parent.command_line like \"/opt/cloudlinux/*\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the execution of multiple base64 decoding commands to decode data. multi-decoded\ndata is suspicious, and may be used by attackers to...", "output": "sequence by process.parent.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.executable != null and\n   process.name in (\"base64\", \"base64plain\", \"base64url\", \"base64mime\", \"base64pem\", \"base32\", \"base16\") and\n   // Only including potentially suspicious locations\n   process.args like~ (\"-d*\", \"--d*\") and process.working_directory like (\n     \"/tmp/*\", \"/var/tmp*\", \"/dev/shm/*\", \"/var/www/*\", \"/home/*\", \"/root/*\"\n   ) and not (\n     process.parent.executable in (\n       \"/usr/share/ec2-instance-connect/eic_curl_authorized_keys\", \"/etc/cron.daily/vivaldi\",\n       \"/etc/cron.daily/opera-browser\"\n     ) or\n     process.working_directory like (\n       \"/opt/microsoft/omsagent/plugin\", \"/opt/rapid7/ir_agent/*\", \"/tmp/newroot/*\"\n      )\n   )]\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.executable != null and\n   process.name in (\"base64\", \"base64plain\", \"base64url\", \"base64mime\", \"base64pem\", \"base32\", \"base16\") and\n   process.args like~ (\"-d*\", \"--d*\")]\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects potential impersonation attempts via the \"kubectl\" command in Linux environments. It identifies\nprocess events where \"kubectl\" is ex...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\nprocess.name == \"kubectl\" and (\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") or\n  (\n    process.parent.executable like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/root/*\", \"/home/*\") or\n    process.parent.name like (\".*\", \"*.sh\")\n  )\n) and process.args like~ (\"--kubeconfig*\", \"--token*\", \"--as*\", \"--as-group*\", \"--as-uid*\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects potential kubectl masquerading activity by monitoring for process events where the process name\nis not \"kubectl\" but the command lin...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\n(\n  process.executable like~ (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/root/*\", \"/var/www/*\", \"./kubectl\", \"/home/*/kubectl\") or\n  process.name like \".*\"\n) and\nprocess.command_line like~ (\n\n  // get and describe commands\n  \"*get po*\", \"*get deploy*\", \"*get node*\", \"*get svc*\", \"*get service*\", \"*get secret*\", \"*get clusterrole*\", \"*get ingress*\",\n  \"*get configmap*\", \"*describe po*\", \"*describe deploy*\", \"*describe node*\", \"*describe svc*\", \"*describe service*\",\n  \"*describe secret*\", \"*describe configmap*\", \"*describe clusterrole*\", \"*describe ingress*\",\n  \n  // exec commands\n  \"*exec -it*\", \"*exec --stdin*\", \"*exec --tty*\",\n  \n  // networking commands\n  \"*port-forward* \", \"*proxy --port*\", \"*run --image=*\", \"*expose*\",\n\n  // authentication/impersonation commands\n  \"*auth can-i*\", \"*--kubeconfig*\", \"*--as *\", \"*--as=*\", \"*--as-group*\", \"*--as-uid*\"\n) and not (\n  process.executable like \"/tmp/newroot/*\" or\n  process.name == \".flatpak-wrapped\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of the PRoot utility, an open-source tool for user-space implementation of chroot, mount\n--bind, and binfmt_misc. Adversaries...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.parent.name == \"proot\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule leverages Auditd data to detect the use of the `prctl` syscall to potentially hide a process\nby changing its name. The `prctl` syscall is us...", "output": "process where host.os.type == \"linux\" and auditd.data.syscall == \"prctl\" and auditd.data.a0 == \"f\" and\nprocess.executable like (\n  \"/boot/*\", \"/dev/shm/*\", \"/etc/cron.*/*\", \"/etc/init.d/*\", \"/var/run/*\", \"/etc/update-motd.d/*\",\n  \"/tmp/*\", \"/var/log/*\", \"/var/tmp/*\", \"/home/*\", \"/run/shm/*\", \"/run/*\", \"./*\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies instances where VMware-related files, such as those with extensions like \".vmdk\", \".vmx\", \".vmxf\", \".vmsd\",\n\".vmsn\", \".vswp\", \".vmss\", \".nv...", "output": "file where host.os.type == \"linux\" and event.action == \"rename\" and\nfile.Ext.original.name : (\"*.vmdk\", \"*.vmx\", \"*.vmxf\", \"*.vmsd\", \"*.vmsn\", \"*.vswp\", \"*.vmss\", \"*.nvram\", \"*.vmem\")\nand not file.name : (\"*.vmdk\", \"*.vmx\", \"*.vmxf\", \"*.vmsd\", \"*.vmsn\", \"*.vswp\", \"*.vmss\", \"*.nvram\", \"*.vmem\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies instances where the \"index.html\" file within the \"/usr/lib/vmware/*\" directory is renamed on a Linux system.\nThe rule monitors for the \"ren...", "output": "file where host.os.type == \"linux\" and event.action == \"rename\" and file.name : \"index.html\" and\nfile.Ext.original.path : \"/usr/lib/vmware/*\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the installation of root certificates on a Linux system. Adversaries may install a root certificate on\na compromised system to avoid...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.name in (\"update-ca-trust\", \"update-ca-certificates\") and not (\n  process.parent.name like (\n    \"ca-certificates.postinst\", \"ca-certificates-*.trigger\", \"pacman\", \"pamac-daemon\", \"autofirma.postinst\",\n    \"ipa-client-install\", \"su\", \"platform-python\", \"python*\", \"kesl\", \"execd\", \"systemd\", \"flock\"\n  ) or\n  process.parent.args like \"/var/tmp/rpm*\" or\n  (process.parent.name in (\"sh\", \"bash\", \"zsh\") and process.args == \"-e\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects the creation or renaming of the SELinux configuration file. SELinux is a security module that provides\naccess control security polic...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\", \"rename\", \"file_rename_event\")\nand file.path : \"/etc/selinux/config\" and not process.name in (\"dockerd\", \"platform-python\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects the deletion of SSL certificates on a Linux system. Adversaries may delete SSL certificates to subvert\ntrust controls and negatively...", "output": "file where host.os.type == \"linux\" and event.type == \"deletion\" and file.path : \"/etc/ssl/certs/*\" and\nfile.extension in (\"pem\", \"crt\") and not process.name in (\"dockerd\", \"pacman\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for the execution of suspicious commands via screen and tmux. When launching a command and detaching\ndirectly, the commands will be...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.parent.name in (\"screen\", \"tmux\") and process.name like (\n    \"nmap\", \"nc\", \"ncat\", \"netcat\", \"socat\", \"nc.openbsd\", \"ngrok\", \"ping\", \"java\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n    \"openssl\", \"telnet\", \"wget\", \"curl\", \"id\"\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects suspicious paths mounted on Linux systems. The mount command is used to attach filesystems to\nthe system, and attackers may use it t...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"mount\" and\nprocess.args like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/home/*\", \"/root/*\", \"/mount\") and process.parent.executable != null and\nnot (\n  process.parent.executable like (\"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\", \"/usr/libexec/*\") or\n  process.parent.name == \"snapd\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the modification and reading of kernel features through built-in commands. Attackers may collect\ninformation, disable or weaken Linu...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.command_line : (\n  \"*/etc/sysctl.conf*\", \"*/etc/sysctl.d/*\", \"*/proc/sys/kernel/nmi_watchdog*\",\n  \"*/proc/sys/vm/nr_hugepages*\", \"*/proc/sys/kernel/yama/ptrace_scope*\",\n  \"*/proc/sys/kernel/randomize_va_space*\", \"*/proc/sys/vm/drop_caches*\",\n  \"*/proc/sys/kernel/sysrq*\", \"*grsecurity*\", \"*exec-shield*\",\n  \"*kernel.randomize_va_space*\", \"*kernel.yama.ptrace_scope*\",\n  \"*kernel.nmi_watchdog*\", \"*vm.nr_hugepages*\", \"*vm.drop_caches*\",\n  \"*kernel.sysrq*\"\n) and\nprocess.parent.executable != null and \n(\n  (process.name == \"tee\" and process.args like \"-*a*\") or // also detects --append\n  (process.name == \"cat\" and not process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")) or\n  (process.name == \"grep\" and process.args_count == 3 and not process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")) or\n  (process.name == \"sysctl\" and process.args like (\"*-w*\", \"*--write*\", \"*=*\")) or\n  (process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.args == \"-c\" and process.args : \"*echo *\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the use of unusual kill signals, specifically kill signals in the range of 32-64, which\nare not commonly used in standard operations...", "output": "process where host.os.type == \"linux\" and event.action == \"killed-pid\" and auditd.data.syscall == \"kill\" and\nauditd.data.a1 in (\n  \"21\", \"22\", \"23\", \"24\", \"25\", \"26\", \"27\", \"28\", \"29\", \"2a\", \"2b\", \"2c\", \"2d\", \"2e\", \"2f\", \"30\",\n  \"31\", \"32\", \"33\", \"34\", \"35\", \"36\", \"37\", \"38\", \"39\", \"3a\", \"3b\", \"3c\", \"3d\", \"3e\", \"3f\", \"40\",\n  \"41\", \"42\", \"43\", \"44\", \"45\", \"46\", \"47\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects potential Docker socket enumeration activity by monitoring processes that attempt to interact with the\nDocker socket file (/var/run/...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\nprocess.name in (\"curl\", \"socat\", \"nc\", \"netcat\", \"ncat\", \"nc.traditional\") and\nprocess.command_line like (\"*/var/run/docker.sock*\", \"*/run/docker.sock*\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Monitors for dynamic linker discovery via the od utility. od (octal dump) is a command-line utility in Unix operating\nsystems used for displaying data...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"od\" and process.args in (\n  \"/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/etc/ld.so.preload\", \"/lib64/ld-linux-x86-64.so.2\",\n  \"/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/usr/lib64/ld-linux-x86-64.so.2\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies instances where the 'find' command is started on a Linux system with arguments targeting specific VM-related\npaths, such as \"/etc/vmware/\",...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\n  process.name == \"find\" and process.args : (\"/etc/vmware/*\", \"/usr/lib/vmware/*\", \"/vmfs/*\") and\n  not process.parent.executable == \"/usr/lib/vmware/viewagent/bin/uninstall_viewagent.sh\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies instances where a process named 'grep', 'egrep', or 'pgrep' is started on a Linux system with arguments\nrelated to virtual machine (VM) fil...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\n  process.name in (\"grep\", \"egrep\", \"pgrep\") and\n  process.args in (\"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", \"vmem\") and\n  not process.parent.executable == \"/usr/share/qemu/init/qemu-kvm-init\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects kernel seeking activity through several built-in Linux utilities. Attackers may use these utilities\nto search the Linux kernel for a...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n(process.parent.args like \"/boot/*\" or process.args like \"/boot/*\") and (\n  (process.name == \"tail\" and (process.args like \"-c*\" or process.args == \"--bytes\")) or\n  (process.name == \"cmp\" and process.args == \"-i\") or\n  (process.name in (\"hexdump\", \"xxd\") and process.args == \"-s\") or\n  (process.name == \"dd\" and process.args like \"seek*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects kernel unpacking activity through several built-in Linux utilities. Attackers may use these utilities\nto unpack kernel images and mo...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n(process.parent.args like \"/boot/*\" or process.args like \"/boot/*\") and (\n  (process.name in (\"file\", \"unlzma\", \"gunzip\", \"unxz\", \"bunzip2\", \"unzstd\", \"unzip\", \"tar\")) or\n  (process.name == \"grep\" and process.args == \"ELF\") or\n  (process.name in (\"lzop\", \"lz4\") and process.args in (\"-d\", \"--decode\"))\n) and\nnot process.parent.name == \"mkinitramfs\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "The kubeconfig file is a critical component in Kubernetes environments, containing configuration\ndetails for accessing and managing Kubernetes cluster...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") or\n  (\n    process.parent.executable like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/root/*\", \"/home/*\") or\n    process.parent.name like (\".*\", \"*.sh\")\n  )\n) and\n(\n  (\n    process.working_directory like (\"/etc/kubernetes\", \"/root/.kube\", \"/home/*/.kube\") and\n    process.args in (\"kubeconfig\", \"admin.conf\", \"super-admin.conf\", \"kubelet.conf\", \"controller-manager.conf\", \"scheduler.conf\")\n  ) or\n  process.args like (\n    \"/etc/kubernetes/admin.conf\",\n    \"/etc/kubernetes/super-admin.conf\",\n    \"/etc/kubernetes/kubelet.conf\",\n    \"/etc/kubernetes/controller-manager.conf\",\n    \"/etc/kubernetes/scheduler.conf\",\n    \"/home/*/.kube/config\",\n    \"/root/.kube/config\",\n    \"/var/lib/*/kubeconfig\"\n  )\n) and not process.name in (\"stat\", \"md5sum\", \"dirname\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects the use of the \"kubectl auth --can-i\" command, which is used to check permissions in Kubernetes clusters.\nAttackers may use this com...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"kubectl\" and process.args == \"auth\" and process.args == \"can-i\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Hping ran on a Linux host. Hping is a FOSS command-line packet analyzer and has the ability to construct network packets\nfor a wide variety of network...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name in (\"hping\", \"hping2\", \"hping3\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Nping ran on a Linux host. Nping is part of the Nmap tool suite and has the ability to construct raw packets for a wide\nvariety of security testing ap...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name == \"nping\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects manual mount discovery via the /etc/exports or /etc/fstab file on Linux systems. These files are used\nby NFS (Network File System) t...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"cat\", \"grep\", \"tail\", \"less\", \"more\", \"egrep\", \"fgrep\") and process.command_line like (\"/etc/exports\", \"/etc/fstab\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule detects PAM version discovery activity on Linux systems. PAM version discovery can be an indication of an\nattacker attempting to backdoor th...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.parent.name != null and\n  (\n    (process.name in (\"dpkg\", \"dpkg-query\") and process.args == \"libpam-modules\") or\n    (process.name == \"rpm\" and process.args == \"pam\")\n  ) and\nnot process.parent.name in (\"dcservice\", \"inspectorssmplugin\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects Polkit version discovery activity on Linux systems. Polkit version discovery can be an indication of\nan attacker attempting to explo...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and (\n  (process.name == \"dnf\" and process.args == \"dnf\" and process.args == \"info\" and process.args == \"polkit\") or\n  (process.name == \"rpm\" and process.args == \"polkit\") or\n  (process.name == \"apt\" and process.args == \"show\" and process.args == \"policykit-1\") or\n  (process.name == \"pkaction\" and process.args == \"--version\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects private key searching activity on Linux systems. Searching for private keys can be an indication of an\nattacker attempting to escala...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.name == \"find\" and\n  process.command_line like (\"*id_dsa*\", \"*id_rsa*\", \"*id_ed*\", \"*id_ecdsa*\", \"*id_xmss*\", \"*id_dh*\") and\n  process.command_line like (\"*/home/*\", \"*/etc/ssh*\", \"*/root/*\", \"/\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Monitors for /proc/*/maps file reads. The /proc/*/maps file in Linux provides a memory map for a specific process,\ndetailing the memory segments, perm...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"cat\", \"grep\", \"tail\", \"less\", \"more\", \"egrep\", \"fgrep\") and process.args like \"/proc/*/maps\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies recursive process capability enumeration of the entire filesystem through the getcap command. Malicious users\nmay manipulate identified cap...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"ProcessRollup2\") and\n  process.name == \"getcap\" and process.args == \"-r\" and process.args == \"/\" and\n  process.args_count == 3 and user.id != \"0\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule leverages auditd to monitor for processes scanning different processes within the /proc directory using the\nopenat syscall. This is a strong...", "output": "sequence by process.pid, host.id with maxspan=5s\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"openat\" and file.path == \"/proc\" and\n   auditd.data.a0 : (\"ffffffffffffff9c\", \"ffffff9c\") and auditd.data.a2 : (\"80000\", \"88000\") and\n   not process.name in (\"agentbeat\", \"packetbeat\")\n  ] with runs=10\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects sensitive security file access via common utilities on Linux systems. Adversaries may attempt to read\nfrom sensitive files using com...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name in (\"cat\", \"grep\", \"less\", \"more\", \"strings\", \"awk\", \"find\", \"xargs\") and\n  process.args like (\n    \"/etc/security/*\", \"/etc/pam.d/*\", \"/etc/login.defs\", \"/lib/security/*\", \"/lib64/security/*\",\n    \"/usr/lib/security/*\", \"/usr/lib64/security/*\", \"/usr/lib/x86_64-linux-gnu/security/*\",\n    \"/home/*/.aws/credentials\", \"/home/*/.aws/config\", \"/home/*/.config/gcloud/*credentials.json\",\n    \"/home/*/.config/gcloud/configurations/config_default\", \"/home/*/.azure/accessTokens.json\",\n    \"/home/*/.azure/azureProfile.json\"\n  ) and \nnot process.parent.name in (\"wazuh-modulesd\", \"lynis\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for the usage of the sudo -l command, which is used to list the allowed and forbidden commands for\nthe invoking user. Attackers may...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.name == \"sudo\" and process.args == \"-l\" and\n  process.args_count == 2 and process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  not process.args == \"dpkg\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for the usage of the \"find\" command in conjunction with SUID and SGUID permission arguments. SUID\n(Set User ID) and SGID (Set Group...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"find\" and process.args : \"-perm\" and process.args : (\n  \"/6000\", \"-6000\", \"/4000\", \"-4000\", \"/2000\", \"-2000\", \"/u=s\", \"-u=s\", \"/g=s\", \"-g=s\", \"/u=s,g=s\", \"/g=s,u=s\"\n) and not (\n  user.Ext.real.id == \"0\" or group.Ext.real.id == \"0\" or process.args_count >= 12 or\n  (process.args : \"/usr/bin/pkexec\" and process.args : \"-xdev\" and process.args_count == 7)\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Monitors for grep activity related to memory mapping. The /proc/*/maps file in Linux provides a memory map for a\nspecific process, detailing the memor...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name in (\"grep\", \"egrep\", \"fgrep\", \"rgrep\") and process.args in (\"[stack]\", \"[vdso]\", \"[heap]\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects commonly abused network utilities running inside a container. Network utilities like nc, nmap, dig,\ntcpdump, ngrep, telnet, mitmprox...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\n  \"nc.traditional\", \"nc\", \"ncat\", \"netcat\", \"nmap\", \"dig\", \"nslookup\", \"tcpdump\", \"tshark\", \"ngrep\", \"telnet\",\n  \"mitmproxy\", \"socat\", \"zmap\", \"masscan\", \"zgrab\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for the usage of the which command with an unusual amount of process arguments. Attackers may\nleverage the which command to enumera...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\") and\n  process.name == \"which\" and process.args_count >= 10 and not (\n    process.parent.name == \"jem\" or\n    process.parent.executable like (\"/vz/root/*\", \"/var/lib/docker/*\") or\n    process.args == \"--tty-only\"\n  )\n\n/* potential tuning if rule would turn out to be noisy\nand process.args in (\"nmap\", \"nc\", \"ncat\", \"netcat\", nc.traditional\", \"gcc\", \"g++\", \"socat\") and\nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n*/\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors for a sequence of 20 \"id\" command executions within 1 second by the same parent process. This\nbehavior is unusual, and may be indic...", "output": "sequence by host.id, process.parent.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name == \"id\" and process.args_count == 2 and\n   not (\n     process.parent.name in (\"rpm\", \"snarftmp\", \"quota_copy\", \"java\") or\n     process.parent.args : \"/var/tmp/rpm-tmp*\"\n    )] with runs=20\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the execution of the `grep` command with the `plugins` argument on Linux systems. This command is used\nto search for YUM/DNF configu...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name == \"grep\" and process.args : \"plugins*\" and process.args : (\n    \"/etc/yum.conf\", \"/usr/lib/yum-plugins/*\", \"/etc/yum/pluginconf.d/*\",\n    \"/usr/lib/python*/site-packages/dnf-plugins/*\", \"/etc/dnf/plugins/*\", \"/etc/dnf/dnf.conf\"\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule detects when a container management binary is run from inside a container. These binaries are critical\ncomponents of many containerized envi...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.interactive == true and\nprocess.name in (\"dockerd\", \"docker\", \"kubelet\", \"kube-proxy\", \"kubectl\", \"containerd\", \"systemd\", \"crictl\") and\nnot process.parent.executable in (\"/sbin/init\", \"/usr/bin/dockerd\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-...", "output": "sequence by host.id with maxspan=10s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name == \"foomatic-rip\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.entity_id\n  [file where host.os.type == \"linux\" and event.type != \"deletion\" and\n   not (process.name == \"gs\" and file.path like \"/tmp/gs_*\")] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\") and user.name == \"lp\" and\n  process.parent.name in (\"cupsd\", \"foomatic-rip\", \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n    process.command_line like (\n      \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n      \"/bin/bash -e -c cat\"\n    ) or\n    process.args like \"gs*\"\n  )\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.parent.name == \"foomatic-rip\" and\n  process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n    process.command_line like (\n      \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n      \"/bin/bash -e -c cat\"\n    ) or\n    process.args like \"gs*\"\n  )\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.parent.name in (\"foomatic-rip\", \"cupsd\") and process.command_line like (\n  // persistence\n  \"*cron*\", \"*/etc/rc.local*\", \"*/dev/tcp/*\", \"*/etc/init.d*\", \"*/etc/update-motd.d*\", \"*/etc/sudoers*\",\n  \"*/etc/profile*\", \"*autostart*\", \"*/etc/ssh*\", \"*/home/*/.ssh/*\", \"*/root/.ssh*\", \"*~/.ssh/*\", \"*udev*\",\n  \"*/etc/shadow*\", \"*/etc/passwd*\",\n\n  // Downloads\n  \"*curl*\", \"*wget*\",\n\n  // encoding and decoding\n  \"*base64 *\", \"*base32 *\", \"*xxd *\", \"*openssl*\",\n\n  // reverse connections\n  \"*GS_ARGS=*\", \"*/dev/tcp*\", \"*/dev/udp/*\", \"*import*pty*spawn*\", \"*import*subprocess*call*\", \"*TCPSocket.new*\",\n  \"*TCPSocket.open*\", \"*io.popen*\", \"*os.execute*\", \"*fsockopen*\", \"*disown*\", \"*nohup*\",\n\n  // SO loads\n  \"*openssl*-engine*.so*\", \"*cdll.LoadLibrary*.so*\", \"*ruby*-e**Fiddle.dlopen*.so*\", \"*Fiddle.dlopen*.so*\",\n  \"*cdll.LoadLibrary*.so*\",\n\n  // misc. suspicious command lines\n   \"*/etc/ld.so*\", \"*/dev/shm/*\", \"*/var/tmp*\", \"*echo*\", \"*>>*\", \"*|*\"\n) and not process.args like \"gs*\"\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects potential exploitation of curl CVE-2023-38545 by monitoring for vulnerable command line arguments in conjunction\nwith an unusual command line ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"curl\"\nand (\n  process.args like (\"--socks5-hostname\", \"--proxy\", \"--preproxy\", \"socks5*\") or\n  process.env_vars like (\"http_proxy=socks5h://*\", \"HTTPS_PROXY=socks5h://*\", \"ALL_PROXY=socks5h://*\")\n) and length(process.command_line) > 255 and not (\n  process.parent.name in (\"cf-agent\", \"agent-run\", \"agent-check\", \"rudder\", \"agent-inventory\", \"cf-execd\") or\n  process.args like \"/opt/rudder/*\" or\n  process.parent.executable like (\"/vz/root/*\", \"/var/rudder/*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule identifies a sequence of events where a process named `entrypoint.sh` is started in a container, followed by a\nnetwork connection attempt. T...", "output": "sequence by host.id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.entry_leader.entry_meta.type == \"container\" and process.name == \"entrypoint.sh\"] by process.entity_id\n  [network where event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\", \"172.31.0.0/16\"\n       )\n    )] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for the creation of a file, followed by its execution and self-deletion in a short timespan within a\ndirectory often used for malic...", "output": "sequence by host.id, user.id with maxspan=1m\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   process.name in (\"curl\", \"wget\", \"fetch\", \"ftp\", \"sftp\", \"scp\", \"rsync\", \"ld\") and\n   file.path : (\"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\",\n     \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\")] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.parent.executable like (\n     \"/tmp/VeeamApp*\", \"/tmp/rajh/spack-stage/*\", \"plz-out/bin/vault/bridge/test/e2e/base/bridge-dev\",\n     \"/usr/bin/ranlib\", \"/usr/bin/ar\", \"plz-out/bin/vault/bridge/test/e2e/base/local-k8s\"\n   )] by process.name\n  [file where host.os.type == \"linux\" and event.action == \"deletion\" and\n   file.path : (\n     \"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\", \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\"\n    ) and not process.name in (\"rm\", \"ld\", \"conftest\", \"link\", \"gcc\", \"getarch\", \"ld\")] by file.name\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects when chmod or chown are used to add the execute permission to a file inside a container. Modifying file\npermissions to make a file e...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\"chmod\", \"chown\") and\nprocess.args in (\"4755\", \"755\", \"000\", \"777\", \"444\", \"-x\", \"+x\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: A netcat process is engaging in network activity on a Linux host. Netcat is often used as a persistence mechanism by\nexporting a reverse shell or by s...", "output": "sequence by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and\n      process.name:(\"nc\",\"ncat\",\"netcat\",\"netcat.openbsd\",\"netcat.traditional\") and (\n          /* bind shell to echo for command execution */\n          (process.args:(\"-l\",\"-p\") and process.args:(\"-c\",\"echo\",\"$*\"))\n          /* bind shell to specific port */\n          or process.args:(\"-l\",\"-p\",\"-lp\")\n          /* reverse shell to command-line interpreter used for command execution */\n          or (process.args:(\"-e\") and process.args:(\"/bin/bash\",\"/bin/sh\"))\n          /* file transfer via stdout */\n          or process.args:(\">\",\"<\")\n          /* file transfer via pipe */\n          or (process.args:(\"|\") and process.args:(\"nc\",\"ncat\"))\n      ) and\n      not process.command_line like~ (\"*127.0.0.1*\", \"*localhost*\")]\n  [network where host.os.type == \"linux\" and (process.name == \"nc\" or process.name == \"ncat\" or process.name == \"netcat\" or\n                  process.name == \"netcat.openbsd\" or process.name == \"netcat.traditional\")]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies when a non-interactive terminal (tty) is being upgraded to a fully interactive shell. Attackers may upgrade a\nsimple reverse shell to a ful...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name == \"stty\" and process.args == \"raw\" and process.args == \"-echo\" and process.args_count >= 3) or\n    (process.name == \"script\" and process.args in (\"-qc\", \"-c\") and process.args == \"/dev/null\" and\n    process.args_count == 4)\n  )\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the execution of the \"kubectl apply\" command with a URL argument. This command is often used to\napply configurations or deploy resou...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"kubectl\" and process.args == \"apply\" and process.args like \"http*\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for the execution of curl or wget commands that directly access Kubernetes API endpoints,\nwhich may indicate an attempt to interact...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\nprocess.name in (\"curl\", \"wget\") and process.args like~ (\n  \"*http*//*/apis/authorization.k8s.io/*\",\n  \"*http*//*/apis/rbac.authorization.k8s.io/*\",\n  \"*http*//*/api/v1/secrets*\",\n  \"*http*//*/api/v1/namespaces/*/secrets*\",\n  \"*http*//*/api/v1/configmaps*\",\n  \"*http*//*/api/v1/pods*\",\n  \"*http*//*/apis/apps/v1/deployments*\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Monitors for the execution of a netcat listener via rlwrap. rlwrap is a 'readline wrapper', a small utility that uses\nthe GNU Readline library to allo...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name == \"rlwrap\" and process.args in (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\", \"socat\") and\n  process.args : \"*l*\" and process.args_count >= 4\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Monitors for the execution of a unix binary with read, write and execute memory region permissions, followed by a\nnetwork connection. The mprotect() s...", "output": "sample by host.id, process.pid, process.name\n  /* auditd.data.a2 == \"7\" translates to RWX memory region protection (PROT_READ | PROT_WRITE | PROT_EXEC) */\n  [process where host.os.type == \"linux\" and auditd.data.syscall == \"mprotect\" and auditd.data.a2 == \"7\" and\n   not process.name == \"httpd\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and\n   not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors a sequence involving a program compilation event followed by its execution and a subsequent network\nconnection event. This behavior...", "output": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name in (\"gcc\", \"g++\", \"cc\")] by process.args\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and process.name == \"ld\"] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\"] by process.name\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and destination.ip != null and not (\n     cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\") or\n     process.name in (\"simpleX\", \"conftest\", \"ssh\", \"python\", \"ispnull\", \"pvtui\", \"npreal2d\", \"ruby\", \"source\", \"ssh\")\n   )] by process.name\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Monitors for the execution of different processes that might be used by attackers for malicious intent. An alert from\nthis rule should be investigated...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\nprocess.name in~ (\n  // exploitation frameworks\n  \"crackmapexec\", \"msfconsole\", \"msfvenom\", \"sliver-client\", \"sliver-server\", \"havoc\",\n  // network scanners (nmap left out to reduce noise)\n  \"zenmap\", \"nuclei\", \"netdiscover\", \"legion\",\n  // web enumeration\n  \"gobuster\", \"dirbuster\", \"dirb\", \"wfuzz\", \"ffuf\", \"whatweb\", \"eyewitness\",\n  // web vulnerability scanning\n  \"wpscan\", \"joomscan\", \"droopescan\", \"nikto\",\n  // exploitation tools\n  \"sqlmap\", \"commix\", \"yersinia\",\n  // cracking and brute forcing\n  \"john\", \"hashcat\", \"hydra\", \"ncrack\", \"cewl\", \"fcrackzip\", \"rainbowcrack\",\n  // host and network\n  \"linenum.sh\", \"linpeas.sh\", \"pspy32\", \"pspy32s\", \"pspy64\", \"pspy64s\", \"binwalk\", \"evil-winrm\",\n  \"linux-exploit-suggester-2.pl\", \"linux-exploit-suggester.sh\", \"panix.sh\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies a new process starting from a process ID (PID), lock or reboot file within the temporary file storage\nparadigm (tmpfs) directory /var/run d...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and user.id == \"0\" and\n  process.executable regex~ \"\"\"/var/run/\\w+\\.(pid|lock|reboot) \"\"\"", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of a binary by root in Linux shared memory directories: (/dev/shm/, /run/shm/, /var/run/,\n/var/lock/). This activity is to be...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nuser.id == \"0\" and process.executable : (\"/dev/shm/*\", \"/run/shm/*\", \"/var/run/*\", \"/var/lock/*\") and\nnot process.executable : (\"/var/run/docker/*\", \"/var/run/utsns/*\", \"/var/run/s6/*\", \"/var/run/cloudera-scm-agent/*\",\n\"/var/run/argo/argoexec\") and not process.parent.command_line : \"/usr/bin/runc init\"\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies when a terminal (tty) is spawned via Python. Attackers may upgrade a simple reverse shell to a fully\ninteractive tty after obtaining initia...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n(\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.parent.args_count >= 3 and process.parent.args : \"*pty.spawn*\" and process.parent.args : \"-c\") or\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.args : \"*sh\" and process.args_count == 1 and process.parent.args_count == 1)\n)\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule identifies when a web server is spawned via Python. Attackers may use Python to spawn a web server to\nexfiltrate/infiltrate data or to move ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name like \"python*\" and process.args in (\"http.server\", \"SimpleHTTPServer\")) or\n    (\n      process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n      process.command_line like~ \"*python* -m http.server*\"\n    )\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for suspicious activities that may indicate an attacker attempting to execute arbitrary code within a\nPostgreSQL environment. Attac...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"fork\", \"fork_event\") and user.name == \"postgres\" and (\n  (process.parent.args : \"*sh\" and process.parent.args : \"echo*\") or\n  (process.args : \"*sh\" and process.args : \"echo*\")\n) and not (\n  process.parent.name == \"puppet\" or\n  process.command_line like (\n    \"*BECOME-SUCCESS-*\", \"bash -c while true; do sleep 1;*\", \"df -l\", \"sleep 1\", \"who\", \"head -v -n *\", \"tail -v -n *\",\n    \"/bin/sh -c echo BECOME-SUCCESS*\", \"/usr/bin/python3 /var/tmp/ansible-tmp*\"\n  ) or\n  process.parent.command_line like \"*BECOME-SUCCESS-*\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the abuse of a Linux binary to break out of a restricted shell or environment by spawning an interactive\nsystem shell. The activity of spaw...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n(\n  /* launching shell from capsh */\n  (process.name == \"capsh\" and process.args == \"--\") or\n\n  /* launching shells from unusual parents or parent+arg combos */\n  (process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n    (process.parent.name : \"*awk\" and process.parent.args : \"BEGIN {system(*)}\") or\n    (process.parent.name == \"git\" and process.parent.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") or\n     process.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") and not process.name == \"ssh\" ) or\n    (process.parent.name : (\"byebug\", \"ftp\", \"strace\", \"zip\", \"tar\") and\n    (\n      process.parent.args : \"BEGIN {system(*)}\" or\n      (process.parent.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") or process.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\")) or\n      (\n        (process.parent.args : \"exec=*sh\" or (process.parent.args : \"-I\" and process.parent.args : \"*sh\")) or\n        (process.args : \"exec=*sh\" or (process.args : \"-I\" and process.args : \"*sh\"))\n        )\n      )\n    ) or\n\n    /* shells specified in parent args */\n    /* nice rule is broken in 8.2 */\n    (process.parent.args : \"*sh\" and\n      (\n        (process.parent.name == \"nice\") or\n        (process.parent.name == \"cpulimit\" and process.parent.args == \"-f\") or\n        (process.parent.name == \"find\" and process.parent.args == \".\" and process.parent.args == \"-exec\" and\n         process.parent.args == \";\" and process.parent.args : \"/bin/*sh\") or\n        (process.parent.name == \"flock\" and process.parent.args == \"-u\" and process.parent.args == \"/\")\n      )\n    )\n  )) or\n\n  /* shells specified in args */\n  (process.args : \"*sh\" and (\n    (process.parent.name == \"crash\" and process.parent.args == \"-h\") or\n    (process.name == \"sensible-pager\" and process.parent.name in (\"apt\", \"apt-get\") and process.parent.args == \"changelog\")\n    /* scope to include more sensible-pager invoked shells with different parent process to reduce noise and remove false positives */\n\n  )) or\n  (process.name == \"busybox\" and event.action == \"exec\" and process.args_count == 2 and process.args : \"*sh\" and not\n   process.executable : \"/var/lib/docker/overlay2/*/merged/bin/busybox\" and not (process.parent.args == \"init\" and\n   process.parent.args == \"runc\") and not process.parent.args in (\"ls-remote\", \"push\", \"fetch\") and not process.parent.name == \"mkinitramfs\") or\n  (process.name == \"env\" and process.args_count == 2 and process.args : \"*sh\") or\n  (process.parent.name in (\"vi\", \"vim\") and process.parent.args == \"-c\" and process.parent.args : \":!*sh\") or\n  (process.parent.name in (\"c89\", \"c99\", \"gcc\") and process.parent.args : \"*sh,-s\" and process.parent.args == \"-wrapper\") or\n  (process.parent.name == \"expect\" and process.parent.args == \"-c\" and process.parent.args : \"spawn *sh;interact\") or\n  (process.parent.name == \"mysql\" and process.parent.args == \"-e\" and process.parent.args : \"\\\\!*sh\") or\n  (process.parent.name == \"ssh\" and process.parent.args == \"-o\" and process.parent.args : \"ProxyCommand=;*sh 0<&2 1>&2\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule identifies when the openssl client or server is used to establish a connection. Attackers may use openssl to\nestablish a secure connection t...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n  process.name == \"openssl\" and (\n    (process.args == \"s_client\" and process.args : (\"-connect\", \"*:*\") and not process.args == \"-showcerts\") or\n    (process.args == \"s_server\" and process.args == \"-port\")\n  ) and\n  not process.parent.executable in (\n    \"/pro/xymon/client/ext/awsXymonCheck.sh\", \"/opt/antidot-svc/nrpe/plugins/check_cert\", \"/etc/zabbix/scripts/check_dane_tlsa.sh\"\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Monitors for the execution of background processes with process arguments capable of opening a socket in the /dev/tcp\nchannel. This may indicate the c...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name in (\"setsid\", \"nohup\") and process.args : \"*/dev/tcp/*0>&1*\" and\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This detection rule identifies suspicious network traffic patterns associated with TCP reverse shell activity. This\nactivity consists of a network eve...", "output": "sequence by host.id, process.entity_id with maxspan=5s\n  [network where event.type == \"start\" and host.os.type == \"linux\" and\n     event.action in (\"connection_attempted\", \"connection_accepted\") and\n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"socat\") and destination.ip != null and\n     not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]\n  [process where event.type == \"start\" and host.os.type == \"linux\" and event.action == \"exec\" and\n     process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n       (process.args : (\"-i\", \"-l\")) or (process.parent.name == \"socat\" and process.parent.args : \"*exec*\")\n   )]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This detection rule identifies the execution of a Linux shell process from a Java JAR application post an incoming\nnetwork connection. This behavior m...", "output": "sequence by host.id with maxspan=5s\n  [network where host.os.type == \"linux\" and event.action in (\"connection_accepted\", \"connection_attempted\") and\n   process.executable : (\"/usr/bin/java\", \"/bin/java\", \"/usr/lib/jvm/*\", \"/usr/java/*\") and\n   not (destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n    )\n  )] by process.entity_id\n  [process where host.os.type == \"linux\" and event.action == \"exec\" and\n   process.parent.executable : (\"/usr/bin/java\", \"/bin/java\", \"/usr/lib/jvm/*\", \"/usr/java/*\") and\n   process.parent.args : \"-jar\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n   and not process.parent.args in (\n     \"/usr/share/java/jenkins.war\", \"/etc/remote-iot/services/remoteiot.jar\",\n     \"/usr/lib64/NetExtender.jar\", \"/usr/lib/jenkins/jenkins.war\"\n   )] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This detection rule detects the creation of a shell through a suspicious process chain. Any reverse shells spawned by\nthe specified utilities that are...", "output": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"fork\") and (\n    (process.name : \"python*\" and process.args : \"-c\" and process.args : (\n     \"*import*pty*spawn*\", \"*import*subprocess*call*\"\n    )) or\n    (process.name : \"perl*\" and process.args : \"-e\" and process.args : \"*socket*\" and process.args : (\n     \"*exec*\", \"*system*\"\n    )) or\n    (process.name : \"ruby*\" and process.args : (\"-e\", \"-rsocket\") and process.args : (\n     \"*TCPSocket.new*\", \"*TCPSocket.open*\"\n     )) or\n    (process.name : \"lua*\" and process.args : \"-e\" and process.args : \"*socket.tcp*\" and process.args : (\n     \"*io.popen*\", \"*os.execute*\"\n    )) or\n    (process.name : \"php*\" and process.args : \"-r\" and process.args : \"*fsockopen*\" and process.args : \"*/bin/*sh*\") or\n    (process.name : (\"awk\", \"gawk\", \"mawk\", \"nawk\") and process.args : \"*/inet/tcp/*\") or\n    (process.name : \"openssl\" and process.args : \"-connect\") or\n    (process.name : (\"nc\", \"ncat\", \"netcat\") and process.args == \"-e\" and process.args_count >= 3 and\n     not process.args == \"-z\") or\n    (process.name : \"telnet\" and process.args_count >= 3)\n  ) and process.parent.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n    \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\")]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and\n    process.name : (\"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\") and\n    destination.ip != null and not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This detection rule identifies a sample of suspicious Linux system file reads used for system fingerprinting, leveraged\nby the Metasploit Meterpreter ...", "output": "sample by host.id, process.pid, user.id\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/etc/machine-id\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/etc/passwd\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/proc/net/route\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/proc/net/ipv6_route\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/proc/net/if_inet6\"]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This detection rule detects the creation of a shell through a chain consisting of the execution of a suspicious binary\n(located in a commonly abused l...", "output": "sequence by host.id, process.entity_id with maxspan=1s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.executable : (\n  \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n  \"/etc/crontab\", \"/etc/cron.*\", \"/etc/update-motd.d/*\", \"/usr/lib/update-notifier/*\",\n  \"/boot/*\", \"/srv/*\", \"/run/*\", \"/root/*\", \"/etc/rc.local\"\n   ) and\n  process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not\n  process.name : (\"curl\", \"wget\", \"ping\", \"apt\", \"dpkg\", \"yum\", \"rpm\", \"dnf\", \"dockerd\") ]\n[ network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and\n  process.executable : (\n  \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n  \"/etc/crontab\", \"/etc/cron.*\", \"/etc/update-motd.d/*\", \"/usr/lib/update-notifier/*\",\n  \"/boot/*\", \"/srv/*\", \"/run/*\", \"/root/*\", \"/etc/rc.local\"\n   ) and destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" ]\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") ]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This detection rule identifies suspicious network traffic patterns associated with TCP reverse shell activity. This\nactivity consists of a parent-chil...", "output": "sequence by host.id with maxspan=5s\n  [network where event.type == \"start\" and host.os.type == \"linux\" and\n     event.action in (\"connection_attempted\", \"connection_accepted\") and\n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"socat\") and destination.ip != null and\n     not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")] by process.entity_id\n  [process where event.type == \"start\" and host.os.type == \"linux\" and event.action in (\"exec\", \"fork\") and\n     process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n       (process.args : (\"-i\", \"-l\")) or (process.parent.name == \"socat\" and process.parent.args : \"*exec*\")\n   )] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This detection rule identifies suspicious network traffic patterns associated with UDP reverse shell activity. This\nactivity consists of a sample of a...", "output": "sample by host.id, process.pid, process.parent.pid\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"executed\" and process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    )]\n  [process where host.os.type == \"linux\" and auditd.data.syscall == \"socket\" and process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    ) and auditd.data.a1 == \"2\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connected-to\" and\n   process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    ) and network.direction == \"egress\" and destination.ip != null and\n   not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies when suspicious content is extracted from a file and subsequently decompressed using the funzip utility.\nMalware may execute the tail utili...", "output": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n((process.args == \"tail\" and process.args == \"-c\" and process.args == \"funzip\")) and\nnot process.args : \"/var/log/messages\" and\nnot process.parent.executable : (\"/usr/bin/dracut\", \"/sbin/dracut\", \"/usr/bin/xargs\") and\nnot (process.parent.name in (\"sh\", \"sudo\") and process.parent.command_line : \"*nessus_su*\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies service creation events of common mining services, possibly indicating the infection of a system with a\ncryptominer.\n", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and event.action : (\"creation\", \"file_create_event\") and\nfile.name : (\"aliyun.service\", \"moneroocean_miner.service\", \"c3pool_miner.service\", \"pnsd.service\", \"apache4.service\", \"pastebin.service\", \"xvf.service\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule identifies file permission modification events on files located in common system binary paths. Adversaries may attempt to\nhide their payload...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name in (\"chmod\", \"chown\") and\nprocess.args like~ (\n  \"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\",\n  \"/lib/*\", \"/usr/lib/*\", \"/lib64/*\", \"/usr/lib64/*\"\n) and\nprocess.args in (\"4755\", \"755\", \"000\", \"777\", \"444\", \"-x\", \"+x\") and not (\n  process.args in (\"/bin/chmod\", \"/usr/bin/chmod\", \"/usr/local/bin/chmod\") or\n  process.parent.executable like~ (\"/tmp/newroot/*\", \"/var/lib/dpkg/info/*\") or\n  process.parent.name in (\"udevadm\", \"systemd\", \"entrypoint\", \"sudo\", \"dart\") or\n  process.parent.command_line == \"runc init\" or\n  process.parent.args like \"/var/tmp/rpm-tmp.*\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detects when the tc (transmission control) binary is utilized to set a BPF (Berkeley Packet Filter) on a network\ninterface. Tc is used to configure Tr...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and process.executable == \"/usr/sbin/tc\" and\nprocess.args == \"filter\" and process.args == \"add\" and process.args == \"bpf\" and\nnot process.parent.executable == \"/usr/sbin/libvirtd\"\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for inter-process communication via Unix sockets. Adversaries may attempt to communicate with local\nUnix sockets to enumerate appli...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n (\n  (process.name in (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\") and\n   process.args == \"-U\" and process.args : (\"/usr/local/*\", \"/run/*\", \"/var/run/*\")) or\n  (process.name == \"socat\" and\n   process.args == \"-\" and process.args : (\"UNIX-CLIENT:/usr/local/*\", \"UNIX-CLIENT:/run/*\", \"UNIX-CLIENT:/var/run/*\")) or\n  (process.name == \"curl\" and process.args : (\"--unix-socket\", \"--abstract-unix-socket\"))\n) and\nnot (\n  process.args == \"/var/run/libvirt/libvirt-sock\" or\n  process.parent.name in (\"bundle\", \"ruby\", \"haproxystatus.sh\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects the use of curl to upload an archived file to an internet server. Threat actors often will collect data on a\nsystem and compress it in an arch...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"curl\" and\nprocess.parent.executable != null and (process.args in (\"-F\", \"-T\", \"-d\") or process.args like \"--data*\") and \nprocess.command_line like~ (\"*@/*.zip*\", \"*@/*.gz*\", \"*@/*.tgz*\", \"*b64=@*\", \"*=<*\") and\nprocess.command_line like~ \"*http*\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule looks for the usage of common data splitting utilities with specific arguments that indicate data splitting\nfor exfiltration on Linux system...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name == \"dd\" and process.args like \"bs=*\" and process.args like \"if=*\") or\n    (\n      process.name in (\"split\", \"rsplit\") and\n      (\n        (process.args == \"-b\" or process.args like \"--bytes*\") or\n        (process.args == \"-C\" or process.args like \"--line-bytes*\")\n      )\n    )\n  ) and\n  not (\n    process.parent.name in (\"apport\", \"overlayroot\", \"nessus-agent-module\") or\n    process.args like (\n      \"if=/tmp/nvim*\", \"if=/boot/*\", \"if=/dev/random\", \"if=/dev/urandom\", \"/dev/mapper/*\",\n      \"if=*.iso\", \"of=/dev/stdout\", \"if=/dev/zero\", \"if=/dev/sda\", \"/proc/sys/kernel/*\"\n    )\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies when the openssl command-line utility is used to encrypt multiple files on a host within a short time window.\nAdversaries may encrypt data ...", "output": "sequence by host.id, user.name, process.parent.entity_id with maxspan=5s\n  [ process where host.os.type == \"linux\" and event.action == \"exec\" and\n    process.name == \"openssl\" and process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl*\", \"php*\", \"python*\", \"xargs\") and\n    process.args == \"-in\" and process.args == \"-out\" and\n    process.args in (\"-k\", \"-K\", \"-kfile\", \"-pass\", \"-iv\", \"-md\") and\n    /* excluding base64 encoding options and including encryption password or key params */\n    not process.args in (\"-d\", \"-a\", \"-A\", \"-base64\", \"-none\", \"-nosalt\") ] with runs=10\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies instances where VMware processes, such as \"vmware-vmx\" or \"vmx,\" are terminated on a Linux system by a \"kill\"\ncommand. The rule monitors fo...", "output": "process where host.os.type == \"linux\" and event.type == \"end\" and process.name in (\"vmware-vmx\", \"vmx\")\nand process.parent.name == \"kill\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects memory swap modification events on Linux systems. Memory swap modification can be used to manipulate\nthe system's memory and potenti...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.parent.executable != null and\nprocess.name in (\"swapon\", \"swapoff\") or (\n  process.command_line like (\"*vm.swappiness*\", \"*/proc/sys/vm/swappiness*\") and (\n    (process.name == \"sysctl\" and process.args like (\"*-w*\", \"*--write*\", \"*=*\")) or\n    (\n      process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.args == \"-c\" and\n      process.command_line like \"*echo *\"\n    )\n  )\n) and\nnot process.parent.name in (\"lynis\", \"systemd\", \"end-zram-swapping\", \"SyxsenseResponder\", \"tuned\", \"platform-python\", \"timeout\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule identifies a sequence of a mass file encryption event in conjunction with the creation of a .txt file with a\nfile name containing ransomware...", "output": "sequence by process.entity_id, host.id with maxspan=1s\n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\"\n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\") and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\", \"rustup-init\", \"bun\"\n    )\n  ] with runs=25\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   file.name : (\"*restore*\", \"*lock*\", \"*recovery*\", \"*read*\", \"*instruction*\", \"*how_to*\", \"*ransom*\")\n  ]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: The kubeconfig file is a critical component in Kubernetes environments, containing configuration\ndetails for accessing and managing Kubernetes cluster...", "output": "file where host.os.type == \"linux\" and event.type != \"deletion\" and file.path like (\n  \"/root/.kube/config\",\n  \"/home/*/.kube/config\",\n  \"/etc/kubernetes/admin.conf\",\n  \"/etc/kubernetes/super-admin.conf\",\n  \"/etc/kubernetes/kubelet.conf\",\n  \"/etc/kubernetes/controller-manager.conf\",\n  \"/etc/kubernetes/scheduler.conf\",\n  \"/var/lib/*/kubeconfig\"\n) and not (\n  process.name in (\"kubeadm\", \"kubelet\", \"vcluster\", \"minikube\") or\n  (process.name == \"sed\" and file.Ext.original.name like \"sed*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the creation of a file in a world-writeable directory through a service that is\ncommonly used for file transfer. This behavior is of...", "output": "file where host.os.type == \"linux\" and event.action == \"creation\" and\nprocess.name in (\"scp\", \"sshd\", \"ssh\", \"ftp\", \"sftp\", \"vsftpd\", \"sftp-server\", \"rsync\") and\nfile.path like~ (\"/tmp*\", \"/var/tmp*\", \"/dev/shm/*\", \"/home/.*\") and user.id != \"0\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies processes that are capable of downloading files with command line arguments containing URLs to SSH-IT's\nautonomous SSH worm. This worm inte...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name in (\"curl\", \"wget\") and process.args : (\n  \"https://thc.org/ssh-it/x\", \"http://nossl.segfault.net/ssh-it-deploy.sh\", \"https://gsocket.io/x\",\n  \"https://thc.org/ssh-it/bs\", \"http://nossl.segfault.net/bs\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects an SSH or SSHD process executed from inside a container. This includes both the client ssh binary and\nserver ssh daemon process. SSH...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\"sshd\", \"ssh\", \"autossh\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects suspicious process events executed by the APT package manager, potentially indicating persistence through an APT\nbackdoor. In Linux, APT (Adva...", "output": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name == \"apt\" and process.args == \"-c\" and process.name in (\n     \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"\n   ) and not process.executable == \"/usr/lib/venv-salt-minion/bin/python.original\"\n  ] by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and process.name : (\n     \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\",\n     \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\"\n   )\n  ] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detects file creation events in the configuration directory for the APT package manager. In Linux, APT (Advanced Package\nTool) is a command-line utili...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : \"/etc/apt/apt.conf.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/local/bin/apt-get\", \"/usr/bin/apt-get\"\n  ) or\n  file.path :(\"/etc/apt/apt.conf.d/*.tmp*\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"pveupdate\", \"perl\", \"executor\", \"crio\", \"docker-init\", \"dockerd\", \"pvedaemon\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects suspicious network events executed by the APT package manager, potentially indicating persistence through an APT\nbackdoor. In Linux, APT (Adva...", "output": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"apt\" and process.args == \"-c\" and process.name in (\n     \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"\n    )\n  ] by process.entity_id\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\", \"172.31.0.0/16\"\n     )\n   ) and not process.executable == \"/usr/bin/apt-listbugs\"\n  ] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for at jobs being created or renamed. Linux at jobs are scheduled tasks that can be leveraged by\nsystem administrators to set up sc...", "output": "file where host.os.type == \"linux\" and\nevent.action in (\"rename\", \"creation\") and file.path : \"/var/spool/cron/atjobs/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the process of copying or moving files from or to the `/boot` directory on Linux systems. The `/boot`\ndirectory contains files that ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and\nprocess.name in (\"cp\", \"mv\") and process.parent.executable != null and process.args like~ \"/boot/*\" and not (\n  process.parent.name in (\"update-initramfs\", \"dracut\", \"grub-mkconfig\", \"shim-install\", \"sudo\", \"activate-theme\", \"update-grub-gfxpayload\", \"grub-pc.postinst\") or\n  process.parent.executable like~ (\"/usr/lib/kernel/install.d/*\", \"/tmp/newroot/*\", \"/var/lib/dpkg/info/*\") or\n  process.parent.args like~ (\"/usr/bin/mkinitcpio\", \"/var/tmp/rpm-tmp.*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects the use of the chkconfig binary to manually add a service for management by chkconfig. Threat actors may utilize\nthis technique to maintain pe...", "output": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n( \n  (process.executable : \"/usr/sbin/chkconfig\" and process.args : \"--add\") or\n  (process.args : \"*chkconfig\" and process.args : \"--add\")\n) and not (\n  process.parent.name in (\"rpm\", \"qualys-scan-util\", \"qualys-cloud-agent\", \"update-alternatives\") or\n  process.parent.args : (\"/var/tmp/rpm*\", \"/var/lib/waagent/*\") or\n  process.args in (\"jexec\", \"sapinit\", \"httpd\", \"dbora\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for (ana)cron jobs being created or renamed. Linux cron jobs are scheduled tasks that can be\nleveraged by system administrators to ...", "output": "file where host.os.type == \"linux\" and\nevent.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/cron.d/*\", \"/etc/cron.hourly/*\", \"/etc/cron.daily/*\", \"/etc/cron.weekly/*\",\n  \"/etc/cron.monthly/*\", \"/etc/crontab\", \"/var/spool/cron/crontabs/*\", \"/var/spool/anacron/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\", \"/opt/elasticbeanstalk/bin/platform-engine\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/opt/imunify360/venv/bin/python3\",\n    \"/opt/eset/efs/lib/utild\", \"/usr/sbin/anacron\", \"/usr/bin/podman\", \"/kaniko/kaniko-executor\",\n    \"/usr/bin/pvedaemon\", \"./usr/bin/podman\", \"/usr/lib/systemd/systemd\"\n  ) or\n  file.path like (\"/var/spool/cron/crontabs/tmp.*\", \"/etc/cron.d/jumpcloud-updater\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/libexec/platform-python*\",\n    \"/var/lib/waagent/Microsoft*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"crond\", \"executor\", \"puppet\", \"droplet-agent.postinst\", \"cf-agent\", \"schedd\", \"imunify-notifier\", \"perl\",\n    \"jumpcloud-agent\", \"crio\", \"dnf_install\", \"utild\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")  or\n  (process.name in (\"vi\", \"vim\") and file.name like \"*~\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the creation of D-Bus service files on Linux systems. D-Bus is a message bus system that provides a\nway for applications to talk to ...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.extension in (\"service\", \"conf\") and file.path like~ (\n  \"/usr/share/dbus-1/system-services/*\", \"/etc/dbus-1/system.d/*\",\n  \"/lib/dbus-1/system-services/*\", \"/run/dbus/system.d/*\",\n  \"/home/*/.local/share/dbus-1/services/*\", \"/home/*/.dbus/session-bus/*\",\n  \"/usr/share/dbus-1/services/*\", \"/etc/dbus-1/session.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\"\n  ) or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.name like (\n    \"ssm-agent-worker\", \"platform-python*\", \"dnf_install\", \"cloudflared\", \"lxc-pve-prestart-hook\",\n    \"convert-usrmerge\", \"elastic-agent\", \"google_metadata_script_runner\", \"update-alternatives\", \"gitlab-runner\",\n    \"install\", \"crio\", \"apt-get\", \"package-cleanup\", \"dcservice\", \"dcregister\", \"jumpcloud-agent\", \"executor\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects when an unusual child process is spawned from the `dbus-daemon` parent process. The `dbus-daemon`\nprocess is a message bus system th...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.parent.name == \"dbus-daemon\" and process.args_count > 1 and not (\n  process.parent.args == \"--session\" or\n  process.args in (\"/usr/lib/software-properties/software-properties-dbus\", \"/usr/share/backintime/qt/serviceHelper.py\") or\n  process.name in (\"dbus-daemon-launch-helper\", \"gnome-keyring-daemon\", \"abrt-dbus\", \"aptd\", \"usb-creator-helper\") or\n  process.executable like~ (\"/usr/lib/*\", \"/usr/local/lib/*\", \"/usr/libexec/*\", \"/tmp/newroot/*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects file creation events in the plugin directories for the Yum package manager. In Linux, DNF (Dandified YUM) is a\ncommand-line utility used for h...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : (\"/usr/lib/python*/site-packages/dnf-plugins/*\", \"/etc/dnf/plugins/*\") and not (\n  process.executable in (\n    \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\", \"/usr/bin/microdnf\", \"/bin/rpm\",\n    \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\", \"/bin/puppet\",\n    \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/bin/autossl_check\",\n    \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\",\n    \"/usr/libexec/netplan/generate\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\") or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") or\n  file.path like~ \"/etc/dnf/plugins/.ansible_tmp*\" or\n  process.name like~ (\"ssm-agent-worker, NinjaOrbit\", \"python*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the execution of the DPKG command by processes not associated with the DPKG package manager. The DPKG\ncommand is used to install, re...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.executable : \"/var/lib/dpkg/info/*\" and process.session_leader.name != null and\nprocess.group_leader.name != null and not (\n  process.parent.name in (\"dpkg\", \"dpkg-reconfigure\", \"frontend\") or\n  process.session_leader.name == \"dpkg\" or\n  process.group_leader.name == \"dpkg\" or\n  process.parent.executable in (\"/usr/share/debconf/frontend\", \"/usr/bin/unattended-upgrade\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule detects the creation of Dracut module files on Linux systems. Dracut is a tool used to generate an initramfs\nimage that is used to boot the ...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.path like~ (\"/lib/dracut/modules.d/*\", \"/usr/lib/dracut/modules.d/*\") and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\n  process.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the copying of the Linux dynamic loader binary and subsequent file creation for the purpose of creating a backup\ncopy. This technique was seen...", "output": "sequence by process.entity_id with maxspan=1m\n[process where host.os.type == \"linux\" and event.type == \"start\" and process.name in (\"cp\", \"rsync\") and\n   process.args in (\n     \"/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/etc/ld.so.preload\", \"/lib64/ld-linux-x86-64.so.2\",\n     \"/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/usr/lib64/ld-linux-x86-64.so.2\"\n    )]\n[file where host.os.type == \"linux\" and event.action == \"creation\" and file.extension == \"so\"]\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the extraction of an initramfs image using the \"cpio\" command on Linux systems. The \"cpio\" command is\nused to create or extract cpio...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and\nprocess.name == \"cpio\" and process.args in (\"-H\", \"--format\") and process.args == \"newc\" and\nnot (\n  process.parent.name in (\"mkinitramfs\", \"dracut\") or\n  ?process.parent.executable like~ (\"/usr/share/initramfs-tools/*\", \"/nix/store/*\") or\n  ?process.parent.args in (\n    \"/bin/dracut\", \"/usr/share/initramfs-tools/hooks/amd64_microcode\", \"/usr/bin/dracut\", \"/usr/sbin/mkinitramfs\",\n    \"/usr/sbin/dracut\", \"/usr/bin/update-microcode-initrd\"\n  ) or\n  process.args like (\"/var/tmp/mkinitramfs_*\", \"/tmp/tmp.*/mkinitramfs_*\") or\n  ?process.working_directory like (\n    \"/var/tmp/mkinitramfs-*\", \"/tmp/microcode-initrd_*\", \"/var/tmp/mkinitramfs-*\", \"/var/tmp/dracut.*\",\n    \"/var/tmp/mkinitramfs_*\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the execution of a potentially malicious process from a Git hook. Git hooks are scripts that Git\nexecutes before or after events suc...", "output": "sequence by host.id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name == \"git\" and process.args : \".git/hooks/*\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n  ] by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects the creation or modification of a Git hook file on a Linux system. Git hooks are scripts that Git\nexecutes before or after events su...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.path : \"*.git/hooks/*\" and\nfile.extension == null and process.executable != null and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/usr/bin/pamac-daemon\", \"/bin/pamac-daemon\",\n    \"/usr/local/bin/dockerd\", \"/sbin/dockerd\"\n  ) or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.name in (\"git\", \"dirname\", \"tar\", \"gitea\", \"git-lfs\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects a suspicious egress network connection attempt from a Git hook script. Git hooks are scripts that Git\nexecutes before or after event...", "output": "sequence by host.id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"git\" and process.args : \".git/hooks/*\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\", \"172.31.0.0/16\"\n     )\n   )\n  ] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects child processes spawned by Git hooks. Git hooks are scripts that Git executes before or after events\nsuch as commit, push, and recei...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.parent.name in (\n    \"applypatch-msg\", \"commit-msg\", \"fsmonitor-watchman\", \"post-update\", \"post-checkout\", \"post-commit\",\n    \"pre-applypatch\", \"pre-commit\", \"pre-merge-commit\", \"prepare-commit-msg\", \"pre-push\", \"pre-rebase\", \"pre-receive\",\n    \"push-to-checkout\", \"update\", \"post-receive\", \"pre-auto-gc\", \"post-rewrite\", \"sendemail-validate\", \"p4-pre-submit\",\n    \"post-index-change\", \"post-merge\", \"post-applypatch\"\n  ) and\n  (\n    process.name in (\"nohup\", \"setsid\", \"disown\", \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") or\n    process.name : (\"php*\", \"perl*\", \"ruby*\", \"lua*\") or\n    process.executable : (\n      \"/boot/*\", \"/dev/shm/*\", \"/etc/cron.*/*\", \"/etc/init.d/*\", \"/etc/update-motd.d/*\",\n      \"/run/*\", \"/srv/*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/log/*\"\n    )\n  ) and\n  not process.name in (\"git\", \"dirname\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the creation of GRUB configuration files on Linux systems. The GRUB configuration file is used to\nconfigure the boot loader, which i...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and file.path like~ (\n  \"/etc/default/grub.d/*\", \"/etc/default/grub\", \"/etc/grub.d/*\",\n  \"/boot/grub2/grub.cfg\", \"/boot/grub/grub.cfg\", \"/boot/efi/EFI/*/grub.cfg\",\n  \"/etc/sysconfig/grub\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\n  process.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the generation of a new GRUB configuration file using built-in Linux commands. The GRUB configuration\nfile is used to configure the ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.parent.executable != null and process.name in (\"grub-mkconfig\", \"grub2-mkconfig\", \"update-grub\") and not (\n  process.parent.name in (\"run-parts\", \"sudo\", \"update-grub\", \"pacman\", \"dockerd\", \"dnf\", \"rpm\", \"yum\") or\n  process.parent.executable like~ (\n    \"/var/lib/dpkg/info/*\", \"/usr/lib/bootloader/grub2-efi/config\", \"/tmp/newroot/*\", \"/usr/lib/kernel/install.d/*\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Files that are placed in the /etc/init.d/ directory in Unix can be used to start custom applications, services, scripts\nor commands during start-up. I...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\", \"rename\", \"file_rename_event\")\nand file.path : \"/etc/init.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\", \"dpkg-new\") or\n  file.path like (\"/etc/init.d/*beat*\", \"/etc/init.d/elastic-agent*\") or\n  process.executable like (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\", \"/opt/puppetlabs/puppet/bin/ruby\") or\n  process.name in (\"docker-init\", \"jumpcloud-agent\", \"crio\") or\n  process.executable == null or\n  process.name in (\"executor\", \"univention-config-registry\", \"install\", \"dockerd-entrypoint.sh\", \"platform-python*\", \"ssm-agent-worker\") or\n  (process.name == \"ln\" and file.path : \"/etc/init.d/rc*.d/*\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the use of the insmod binary to load a Linux kernel object file. Threat actors can use this binary, given they\nhave root privileges, to load a...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and process.name == \"insmod\" and process.args : \"*.ko\" and\nnot process.parent.executable like (\n  \"/opt/ds_agent/*\", \"/usr/sbin/veeamsnap-loader\", \"/opt/TrendMicro/vls_agent/*\", \"/opt/intel/oneapi/*\",\n  \"/opt/commvault/Base/linux_drv\", \"/bin/falcoctl\"\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation or modification of a K Desktop Environment (KDE) AutoStart script or desktop file that will\nexecute upon each user logon. Adve...", "output": "file where host.os.type == \"linux\" and event.type != \"deletion\" and\n  file.extension in (\"sh\", \"desktop\") and\n  file.path :\n    (\n      \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\",\n      \"/home/*/.kde/Autostart/*\", \"/root/.kde/Autostart/*\",\n      \"/home/*/.kde4/Autostart/*\", \"/root/.kde4/Autostart/*\",\n      \"/home/*/.kde/share/autostart/*\", \"/root/.kde/share/autostart/*\",\n      \"/home/*/.kde4/share/autostart/*\", \"/root/.kde4/share/autostart/*\",\n      \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\",\n      \"/home/*/.config/autostart-scripts/*\", \"/root/.config/autostart-scripts/*\",\n      \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\"\n    ) and\n    not process.name in (\n      \"yum\", \"dpkg\", \"install\", \"dnf\", \"teams\", \"yum-cron\", \"dnf-automatic\", \"docker\", \"dockerd\", \"rpm\", \"pacman\",\n      \"podman\", \"nautilus\", \"remmina\", \"cinnamon-settings.py\", \"executor\", \"xfce4-clipman\", \"jetbrains-toolbox\",\n      \"ansible-admin\", \"apk\"\n    )\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detects the loading of a Linux kernel module through system calls. Threat actors may leverage Linux kernel modules to\nload a rootkit on a system provi...", "output": "driver where host.os.type == \"linux\" and event.action == \"loaded-kernel-module\" and\nauditd.data.syscall in (\"init_module\", \"finit_module\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects the loading of a Linux kernel module by a non-root user through system calls. Threat actors may leverage Linux\nkernel modules to load a rootki...", "output": "driver where host.os.type == \"linux\" and event.action == \"loaded-kernel-module\" and\nauditd.data.syscall in (\"init_module\", \"finit_module\") and user.id != \"0\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects the creation or modification of sensitive Kubernetes configuration files on Linux systems. These files\ninclude Kubernetes manifests,...", "output": "file where host.os.type == \"linux\" and event.type != \"deletion\" and file.path like (\n  \"/etc/kubernetes/manifests/*\",\n  \"/etc/kubernetes/pki/*\",\n  \"/etc/kubernetes/*.conf\"\n) and not process.name in (\"kubeadm\", \"kubelet\", \"dpkg\", \"sed\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for a file creation event originating from a kworker parent process. kworker, or kernel worker,\nprocesses are part of the kernel's ...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\") and\n  process.name : \"kworker*\" and not (\n    (process.name : \"kworker*kcryptd*\") or\n    (file.path : (\n      \"/var/log/*\", \"/var/crash/*\", \"/var/run/*\", \"/var/lib/systemd/coredump/*\", \"/var/spool/*\",\n      \"/var/lib/nfs/nfsdcltrack/main.sqlite-journal\", \"/proc/*/cwd/core.*\", \"/var/run/apport.lock\",\n      \"/var/spool/abrt/ccpp-*\", \"/var/lib/dynatrace/oneagent/*\", \"/var/lib/nfs*\", \"/run/user/*/.bubblewrap/*\",\n      \"/etc/localtime/*\", \"/proc/*/cwd/core.*\"\n      )\n    )\n  )\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the attempt to create a new backdoor user by setting the user's UID to 0. Attackers may alter a user's UID to\n0 to establish persistence on...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"usermod\" and process.args : \"-u\" and process.args : \"0\" and process.args : \"-o\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to create a new group. Attackers may create new groups to establish persistence on a system.\n", "output": "iam where host.os.type == \"linux\" and (event.type == \"group\" and event.type == \"creation\") and\nprocess.name in (\"groupadd\", \"addgroup\") and group.name != null\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access.\nAttackers may exploit a vulnerabi...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\") and process.parent.executable : (\n  \"/usr/sbin/nginx\", \"/usr/local/sbin/nginx\",\n  \"/usr/sbin/apache\", \"/usr/local/sbin/apache\",\n  \"/usr/sbin/apache2\", \"/usr/local/sbin/apache2\",\n  \"/usr/sbin/php*\", \"/usr/local/sbin/php*\",\n  \"/usr/sbin/lighttpd\", \"/usr/local/sbin/lighttpd\",\n  \"/usr/sbin/hiawatha\", \"/usr/local/sbin/hiawatha\",\n  \"/usr/local/bin/caddy\", \n  \"/usr/local/lsws/bin/lswsctrl\",\n  \"*/bin/catalina.sh\"\n) and\nprocess.name : (\n  \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\",\n  \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and process.args : (\n  \"whoami\", \"id\", \"uname\", \"cat\", \"hostname\", \"ip\", \"curl\", \"wget\", \"pwd\", \"ls\", \"cd\", \"python*\", \"php*\", \"perl\",\n  \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and not process.name == \"phpquery\"\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to create new users. Attackers may add new users to establish persistence on a system.\n", "output": "iam where host.os.type == \"linux\" and (event.type == \"user\" and event.type == \"creation\") and\nprocess.name in (\"useradd\", \"adduser\") and user.name != null\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies attempts to add a user to a privileged group. Attackers may add users to a privileged group in order to\nestablish persistence on a system.\n", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.args in (\n    \"root\", \"admin\", \"wheel\", \"staff\", \"sudo\",\"disk\", \"video\", \"shadow\", \"lxc\", \"lxd\"\n  ) and\n  (\n    process.name in (\"usermod\", \"adduser\") or\n    (process.name == \"gpasswd\" and process.args in (\"-a\", \"--add\", \"-M\", \"--members\"))\n  )\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the creation of Loadable Kernel Module (LKM) configuration files. Attackers may create or modify these\nfiles to allow their LKMs to ...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and process.executable != null and\nfile.path like (\n  \"/etc/modules\", \"/etc/modprobe.d/*\", \"/run/modprobe.d/*\", \"/usr/local/lib/modprobe.d/*\", \"/usr/lib/modprobe.d/*\",\n  \"/lib/modprobe.d/*\", \"/etc/modules-load.d/*\", \"/run/modules-load.d/*\", \"/usr/local/lib/modules-load.d/*\",\n  \"/usr/lib/modules-load.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\", \"/opt/elasticbeanstalk/bin/platform-engine\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/opt/imunify360/venv/bin/python3\",\n    \"/opt/eset/efs/lib/utild\", \"/usr/sbin/anacron\", \"/usr/bin/podman\", \"/kaniko/kaniko-executor\", \"/usr/bin/prime-select\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable like (\n    \"/nix/store/*\", \"/var/lib/dpkg/info/kmod.postinst\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\",\n    \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"crond\", \"executor\", \"puppet\", \"droplet-agent.postinst\", \"cf-agent\", \"schedd\", \"imunify-notifier\", \"perl\",\n    \"jumpcloud-agent\", \"crio\", \"dnf_install\", \"utild\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects manual execution of the `dracut` command on Linux systems. Dracut is a tool used to generate an\ninitramfs image that is used to boot...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"dracut\" and process.parent.executable != null and not (\n  process.parent.executable like~ (\n    \"/usr/lib/kernel/*\", \"/etc/kernel/install.d/*\", \"/var/lib/dpkg/info/dracut.postinst\",\n    \"/tmp/newroot/*\", \"/usr/lib/module-init-tools/*\"\n  ) or\n  process.parent.name in (\n    \"dracut-install\", \"dracut\", \"run-parts\", \"weak-modules\", \"mkdumprd\", \"new-kernel-pkg\", \"sudo\"\n  ) or\n  process.parent.args like~ (\"/usr/bin/dracut-rebuild\", \"/var/tmp/rpm-tmp.*\") or\n  process.parent.command_line like~ \"/bin/sh -c if command -v mkinitcpio*\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the creation of potentially malicious files within the default MOTD file directories. Message of the\nday (MOTD) is the message that ...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : \"/etc/update-motd.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"executor\", \"dockerd\", \"crio\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Message of the day (MOTD) is the message that is presented to the user when a user connects to a Linux server via SSH or\na serial connection. Linux sy...", "output": "process where event.type == \"start\" and host.os.type == \"linux\" and event.action : (\"exec\", \"exec_event\", \"start\") and\n  process.parent.executable : \"/etc/update-motd.d/*\" and\n  (\n    (\n      process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n      (\n        process.args : (\"-i\", \"-l\") or\n        (process.parent.name == \"socat\" and process.parent.args : \"*exec*\")\n      )\n    ) or\n    (\n      process.name : (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\") and process.args_count >= 3 and \n      not process.args : (\"-*z*\", \"-*l*\")\n    ) or\n    (\n      process.name : \"python*\" and process.args : \"-c\" and process.args : (\n        \"*import*pty*spawn*\", \"*import*subprocess*call*\"\n      )\n    ) or\n    (\n      process.name : \"perl*\" and process.args : \"-e\" and process.args : \"*socket*\" and process.args : (\n        \"*exec*\", \"*system*\"\n      )\n    ) or\n    (\n      process.name : \"ruby*\" and process.args : (\"-e\", \"-rsocket\") and process.args : (\n        \"*TCPSocket.new*\", \"*TCPSocket.open*\"\n      )\n    ) or\n    (\n      process.name : \"lua*\" and process.args : \"-e\" and process.args : \"*socket.tcp*\" and process.args : (\n        \"*io.popen*\", \"*os.execute*\"\n      )\n    ) or\n    (process.name : \"php*\" and process.args : \"-r\" and process.args : \"*fsockopen*\" and process.args : \"*/bin/*sh*\") or \n    (process.name : (\"awk\", \"gawk\", \"mawk\", \"nawk\") and process.args : \"*/inet/tcp/*\") or \n    (process.name in (\"openssl\", \"telnet\")) or\n    (\n      process.args : (\n        \"./*\", \"/boot/*\", \"/dev/shm/*\", \"/etc/cron.*/*\", \"/etc/init.d/*\", \"/etc/update-motd.d/*\", \"/run/*\", \"/srv/*\",\n        \"/tmp/*\", \"/var/tmp/*\", \"/var/log/*\", \"/opt/*\"\n      ) and process.args_count == 1\n    )\n  ) and \n  not (\n    process.parent.args == \"--force\" or\n    process.args in (\"/usr/games/lolcat\", \"/usr/bin/screenfetch\") or\n    process.parent.name == \"system-crash-notification\"\n  )\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the creation of a NetworkManager dispatcher script on a Linux system. NetworkManager dispatcher\nscripts are shell scripts that Netwo...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.path like~ \"/etc/NetworkManager/dispatcher.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\n  process.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule detects the execution of Node.js pre or post-install scripts. These scripts are executed\nby the Node.js package manager (npm) during the ins...", "output": "sequence by host.id with maxspan=10s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"node\" and process.args == \"install\"] by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name == \"node\"] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the usage of the `openssl` binary to generate password hashes on Linux systems. The `openssl` command\nis a cryptographic utility tha...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and process.name == \"openssl\"\nand process.args == \"passwd\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for the creation or modification of Pluggable Authentication Module (PAM) shared object files or\nconfiguration files. Attackers may...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nprocess.executable != null and (\n  (file.path like~ (\n    \"/lib/security/*\", \"/lib64/security/*\", \"/usr/lib/security/*\", \"/usr/lib64/security/*\",\n    \"/lib/x86_64-linux-gnu/security/*\", \"/usr/lib/x86_64-linux-gnu/security/*\"\n  ) and file.extension == \"so\") or\n  (file.path like~ \"/etc/pam.d/*\" and file.extension == null) or\n  (file.path like~ \"/etc/security/pam_*\" or file.path == \"/etc/pam.conf\")\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/sbin/pam-auth-update\",\n    \"/usr/lib/systemd/systemd\", \"/usr/libexec/packagekitd\", \"/usr/bin/bsdtar\", \"/sbin/pam-auth-update\"\n  ) or\n  file.path like (\n    \"/tmp/snap.rootfs_*/pam_*.so\", \"/tmp/newroot/lib/*/pam_*.so\", \"/tmp/newroot/usr/lib64/security/pam_*.so\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable like (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  (process.name == \"sed\" and file.name like~ \"sed*\") or\n  (process.name == \"perl\" and file.name like~ \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the creation of Pluggable Authentication Module (PAM) shared object files in unusual directories.\nAttackers may compile PAM shared o...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.name like \"pam_*.so\" and not file.path like (\n  \"/lib/security/*\",\n  \"/lib64/security/*\",\n  \"/lib/x86_64-linux-gnu/security/*\",\n  \"/usr/lib/security/*\",\n  \"/usr/lib64/security/*\",\n  \"/usr/lib/x86_64-linux-gnu/security/*\"\n) and not (\n  process.name in (\"dockerd\", \"containerd\", \"steam\", \"buildkitd\", \"unsquashfs\", \"pacman\") or\n  file.path like (\n    \"/build/rootImage/nix/store/*\", \"/home/*/.local/share/containers/*\", \"/nix/store/*\", \"/var/lib/containerd/*\",\n    \"/var/snap/*\", \"/usr/share/nix/nix/store/*\", \"/tmp/cura/squashfs-root/*\", \"/home/*/docker/*\", \"/tmp/containerd*\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects SSH session ID change followed by a suspicious SSHD child process, this may\nindicate the successful execution of a potentially malic...", "output": "sequence by process.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"session_id_change\" and process.name in (\"ssh\", \"sshd\")]\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name in (\"ssh\", \"sshd\") and\n   process.args_count == 2 and (\n     process.name like (\"perl*\", \"python*\", \"php*\", \"ruby*\", \"lua*\") or\n     process.executable like (\n       \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"./*\", \"/boot/*\", \"/sys/*\", \"/lost+found/*\", \"/media/*\", \"/proc/*\",\n       \"/var/backups/*\", \"/var/log/*\", \"/var/mail/*\", \"/var/spool/*\") or\n     process.name like \".*\"\n   )]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the usage of `curl` or `wget` to download the source code of a Pluggable Authentication Module (PAM)\nshared object file. Attackers m...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name in (\"curl\", \"wget\") and\nprocess.args like~ \"https://github.com/linux-pam/linux-pam/releases/download/v*/Linux-PAM-*.tar.xz\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for the creation of Polkit policy files on Linux systems. Polkit policy files are used to define the\npermissions for system-wide se...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.extension in (\"rules\", \"pkla\", \"policy\") and file.path like~ (\n\n  // Rule files\n  \"/etc/polkit-1/rules.d/*\", \"/usr/share/polkit-1/rules.d/*\",\n\n  // pkla files\n  \"/etc/polkit-1/localauthority/*\", \"/var/lib/polkit-1/localauthority/*\",\n\n  // Action files\n  \"/usr/share/polkit-1/actions/*\",\n\n  // Misc. legacy paths\n  \"/lib/polkit-1/rules.d/*\", \"/lib64/polkit-1/rules.d/*\", \"/var/lib/polkit-1/rules.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\nprocess.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors for the addition of an executable bit for scripts that are located in directories which are commonly\nabused for persistence. An ale...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.args : (\n  // Misc.\n  \"/etc/rc.local\", \"/etc/rc.common\", \"/etc/rc.d/rc.local\", \"/etc/init.d/*\", \"/etc/update-motd.d/*\",\n  \"/etc/apt/apt.conf.d/*\", \"/etc/cron*\", \"/etc/init/*\", \"/etc/NetworkManager/dispatcher.d/*\",\n  \"/lib/dracut/modules.d/*\", \"/usr/lib/dracut/modules.d/*\",\n\n  // XDG\n  \"/etc/xdg/autostart/*\", \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\",\n  \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\", \"/home/*/.config/autostart-scripts/*\",\n  \"/root/.config/autostart-scripts/*\", \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\",\n\n  // udev\n  \"/lib/udev/*\", \"/etc/udev/rules.d/*\", \"/usr/lib/udev/rules.d/*\", \"/run/udev/rules.d/*\"\n\n) and (\n  (process.name == \"chmod\" and process.args : (\"+x*\", \"1*\", \"3*\", \"5*\", \"7*\")) or\n  (process.name == \"install\" and process.args : \"-m*\" and process.args : (\"7*\", \"5*\", \"3*\", \"1*\"))\n) and not (\n  process.parent.executable : \"/var/lib/dpkg/*\" or\n  process.command_line in (\"chmod 777 /etc/update-motd.d/\", \"chmod 755 /etc/update-motd.d/\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the use of the setcap utility to set capabilities on a process. The setcap utility is used to set the\ncapabilities of a binary to al...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.name == \"setcap\" and not (\n  process.parent.executable == null or\n  process.parent.executable : (\"/var/lib/dpkg/*\", \"/var/lib/docker/*\", \"/tmp/newroot/*\", \"/var/tmp/newroot/*\") or\n  process.parent.name in (\"jem\", \"vzctl\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule detects the creation of .pth files in system-wide and user-specific Python package\ndirectories, which can be abused for persistent code exec...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and file.extension == \"pth\" and\nfile.path like~ (\n  \"/usr/local/lib/python*/dist-packages/*\", \n  \"/usr/lib/python*/dist-packages/*\",\n  \"/usr/local/lib/python*/site-packages/*\",\n  \"/usr/lib/python*/site-packages/*\",\n  \"/home/*/.local/lib/python*/site-packages/*\",\n  \"/opt/*/lib/python*/site-packages/*\"\n) and process.executable != null and not (\n  process.executable in (\n    \"/usr/local/bin/pip2\", \"/usr/bin/restic\", \"/usr/bin/pacman\", \"/usr/bin/dockerd\", \"/usr/local/bin/pip3\",\n    \"/usr/bin/pip3\", \"/usr/local/bin/pip\", \"/usr/bin/pip\", \"/usr/bin/podman\", \"/usr/local/bin/poetry\",\n    \"/usr/bin/poetry\", \"/usr/bin/pamac-daemon\", \"/opt/venv/bin/pip\", \"/usr/bin/dnf\", \"./venv/bin/pip\",\n    \"/usr/bin/dnf5\", \"/bin/dnf5\", \"/bin/pip\", \"/bin/podman\"\n  ) or\n  process.executable like~ (\n    \"/usr/bin/python*\", \"/usr/local/bin/python*\", \"/opt/venv/bin/python*\",\n    \"/nix/store/*libexec/docker/dockerd\", \"/snap/docker/*dockerd\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule detects the potential execution of the `/etc/rc.local` script through the `already_running` event action\ncreated by the `rc-local.service` s...", "output": "process where host.os.type == \"linux\" and event.type == \"info\" and event.action == \"already_running\" and\nprocess.parent.args == \"/etc/rc.local\" and process.parent.args == \"start\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors the creation/alteration of the rc.local/rc.common file. The /etc/rc.local file is used to start\ncustom applications, services, scri...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path in (\"/etc/rc.local\", \"/etc/rc.common\") and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"ssm-agent-worker\", \"convert2rhel\", \"platform-python*\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap. Setuid (Set User ID)\nand setgid (Set Group ID) are ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and \n  process.name == \"setcap\" and process.args : \"cap_set?id+ep\" and not (\n    process.parent.name in (\"jem\", \"vzctl\") or\n    process.args like \"/usr/bin/new?idmap\"\n  )\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for Linux Shadow file modifications. These modifications are indicative of a potential password\nchange or user addition event. Thre...", "output": "file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and\nfile.path == \"/etc/shadow\" and file.Ext.original.path != null and \nnot process.name in (\n  \"usermod\", \"useradd\", \"passwd\", \"chage\", \"systemd-sysusers\", \"chpasswd\", \"userdel\", \"adduser\", \"update-passwd\", \"perl\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors the creation/alteration of a shell configuration file. Unix systems use shell configuration files to\nset environment variables, cre...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  // system-wide configurations\n  \"/etc/profile\", \"/etc/profile.d/*\", \"/etc/bash.bashrc\", \"/etc/bash.bash_logout\", \"/etc/zsh/*\",\n  \"/etc/csh.cshrc\", \"/etc/csh.login\", \"/etc/fish/config.fish\", \"/etc/ksh.kshrc\",\n  // root and user configurations\n  \"/home/*/.profile\", \"/home/*/.bashrc\", \"/home/*/.bash_login\", \"/home/*/.bash_logout\", \"/home/*/.bash_profile\",\n  \"/root/.profile\", \"/root/.bashrc\", \"/root/.bash_login\", \"/root/.bash_logout\", \"/root/.bash_profile\",\n  \"/root/.bash_aliases\", \"/home/*/.bash_aliases\", \"/home/*/.zprofile\", \"/home/*/.zshrc\", \"/root/.zprofile\",\n  \"/root/.zshrc\", \"/home/*/.cshrc\", \"/home/*/.login\", \"/home/*/.logout\", \"/root/.cshrc\", \"/root/.login\",\n  \"/root/.logout\", \"/home/*/.config/fish/config.fish\", \"/root/.config/fish/config.fish\", \"/home/*/.kshrc\",\n  \"/root/.kshrc\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/sbin/adduser\", \"/usr/sbin/useradd\", \"/usr/local/bin/dockerd\",\n    \"/usr/sbin/gdm\", \"/usr/bin/unzip\", \"/usr/bin/gnome-shell\", \"/sbin/mkhomedir_helper\", \"/usr/sbin/sshd\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/bin/xfce4-session\", \"/usr/libexec/oddjob/mkhomedir\", \"/sbin/useradd\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/crond\", \"/usr/bin/pamac-daemon\", \"/usr/sbin/mkhomedir_helper\",\n    \"/opt/pbis/sbin/lwsmd\", \"/usr/sbin/oddjobd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\",\n    \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\"adclient\", \"mkhomedir_helper\", \"teleport\", \"mkhomedir\", \"adduser\", \"desktopDaemon\", \"executor\", \"crio\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects connections accepted by a simple HTTP web server in Python and PHP built-in modules. Adversaries may\ncreate simple HTTP web servers ...", "output": "sequence by process.entity_id with maxspan=1m\n[process where host.os.type == \"linux\" and event.type == \"start\" and \n (\n  (process.name regex~ \"\"\"php?[0-9]?\\.?[0-9]{0,2}\"\"\" and process.command_line like \"*-S*\") or\n  (process.name like \"python*\" and process.command_line like (\"*--cgi*\", \"*CGIHTTPServer*\"))\n )]\n[network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_accepted\"]\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the creation of a simple HTTP web server using PHP or Python built-in modules. Adversaries may create\nsimple HTTP web servers to est...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name regex~ \"\"\"php?[0-9]?\\.?[0-9]{0,2}\"\"\" and process.args == \"-S\") or\n    (process.name like \"python*\" and process.args in (\"--cgi\", \"CGIHTTPServer\"))\n  ) and\nnot process.parent.name in (\"check_kmp_wrapper\", \"naemon\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the creation and modification of sitecustomize.py and usercustomize.py, which\nPython automatically executes on startup. Attackers ca...", "output": "file where host.os.type == \"linux\" and event.type in (\"creation\", \"rename\") and process.executable != null and\nfile.path like~ (\n  \"/usr/lib/python*/sitecustomize.py\",\n  \"/usr/local/lib/python*/sitecustomize.py\",\n  \"/usr/lib/python*/dist-packages/sitecustomize.py\",\n  \"/usr/local/lib/python*/dist-packages/sitecustomize.py\",\n  \"/opt/*/lib/python*/sitecustomize.py\",\n  \"/home/*/.local/lib/python*/site-packages/usercustomize.py\",\n  \"/home/*/.config/python/usercustomize.py\"\n) and not (\n  process.executable in (\n    \"/usr/local/bin/pip2\", \"/usr/bin/restic\", \"/usr/bin/pacman\", \"/usr/bin/dockerd\", \"/usr/local/bin/pip3\",\n    \"/usr/bin/pip3\", \"/usr/local/bin/pip\", \"/usr/bin/pip\", \"/usr/bin/podman\", \"/usr/local/bin/poetry\",\n    \"/usr/bin/poetry\", \"/usr/bin/pamac-daemon\", \"./venv/bin/pip\"\n  ) or\n  process.executable like~ (\n    \"/usr/bin/python*\", \"/usr/local/bin/python*\", \"/opt/venv/bin/python*\",\n    \"/nix/store/*libexec/docker/dockerd\", \"/snap/docker/*dockerd\"\n  )\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule identifies the creation of SSH keys using the ssh-keygen tool, which is the standard utility for generating\nSSH keys. Users often create SSH...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\") and\nprocess.executable == \"/usr/bin/ssh-keygen\" and file.path : (\"/home/*/.ssh/*\", \"/root/.ssh/*\", \"/etc/ssh/*\") and\nnot file.name : \"known_hosts.*\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule identifies an egress internet connection initiated by an SSH Daemon child process. This behavior is\nindicative of the alteration of a shell ...", "output": "sequence by host.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.executable == \"/usr/sbin/sshd\"] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\", \"172.31.0.0/16\"\n     )\n    ) and not (\n      process.executable in (\"/bin/yum\", \"/usr/bin/yum\") or\n      process.name in (\"login_duo\", \"ssh\", \"sshd\", \"sshd-session\")\n    )\n  ] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule identifies successful logins by system users that are uncommon to authenticate. These users\nhave `nologin` set by default, and must be modif...", "output": "authentication where host.os.type == \"linux\" and event.action in (\"ssh_login\", \"user_login\") and\nuser.name in (\n  \"deamon\", \"bin\", \"sys\", \"games\", \"man\", \"lp\", \"mail\", \"news\", \"uucp\", \"proxy\", \"www-data\", \"backup\",\n  \"list\", \"irc\", \"gnats\", \"nobody\", \"systemd-timesync\", \"systemd-network\", \"systemd-resolve\", \"messagebus\",\n  \"avahi\", \"sshd\", \"dnsmasq\"\n) and event.outcome == \"success\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors for the potential edit of a suspicious file. In Linux, when editing a file through an editor, a\ntemporary .swp file is created. By ...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\") and file.extension == \"swp\" and\nfile.path : (\n  /* common interesting files and locations */\n  \"/etc/.shadow.swp\", \"/etc/.shadow-.swp\", \"/etc/.shadow~.swp\", \"/etc/.gshadow.swp\", \"/etc/.gshadow-.swp\",\n  \"/etc/.passwd.swp\", \"/etc/.pwd.db.swp\", \"/etc/.master.passwd.swp\", \"/etc/.spwd.db.swp\", \"/etc/security/.opasswd.swp\",\n  \"/etc/.environment.swp\", \"/etc/.profile.swp\", \"/etc/sudoers.d/.*.swp\", \"/etc/ld.so.conf.d/.*.swp\",\n  \"/etc/init.d/.*.swp\", \"/etc/.rc.local.swp\", \"/etc/rc*.d/.*.swp\", \"/dev/shm/.*.swp\", \"/etc/update-motd.d/.*.swp\",\n  \"/usr/lib/update-notifier/.*.swp\",\n\n  /* service, timer, want, socket and lock files */\n  \"/etc/systemd/system/.*.swp\", \"/usr/local/lib/systemd/system/.*.swp\", \"/lib/systemd/system/.*.swp\",\n  \"/usr/lib/systemd/system/.*.swp\",\"/home/*/.config/systemd/user/.*.swp\", \"/run/.*.swp\", \"/var/run/.*.swp/\",\n\n  /* profile and shell configuration files */\n  \"/home/*.profile.swp\", \"/home/*.bash_profile.swp\", \"/home/*.bash_login.swp\", \"/home/*.bashrc.swp\", \"/home/*.bash_logout.swp\",\n  \"/home/*.zshrc.swp\", \"/home/*.zlogin.swp\", \"/home/*.tcshrc.swp\", \"/home/*.kshrc.swp\", \"/home/*.config.fish.swp\",\n  \"/root/*.profile.swp\", \"/root/*.bash_profile.swp\", \"/root/*.bash_login.swp\", \"/root/*.bashrc.swp\", \"/root/*.bash_logout.swp\",\n  \"/root/*.zshrc.swp\", \"/root/*.zlogin.swp\", \"/root/*.tcshrc.swp\", \"/root/*.kshrc.swp\", \"/root/*.config.fish.swp\"\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "It identifies potential malicious shell executions through remote SSH and detects cases where the sshd service suddenly\nterminates soon after successf...", "output": "sequence by host.id, user.id with maxspan=1s\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"sshd\" and\n    process.args == \"-D\" and process.args == \"-R\"] by process.pid, process.entity_id\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name == \"sshd\" and\n  process.executable != null and not (\n    process.executable in (\"/usr/sbin/sshd\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/bin/fipscheck\") or\n    process.args like (\"rsync*\", \"systemctl*\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/sbin/aad_certhandler*\") or\n    process.command_line like \"sh -c /usr/bin/env -i PATH=*\"\n  )] by process.parent.pid, process.parent.entity_id\n [process where host.os.type == \"linux\" and event.action == \"end\" and process.name == \"sshd\" and process.exit_code != 0] by process.pid, process.entity_id\n [network where host.os.type == \"linux\" and event.type == \"end\" and event.action == \"disconnect_received\" and process.name == \"sshd\"] by process.pid, process.entity_id\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule detects the creation of a systemd generator file. Generators are small executables executed by systemd at\nbootup and during configuration re...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n\"/run/systemd/system-generators/*\", \"/etc/systemd/system-generators/*\",\n\"/usr/local/lib/systemd/system-generators/*\", \"/lib/systemd/system-generators/*\",\n\"/usr/lib/systemd/system-generators/*\", \"/etc/systemd/user-generators/*\",\n\"/usr/local/lib/systemd/user-generators/*\", \"/usr/lib/systemd/user-generators/*\",\n\"/lib/systemd/user-generators/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/usr/sbin/sshd\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\"\n  ) or\n  process.name like~ (\"ssm-agent-worker\", \"crio\", \"docker-init\", \"systemd\", \"pacman\", \"python*\", \"platform-python*\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable == null\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects suspicious network events executed by systemd, potentially indicating persistence through a systemd backdoor.\nSystemd is a system and service ...", "output": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"systemd\" and process.name in (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\"\n   )\n  ] by process.entity_id\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and\n   not process.executable == \"/tmp/newroot/bin/curl\"] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the creation of a systemd timer within any of the default systemd timer directories. Systemd timers can be used\nby an attacker to gain persist...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"timer\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/kaniko/executor\"\n  ) or\n  process.name like (\n    \"python*\", \"crio\", \"apt-get\", \"install\", \"snapd\", \"cloudflared\", \"sshd\", \"convert-usrmerge\", \"docker-init\",\n    \"google_metadata_script_runner\", \"ssm-agent-worker\", \"pacman\", \"convert2rhel\", \"platform-python\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the creation or renaming of a new Systemd file in all of the common Systemd service locations for both\nroot and regular users. Syste...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"service\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name like (\n    \"ssm-agent-worker\", \"python*\", \"platform-python*\", \"dnf_install\", \"cloudflared\", \"lxc-pve-prestart-hook\",\n    \"convert-usrmerge\", \"elastic-agent\", \"google_metadata_script_runner\", \"update-alternatives\", \"gitlab-runner\",\n    \"install\", \"crio\", \"apt-get\", \"package-cleanup\", \"dcservice\", \"dcregister\", \"jumpcloud-agent\", \"executor\",\n    \"pacman\", \"convert2rhel\", \"packagekitd\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the execution of shell commands by systemd during the boot process on Linux systems. Systemd\nis a system and service manager for Lin...", "output": "process where host.os.type == \"linux\" and event.type == \"info\" and event.action == \"already_running\" and\nprocess.parent.name == \"systemd\" and process.name in (\"bash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\nprocess.parent.command_line == \"/sbin/init\" and process.args_count >= 2\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Monitors for the creation of rule files that are used by systemd-udevd to manage device nodes and handle kernel device\nevents in the Linux operating s...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nprocess.executable != null and file.extension == \"rules\" and\nfile.path : (\n  \"/lib/udev/*\", \"/etc/udev/rules.d/*\", \"/usr/lib/udev/rules.d/*\", \"/run/udev/rules.d/*\", \"/usr/local/lib/udev/rules.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/lib/systemd/system-generators/netplan\", \"/lib/systemd/systemd\", \"/usr/bin/containerd\", \"/usr/sbin/sshd\",\n    \"/kaniko/executor\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\"\n  ) or\n  process.name in (\n    \"systemd\", \"netplan\", \"apt-get\", \"vmware-config-tools.pl\", \"systemd-hwdb\", \"ssm-agent-worker\", \"crio\", \"cloud-init\", \"convert2rhel\" \n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the unpacking of an initramfs image using the `unmkinitramfs` command on Linux systems. The\n`unmkinitramfs` command is used to extra...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and\nprocess.name == \"unmkinitramfs\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects Linux user account credential modification events where the echo command is\nused to directly echo a password into the passwd utility...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\nprocess.command_line like~ \"*echo*passwd*\" and\nnot (\n  process.parent.command_line == \"runc init\" or\n  process.parent.executable in (\"/usr/bin/make\", \"/bin/make\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule leverages the `auditd_manager` integration to detect user or group creation or modification events on Linux\nsystems. Threat actors may attem...", "output": "iam where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and auditd.result == \"success\" and\nevent.action in (\"changed-password\", \"added-user-account\", \"added-group-account-to\") and process.name != null\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule identifies unusual destination port network activity originating from a web server process. The\nrule is designed to detect potential web she...", "output": "network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and (\n     user.name in (\n      \"apache\", \"www-data\", \"httpd\", \"nginx\", \"lighttpd\", \"tomcat\", \"tomcat8\", \"tomcat9\", \"ftp\", \"ftpuser\", \"ftpd\"\n     ) or\n     user.id in (\"99\", \"33\", \"498\", \"48\")\n   ) and (\n   process.name in (\n    \"apache\", \"nginx\", \"apache2\", \"httpd\", \"lighttpd\", \"caddy\", \"node\", \"mongrel_rails\", \"java\", \"gunicorn\",\n    \"uwsgi\", \"openresty\", \"cherokee\", \"h2o\", \"resin\", \"puma\", \"unicorn\", \"traefik\", \"tornado\", \"hypercorn\",\n    \"daphne\", \"twistd\", \"yaws\", \"webfsd\", \"httpd.worker\", \"flask\", \"rails\", \"mongrel\"\n  ) or\n    process.name like (\"php-*\", \"python*\", \"ruby*\", \"perl*\")\n) and\nnetwork.direction == \"egress\" and destination.ip != null and\nnot destination.port in (80, 443, 8080, 8443, 8000, 8888, 3128, 3306) and\nnot cidrmatch(destination.ip, \"127.0.0.0/8\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n\n/* \nThis rule does not exclude local IP ranges by default. To exclude these, use the following exclusion statement:\ncidrmatch(destination.ip, \"10.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\",\n\"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\",\n\"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"224.0.0.0/4\", \"240.0.0.0/4\")\n*/\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects network connections initiated through Cross-Desktop Group (XDG) autostart entries for GNOME and XFCE-based Linux\ndistributions. XDG Autostart ...", "output": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n     (process.parent.executable == \"/usr/bin/xfce4-session\") or\n     (process.executable == \"/bin/sh\" and process.args == \"-e\" and process.args == \"-u\" and\n      process.args == \"-c\" and process.args : \"export GIO_LAUNCHED_DESKTOP_FILE_PID=$$;*\")\n   )\n  ]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\", \"172.31.0.0/16\"\n       ) or\n       process.name in (\n         \"telegram-desktop\", \"firefox\", \"gnome-calculator\", \"remmina\", \"spotify\", \"librewolf\", \"fortitraylauncher\",\n         \"flameshot\", \"thunderbird\", \"update-manager\", \"warp-terminal\", \"obs\", \"transmission-gtk\"\n       )\n     )\n  ]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detects file creation events in the plugin directories for the Yum package manager. In Linux, Yum (Yellowdog Updater,\nModified) is a command-line util...", "output": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : (\"/usr/lib/yum-plugins/*\", \"/etc/yum/pluginconf.d/*\") and not (\n  process.executable in (\n    \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\", \"/usr/bin/microdnf\", \"/bin/rpm\",\n    \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\", \"/bin/puppet\",\n    \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/bin/autossl_check\",\n    \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\",\n    \"/usr/libexec/netplan/generate\"\n  ) or\n  process.name in (\"yumBackend.py\", \"crio\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\") or\n  file.Ext.original.name like \".ansible*\" or\n  file.name like \".ansible_tmp*\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule monitors for the execution of the \"chown\" and \"chmod\" commands with command line flags that could indicate a\nwildcard injection attack. Linu...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.name in (\"chown\", \"chmod\") and process.args == \"-R\" and process.args : \"--reference=*\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for the execution of processes that interact with Linux containers through an interactive shell\nwithout root permissions. Utilities...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.name == \"runc\" and process.args == \"run\") or\n  (process.name == \"ctr\" and process.args == \"run\" and process.args in (\"--privileged\", \"--mount\"))\n) and not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\" and\nprocess.interactive == true and process.parent.interactive == true\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detects suspicious creation of the nsswitch.conf file, outside of the regular /etc/nsswitch.conf path,\nconsistent with attempts to exploit CVE-2025-32...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.path like \"/*/etc/nsswitch.conf\" and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\nnot (\n  process.name == \"dash\" and file.path like (\"/var/tmp/mkinitramfs_*\", \"/tmp/tmp.*/mkinitramfs_*\")\n)\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects suspicious use of sudo's --chroot / -R option consistent with attempts to exploit CVE-2025-32463\n(the \"sudo chroot\" privilege escalation), whe...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\", \"ProcessRollup2\") and\nprocess.name == \"sudo\" and process.args like (\"-R\", \"--chroot*\") and\n// To enforce the -R and --chroot arguments to be for sudo specifically, while wildcarding potential full sudo paths\nprocess.command_line like (\"*sudo -R*\", \"*sudo --chroot*\") \n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "This rule looks for processes that behave like an attacker trying to exploit a known vulnerability in VMware tools (CVE-2025-41244).\nThe vulnerable be...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\", \"ProcessRollup2\") and\n(\n  (\n    process.parent.name == \"vmtoolsd\"\n  ) or\n  (\n    process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n    ?process.parent.args like (\"/*/open-vm-tools/serviceDiscovery/scripts/get-versions.sh\")\n  )\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule detects the use of the built-in Linux DebugFS utility from inside a container. DebugFS is a special\nfile system debugging utility which supp...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name == \"debugfs\" and\nprocess.command_line like~ \"/dev/sd*\" and not process.args == \"-R\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule identifies a UID change event via `nsenter`. The `nsenter` command is used to enter a namespace, which is a\nway to isolate processes and res...", "output": "process where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"uid_change\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.args == \"nsenter\" and\nprocess.args in (\"-t\", \"--target\") and process.args_count >= 4\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Monitors for the execution of a file system mount followed by a chroot execution. Given enough permissions, a user\nwithin a container is capable of mo...", "output": "sequence by host.id, process.parent.entity_id with maxspan=5m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.name == \"mount\" and process.args : \"/dev/sd*\" and process.args_count >= 3 and\n   process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.name == \"chroot\"]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the creation of files named release_agent or notify_on_release, which are\ncommonly associated with the abuse of Linux cgroup release...", "output": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.name in (\"release_agent\", \"notify_on_release\")\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies an attempt to exploit a local privilege escalation CVE-2022-37706 via a flaw in Linux window manager package\nEnlightenment. enlightenment_s...", "output": "sequence by host.id, process.parent.entity_id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n    process.name == \"enlightenment_sys\" and process.args in (\"/bin/mount/\", \"-o\",\"noexec\",\"nosuid\",\"nodev\",\"uid=*\") ]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and user.id == \"0\"]\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies instances where GDB (granted the CAP_SYS_PTRACE capability) is executed, after which the user's access is\nelevated to UID/GID 0 (root). In ...", "output": "sequence by host.id, process.entry_leader.entity_id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"gdb\" and\n   (process.thread.capabilities.effective : \"CAP_SYS_PTRACE\" or process.thread.capabilities.permitted : \"CAP_SYS_PTRACE\") and\n   user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name != null and user.id == \"0\"]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies instances where GDB (granted the CAP_SYS_PTRACE capability) is executed, after which an outbound network\nconnection is initiated by UID/GID...", "output": "sequence by host.id, process.entry_leader.entity_id with maxspan=30s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"gdb\" and\n   (process.thread.capabilities.effective : \"CAP_SYS_PTRACE\" or process.thread.capabilities.permitted : \"CAP_SYS_PTRACE\") and\n   user.id != \"0\"]\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and\n   process.name != null and user.id == \"0\"]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Monitors for the elevation of regular user permissions to root permissions through the kworker process. kworker, or\nkernel worker, processes are part ...", "output": "process where host.os.type == \"linux\" and event.action == \"session_id_change\" and process.name : \"kworker*\" and\nuser.id == \"0\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of a symbolic link to a suspicious file or location. A symbolic link is a reference to a file or\ndirectory that acts as a poin...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"ln\" and process.args in (\"-s\", \"-sf\") and\n  (\n    /* suspicious files */\n    (process.args in (\"/etc/shadow\", \"/etc/shadow-\", \"/etc/shadow~\", \"/etc/gshadow\", \"/etc/gshadow-\") or\n    (process.working_directory == \"/etc\" and process.args in (\"shadow\", \"shadow-\", \"shadow~\", \"gshadow\", \"gshadow-\"))) or\n\n    /* suspicious bins */\n    (process.args in (\"/bin/bash\", \"/bin/dash\", \"/bin/sh\", \"/bin/tcsh\", \"/bin/csh\", \"/bin/zsh\", \"/bin/ksh\", \"/bin/fish\") or\n    (process.working_directory == \"/bin\" and process.args : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or\n    (process.args in (\"/usr/bin/bash\", \"/usr/bin/dash\", \"/usr/bin/sh\", \"/usr/bin/tcsh\", \"/usr/bin/csh\", \"/usr/bin/zsh\", \"/usr/bin/ksh\", \"/usr/bin/fish\") or\n    (process.working_directory == \"/usr/bin\" and process.args in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or\n\n    /* suspicious locations */\n    (process.args : (\"/etc/cron.d/*\", \"/etc/cron.daily/*\", \"/etc/cron.hourly/*\", \"/etc/cron.weekly/*\", \"/etc/cron.monthly/*\")) or\n    (process.args : (\"/home/*/.ssh/*\", \"/root/.ssh/*\",\"/etc/sudoers.d/*\", \"/dev/shm/*\"))\n  ) and\n  process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for the execution of the systemd-run command by a user with a UID that is larger than the maximum\nallowed UID size (INT_MAX). Some ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"ProcessRollup2\") and\n  process.name == \"systemd-run\" and process.args == \"-t\" and process.args_count >= 3 and user.id >= \"1000000000\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This detection rule identifies the usage of kexec, helping to uncover unauthorized kernel replacements and potential\ncompromise of the system's integr...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.name == \"kexec\" and process.args in (\"--exec\", \"-e\", \"--load\", \"-l\", \"--unload\", \"-u\") and\n  not process.parent.name in (\"kdumpctl\", \"unload.sh\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule detects potential privilege escalation attempts through Looney Tunables (CVE-2023-4911). Looney Tunables is a\nbuffer overflow vulnerability ...", "output": "sequence by host.id, process.parent.entity_id, process.executable with maxspan=5s\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.env_vars : \"*GLIBC_TUNABLES=glibc.*=glibc.*=*\"] with runs=5\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects the use of the mount utility from inside a container. The mount command is used to make a\ndevice or file system accessible to the sy...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name == \"mount\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects network connections initiated by the \"sudo\" binary. This behavior is uncommon and may occur in instances where\nreverse shell shellcode is inje...", "output": "sequence by host.id, process.entity_id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"connection_attempted\", \"ipv4_connection_attempt_event\") and process.name == \"sudo\" and not (\n    destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n      destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n      \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n      \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n      \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n      \"FF00::/8\", \"172.31.0.0/16\"\n    )\n  )]\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies an attempt to exploit a local privilege escalation (CVE-2023-2640 and CVE-2023-32629) via a flaw in Ubuntu's\nmodifications to OverlayFS. Th...", "output": "sequence by process.parent.entity_id, host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n    process.name == \"unshare\" and process.args : (\"-r\", \"-rm\", \"m\") and process.args : \"*cap_setuid*\"  and user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and\n    user.id == \"0\"]\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies an attempt to exploit a local privilege escalation in polkit pkexec (CVE-2021-4034) via unsecure environment\nvariable injection. Successful...", "output": "file where host.os.type == \"linux\" and file.path : \"/*GCONV_PATH*\"\n", "source": "detection-rules/linux", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies instances where a process is executed with user/group ID 0 (root), and a real user/group ID that is not 0.\nThis is indicative of a process ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.user.id == \"0\" and process.real_user.id != \"0\") or\n  (process.group.id == \"0\" and process.real_group.id != \"0\")\n) and (\n  process.name in (\n    \"aa-exec\", \"ab\", \"agetty\", \"alpine\", \"ar\", \"arj\", \"arp\", \"as\", \"ascii-xfr\", \"ash\", \"aspell\",\n    \"atobm\", \"awk\", \"base32\", \"base64\", \"basenc\", \"basez\", \"bash\", \"bc\", \"bridge\", \"busctl\",\n    \"busybox\", \"bzip2\", \"cabal\", \"capsh\", \"cat\", \"choom\", \"chown\", \"chroot\", \"clamscan\", \"cmp\",\n    \"column\", \"comm\", \"cp\", \"cpio\", \"cpulimit\", \"csh\", \"csplit\", \"csvtool\", \"cupsfilter\", \"curl\",\n    \"cut\", \"dash\", \"date\", \"dd\", \"debugfs\", \"dialog\", \"diff\", \"dig\", \"distcc\", \"dmsetup\", \"docker\",\n    \"dosbox\", \"ed\", \"efax\", \"elvish\", \"emacs\", \"env\", \"eqn\", \"espeak\", \"expand\", \"expect\", \"file\",\n    \"find\", \"fish\", \"flock\", \"fmt\", \"fold\", \"gawk\", \"gcore\", \"gdb\", \"genie\", \"genisoimage\", \"gimp\",\n    \"grep\", \"gtester\", \"gzip\", \"hd\", \"head\", \"hexdump\", \"highlight\", \"hping3\", \"iconv\", \"install\",\n    \"ionice\", \"ispell\", \"jjs\", \"join\", \"jq\", \"jrunscript\", \"julia\", \"ksh\", \"ksshell\", \"kubectl\",\n    \"ld.so\", \"less\", \"links\", \"logsave\", \"look\", \"lua\", \"make\", \"mawk\", \"minicom\", \"more\",\n    \"mosquitto\", \"msgattrib\", \"msgcat\", \"msgconv\", \"msgfilter\", \"msgmerge\", \"msguniq\", \"multitime\",\n    \"mv\", \"nasm\", \"nawk\", \"ncftp\", \"nft\", \"nice\", \"nl\", \"nm\", \"nmap\", \"node\", \"nohup\", \"ntpdate\",\n    \"od\", \"openssl\", \"openvpn\", \"pandoc\", \"paste\", \"perf\", \"perl\", \"pexec\", \"pg\", \"php\", \"pidstat\",\n    \"pr\", \"ptx\", \"python\", \"rc\", \"readelf\", \"restic\", \"rev\", \"rlwrap\", \"rsync\", \"rtorrent\",\n    \"run-parts\", \"rview\", \"rvim\", \"sash\", \"scanmem\", \"sed\", \"setarch\", \"setfacl\", \"setlock\", \"shuf\",\n    \"soelim\", \"softlimit\", \"sort\", \"sqlite3\", \"ss\", \"ssh-agent\", \"ssh-keygen\", \"ssh-keyscan\",\n    \"sshpass\", \"start-stop-daemon\", \"stdbuf\", \"strace\", \"strings\", \"sysctl\", \"systemctl\", \"tac\",\n    \"tail\", \"taskset\", \"tbl\", \"tclsh\", \"tee\", \"terraform\", \"tftp\", \"tic\", \"time\", \"timeout\", \"troff\",\n    \"ul\", \"unexpand\", \"uniq\", \"unshare\", \"unsquashfs\", \"unzip\", \"update-alternatives\", \"uudecode\",\n    \"uuencode\", \"vagrant\", \"varnishncsa\", \"view\", \"vigr\", \"vim\", \"vimdiff\", \"vipw\", \"w3m\", \"watch\",\n    \"wc\", \"wget\", \"whiptail\", \"xargs\", \"xdotool\", \"xmodmap\", \"xmore\", \"xxd\", \"xz\", \"yash\", \"zsh\",\n    \"zsoelim\"\n  ) or\n  process.name == \"ip\" and (\n    (process.args == \"-force\" and process.args in (\"-batch\", \"-b\")) or (process.args == \"exec\")\n  )\n) and not process.parent.name == \"spine\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for the execution of a set of linux binaries, that are potentially vulnerable to wildcard injection,\nwith suspicious command line f...", "output": "sequence by host.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and (\n    (process.name == \"tar\" and process.args : \"--checkpoint=*\" and process.args : \"--checkpoint-action=*\") or\n    (process.name == \"rsync\" and process.args : \"-e*\") or\n    (process.name == \"zip\" and process.args == \"--unzip-command\")\n   ) and not process.executable : \"/tmp/newroot/*\"\n  ]  by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n     process.parent.name : (\"tar\", \"rsync\", \"zip\") and\n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n  ] by process.parent.entity_id\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "This rule monitors for the usage of the built-in Linux DebugFS utility to access a disk device without root permissions.\nLinux users that are part of ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"debugfs\" and process.args : \"/dev/sd*\" and not process.args == \"-R\" and\nnot user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\"\n", "source": "detection-rules/linux", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors for the execution of a suspicious sudo command that is leveraged in CVE-2019-14287 to escalate\nprivileges to root. Sudo does not ve...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.name == \"sudo\" and process.args == \"-u#-1\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation of a sudo binary located at /usr/bin/sudo. Attackers may hijack the default sudo binary and\nreplace it with a custom binary or...", "output": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and\nfile.path in (\"/usr/bin/sudo\", \"/bin/sudo\") and not (\n  file.Ext.original.path in (\"/usr/bin/sudo\", \"/bin/sudo\") or\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/bin/pacman\", \"/usr/bin/pacman\",\n    \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/apt\",\n    \"/usr/sbin/pacman\", \"/usr/bin/microdnf\", \"/usr/local/bin/dockerd\", \"/usr/local/bin/podman\", \"/usr/local/bin/dnf\",\n    \"/kaniko/executor\", \"/proc/self/exe\", \"/usr/bin/apt-get\", \"/usr/bin/apt-cache\", \"/usr/bin/apt-mark\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/var/lib/docker/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule detects potential sudo token manipulation attacks through process injection by monitoring the use of a\ndebugger (gdb) process followed by a ...", "output": "sequence by host.id, process.session_leader.entity_id with maxspan=15s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.name == \"gdb\" and process.user.id != \"0\" and process.group.id != \"0\" ]\n[ process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and\n  process.name == \"sudo\" and process.user.id == \"0\" and process.group.id == \"0\" ]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This detection rule monitors for the execution of a system command with setuid or setgid capabilities via Python,\nfollowed by a uid or gid change to t...", "output": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.args : \"import os;os.set?id(0);os.system(*)\" and process.args : \"*python*\" and user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.action in (\"uid_change\", \"gid_change\") and event.type == \"change\" and\n   (user.id == \"0\" or group.id == \"0\")]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies instances where a processes (granted CAP_CHOWN and/or CAP_FOWNER capabilities) is executed, after which the\nownership of a suspicious file ...", "output": "sequence by host.id, process.pid with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name != null and process.thread.capabilities.effective : (\"CAP_CHOWN\", \"CAP_FOWNER\") and\n   process.command_line : (\"*sudoers*\", \"*passwd*\", \"*shadow*\", \"*/root/*\") and user.id != \"0\"]\n  [file where host.os.type == \"linux\" and event.action == \"changed-file-ownership-of\" and event.type == \"change\" and\n   event.outcome == \"success\" and file.path in (\n     \"/etc/passwd\",\n     \"/etc/shadow\",\n     \"/etc/sudoers\",\n     \"/root/.ssh/*\"\n   ) and user.id != \"0\"\n  ]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Monitors for the generation of a passwd password entry via openssl, followed by a file write activity on the\n\"/etc/passwd\" file. The \"/etc/passwd\" fil...", "output": "sequence by host.id, process.parent.pid with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name == \"openssl\" and process.args == \"passwd\" and user.id != \"0\"]\n  [file where host.os.type == \"linux\" and file.path == \"/etc/passwd\" and process.parent.pid != 1 and\n   not auditd.data.a2 == \"80000\" and event.outcome == \"success\" and user.id != \"0\"]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies instances where a process (granted CAP_SETUID and/or CAP_SETGID capabilities) is executed, after which the\nuser's access is elevated to UID...", "output": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name != null and\n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\") and\n   user.id != \"0\" and not (\n     process.parent.executable : (\"/tmp/newroot/*\", \"/opt/carbonblack*\") or\n     process.parent.executable in (\n       \"/opt/SolarWinds/Agent/bin/Plugins/JobEngine/SolarWinds.Agent.JobEngine.Plugin\", \"/usr/bin/vmware-toolbox-cmd\",\n       \"/usr/bin/dbus-daemon\", \"/usr/bin/update-notifier\", \"/usr/share/language-tools/language-options\",\n       \"/opt/SolarWinds/Agent/*\", \"/usr/local/sbin/lynis.sh\"\n     ) or\n     process.executable : (\"/opt/dynatrace/*\", \"/tmp/newroot/*\", \"/opt/SolarWinds/Agent/*\") or\n     process.executable in (\n       \"/bin/fgrep\", \"/usr/bin/sudo\", \"/usr/bin/pkexec\", \"/usr/lib/cockpit/cockpit-session\", \"/usr/sbin/suexec\"\n     ) or\n     process.parent.name in (\"update-notifier\", \"language-options\", \"osqueryd\", \"saposcol\", \"dbus-daemon\", \"osqueryi\", \"sdbrun\") or\n     process.command_line like (\"sudo*BECOME-SUCCESS*\", \"/bin/sh*sapsysinfo.sh*\", \"sudo su\", \"sudo su -\") or\n     process.name in (\"sudo\", \"fgrep\", \"lsb_release\", \"apt-update\", \"dbus-daemon-launch-helper\", \"man\") or\n     process.parent.command_line like \"/usr/bin/python*ansible*\"\n   )]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and\n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\")\n   and user.id == \"0\"]\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: This rule monitors a sequence involving a program compilation event followed by its execution and a subsequent\nalteration of UID permissions to root p...", "output": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name in (\"gcc\", \"g++\", \"cc\") and user.id != \"0\"] by process.args\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and event.type == \"creation\" and\n   process.name == \"ld\" and user.id != \"0\"] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   user.id != \"0\"] by process.name\n  [process where host.os.type == \"linux\" and event.action in (\"uid_change\", \"guid_change\") and event.type == \"change\" and\n   user.id == \"0\"] by process.name\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious usage of unshare to manipulate system namespaces. Unshare can be utilized to escalate privileges\nor escape container security bo...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action : (\"exec\", \"exec_event\", \"start\") and\nprocess.executable: \"/usr/bin/unshare\" and\nnot process.parent.executable: (\"/usr/bin/udevadm\", \"*/lib/systemd/systemd-udevd\", \"/usr/bin/unshare\") and\nnot process.args == \"/usr/bin/snap\" and not process.parent.name in (\"zz-proxmox-boot\", \"java\")\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule monitors for the usage of Docker runtime sockets to escalate privileges on Linux systems. Docker sockets by\ndefault are only be writable by ...", "output": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n(\n  (process.name == \"docker\" and process.args : \"run\" and process.args : \"-it\"  and\n   process.args : (\"unix://*/docker.sock\", \"unix://*/dockershim.sock\")) or\n  (process.name == \"socat\" and process.args : (\"UNIX-CONNECT:*/docker.sock\", \"UNIX-CONNECT:*/dockershim.sock\"))\n) and not user.Ext.real.id : \"0\" and not group.Ext.real.id : \"0\"\n", "source": "detection-rules/linux", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Adversaries may collect the keychain storage data from a system to acquire credentials. Keychains are the built-in way\nfor macOS to keep track of user...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and event.action == \"exec\" and\n  process.args like (\"/Users/*/Library/Keychains/*\", \"/Library/Keychains/*\", \"login.keychain-db\", \"login.keychain\") and \n  ((process.code_signature.trusted == false or process.code_signature.exists == false) or \n   (process.name in (\"bash\", \"sh\", \"zsh\", \"osascript\", \"cat\", \"echo\", \"cp\") and \n   (process.parent.code_signature.trusted == false or process.parent.code_signature.exists == false)))\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of macOS built-in commands used to dump user account hashes. Adversaries may attempt to dump\ncredentials to obtain account lo...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name in (\"defaults\", \"mkpassdb\") and process.args like~ (\"ShadowHashData\", \"-dump\")\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Adversaries may dump the content of the keychain storage data from a system to acquire credentials. Keychains are the\nbuilt-in way for macOS to keep t...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.args like~ \"dump-keychain\" and process.args == \"-d\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a high volume of `pbpaste` executions, which may indicate a bash loop continuously collecting clipboard\ncontents, potentially allowing an a...", "output": "sequence by host.hostname, host.id with maxspan=1m\n[process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and process.name: \"pbpaste\"] with runs = 5\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the use of the Kerberos credential cache (kcc) utility to dump locally cached Kerberos tickets. Adversaries\nmay attempt to dump credential ...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"kcc\" and\n  process.args like~ \"copy_cred_cache\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Adversaries may collect keychain storage data from a system to in order to acquire credentials. Keychains are the\nbuilt-in way for macOS to keep track...", "output": "process where host.os.type == \"macos\" and event.action == \"exec\" and\n process.name == \"security\" and\n process.args like (\"-wa\", \"-ga\") and process.args like~ (\"find-generic-password\", \"find-internet-password\") and\n process.command_line : (\"*Chrome*\", \"*Chromium*\", \"*Opera*\", \"*Safari*\", \"*Brave*\", \"*Microsoft Edge*\", \"*Firefox*\") and\n not process.parent.executable like \"/Applications/Keeper Password Manager.app/Contents/Frameworks/Keeper Password Manager Helper*/Contents/MacOS/Keeper Password Manager Helper*\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the use of the built-in networksetup command to configure webproxy settings. This may indicate an attempt to\nhijack web browser traffic for...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and event.action == \"exec\" and\n process.name == \"networksetup\" and process.args like~ (\"-setwebproxy\", \"-setsecurewebproxy\", \"-setautoproxyurl\") and\n (process.parent.name like~ (\"osascript\", \"bash\", \"sh\", \"zsh\", \"Terminal\", \"Python*\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the use of osascript to execute scripts via standard input that may prompt a user with a rogue dialog for\ncredentials.\n", "output": "process where event.action == \"exec\" and host.os.type == \"macos\" and\n process.name == \"osascript\" and process.args == \"-e\" and process.command_line like~ (\"*osascript*display*dialog*password*\", \"*osascript*display*dialog*passphrase*\", \"*pass*display*dialog*\") and\n not (process.parent.executable == \"/usr/bin/sudo\" and process.command_line like~ \"*Encryption Key Escrow*\") and\n not (process.command_line like~ \"*-e with timeout of 3600 seconds*\" and user.id like \"0\" and process.parent.executable == \"/bin/bash\") and\n not process.Ext.effective_parent.executable like~\n                                               (\"/usr/local/jamf/*\",\n                                                \"/Library/Intune/Microsoft Intune Agent.app/Contents/MacOS/IntuneMdmDaemon\",\n                                                \"/Library/Application Support/Mosyle/MosyleMDM.app/Contents/MacOS/MosyleMDM\",\n                                                \"/Applications/Karabiner-Elements.app/Contents/MacOS/Karabiner-Elements\",\n                                                \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfDaemon.app/Contents/MacOS/JamfDaemon\",\n                                                \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfManagementService.app/Contents/MacOS/JamfManagementService\")\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the access or file open of web browser sensitive files by an untrusted/unsigned process or osascript.\nAdversaries may acquire credentials f...", "output": "file where event.action == \"open\" and host.os.type == \"macos\" and process.executable != null and\n file.name like~ (\"cookies.sqlite\",\n                  \"key?.db\",\n                  \"logins.json\",\n                  \"Cookies\",\n                  \"Cookies.binarycookies\",\n                  \"Login Data\") and\n ((process.code_signature.trusted == false or process.code_signature.exists == false) or process.name == \"osascript\") and\n not process.code_signature.signing_id == \"org.mozilla.firefox\" and\n not Effective_process.executable like \"/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and\nfeatures, including Wi-Fi and website...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.args in (\"/private/var/db/SystemKey\", \"/var/db/SystemKey\") and\n  not process.Ext.effective_parent.executable like \"/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies changes to the SoftwareUpdate preferences using the built-in defaults command. Adversaries may abuse this in\nan attempt to disable security...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"defaults\" and\n process.args like \"write\" and process.args like \"-bool\" and process.args like~ (\"com.apple.SoftwareUpdate\", \"/Library/Preferences/com.apple.SoftwareUpdate.plist\") and not process.args like (\"TRUE\", \"true\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects deletion of the quarantine attribute by an unusual process (xattr). In macOS, when applications or programs are\ndownloaded from the internet, ...", "output": "file where event.action == \"extended_attributes_delete\" and host.os.type == \"macos\" and process.executable != null and\n (process.code_signature.trusted == false or process.code_signature.exists == false) and \n not process.executable like (\"/usr/bin/xattr\",\n                              \"/System/*\",\n                              \"/private/tmp/KSInstallAction.*/*/Install Google Software Update.app/Contents/Helpers/ksinstall\",\n                              \"/Applications/CEWE Fotoschau.app/Contents/MacOS/FotoPlus\",\n                              \"/Applications/.com.bomgar.scc.*/Remote Support Customer Client.app/Contents/MacOS/sdcust\") and \n not file.path like \"/private/var/folders/*\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects attempts to disable Gatekeeper on macOS. Gatekeeper is a security feature that's designed to ensure that only\ntrusted software is run. Adversa...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"spctl\" and\n process.args like~ \"--master-disable\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to their command\nand control servers. Root certif...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"security\" and process.args like \"add-trusted-cert\" and\n  (process.parent.name like~ (\"osascript\", \"bash\", \"sh\", \"zsh\", \"Terminal\", \"Python*\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies modifications to an environment variable using the built-in launchctl command. Adversaries may execute their\nown malicious payloads by hija...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"launchctl\" and\n  (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false) and\n  process.args == \"setenv\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the use of sqlite3 to directly modify the Transparency, Consent, and Control (TCC) SQLite database. This may\nindicate an attempt to bypass ...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"sqlite*\" and\n process.args like \"/*/Application Support/com.apple.TCC/TCC.db\" and\n (process.parent.name like~ (\"osascript\", \"bash\", \"sh\", \"zsh\", \"Terminal\", \"Python*\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies use of the Secure Copy Protocol (SCP) to copy files locally by abusing the auto addition of the Secure Shell\nDaemon (sshd) to the authorize...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"scp\" and\n process.args like~ \"StrictHostKeyChecking=no\" and\n process.command_line : (\"scp *localhost:/*\", \"scp *127.0.0.1:/*\") and\n not process.args : \"vagrant@*127.0.0.1*\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies changes to the Safari configuration using the built-in defaults command. Adversaries may attempt to enable or\ndisable certain Safari settin...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"defaults\" and process.args like~ (\"com.apple.Safari\", \"write\") and \n  not process.args like~ (\"UniversalSearchEnabled\", \"SuppressSearchSuggestions\", \"WebKitTabToLinksPreferenceKey\", \n                          \"ShowFullURLInSmartSearchField\", \"com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation of a suspicious zip file prepended with special characters. Sandboxed Microsoft Office\napplications on macOS are allowed to wr...", "output": "file where host.os.type == \"macos\" and event.action in (\"modification\", \"rename\") and file.name like~ \"~$*.zip\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the use of the mount_apfs command to mount the entire file system through Apple File System (APFS) snapshots\nas read-only and with the noow...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"mount_apfs\" and\n process.args like~ \"/System/Volumes/Data\" and process.args like~ \"noowners\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies attempts to unload the Elastic Endpoint Security kernel extension via the kextunload command.", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"kextunload\" and process.args like~ (\"/System/Library/Extensions/EndpointSecurity.kext\", \"EndpointSecurity.kext\")\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of macOS built-in commands related to account or group enumeration. Adversaries may use account\nand group information to orie...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    process.name in (\"ldapsearch\", \"dsmemberutil\") or\n    (process.name == \"dscl\" and\n      process.args in (\"read\", \"-read\", \"list\", \"-list\", \"ls\", \"search\", \"-search\") and\n      process.args like (\"/Active Directory/*\", \"/Users*\", \"/Groups*\"))\n\t) and\n  ((process.Ext.effective_parent.executable like \"/Volumes/*\" or process.parent.executable like \"/Volumes/*\") or\n   (process.Ext.effective_parent.name : \".*\" or process.parent.name : \".*\") or\n   (process.parent.code_signature.trusted == false or process.parent.code_signature.exists == false))\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies attempts to execute a child process from within the context of an Electron application using the\nchild_process Node.js module. Adversaries ...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.args == \"-e\" and process.args : \"const*require*child_process*\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of a suspicious browser child process. Adversaries may gain access to a system through a user\nvisiting a website over the nor...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.parent.name like~ (\"Google Chrome\", \"Google Chrome Helper*\", \"firefox\", \"Opera\", \"Safari\", \"com.apple.WebKit.WebContent\", \"Microsoft Edge\") and\n  ((process.name like~ (\"sh\", \"bash\", \"dash\", \"ksh\", \"tcsh\", \"zsh\") and process.command_line : (\"*curl*\", \"*nscurl*\", \"*wget*\", \"*whoami*\", \"*pwd*\")) or\n  process.name like~ (\"curl\", \"wget\", \"python*\", \"perl*\", \"php*\", \"osascript\", \"pwsh\")) and\n  process.command_line != null\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the execution of a MacOS installer package with an abnormal child process (e.g bash) followed immediately by a\nnetwork connection via a suspic...", "output": "sequence by host.id, process.entity_id with maxspan=15s\n[process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name like~ (\"installer\", \"package_script_service\") and ((process.name in (\"bash\", \"sh\", \"zsh\") and process.args == \"-c\") or (process.name like~ (\"python*\", \"osascript\", \"tclsh*\", \"curl\", \"nscurl\")))]\n[network where host.os.type == \"macos\" and event.type == \"start\"]\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the execution of the Automator Workflows process followed by a network connection from it's XPC service.\nAdversaries may drop a custom work...", "output": "sequence by host.id, process.entity_id with maxspan=15s\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"Automator\"]\n [network where host.os.type == \"macos\"]\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects execution via the Apple script interpreter (osascript) followed by a network connection from the same process\nwithin a short time period. Adve...", "output": "sequence by host.id, process.entity_id with maxspan=30s\n [process where host.os.type == \"macos\" and event.type == \"start\" and process.name == \"osascript\"]\n [network where host.os.type == \"macos\" and event.type == \"start\" and process.name == \"osascript\" and\n   not cidrmatch(destination.ip, \n       \"240.0.0.0/4\", \"233.252.0.0/24\", \"224.0.0.0/4\", \"198.19.0.0/16\", \"192.18.0.0/15\", \n       \"192.0.0.0/24\", \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \n       \"100.64.0.0/10\", \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\",\n       \"::1\", \"FE80::/10\", \"FF00::/8\")]\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of the shell process (sh) via scripting (JXA or AppleScript). Adversaries may use the\ndoShellScript functionality in JXA or d...", "output": "sequence by host.id with maxspan=10s\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and event.action == \"exec\" and process.name == \"osascript\" and process.args == \"-e\"] by process.entity_id\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name in (\"sh\", \"bash\", \"zsh\") and process.args == \"-c\" and process.command_line : (\"*curl*\", \"*pbpaste*\", \"*http*\", \"*chmod*\", \"*nscurl*\")] by process.parent.entity_id\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, and\nExcel). These child processes are of...", "output": "process where event.action == \"exec\" and host.os.type == \"macos\" and\n    process.parent.name: (\n      \"Microsoft Word\",\n      \"Microsoft Outlook\",\n      \"Microsoft Excel\",\n      \"Microsoft PowerPoint\",\n      \"Microsoft OneNote\"\n    ) and\n  process.name : (\n    \"curl\",\n    \"nscurl\",\n    \"bash\",\n    \"sh\",\n    \"osascript\",\n    \"python*\",\n    \"perl*\",\n    \"mktemp\",\n    \"chmod\",\n    \"php\",\n    \"nohup\",\n    \"openssl\",\n    \"plutil\",\n    \"PlistBuddy\",\n    \"xattr\",\n    \"mktemp\",\n    \"sqlite3\",\n    \"funzip\",\n    \"popen\"\n  ) and\n\n  // Filter FPs related to product version discovery and Office error reporting behavior\n  not process.args:\n    (\n      \"ProductVersion\",\n      \"hw.model\",\n      \"ioreg\",\n      \"ProductName\",\n      \"ProductUserVisibleVersion\",\n      \"ProductBuildVersion\",\n      \"/Library/Application Support/Microsoft/MERP*/Microsoft Error Reporting.app/Contents/MacOS/Microsoft Error Reporting\",\n      \"open -a Safari *\",\n      \"defaults read *\",\n      \"sysctl hw.model*\",\n      \"ioreg -d2 -c IOPlatformExpertDevice *\",\n      \"ps aux | grep 'ToDesk_Desktop' | grep -v grep\",\n      \"PIPE=\\\"$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\"\n    ) and\n\n   not process.parent.executable :\n        (\n          \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n          \"/usr/local/Privacy-i/PISupervisor\",\n          \"/Library/Addigy/lan-cache\",\n          \"/Library/Elastic/Agent/*\",\n          \"/opt/jc/bin/jumpcloud-agent\",\n          \"/usr/sbin/networksetup\"\n        ) and\n   not (process.name : \"sh\" and process.command_line : \"*$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\") and\n\n   not process.Ext.effective_parent.executable : (\n        \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n        \"/usr/local/Privacy-i/PISupervisor\",\n        \"/Library/Addigy/auditor\",\n        \"/Library/Elastic/Agent/*\",\n        \"/opt/jc/bin/jumpcloud-agent\",\n        \"/usr/sbin/networksetup\"\n      )\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies use of Bifrost, a known macOS Kerberos pentesting tool, which can be used to dump cached Kerberos tickets or\nattempt unauthorized authentic...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.args like~ \"-action\" and (process.args like~ (\"-kerberoast\", \"askhash\", \"asktgs\", \"asktgt\", \"s4u\") or process.args like~ (\"-ticket\", \"ptt\") or process.args like~ \"dump\") and process.args like~ (\"tickets\", \"keytab\")\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the execution of macOS built-in commands to mount a Server Message Block (SMB) network share. Adversaries may\nuse valid accounts to interac...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    process.name == \"mount_smbfs\" or\n    (process.name == \"open\" and process.args like~ \"smb://*\") or\n    (process.name == \"mount\" and process.args like~ \"smbfs\") or\n    (process.name == \"osascript\" and process.command_line : \"osascript*mount volume*smb://*\")\n  ) and\n  not process.parent.executable like \"/Applications/Google Drive.app/Contents/MacOS/Google Drive\"\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects use of the systemsetup command to enable remote SSH Login.", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"systemsetup\" and\n process.args like~ \"-setremotelogin\" and \n process.args like~ \"on\" and\n process.parent.executable != null and\n not process.parent.executable like (\"/usr/local/jamf/bin/jamf\", \"/usr/libexec/xpcproxy\", \"/usr/bin/sudo\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of macOS built-in commands to connect to an existing Virtual Private Network (VPN). Adversaries\nmay use VPN connections to la...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    (process.name == \"networksetup\" and process.args like~ \"-connectpppoeservice\") or\n    (process.name == \"scutil\" and process.args like~ \"--nc\" and process.args like~ \"start\") or\n    (process.name == \"osascript\" and process.command_line : \"osascript*set VPN to service*\")\n  )\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to create a local account that will be hidden from the macOS logon window. This may indicate an\nattempt to evade user attention wh...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"dscl\" and process.args like~ \"IsHidden\" and process.args like~ \"create\" and \n process.args like~ (\"true\", \"1\", \"yes\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: An adversary can establish persistence by installing a new launch agent that executes at login by using launchd or\nlaunchctl to load a plist into the ...", "output": "sequence by host.id with maxspan=30s\n [file where host.os.type == \"macos\" and event.action == \"launch_daemon\"] by process.entity_id\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"launchctl\" and process.args == \"load\"] by process.parent.entity_id\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of osascript to create a hidden login item. This may indicate an attempt to persist a malicious\nprogram while concealing its ...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"osascript\" and\n process.command_line : \"osascript*login item*hidden:true*\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Indicates the creation or modification of a launch daemon, which adversaries may use to repeatedly execute malicious\npayloads as part of persistence.\n", "output": "sequence by host.id with maxspan=1m\n [file where host.os.type == \"macos\" and event.type != \"deletion\" and file.path : (\"/System/Library/LaunchDaemons/*\", \"/Library/LaunchDaemons/*\")]\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"launchctl\" and process.args == \"load\"]\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Authorization plugins are used to extend the authorization services API and implement mechanisms that are not natively\nsupported by the OS, such as mu...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.path like \"/Library/Security/SecurityAgentPlugins/*\" and\n  not file.path like (\"/Library/Security/SecurityAgentPlugins/KandjiPassport.bundle/*\", \"/Library/Security/SecurityAgentPlugins/TeamViewerAuthPlugin.bundle/*\") and\n  not process.name == \"shove\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to create or modify a crontab via a process that is not crontab (i.e python, osascript, etc.). This\nactivity should not be highly ...", "output": "file where host.os.type == \"macos\" and event.type != \"deletion\" and process.name != null and\n  file.path like \"/private/var/at/tabs/*\" and not process.executable == \"/usr/bin/crontab\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of a launchd child process with a hidden file. An adversary can establish persistence by\ninstalling a new logon item, launch ...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name like~ \".*\" and process.parent.name == \"launchd\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation or modification of a DirectoryService PlugIns (dsplug) file. The DirectoryService daemon\nlaunches on each system boot and auto...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.path like \"/Library/DirectoryServices/PlugIns/*.dsplug\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "An adversary can establish persistence by modifying an existing macOS dock property list in order to execute a malicious\napplication instead of the in...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like \"/Users/*/Library/Preferences/com.apple.dock.plist\" and\n ((process.name like~ (\"osascript\", \"python*\", \"sh\", \"bash\", \"zsh\", \"node\") or Effective_process.name like~ (\"osascript\", \"python*\", \"sh\", \"bash\", \"zsh\", \"node\")) or\n  (process.code_signature.exists == false or process.code_signature.trusted == false))\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation or modification of the Event Monitor Daemon (emond) rules. Adversaries may abuse this service by\nwriting a rule to execute com...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like (\"/private/etc/emond.d/rules/*.plist\", \"/etc/emon.d/rules/*.plist\", \"/private/var/db/emondClients/*\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of a suspicious child process of the Event Monitor Daemon (emond). Adversaries may abuse this\nservice by writing a rule to ex...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.parent.name == \"emond\" and\n process.name like~ (\n   \"bash\",\n   \"dash\",\n   \"sh\",\n   \"tcsh\",\n   \"csh\",\n   \"zsh\",\n   \"ksh\",\n   \"fish\",\n   \"Python\",\n   \"python*\",\n   \"perl*\",\n   \"php*\",\n   \"osascript\",\n   \"pwsh\",\n   \"curl\",\n   \"wget\",\n   \"cp\",\n   \"mv\",\n   \"touch\",\n   \"echo\",\n   \"base64\",\n   \"launchctl\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to enable the root account using the dsenableroot command. This command may be abused by adversaries\nfor persistence, as the root ...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"dsenableroot\" and \n not process.args == \"-d\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation of a hidden launch agent or daemon. An adversary may establish persistence by installing a new\nlaunch agent or daemon which ex...", "output": "file where host.os.type == \"macos\" and event.action == \"launch_daemon\" and\n  Persistence.name : \".*\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Finder Sync plugins enable users to extend Finders functionality by modifying the user interface. Adversaries may abuse\nthis feature by adding a rogu...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"pluginkit\" and\n  process.args == \"-e\" and process.args like~ \"use\" and process.args == \"-i\" and\n  (process.name like~ (\"python*\", \"node\", \"osascript\", \"bash\", \"sh\", \"zsh\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects modification of a Folder Action script. A Folder Action script is executed when the folder to which it is\nattached has items added or removed,...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.parent.name == \"com.apple.foundation.UserScriptService\" and\n ((process.name like~ (\"osascript\", \"python*\", \"tcl*\", \"node\", \"perl\", \"ruby\", \"php\")) or \n  (process.name in (\"bash\", \"csh\", \"zsh\", \"sh\") and process.args == \"-c\")) and \n not process.args like (\"/Users/*/Library/Scripts/*\", \"/Users/*/Library/Application Scripts/*\", \"/Library/Scripts/*\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies use of the Defaults command to install a login or logoff hook in MacOS. An adversary may abuse this\ncapability to establish persistence in ...", "output": "process where host.os.type == \"macos\" and event.type == \"start\" and\n process.name == \"defaults\" and process.args == \"write\" and process.args : (\"LoginHook\", \"LogoutHook\") and\n not process.args :\n       (\n         \"Support/JAMF/ManagementFrameworkScripts/logouthook.sh\",\n         \"Support/JAMF/ManagementFrameworkScripts/loginhook.sh\",\n         \"/Library/Application Support/JAMF/ManagementFrameworkScripts/logouthook.sh\",\n         \"/Library/Application Support/JAMF/ManagementFrameworkScripts/loginhook.sh\"\n       )\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Adversaries may create or modify the Sublime application plugins or scripts to execute a malicious payload each time the\nSublime application is starte...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and file.extension == \"py\" and\n  file.path like\n    (\n      \"/Users/*/Library/Application Support/Sublime Text*/Packages/*.py\",\n      \"/Applications/Sublime Text.app/Contents/MacOS/sublime.py\"\n    ) and\n  not process.executable like\n    (\n      \"/Applications/Sublime Text*.app/Contents/*\",\n      \"/usr/local/Cellar/git/*/bin/git\",\n      \"/Library/Developer/CommandLineTools/usr/bin/git\",\n      \"/usr/libexec/xpcproxy\",\n      \"/System/Library/PrivateFrameworks/DesktopServicesPriv.framework/Versions/A/Resources/DesktopServicesHelper\"\n    )\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation or modification of the default configuration for periodic tasks. Adversaries may abuse periodic\ntasks to execute malicious cod...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like (\"/private/etc/periodic/*\", \"/private/etc/defaults/periodic.conf\", \"/private/etc/periodic.conf\")\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies when a child process is spawned by the screensaver engine process, which is consistent with an attacker's\nmalicious payload being executed ...", "output": "process where host.os.type == \"macos\" and event.type == \"start\" and process.parent.name == \"ScreenSaverEngine\"\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies when a screensaver plist file is modified by an unexpected process. An adversary can maintain persistence on\na macOS endpoint by creating a...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.name like~ \"com.apple.screensaver.*.plist\" and\n   file.path like (\n      \"/Users/*/Library/Preferences/ByHost/*\",\n      \"/Library/Managed Preferences/*\",\n      \"/System/Library/Preferences/*\"\n      ) and\n  (\n    process.code_signature.trusted == false or\n    process.code_signature.exists == false or\n\n    /* common script interpreters and abused native macOS bins */\n    process.name like~ (\n      \"curl\",\n      \"mktemp\",\n      \"tail\",\n      \"funzip\",\n      \"python*\",\n      \"osascript\",\n      \"perl\"\n      )\n   ) and\n\n  /* Filter OS processes modifying screensaver plist files */\n  not process.executable like (\n    \"/usr/sbin/cfprefsd\",\n    \"/usr/libexec/xpcproxy\",\n    \"/System/Library/CoreServices/ManagedClient.app/Contents/Resources/MCXCompositor\",\n    \"/System/Library/CoreServices/ManagedClient.app/Contents/MacOS/ManagedClient\"\n    )\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies suspicious modifications of the calendar file by an unusual process. Adversaries may create a custom calendar\nnotification procedure to exe...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.path like~ \"/Users/*/Library/Calendars/*.calendar/Events/*.ics\" and\n  not process.executable like (\"/System/Library/*\", \"/System/Applications/Calendar.app/Contents/MacOS/*\", \n                               \"/System/Applications/Mail.app/Contents/MacOS/Mail\", \"/usr/libexec/xpcproxy\",\n                               \"/sbin/launchd\", \"/Applications/*\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies modifications to the Atom desktop text editor Init File. Adversaries may add malicious JavaScript code to the\ninit.coffee file that will be...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like \"/Users/*/.atom/init.coffee\" and \n not process.name like (\"Atom\", \"xpcproxy\") and \n not user.name == \"root\"\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies execution of the Apple script interpreter (osascript) without a password prompt and with administrator\nprivileges.\n", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"osascript\" and\n process.command_line : \"osascript*with administrator privileges\" and\n ((process.parent.code_signature.trusted == false or process.parent.code_signature.exists == false) or process.Ext.effective_parent.executable like (\"/tmp/*\", \"/private/tmp/*\", \"/Users/Shared/*\"))\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies execution of the security_authtrampoline process via a scripting interpreter. This occurs when programs use\nAuthorizationExecute-WithPrivil...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"security_authtrampoline\" and\n process.parent.name like~ (\"osascript\", \"com.apple.automator.runner\", \"sh\", \"bash\", \"dash\", \"zsh\", \"python*\", \"perl*\", \"php*\", \"ruby\", \"pwsh\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detects attempts to exploit privilege escalation vulnerabilities related to the Adobe Acrobat Reader\nPrivilegedHelperTool responsible for installing u...", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.parent.name like \"com.adobe.ARMDC.SMJobBlessHelper\" and\n  user.name == \"root\" and\n  not process.executable like (\"/Library/PrivilegedHelperTools/com.adobe.ARMDC.SMJobBlessHelper\",\n                               \"/usr/bin/codesign\",\n                               \"/private/var/folders/zz/*/T/download/ARMDCHammer\",\n                               \"/usr/sbin/pkgutil\",\n                               \"/usr/bin/shasum\",\n                               \"/usr/bin/perl*\",\n                               \"/usr/sbin/spctl\",\n                               \"/usr/sbin/installer\",\n                               \"/usr/bin/csrutil\")\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to add an account to the admin group via the command line. This could be an indication of privilege\nescalation activity.\n", "output": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name in (\"dscl\", \"dseditgroup\") and process.args like~ (\"/Groups/admin\", \"admin\") and process.args like (\"-a\", \"-append\") and\n not process.Ext.effective_parent.executable like (\"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfDaemon.app/Contents/MacOS/JamfDaemon\",\n                                                   \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfManagementService.app/Contents/MacOS/JamfManagementService\",\n                                                   \"/opt/jc/bin/jumpcloud-agent\",\n                                                   \"/Library/Addigy/go-agent\")\n", "source": "detection-rules/macos", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies modifications to the root crontab file. Adversaries may overwrite this file to gain code execution with root\nprivileges by exploiting privi...", "output": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like \"/private/var/at/tabs/root\" and \n not process.executable like \"/usr/bin/crontab\"\n", "source": "detection-rules/macos", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies users being added to the admin group. This could be an indication of privilege\nescalation activity.\n", "output": "configuration where host.os.type == \"macos\" and event.type == \"change\" and\n  event.action == \"od_group_add\" and group.name:\"admin\"\n", "source": "detection-rules/macos", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects Inter-Process Communication with Outlook via Component Object Model from an unusual process. Adversaries may\ntarget user email to collect sens...", "output": "sequence with maxspan=1m\n[process where host.os.type == \"windows\" and event.action == \"start\" and\n  (\n    process.name : (\n      \"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\",\n      \"cmd.exe\", \"regsvr32.exe\", \"cscript.exe\", \"wscript.exe\"\n    ) or\n    (\n      (process.code_signature.trusted == false or process.code_signature.exists == false) and\n      (process.Ext.relative_file_creation_time <= 500 or process.Ext.relative_file_name_modify_time <= 500)\n    )\n  )\n] by process.entity_id\n[process where host.os.type == \"windows\" and event.action == \"start\" and process.name : \"OUTLOOK.EXE\" and\n  process.Ext.effective_parent.name != null] by process.Ext.effective_parent.entity_id\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary\nmailbox or archive to a .pst file....", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.command_line : (\"*MailboxExportRequest*\", \"*-Mailbox*-ContentFilter*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies use of WinRar or 7z to create an encrypted files. Adversaries will often compress and encrypt data in\npreparation for exfiltration.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      process.name : (\"rar.exe\", \"WinRAR.exe\") or ?process.code_signature.subject_name == \"win.rar GmbH\" or\n      ?process.pe.original_file_name == \"WinRAR.exe\"\n    ) and\n    process.args == \"a\" and process.args : (\"-hp*\", \"-p*\", \"/hp*\", \"/p*\")\n  ) or\n  (\n    (process.name : (\"7z.exe\", \"7za.exe\") or ?process.pe.original_file_name in (\"7z.exe\", \"7za.exe\")) and\n    process.args == \"a\" and process.args : \"-p*\"\n  )\n) and\n  not process.parent.executable : (\n        \"C:\\\\Program Files\\\\*.exe\",\n        \"C:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"?:\\\\Nox\\\\bin\\\\Nox.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Nox\\\\bin\\\\Nox.exe\"\n      )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies Certreq making an HTTP Post request. Adversaries could abuse Certreq to download files or upload data to a\nremote URL.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"CertReq.exe\" or ?process.pe.original_file_name == \"CertReq.exe\") and process.args : \"-Post\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies DNS queries to known Large Language Model domains by unsigned binaries or common Windows scripting utilities.\nMalwares may leverage the cap...", "output": "network where host.os.type == \"windows\" and dns.question.name != null and\n(\n  process.name : (\"MSBuild.exe\", \"mshta.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"msiexec.exe\", \"rundll32.exe\",\n  \"bitsadmin.exe\", \"InstallUtil.exe\", \"RegAsm.exe\", \"vbc.exe\", \"RegSvcs.exe\", \"python.exe\", \"regsvr32.exe\", \"dllhost.exe\",\n  \"node.exe\", \"javaw.exe\", \"java.exe\", \"*.pif\", \"*.com\") or\n\n  ?process.code_signature.subject_name : (\"AutoIt Consulting Ltd\", \"OpenJS Foundation\", \"Python Software Foundation\") or\n\n  (\n    process.executable : (\"?:\\\\Users\\\\*.exe\", \"?:\\\\ProgramData\\\\*.exe\") and\n    (?process.code_signature.trusted == false or ?process.code_signature.exists == false)\n  )\n ) and\n    dns.question.name : (\n    // Major LLM APIs\n    \"api.openai.com\",\n    \"*.openai.azure.com\",\n    \"api.anthropic.com\",\n    \"api.mistral.ai\",\n    \"api.cohere.ai\",\n    \"api.ai21.com\",\n    \"api.groq.com\",\n    \"api.perplexity.ai\",\n    \"api.x.ai\",\n    \"api.deepseek.com\",\n    \"api.gemini.google.com\",\n    \"generativelanguage.googleapis.com\",\n    \"api.azure.com\",\n    \"api.bedrock.aws\",\n    \"bedrock-runtime.amazonaws.com\",\n\n    // Hugging Face & other ML infra\n    \"api-inference.huggingface.co\",\n    \"inference-endpoint.huggingface.cloud\",\n    \"*.hf.space\",\n    \"*.replicate.com\",\n    \"api.replicate.com\",\n    \"api.runpod.ai\",\n    \"*.runpod.io\",\n    \"api.modal.com\",\n    \"*.forefront.ai\",\n\n    // Consumer-facing AI chat portals\n    \"chat.openai.com\",\n    \"chatgpt.com\",\n    \"copilot.microsoft.com\",\n    \"bard.google.com\",\n    \"gemini.google.com\",\n    \"claude.ai\",\n    \"perplexity.ai\",\n    \"poe.com\",\n    \"chat.forefront.ai\",\n    \"chat.deepseek.com\"\n  ) and\n\n  not process.executable : (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n          \"?:\\\\Windows\\\\SystemApps\\\\Microsoft.LockApp_*\\\\LockApp.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\BraveSoftware\\\\*\\\\Application\\\\brave.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Vivaldi\\\\Application\\\\vivaldi.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera*\\\\opera.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\"\n        ) and\n    not (?process.code_signature.trusted == true and\n         ?process.code_signature.subject_name : (\"Anthropic, PBC\", \"Google LLC\", \"Mozilla Corporation\", \"Brave Software, Inc.\", \"Island Technology Inc.\", \"Opera Norway AS\"))\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Adversaries may implement command and control (C2) communications that use common web services to hide their activity.\nThis attack technique is typica...", "output": "network where host.os.type == \"windows\" and\n    dns.question.name != null and process.name != null and\n    not (?user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") or user.domain == \"NT AUTHORITY\") and\n    /* Add new WebSvc domains here */\n    dns.question.name :\n       (\n        \"raw.githubusercontent.*\",\n        \"pastebin.*\",\n        \"paste4btc.com\",\n        \"paste.ee\",\n        \"ghostbin.com\",\n        \"drive.google.com\",\n        \"?.docs.live.net\",\n        \"api.dropboxapi.*\",\n        \"content.dropboxapi.*\",\n        \"dl.dropboxusercontent.*\",\n        \"api.onedrive.com\",\n        \"*.onedrive.org\",\n        \"onedrive.live.com\",\n        \"filebin.net\",\n        \"*.ngrok.io\",\n        \"ngrok.com\",\n        \"*.portmap.*\",\n        \"*serveo.net\",\n        \"*localtunnel.me\",\n        \"*pagekite.me\",\n        \"*localxpose.io\",\n        \"*notabug.org\",\n        \"rawcdn.githack.*\",\n        \"paste.nrecom.net\",\n        \"zerobin.net\",\n        \"controlc.com\",\n        \"requestbin.net\",\n        \"slack.com\",\n        \"api.slack.com\",\n        \"slack-redir.net\",\n        \"slack-files.com\",\n        \"cdn.discordapp.com\",\n        \"discordapp.com\",\n        \"discord.com\",\n        \"apis.azureedge.net\",\n        \"cdn.sql.gg\",\n        \"?.top4top.io\",\n        \"top4top.io\",\n        \"www.uplooder.net\",\n        \"*.cdnmegafiles.com\",\n        \"transfer.sh\",\n        \"gofile.io\",\n        \"updates.peer2profit.com\",\n        \"api.telegram.org\",\n        \"t.me\",\n        \"meacz.gq\",\n        \"rwrd.org\",\n        \"*.publicvm.com\",\n        \"*.blogspot.com\",\n        \"api.mylnikov.org\",\n        \"file.io\",\n        \"stackoverflow.com\",\n        \"*files.1drv.com\",\n        \"api.anonfile.com\",\n        \"*hosting-profi.de\",\n        \"ipbase.com\",\n        \"ipfs.io\",\n        \"*up.freeo*.space\",\n        \"api.mylnikov.org\",\n        \"script.google.com\",\n        \"script.googleusercontent.com\",\n        \"api.notion.com\",\n        \"graph.microsoft.com\",\n        \"*.sharepoint.com\",\n        \"mbasic.facebook.com\",\n        \"login.live.com\",\n        \"api.gofile.io\",\n        \"api.anonfiles.com\",\n        \"api.notion.com\",\n        \"api.trello.com\",\n        \"gist.githubusercontent.com\",\n        \"files.pythonhosted.org\",\n        \"g.live.com\",\n        \"*.zulipchat.com\",\n        \"webhook.site\",\n        \"run.mocky.io\",\n        \"mockbin.org\", \n        \"www.googleapis.com\", \n        \"googleapis.com\",\n        \"global.rel.tunnels.api.visualstudio.com\",\n        \"*.devtunnels.ms\", \n        \"api.github.com\") and\n        \n    /* Insert noisy false positives here */\n    not (\n      (\n        process.executable : (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\BraveSoftware\\\\*\\\\Application\\\\brave.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera*\\\\opera.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\PowerToys\\\\PowerToys.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Vivaldi\\\\Application\\\\vivaldi.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Zen Browser\\\\zen.exe\",\n          \"?:\\\\Users\\\\*\\\\Wavesor Software\\\\WaveBrowser\\\\wavebrowser.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n          \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\", \n          \"?:\\\\Windows\\\\system32\\\\svchost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wsl.exe\", \n          \"?:\\\\Windows\\\\System32\\\\WWAHost.exe\"\n        )\n      ) or\n    \n      /* Discord App */\n      (process.name : \"Discord.exe\" and (process.code_signature.subject_name : \"Discord Inc.\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"discord.com\", \"cdn.discordapp.com\", \"discordapp.com\")\n      ) or \n\n      /* MS Sharepoint / OneDrive */\n      (process.name : (\"Microsoft.SharePoint.exe\", \"OneDrive.Sync.Service.exe\") and dns.question.name : \"onedrive.live.com\" and\n       (process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true)\n      ) or \n\n      /* Obsidian - Plugins are stored on raw.githubusercontent.com */\n      (process.name : \"Obsidian.exe\" and (process.code_signature.subject_name : \"Dynalist Inc\" and\n       process.code_signature.trusted == true) and dns.question.name : \"raw.githubusercontent.com\"\n      ) or \n\n      /* WebExperienceHostApp */\n      (process.name : \"WebExperienceHostApp.exe\" and (process.code_signature.subject_name : \"Microsoft Windows\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"onedrive.live.com\", \"skyapi.onedrive.live.com\")\n      ) or\n\n      /* IntelliJ IDEA connecting to raw.githubusercontent.com */\n      (process.code_signature.subject_name : \"JetBrains s.r.o.\" and\n       process.code_signature.trusted == true and dns.question.name : (\"api.github.com\", \"raw.githubusercontent.com\")\n      ) or \n\n      (process.code_signature.subject_name : \"Microsoft *\" and process.code_signature.trusted == true and\n       dns.question.name : (\"*.sharepoint.com\", \"graph.microsoft.com\", \"g.live.com\", \"login.live.com\")\n      ) or\n\n      (process.code_signature.subject_name : \"Python Software Foundation\" and process.code_signature.trusted == true and\n       dns.question.name : \"files.pythonhosted.org\") or \n\n      /* Zoom */\n      (process.name : \"Zoom.exe\" and (process.code_signature.subject_name : \"Zoom Video Communications, Inc.\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"www.googleapis.com\", \"graph.microsoft.com\")\n      ) or\n\n      /* VSCode */\n      (process.name : \"Code.exe\" and (process.code_signature.subject_name : \"Microsoft Corporation\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"api.github.com\", \"raw.githubusercontent.com\")\n      ) or\n\n      /* Terraform */\n      (process.name : \"terraform-provider*.exe\" and (process.code_signature.subject_name : \"HashiCorp, Inc.\" and\n       process.code_signature.trusted == true) and dns.question.name : \"graph.microsoft.com\"\n      ) or\n\n      (\n        process.code_signature.trusted == true and\n        process.code_signature.subject_name : (\n                              \"Johannes Schindelin\",\n                              \"Redis Inc.\",\n                              \"Slack Technologies, LLC\",\n                              \"Cisco Systems, Inc.\",\n                              \"Dropbox, Inc\",\n                              \"Amazon.com Services LLC\", \n                              \"Island Technology Inc.\", \n                              \"GitHub, Inc.\", \n                              \"Red Hat, Inc\",\n                              \"Mozilla Corporation\"\n        )\n      )\n    )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies DNS queries to commonly abused Top Level Domains by common LOLBINs or executable running from world writable\ndirectories or unsigned binari...", "output": "network where host.os.type == \"windows\" and dns.question.name != null and\n (\n  process.name : (\"MSBuild.exe\", \"mshta.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"msiexec.exe\", \"rundll32.exe\",\n                  \"bitsadmin.exe\", \"InstallUtil.exe\", \"python.exe\", \"regsvr32.exe\", \"dllhost.exe\", \"node.exe\",\n                  \"java.exe\", \"javaw.exe\", \"*.pif\", \"*.com\", \"*.scr\") or\n  (?process.code_signature.trusted == false or ?process.code_signature.exists == false) or\n  ?process.code_signature.subject_name : (\"AutoIt Consulting Ltd\", \"OpenJS Foundation\", \"Python Software Foundation\") or\n  ?process.executable : (\"?:\\\\Users\\\\*.exe\", \"?:\\\\ProgramData\\\\*.exe\")\n ) and\ndns.question.name regex \"\"\".*\\.(top|buzz|xyz|rest|ml|cf|gq|ga|onion|monster|cyou|quest|cc|bar|cfd|click|cam|surf|tk|shop|club|icu|pw|ws|online|fun|life|boats|store|hair|skin|motorcycles|christmas|lol|makeup|mom|bond|beauty|biz|live|work|zip|country|accountant|date|party|science|loan|win|men|faith|review|racing|download|host) \"\"\"", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This rule identifies a large number (15) of nslookup.exe executions with an explicit query type from the same host. This\nmay indicate command and cont...", "output": "sequence by host.id with maxspan=5m\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"nslookup.exe\" and process.args:(\"-querytype=*\", \"-qt=*\", \"-q=*\", \"-type=*\")] with runs = 10\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies unusual processes connecting to domains using known free SSL certificates. Adversaries may employ a known\nencryption algorithm to conceal c...", "output": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n  /* Add new free SSL certificate provider domains here */\n  dns.question.name : (\"*letsencrypt.org\", \"*.sslforfree.com\", \"*.zerossl.com\", \"*.freessl.org\") and\n\n  /* Native Windows process paths that are unlikely to have network connections to domains secured using free SSL certificates */\n  process.executable : (\"C:\\\\Windows\\\\System32\\\\*.exe\",\n                        \"C:\\\\Windows\\\\System\\\\*.exe\",\n\t                  \"C:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\explorer.exe\",\n\t\t          \"C:\\\\Windows\\\\notepad.exe\") and\n\n  /* Insert noisy false positives here */\n  not process.name : (\"svchost.exe\", \"MicrosoftEdge*.exe\", \"msedge.exe\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies the use of a browser to download a file from a remote URL and from a suspicious parent process. Adversaries\nmay use browsers to avoid ingre...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\") and\n  process.args : \"--headless*\" and\n  process.args : (\"--disable-gpu\", \"--dump-dom\", \"*http*\", \"data:text/html;base64,*\") and\n  process.parent.name :\n     (\"cmd.exe\", \"powershell.exe\", \"wscript.exe\", \"cscript.exe\", \"mshta.exe\", \"conhost.exe\", \"msiexec.exe\",\n      \"explorer.exe\", \"rundll32.exe\", \"winword.exe\", \"excel.exe\", \"onenote.exe\", \"hh.exe\", \"powerpnt.exe\", \"forfiles.exe\",\n      \"pcalua.exe\", \"wmiprvse.exe\") and\n  not process.executable : (\n        \"?:\\\\inetpub\\\\wwwroot\\\\*\\\\ext\\\\modules\\\\html2pdf\\\\bin\\\\chrome\\\\*\\\\chrome-win64\\\\chrome.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\inetpub\\\\wwwroot\\\\*\\\\ext\\\\modules\\\\html2pdf\\\\bin\\\\chrome\\\\*\\\\chrome-win64\\\\chrome.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies instances of Internet Explorer (iexplore.exe) being started via the Component Object Model (COM) making\nunusual network connections. Advers...", "output": "sequence by host.id, user.name with maxspan = 5s\n  [library where host.os.type == \"windows\" and dll.name : \"IEProxy.dll\" and process.name : (\"rundll32.exe\", \"regsvr32.exe\")]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"iexplore.exe\" and process.parent.args : \"-Embedding\"]\n  /* IE started via COM in normal conditions makes few connections, mainly to Microsoft and OCSP related domains, add FPs here */\n  [network where host.os.type == \"windows\" and network.protocol == \"dns\" and process.name : \"iexplore.exe\" and\n   not dns.question.name :\n   (\n    \"*.microsoft.com\",\n    \"*.digicert.com\",\n    \"*.msocsp.com\",\n    \"*.windowsupdate.com\",\n    \"*.bing.com\",\n    \"*.identrust.com\",\n    \"*.sharepoint.com\",\n    \"*.office365.com\",\n    \"*.office.com\"\n    )\n  ] /* with runs=5 */\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies downloads of executable and archive files via the Windows Background Intelligent Transfer Service (BITS).\nAdversaries could leverage Window...", "output": "file where host.os.type == \"windows\" and event.action == \"rename\" and\n  process.name : \"svchost.exe\" and file.Ext.original.name : \"BIT*.tmp\" and \n  (file.extension : (\"exe\", \"zip\", \"rar\", \"bat\", \"dll\", \"ps1\", \"vbs\", \"wsh\", \"js\", \"vbe\", \"pif\", \"scr\", \"cmd\", \"cpl\") or\n   file.Ext.header_bytes : \"4d5a*\") and \n \n  /* noisy paths, for hunting purposes you can use the same query without the following exclusions */\n  not file.path : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Windows\\\\*\", \"?:\\\\ProgramData\\\\*\\\\*\") and \n \n  /* lot of third party SW use BITS to download executables with a long file name */\n  not length(file.name) > 30 and\n  not file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp*\\\\wct*.tmp\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Adobe\\\\ARM\\\\*\\\\RdrServicesUpdater*.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Adobe\\\\ARM\\\\*\\\\AcroServicesUpdater*.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Docker Desktop Installer\\\\update-*.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies modifications in registry keys associated with abuse of the Outlook Home Page functionality for command and\ncontrol or persistence.\n", "output": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and registry.value : \"URL\" and\n    registry.path : (\n        \"*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Outlook\\\\Webview\\\\*\",\n        \"*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Outlook\\\\Today\\\\*\"\n    ) and registry.data.strings : (\"*://*\", \"*:\\\\*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation of a new port forwarding rule. An adversary may abuse this technique to bypass network\nsegmentation restrictions.\n", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : \"*\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\" and registry.data.strings != null\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers to\nenable routing of network pack...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* RDP port and usual SSH tunneling related switches in command line */\n  process.args : \"*:3389\" and\n  process.args : (\"-L\", \"-P\", \"-R\", \"-pw\", \"-ssh\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies known execution traces of the REMCOS Remote Access Trojan. Remcos RAT is used by attackers to perform actions on infected machines remotely...", "output": "any where host.os.type == \"windows\" and\n(\n (event.category == \"file\" and event.type == \"deletion\" and file.path like \"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\TH????.tmp\") or\n\n (event.category == \"file\" and file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\remcos\\\\logs.dat\") or\n\n (event.category == \"registry\" and\n  registry.value : (\"Remcos\", \"Rmc-??????\", \"licence\") and\n  registry.path : (\n      \"*\\\\Windows\\\\CurrentVersion\\\\Run\\\\Remcos\",\n      \"*\\\\Windows\\\\CurrentVersion\\\\Run\\\\Rmc-??????\",\n      \"*\\\\SOFTWARE\\\\Remcos-*\\\\licence\",\n      \"*\\\\Software\\\\Rmc-??????\\\\licence\"\n  )\n )\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the desktopimgdownldr utility being used to download a remote file. An adversary may use desktopimgdownldr to\ndownload arbitrary files as a...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"desktopimgdownldr.exe\" or ?process.pe.original_file_name == \"desktopimgdownldr.exe\") and\n  process.args : \"/lockscreenurl:http*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the Windows Defender configuration utility (MpCmdRun.exe) being used to download a remote file.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"MpCmdRun.exe\" or ?process.pe.original_file_name == \"MpCmdRun.exe\") and\n   process.args : \"-DownloadFile\" and process.args : \"-url\" and process.args : \"-path\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies powershell.exe being used to download an executable file from an untrusted remote destination.", "output": "sequence by process.entity_id with maxspan=30s\n[network where host.os.type == \"windows\" and \n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  network.protocol == \"dns\" and\n  not dns.question.name : (\n        \"*.microsoft.com\", \"*.azureedge.net\", \"*.powershellgallery.com\", \"*.windowsupdate.com\",\n        \"metadata.google.internal\", \"dist.nuget.org\", \"artifacts.elastic.co\", \"*.digicert.com\",\n        \"*.chocolatey.org\", \"outlook.office365.com\", \"cdn.oneget.org\", \"ci.dot.net\",\n        \"packages.icinga.com\", \"login.microsoftonline.com\", \"*.gov\", \"*.azure.com\", \"*.python.org\",\n        \"dl.google.com\", \"sensor.cloud.tenable.com\", \"*.azurefd.net\", \"*.office.net\", \"*.anac*\",\n        \"aka.ms\", \"dot.net\", \"*.visualstudio.com\", \"*.local\") and\n  not user.id == \"S-1-5-18\" and\n  /* Filter out NetBIOS/LLMNR-style names (e.g. host, localhost, etc.) */\n  dns.question.name regex \"\"\".*\\.[a-zA-Z]{2,5}\"\"\"]\n[file where host.os.type == \"windows\" and event.type == \"creation\" and\n  process.name : \"powershell.exe\" and \n  (file.extension : (\"exe\", \"dll\", \"ps1\", \"bat\") or file.Ext.header_bytes : \"4d5a*\") and\n  not file.name : \"__PSScriptPolicy*.ps1\" and\n  not file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\????????.dll\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\????????.dll\",\n        \"?:\\\\Windows\\\\TEMP\\\\ansible-tmp-*\\\\AnsiballZ*.ps1\"\n  ) and\n  not user.id == \"S-1-5-18\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies built-in Windows script interpreters (cscript.exe or wscript.exe) being used to download an executable file\nfrom a remote destination.\n", "output": "sequence by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and process.name : (\"wscript.exe\", \"cscript.exe\") and network.protocol != \"dns\" and\n   network.direction : (\"outgoing\", \"egress\") and network.type == \"ipv4\" and destination.ip != \"127.0.0.1\"\n  ]\n  [file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : (\"exe\", \"dll\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies execution of the NetSupport remote access software from non-default paths. Adversaries may abuse NetSupport\nManager to control a target vic...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"client32.exe\" or ?process.pe.original_file_name == \"client32.exe\" or process.parent.name : \"client32.exe\") and\n (\n  process.executable :\n               (\"?:\\\\Users\\\\*.exe\",\n                \"?:\\\\ProgramData\\\\*.exe\",\n                \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*.exe\",\n                \"\\\\Device\\\\HarddiskVolume?\\\\ProgramData\\\\*.exe\") or\n  ?process.parent.executable : (\"?:\\\\Users\\\\*\\\\client32.exe\", \"?:\\\\ProgramData\\\\*\\\\client32.exe\")\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious processes being spawned by the ScreenConnect client processes. This activity may indicate\nexecution abusing unauthorized access ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name :\n                (\"ScreenConnect.ClientService.exe\",\n                 \"ScreenConnect.WindowsClient.exe\",\n                 \"ScreenConnect.WindowsBackstageShell.exe\",\n                 \"ScreenConnect.WindowsFileManager.exe\") and\n  (\n   (process.name : \"powershell.exe\" and\n    process.args : (\"-enc\", \"-ec\", \"-e\", \"*downloadstring*\", \"*Reflection.Assembly*\", \"*http*\")) or\n   (process.name : \"cmd.exe\" and process.args : \"/c\") or\n   (process.name : \"net.exe\" and process.args : \"/add\") or\n   (process.name : \"schtasks.exe\" and process.args : (\"/create\", \"-create\")) or\n   (process.name : \"sc.exe\" and process.args : \"create\") or\n   (process.name : \"rundll32.exe\" and not process.args : \"url.dll,FileProtocolHandler\") or\n   (process.name : \"msiexec.exe\" and process.args : (\"/i\", \"-i\") and\n    process.args : (\"/q\", \"/quiet\", \"/qn\", \"-q\", \"-quiet\", \"-qn\", \"-Q+\")) or\n   process.name : (\"mshta.exe\", \"certutil.exe\", \"bistadmin.exe\", \"certreq.exe\", \"wscript.exe\", \"cscript.exe\", \"curl.exe\",\n                   \"ssh.exe\", \"scp.exe\", \"wevtutil.exe\", \"wget.exe\", \"wmic.exe\")\n   )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: The malware known as SUNBURST targets the SolarWind's Orion business software for command and control. This rule detects\npost-exploitation command and...", "output": "network where host.os.type == \"windows\" and event.type == \"protocol\" and network.protocol == \"http\" and\n  process.name : (\"ConfigurationWizard.exe\",\n                  \"NetFlowService.exe\",\n                  \"NetflowDatabaseMaintenance.exe\",\n                  \"SolarWinds.Administration.exe\",\n                  \"SolarWinds.BusinessLayerHost.exe\",\n                  \"SolarWinds.BusinessLayerHostx64.exe\",\n                  \"SolarWinds.Collector.Service.exe\",\n                  \"SolarwindsDiagnostics.exe\") and\n  (\n    (\n      (http.request.body.content : \"*/swip/Upload.ashx*\" and http.request.body.content : (\"POST*\", \"PUT*\")) or\n      (http.request.body.content : (\"*/swip/SystemDescription*\", \"*/swip/Events*\") and http.request.body.content : (\"GET*\", \"HEAD*\"))\n    ) and\n    not http.request.body.content : \"*solarwinds.com*\"\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies an executable or script file remotely downloaded via a TeamViewer transfer session.", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and process.name : \"TeamViewer.exe\" and\n  file.extension : (\"exe\", \"dll\", \"scr\", \"com\", \"bat\", \"ps1\", \"vbs\", \"vbe\", \"js\", \"wsh\", \"hta\") and\n  not \n  (\n    file.path : (\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\*.js\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\TeamViewer\\\\update.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\?\\\\TeamViewer\\\\update.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\TeamViewer\\\\CustomConfigs\\\\???????\\\\TeamViewer_Resource_??.dll\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\TeamViewer\\\\CustomConfigs\\\\???????\\\\TeamViewer*.exe\"\n    ) and process.code_signature.trusted == true\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies Curl for Windows making an HTTP request. Adversaries could abuse Curl to download files or upload data to a\nremote URL.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\curl.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\curl.exe\"\n  ) and\n  process.command_line : \"*http*\" and\n  process.parent.name : (\n    \"cmd.exe\", \"powershell.exe\",\n    \"rundll32.exe\", \"explorer.exe\",\n    \"conhost.exe\", \"forfiles.exe\",\n    \"wscript.exe\", \"cscript.exe\",\n    \"mshta.exe\", \"hh.exe\", \"mmc.exe\"\n  ) and \n  not (\n    ?user.id == \"S-1-5-18\" and\n    /* Don't apply the user.id exclusion to Sysmon for compatibility */\n    not event.dataset : (\"windows.sysmon_operational\", \"windows.sysmon\")\n  ) and\n  /* Exclude System Integrity Processes for Sysmon */\n  not ?winlog.event_data.IntegrityLevel == \"System\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects the execution of the VScode portable binary with the tunnel command line option indicating an attempt to\nestablish a remote tunnel session to ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : \"tunnel\" and (process.args : \"--accept-server-license-terms\" or process.name : \"code*.exe\") and\n  not (process.name == \"code-tunnel.exe\" and process.args == \"status\" and process.parent.name == \"Code.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Active Directory Integrated DNS (ADIDNS) is one of the core components of AD DS, leveraging AD's access control and\nreplication to maintain domain con...", "output": "any where host.os.type == \"windows\" and event.code == \"5137\" and\n    startsWith(winlog.event_data.ObjectDN, \"DC=*,\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of a DNS record that is potentially meant to enable WPAD spoofing. Attackers can disable the\nGlobal Query Block List (GQBL) an...", "output": "any where host.os.type == \"windows\" and event.code == \"5137\" and winlog.event_data.ObjectDN : \"DC=wpad,*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies instances where an unusual process spawns a chrome browser child process. This behavior could be related to malware\nstealing browser inform...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"chrome.exe\", \"msedge.exe\") and\n  process.parent.executable != null and process.command_line != null and\n  (\n  process.command_line :\n           (\"\\\"C:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\\\"\",\n            \"\\\"C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\"\",\n            \"\\\"C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --headless --disable-logging --log-level=3 --v=0\",\n            \"\\\"C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --headless --log-level=3\",\n            \"\\\"C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --headless\",\n            \"\\\"C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --remote-debugging-port=922? --profile-directory=\\\"Default\\\"*\",\n            \"\\\"C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --headless --restore-last-session --remote-debugging-port=45452*\") or\n\n  (process.args : \"--remote-debugging-port=922?\" and process.args : \"--window-position=-*,-*\")\n   ) and\n  not process.parent.executable :\n                         (\"C:\\\\Windows\\\\explorer.exe\",\n                          \"C:\\\\Program Files (x86)\\\\*.exe\",\n                          \"C:\\\\Program Files\\\\*.exe\",\n                          \"C:\\\\Windows\\\\System32\\\\rdpinit.exe\",\n                          \"C:\\\\Windows\\\\System32\\\\sihost.exe\",\n                          \"C:\\\\Windows\\\\System32\\\\RuntimeBroker.exe\",\n                          \"C:\\\\Windows\\\\System32\\\\SECOCL64.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies multiple consecutive logon failures targeting an Admin account from the same source address and within a\nshort time interval. Adversaries w...", "output": "sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and user.name : \"*admin*\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies multiple logon failures followed by a successful one from the same source address. Adversaries will often\nbrute force login attempts across...", "output": "sequence by winlog.computer_name, source.ip with maxspan=5s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and user.id != null and \n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and \n    not winlog.event_data.TargetUserSid : \"S-1-0-0\" and not user.id : \"S-1-0-0\" and \n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies multiple consecutive logon failures from the same source address and within a short time interval.\nAdversaries will often brute force login...", "output": "sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /*\n    noisy failure status codes often associated to authentication misconfiguration :\n     0xC000015B - The user has not been granted the requested logon type (also called the logon right) at this machine.\n     0XC000005E\t- There are currently no logon servers available to service the logon request.\n     0XC0000133\t- Clocks between DC and other computer too far out of sync.\n     0XC0000192\tAn attempt was made to logon, but the Netlogon service was not started.\n    */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=10\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of known Windows utilities often abused to dump LSASS memory or the Active Directory database\n(NTDS.dit) in preparation for c...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (?process.pe.original_file_name : \"procdump\" or process.name : \"procdump.exe\") and process.args : \"-ma\"\n  ) or\n  (\n    process.name : \"ProcessDump.exe\" and not process.parent.executable regex~ \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\Cisco Systems\\\\.* \"\"\"  ) or\n  (\n    (?process.pe.original_file_name : \"WriteMiniDump.exe\" or process.name : \"WriteMiniDump.exe\") and\n      not process.parent.executable regex~ \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\Steam\\\\.* \"\"\"  ) or\n  (\n    (?process.pe.original_file_name : \"RUNDLL32.EXE\" or process.name : \"RUNDLL32.exe\") and\n      (process.args : \"*MiniDump*\" or process.command_line : \"*comsvcs*#*24*\")\n  ) or\n  (\n    (?process.pe.original_file_name : \"RdrLeakDiag.exe\" or process.name : \"RdrLeakDiag.exe\") and\n      process.args : \"/fullmemdmp\"\n  ) or\n  (\n    (?process.pe.original_file_name : \"SqlDumper.exe\" or process.name : \"SqlDumper.exe\") and\n      process.args : \"0x01100*\") or\n  (\n    (?process.pe.original_file_name : \"TTTracer.exe\" or process.name : \"TTTracer.exe\") and\n      process.args : \"-dumpFull\" and process.args : \"-attach\") or\n  (\n    (?process.pe.original_file_name : \"ntdsutil.exe\" or process.name : \"ntdsutil.exe\") and\n      process.args : \"cr*fu*\") or\n  (\n    (?process.pe.original_file_name : \"diskshadow.exe\" or process.name : \"diskshadow.exe\") and process.args : \"/s\")\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a copy operation of the Active Directory Domain Database (ntds.dit) or Security Account Manager (SAM) files.\nThose files contain sensitive ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    ((?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\", \"XCOPY.EXE\") or process.name : (\"Cmd.Exe\", \"PowerShell.EXE\", \"XCOPY.EXE\")) and\n       process.args : (\"copy\", \"xcopy\", \"Copy-Item\", \"move\", \"cp\", \"mv\")\n    ) or\n    ((?process.pe.original_file_name : \"esentutl.exe\" or process.name : \"esentutl.exe\") and process.args : (\"*/y*\", \"*/vss*\", \"*/d*\"))\n  ) and\n  process.command_line : (\"*\\\\ntds.dit*\", \"*\\\\config\\\\SAM*\", \"*\\\\*\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy*\\\\*\", \"*/system32/config/SAM*\", \"*\\\\User Data\\\\*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windows\ncredential management. This tec...", "output": "sequence by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and (process.name : \"MSBuild.exe\" or process.pe.original_file_name == \"MSBuild.exe\")]\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : (\"vaultcli.dll\", \"SAMLib.DLL\") or file.name : (\"vaultcli.dll\", \"SAMLib.DLL\"))]\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the modification of an account's Kerberos pre-authentication options. An adversary with\nGenericWrite/GenericAll rights over the account can...", "output": "any where host.os.type == \"windows\" and event.code == \"4738\" and\n  winlog.event_data.NewUACList == \"USER_DONT_REQUIRE_PREAUTH\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Active Directory Integrated DNS (ADIDNS) is one of the core components of AD DS, leveraging AD's access control and\nreplication to maintain domain con...", "output": "any where host.os.type == \"windows\" and event.code == \"5137\" and winlog.event_data.ObjectClass == \"dnsNode\" and\n    not winlog.event_data.SubjectUserName : \"*$\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies potential relay activities against a Computer account by identifying authentication events using the computer\naccount coming from from host...", "output": "authentication where host.os.type == \"windows\" and event.code in (\"4624\", \"4625\") and\n    endswith~(user.name, \"$\") and winlog.logon.type : \"network\" and\n\n    /* Filter for a machine account that matches the hostname */\n    startswith~(host.name, substring(user.name, 0, -1)) and\n\n    /* Verify if the Source IP belongs to the host */\n    not endswith(string(source.ip), string(host.ip)) and\n    source.ip != null and source.ip != \"::1\" and source.ip != \"127.0.0.1\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects potential relay attacks by identifying coercion attempts followed by authentication events using a target\nserver's computer account, originati...", "output": "sequence by winlog.computer_name, source.ip with maxspan=5s\n\n/* Filter for an event that indicates coercion against known abused named pipes using an account that is not the host */\n[file where host.os.type == \"windows\" and event.code : \"5145\" and \n    not startswith~(winlog.computer_name, substring(user.name, 0, -1)) and\n    file.name : (\n        \"Spoolss\", \"netdfs\", \"lsarpc\", \"lsass\", \"netlogon\", \"samr\", \"efsrpc\", \"FssagentRpc\",\n        \"eventlog\", \"winreg\", \"srvsvc\", \"dnsserver\", \"dhcpserver\", \"WinsPipe\"\n    )]\n\n/* Detects a logon attempt using the Kerberos protocol resulting from the coercion coming from the same IP address */\n[authentication where host.os.type == \"windows\" and event.code in (\"4624\", \"4625\") and\n    endswith~(user.name, \"$\") and winlog.logon.type : \"network\" and\n    winlog.event_data.AuthenticationPackageName : \"Kerberos\" and\n\n    /* Filter for a machine account that matches the hostname */\n    startswith~(winlog.computer_name, substring(user.name, 0, -1)) and\n\n    /* Verify if the Source IP belongs to the host */\n    not endswith(string(source.ip), string(host.ip)) and\n    source.ip != null and source.ip != \"::1\" and source.ip != \"127.0.0.1\"]\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detects potential relay attacks by identifying coercion attempts followed by authentication events using a target\nserver's computer account, originati...", "output": "sequence by winlog.computer_name, source.ip with maxspan=5s\n\n/* Filter for an event that indicates coercion against known abused named pipes using an account that is not the host */\n[file where host.os.type == \"windows\" and event.code : \"5145\" and \n    not startswith~(winlog.computer_name, substring(user.name, 0, -1)) and\n    file.name : (\n        \"Spoolss\", \"netdfs\", \"lsarpc\", \"lsass\", \"netlogon\", \"samr\", \"efsrpc\", \"FssagentRpc\",\n        \"eventlog\", \"winreg\", \"srvsvc\", \"dnsserver\", \"dhcpserver\", \"WinsPipe\"\n    )]\n\n/* Detects a logon attempt using the NTLM protocol resulting from the coercion coming from the same IP address */\n[authentication where host.os.type == \"windows\" and event.code in (\"4624\", \"4625\") and\n    endswith~(user.name, \"$\") and winlog.logon.type : \"network\" and\n    winlog.event_data.AuthenticationPackageName : \"NTLM\" and\n\n    /* Filter for a machine account that matches the hostname */\n    startswith~(winlog.computer_name, substring(user.name, 0, -1)) and\n\n    /* Verify if the Source IP belongs to the host */\n    not endswith(string(source.ip), string(host.ip)) and\n    source.ip != null and source.ip != \"::1\" and source.ip != \"127.0.0.1\"]\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API\n(DPAPI) domain backup key from ...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.name : (\"ntds_capi_*.pfx\", \"ntds_capi_*.pvk\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"reg.exe\" or process.name : \"reg.exe\") and\n process.args : (\"save\", \"export\") and\n process.args : (\"hklm\\\\sam\", \"hklm\\\\security\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the enable of the full user-mode dumps feature system-wide. This feature allows Windows Error Reporting (WER)\nto collect data after an appl...", "output": "registry where host.os.type == \"windows\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\LocalDumps\\\\DumpType\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\LocalDumps\\\\DumpType\"\n    ) and\n    registry.data.strings : (\"2\", \"0x00000002\") and\n    not (process.executable : \"?:\\\\Windows\\\\system32\\\\svchost.exe\" and user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\"))\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies use of aspnet_regiis to decrypt Microsoft IIS connection strings. An attacker with Microsoft IIS web server\naccess via a webshell or alike ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"aspnet_regiis.exe\" or ?process.pe.original_file_name == \"aspnet_regiis.exe\") and\n  process.args : \"connectionStrings\" and process.args : \"-pdf\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the load of a DLL without a valid code signature by the Azure AD Sync process, which may indicate an attempt\nto persist or collect sensitiv...", "output": "any where host.os.type == \"windows\" and process.name : \"AzureADConnectAuthenticationAgentService.exe\" and\n(\n (event.category == \"library\" and event.action == \"load\") or\n (event.category == \"process\" and event.action : \"Image loaded*\")\n) and\n\nnot (?dll.code_signature.trusted == true or file.code_signature.status == \"Valid\") and not\n\n  (\n   /* Elastic defend DLL path */\n   ?dll.path :\n         (\"?:\\\\Windows\\\\assembly\\\\NativeImages*\",\n          \"?:\\\\Windows\\\\Microsoft.NET\\\\*\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\") or\n\n   /* Sysmon DLL path is mapped to file.path */\n   file.path :\n         (\"?:\\\\Windows\\\\assembly\\\\NativeImages*\",\n          \"?:\\\\Windows\\\\Microsoft.NET\\\\*\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\")\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies network connections to the standard Kerberos port from an unusual process. On Windows, the only process that\nnormally performs Kerberos tra...", "output": "network where host.os.type == \"windows\" and event.type == \"start\" and network.direction == \"egress\" and\n  destination.port == 88 and source.port >= 49152 and process.pid != 4 and destination.address : \"*\" and\n  not \n  (\n    process.executable : (\n        \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap\\\\nmap.exe\",\n        \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap oem\\\\nmap.exe\",\n        \"\\\\device\\\\harddiskvolume?\\\\windows\\\\system32\\\\lsass.exe\",\n        \"?:\\\\Program Files\\\\Amazon Corretto\\\\jdk1*\\\\bin\\\\java.exe\",\n        \"?:\\\\Program Files\\\\BlackBerry\\\\UEM\\\\Proxy Server\\\\bin\\\\prunsrv.exe\",\n        \"?:\\\\Program Files\\\\BlackBerry\\\\UEM\\\\Core\\\\tomcat-core\\\\bin\\\\tomcat9.exe\",\n        \"?:\\\\Program Files\\\\DBeaver\\\\dbeaver.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\com.docker.backend.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\com.docker.vpnkit.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\vpnkit.exe\",\n        \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n        \"?:\\\\Program Files\\\\Internet Explorer\\\\iexplore.exe\",\n        \"?:\\\\Program Files\\\\JetBrains\\\\PyCharm Community Edition*\\\\bin\\\\pycharm64.exe\",\n        \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n        \"?:\\\\Program Files\\\\Oracle\\\\VirtualBox\\\\VirtualBoxVM.exe\",\n        \"?:\\\\Program Files\\\\Puppet Labs\\\\Puppet\\\\puppet\\\\bin\\\\ruby.exe\",\n        \"?:\\\\Program Files\\\\rapid7\\\\nexpose\\\\nse\\\\.DLLCACHE\\\\nseserv.exe\",\n        \"?:\\\\Program Files\\\\Silverfort\\\\Silverfort AD Adapter\\\\SilverfortServer.exe\",\n        \"?:\\\\Program Files\\\\Tenable\\\\Nessus\\\\nessusd.exe\",\n        \"?:\\\\Program Files\\\\VMware\\\\VMware View\\\\Server\\\\bin\\\\ws_TomcatService.exe\",\n        \"?:\\\\Program Files (x86)\\\\Advanced Port Scanner\\\\advanced_port_scanner.exe\",\n        \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\bin\\\\dcpatchscan.exe\",\n        \"?:\\\\Program Files (x86)\\\\GFI\\\\LanGuard 12 Agent\\\\lnsscomm.exe\",\n        \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n        \"?:\\\\Program Files (x86)\\\\Internet Explorer\\\\iexplore.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeUpdate\\\\MicrosoftEdgeUpdate.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft Silverlight\\\\sllauncher.exe\",\n        \"?:\\\\Program Files (x86)\\\\Nmap\\\\nmap.exe\",\n        \"?:\\\\Program Files (x86)\\\\Nmap OEM\\\\nmap.exe\",\n        \"?:\\\\Program Files (x86)\\\\nwps\\\\NetScanTools Pro\\\\NSTPRO.exe\",\n        \"?:\\\\Program Files (x86)\\\\SAP BusinessObjects\\\\tomcat\\\\bin\\\\tomcat9.exe\",\n        \"?:\\\\Program Files (x86)\\\\SuperScan\\\\scanner.exe\",\n        \"?:\\\\Program Files (x86)\\\\Zscaler\\\\ZSATunnel\\\\ZSATunnel.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\vmnat.exe\",\n        \"?:\\\\Windows\\\\SystemApps\\\\Microsoft.MicrosoftEdge_*\\\\MicrosoftEdge.exe\",\n        \"System\"\n    ) and process.code_signature.trusted == true\n  ) and\n destination.address != \"127.0.0.1\" and destination.address != \"::1\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies queries to a DNS record containing a base64-encoded blob matching the pattern \"UWhRCA...BAAAA\". This pattern\ncorresponds to a marshaled CRE...", "output": "network where host.os.type == \"windows\" and dns.question.name : \"*UWhRC*BAAAA*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of .kirbi files. The creation of this kind of file is an indicator of an attacker running\nKerberos ticket dump utilities, such...", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : \"kirbi\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as\nunixUserPassword, ms-PKI-Account...", "output": "any where event.code == \"4662\" and\n\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n  winlog.event_data.Properties : (\n   /* unixUserPassword */\n  \"*612cb747-c0e8-4f92-9221-fdd5f15b550d*\",\n\n  /* ms-PKI-AccountCredentials */\n  \"*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*\",\n\n  /*  ms-PKI-DPAPIMasterKeys */\n  \"*b3f93023-9239-4f7c-b99c-6745d87adbc2*\",\n\n  /* msPKI-CredentialRoamingTokens */\n  \"*b7ff5a38-0818-42b0-8110-d3d154c97f24*\"\n  ) and\n\n  /*\n   Excluding noisy AccessMasks\n   0x0 undefined and 0x100 Control Access\n   https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662\n   */\n  not winlog.event_data.AccessMask in (\"0x0\", \"0x100\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious access\nrights value. This may indicate a...", "output": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* seclogon service accessing lsass */\n  winlog.event_data.CallTrace : \"*seclogon.dll*\" and process.name : \"svchost.exe\" and\n\n   /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */\n  winlog.event_data.GrantedAccess == \"0x14c0\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies LSASS loading an unsigned or untrusted DLL. Windows Security Support Provider (SSP) DLLs are loaded into\nLSSAS process at system start. Onc...", "output": "any where event.category in (\"library\", \"driver\") and host.os.type == \"windows\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  not (dll.code_signature.subject_name :\n               (\"Microsoft Windows\",\n                \"Microsoft Corporation\",\n                \"Microsoft Windows Publisher\",\n                \"Microsoft Windows Software Compatibility Publisher\",\n                \"Microsoft Windows Hardware Compatibility Publisher\",\n                \"McAfee, Inc.\",\n                \"SecMaker AB\",\n                \"HID Global Corporation\",\n                \"HID Global\",\n                \"Apple Inc.\",\n                \"Citrix Systems, Inc.\",\n                \"Dell Inc\",\n                \"Hewlett-Packard Company\",\n                \"Symantec Corporation\",\n                \"National Instruments Corporation\",\n                \"DigitalPersona, Inc.\",\n                \"Novell, Inc.\",\n                \"gemalto\",\n                \"EasyAntiCheat Oy\",\n                \"Entrust Datacard Corporation\",\n                \"AuriStor, Inc.\",\n                \"LogMeIn, Inc.\",\n                \"VMware, Inc.\",\n                \"Istituto Poligrafico e Zecca dello Stato S.p.A.\",\n                \"Nubeva Technologies Ltd\",\n                \"Micro Focus (US), Inc.\",\n                \"Yubico AB\",\n                \"GEMALTO SA\",\n                \"Secure Endpoints, Inc.\",\n                \"Sophos Ltd\",\n                \"Morphisec Information Security 2014 Ltd\",\n                \"Entrust, Inc.\",\n                \"Nubeva Technologies Ltd\",\n                \"Micro Focus (US), Inc.\",\n                \"F5 Networks Inc\",\n                \"Bit4id\",\n                \"Thales DIS CPL USA, Inc.\",\n                \"Micro Focus International plc\",\n                \"HYPR Corp\",\n                \"Intel(R) Software Development Products\",\n                \"PGP Corporation\",\n                \"Parallels International GmbH\",\n                \"FrontRange Solutions Deutschland GmbH\",\n                \"SecureLink, Inc.\",\n                \"Tidexa OU\",\n                \"Amazon Web Services, Inc.\",\n                \"SentryBay Limited\",\n                \"Audinate Pty Ltd\",\n                \"CyberArk Software Ltd.\",\n                \"McAfeeSysPrep\",\n                \"NVIDIA Corporation PE Sign v2016\",\n                \"Trend Micro, Inc.\",\n                \"Fortinet Technologies (Canada) Inc.\",\n                \"Carbon Black, Inc.\") and\n       dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\", \"errorChaining\")) and\n\n     not dll.hash.sha256 :\n                (\"811a03a5d7c03802676d2613d741be690b3461022ea925eb6b2651a5be740a4c\",\n                 \"1181542d9cfd63fb00c76242567446513e6773ea37db6211545629ba2ecf26a1\",\n                 \"ed6e735aa6233ed262f50f67585949712f1622751035db256811b4088c214ce3\",\n                 \"26be2e4383728eebe191c0ab19706188f0e9592add2e0bf86b37442083ae5e12\",\n                 \"9367e78b84ef30cf38ab27776605f2645e52e3f6e93369c674972b668a444faa\",\n                 \"d46cc934765c5ecd53867070f540e8d6f7701e834831c51c2b0552aba871921b\",\n                 \"0f77a3826d7a5cd0533990be0269d951a88a5c277bc47cff94553330b715ec61\",\n                 \"4aca034d3d85a9e9127b5d7a10882c2ef4c3e0daa3329ae2ac1d0797398695fb\",\n                 \"86031e69914d9d33c34c2f4ac4ae523cef855254d411f88ac26684265c981d95\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation of a Local Security Authority Subsystem Service (lsass.exe) default memory dump. This may\nindicate a credential access attempt...", "output": "file where host.os.type == \"windows\" and event.action != \"deletion\" and\n  file.name : (\"lsass*.dmp\", \"dumpert.dmp\", \"Andrew.dmp\", \"SQLDmpr*.mdmp\", \"Coredump.dmp\") and\n\n  not (\n        process.executable : (\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\SqlDumper.exe\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server Reporting Services\\\\SSRS\\\\ReportServer\\\\bin\\\\SqlDumper.exe\",\n          \"?:\\\\Windows\\\\System32\\\\dllhost.exe\"\n        ) and\n        file.path : (\n          \"?:\\\\*\\\\Reporting Services\\\\Logfiles\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server Reporting Services\\\\SSRS\\\\Logfiles\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\ErrorDumps\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\MSSQL\\\\LOG\\\\SQLDmpr*.mdmp\"\n        )\n      ) and\n\n  not (\n        process.executable : (\n          \"?:\\\\Windows\\\\system32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n          ) and\n        file.path : (\n          \"?:\\\\Windows\\\\System32\\\\config\\\\systemprofile\\\\AppData\\\\Local\\\\CrashDumps\\\\lsass.exe.*.dmp\",\n          \"?:\\\\Windows\\\\System32\\\\%LOCALAPPDATA%\\\\CrashDumps\\\\lsass.exe.*.dmp\"\n        )\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies access attempts to the LSASS handle, which may indicate an attempt to dump credentials from LSASS memory.\n", "output": "api where host.os.type == \"windows\" and\n  process.Ext.api.name in (\"OpenProcess\", \"OpenThread\") and Target.process.name : \"lsass.exe\" and \n  not \n  (\n    process.executable : (\n        \"?:\\\\ProgramData\\\\GetSupportService*\\\\Updates\\\\Update_*.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files (x86)\\\\Asiainfo Security\\\\OfficeScan Client\\\\NTRTScan.exe\",\n        \"?:\\\\Program Files (x86)\\\\Blackpoint\\\\SnapAgent\\\\SnapAgent.exe\",\n        \"?:\\\\Program Files (x86)\\\\CheckPoint\\\\Endpoint Security\\\\EFR\\\\EFRService.exe\",\n        \"?:\\\\Program Files (x86)\\\\CyberCNSAgent\\\\osqueryi.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\vpnagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\aciseagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\vpndownloader.exe\",\n        \"?:\\\\Program Files (x86)\\\\eScan\\\\reload.exe\",\n        \"?:\\\\Program Files (x86)\\\\Google\\\\Update\\\\GoogleUpdate.exe\",\n        \"?:\\\\Program Files (x86)\\\\Kaspersky Lab\\\\*\\\\avp.exe\",\n        \"?:\\\\Program Files (x86)\\\\microsoft intune management extension\\\\microsoft.management.services.intunewindowsagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\N-able Technologies\\\\Reactive\\\\bin\\\\NableReactiveManagement.exe\",\n        \"?:\\\\Program Files (x86)\\\\N-able Technologies\\\\Windows Agent\\\\bin\\\\agent.exe\",\n        \"?:\\\\Program Files (x86)\\\\Tanium\\\\Tanium Client\\\\TaniumClient.exe\",\n        \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*\\\\CCSF\\\\TmCCSF.exe\",\n        \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\TMASutility.exe\",\n        \"?:\\\\Program Files*\\\\Windows Defender\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files\\\\Bitdefender\\\\Endpoint Security\\\\EPSecurityService.exe\",\n        \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n        \"?:\\\\Program Files\\\\Common Files\\\\McAfee\\\\AVSolution\\\\mcshield.exe\",\n        \"?:\\\\Program Files\\\\EA\\\\AC\\\\EAAntiCheat.GameService.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\agentbeat.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\metricbeat.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\osqueryd.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\packetbeat.exe\",\n        \"?:\\\\Program Files\\\\ESET\\\\ESET Security\\\\ekrn.exe\",\n        \"?:\\\\Program Files\\\\Fortinet\\\\FortiClient\\\\FortiProxy.exe\",\n        \"?:\\\\Program Files\\\\Fortinet\\\\FortiClient\\\\FortiSSLVPNdaemon.exe\",\n        \"?:\\\\Program Files\\\\Goverlan Inc\\\\GoverlanAgent\\\\GovAgentx64.exe\",\n        \"?:\\\\Program Files\\\\Huntress\\\\HuntressAgent.exe\",\n        \"?:\\\\Program Files\\\\LogicMonitor\\\\Agent\\\\bin\\\\sbshutdown.exe\",\n        \"?:\\\\Program Files\\\\Malwarebytes\\\\Anti-Malware\\\\MBAMService.exe\",\n        \"?:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\*\\\\pmfexe.exe\", \n        \"?:\\\\Program Files\\\\Microsoft Security Client\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files\\\\Qualys\\\\QualysAgent\\\\QualysAgent.exe\",\n        \"?:\\\\Program Files\\\\smart-x\\\\controlupagent\\\\version*\\\\cuagent.exe\",\n        \"?:\\\\Program Files\\\\TDAgent\\\\ossec-agent\\\\ossec-agent.exe\",\n        \"?:\\\\Program Files\\\\Topaz OFD\\\\Warsaw\\\\core.exe\",\n        \"?:\\\\Program Files\\\\Trend Micro\\\\Deep Security Agent\\\\netagent\\\\tm_netagent.exe\",\n        \"?:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmtoolsd.exe\",\n        \"?:\\\\Program Files\\\\Windows Defender Advanced Threat Protection\\\\MsSense.exe\",\n        \"?:\\\\Program Files\\\\Wise\\\\Wise Memory Optimizer\\\\WiseMemoryOptimzer.exe\",\n        \"?:\\\\Windows\\\\AdminArsenal\\\\PDQDeployRunner\\\\*\\\\exec\\\\Sysmon64.exe\",\n        \"?:\\\\Windows\\\\Sysmon.exe\",\n        \"?:\\\\Windows\\\\Sysmon64.exe\",\n        \"?:\\\\Windows\\\\System32\\\\csrss.exe\",\n        \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n        \"?:\\\\Windows\\\\System32\\\\RtkAudUService64.exe\",\n        \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\tenable_mw_scan_142a90001fb65e0beb1751cc8c63edd0.exe\"\n    ) and not ?process.code_signature.trusted == false\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies potential relay attacks against a machine account by identifying network share access events coming from a\nremote source.ip but using the t...", "output": "file where event.code == \"5145\" and endswith(user.name, \"$\") and\n\n /* compare computername with user.name and make sure they match */\n startswith~(winlog.computer_name, substring(user.name, 0, -1)) and\n\n /* exclude local access */\n not endswith(string(source.ip), string(host.ip)) and\n source.ip != \"::\" and source.ip != null and source.ip != \"::1\" and source.ip != \"127.0.0.1\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the password log file from the default Mimikatz memssp module.", "output": "file where host.os.type == \"windows\" and file.name : \"mimilsa.log\" and process.name : \"lsass.exe\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to modify the WDigest security provider in the registry to force the user's password to be stored in\nclear text in memory. This be...", "output": "registry where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and\n    registry.value : \"UseLogonCredential\" and\n    registry.path : \"*\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\SecurityProviders\\\\WDigest\\\\UseLogonCredential\" and\n    registry.data.strings : (\"1\", \"0x00000001\") and\n    not (process.executable : \"?:\\\\Windows\\\\System32\\\\svchost.exe\" and user.id : \"S-1-5-18\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation or modification of a medium-size registry hive file on a Server Message Block (SMB) share, which\nmay indicate an exfiltration ...", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n /* regf file header */\n file.Ext.header_bytes : \"72656766*\" and file.size >= 30000 and\n process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-1-*\") and\n not file.path : (\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT\",\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT.LASTGOODLOAD\",\n    \"?:\\\\*\\\\UPM_Profile\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\UsrClass.dat*\",\n    \"?:\\\\Windows\\\\Netwrix\\\\Temp\\\\????????.???.offreg\",\n    \"?:\\\\*\\\\AppData\\\\Local\\\\Packages\\\\Microsoft.*\\\\Settings\\\\settings.dat*\"\n )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon\nprovider module for persistence and...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.data.strings : \"?*\" and registry.value : \"ProviderPath\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\"\n  ) and\n  /* Excluding default NetworkProviders RDPNP, LanmanWorkstation and webclient. */\n  not (\n    user.id : \"S-1-5-18\" and\n    registry.data.strings : (\n        \"%SystemRoot%\\\\System32\\\\ntlanman.dll\",\n        \"%SystemRoot%\\\\System32\\\\drprov.dll\",\n        \"%SystemRoot%\\\\System32\\\\davclnt.dll\",\n        \"%SystemRoot%\\\\System32\\\\vmhgfs.dll\",\n        \"?:\\\\Program Files (x86)\\\\Citrix\\\\ICA Client\\\\x64\\\\pnsson.dll\",\n        \"?:\\\\Program Files\\\\Dell\\\\SARemediation\\\\agent\\\\DellMgmtNP.dll\",\n        \"?:\\\\Program Files (x86)\\\\CheckPoint\\\\Endpoint Connect\\\\\\\\epcgina.dll\"\n    )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious access to an LSASS handle via DuplicateHandle from an unknown call trace module. This may indicate\nan attempt to bypass the NtOp...", "output": "process where host.os.type == \"windows\" and event.code == \"10\" and\n\n /* LSASS requesting DuplicateHandle access right to another process */\n process.name : \"lsass.exe\" and winlog.event_data.GrantedAccess == \"0x40\" and\n\n /* call is coming from an unknown executable region */\n winlog.event_data.CallTrace : \"*UNKNOWN*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies attempts to access sensitive registry hives which contain credentials from the registry backup folder.", "output": "file where host.os.type == \"windows\" and\n event.action == \"open\" and event.outcome == \"success\" and process.executable != null and \n file.path :\n      (\"?:\\\\Windows\\\\System32\\\\config\\\\RegBack\\\\SAM\",\n       \"?:\\\\Windows\\\\System32\\\\config\\\\RegBack\\\\SECURITY\",\n       \"?:\\\\Windows\\\\System32\\\\config\\\\RegBack\\\\SYSTEM\") and \n not (\n    user.id == \"S-1-5-18\" and process.executable : (\n        \"?:\\\\Windows\\\\system32\\\\taskhostw.exe\", \"?:\\\\Windows\\\\system32\\\\taskhost.exe\"\n    ))\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies attempt to coerce a local NTLM authentication via HTTP using the Windows Printer Spooler service as a target.\nAn adversary may use this pri...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"rundll32.exe\" and\n\n  /* Rundll32 WbeDav Client  */\n  process.args : (\"?:\\\\Windows\\\\System32\\\\davclnt.dll,DavSetCookie\", \"?:\\\\Windows\\\\SysWOW64\\\\davclnt.dll,DavSetCookie\") and\n\n  /* Access to named pipe via http */\n  process.args : (\"http*/print/pipe/*\", \"http*/pipe/spoolss\", \"http*/pipe/srvsvc\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies remote access to the registry to potentially dump credential data from the Security Account Manager (SAM)\nregistry hive in preparation for ...", "output": "file where host.os.type == \"windows\" and\n  event.action == \"creation\" and process.name : \"svchost.exe\" and\n  file.Ext.header_bytes : \"72656766*\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and file.size >= 30000 and\n  file.path : (\"?:\\\\Windows\\\\system32\\\\*.tmp\", \"?:\\\\WINDOWS\\\\Temp\\\\*.tmp\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected\napplications, and networks. An...", "output": "sequence by winlog.computer_name, winlog.process.pid with maxspan=1s\n\n /* 2 consecutive vault reads from same pid for web creds */\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n  not winlog.event_data.Resource : \"http://localhost/\"]\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n  not winlog.event_data.Resource : \"http://localhost/\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected\napplications, and networks. An...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name:\"vaultcmd.exe\" or process.name:\"vaultcmd.exe\") and\n  process.args:\"/list*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious renamed COMSVCS.DLL Image Load, which exports the MiniDump function that can be used to dump a\nprocess memory. This may indicate...", "output": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type == \"windows\" and event.category == \"process\" and\n    process.name : \"rundll32.exe\"]\n [process where host.os.type == \"windows\" and event.category == \"process\" and event.dataset : \"windows.sysmon_operational\" and event.code == \"7\" and\n   (file.pe.original_file_name : \"COMSVCS.DLL\" or file.pe.imphash : \"EADBCCBB324829ACB5F2BBE87E5549A8\") and\n    /* renamed COMSVCS */\n    not file.name : \"COMSVCS.DLL\"]\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies access attempts to LSASS handle, this may indicate an attempt to dump credentials from Lsass memory.\n", "output": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n  not winlog.event_data.GrantedAccess :\n                (\"0x1000\", \"0x1400\", \"0x101400\", \"0x101000\", \"0x101001\", \"0x100000\", \"0x100040\", \"0x3200\", \"0x40\", \"0x3200\") and\n  not process.name : (\"procexp64.exe\", \"procmon.exe\", \"procexp.exe\", \"Microsoft.Identity.AadConnect.Health.AadSync.Host.ex\") and\n  not process.executable : (\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\platform\\\\*\",\n        \"?:\\\\ProgramData\\\\WebEx\\\\webex\\\\*\",\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n        \"?:\\\\Windows\\\\LTSvc\\\\LTSVC.exe\",\n        \"?:\\\\Windows\\\\Sysmon.exe\",\n        \"?:\\\\Windows\\\\Sysmon64.exe\",\n        \"C:\\\\Windows\\\\CynetMS.exe\",\n        \"?:\\\\Windows\\\\system32\\\\csrss.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lsm.exe\",\n        \"?:\\\\Windows\\\\system32\\\\MRT.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\wmiprvse.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wininit.exe\",\n        \"?:\\\\Windows\\\\SystemTemp\\\\GUM*.tmp\\\\GoogleUpdate.exe\",\n        \"?:\\\\Windows\\\\sysWOW64\\\\wbem\\\\wmiprvse.exe\",\n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlplus.exe\",\n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlldr.exe\",\n        \"d:\\\\oracle\\\\product\\\\19\\\\dbhome1\\\\bin\\\\ORACLE.EXE\",\n        \"C:\\\\wamp\\\\bin\\\\apache\\\\apache*\\\\bin\\\\httpd.exe\",\n        \"C:\\\\Windows\\\\system32\\\\netstat.exe\",\n        \"C:\\\\PROGRA~1\\\\INFORM~1\\\\apps\\\\jdk\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"C:\\\\PROGRA~2\\\\CyberCNSAgentV2\\\\osqueryi.exe\",\n        \"C:\\\\Utilityw2k19\\\\packetbeat\\\\packetbeat.exe\",\n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco AnyConnect Secure Mobility Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\",\n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco Secure Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\"\n  ) and\n  not winlog.event_data.CallTrace : (\"*mpengine.dll*\", \"*appresolver.dll*\", \"*sysmain.dll*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both export\nthe MiniDumpWriteDump method ...", "output": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/\n  winlog.event_data.CallTrace : (\"*dbghelp*\", \"*dbgcore*\") and\n\n   /* case of lsass crashing */\n  not process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n      )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an\nattempt to exfiltrate credentia...", "output": "sequence by winlog.computer_name, winlog.event_data.SubjectLogonId with maxspan=1m\n [iam where event.action == \"logged-in-special\"  and\n  winlog.event_data.PrivilegeList : \"SeBackupPrivilege\" and\n\n  /* excluding accounts with existing privileged access */\n  not winlog.event_data.PrivilegeList : \"SeDebugPrivilege\"]\n [any where event.code == \"5145\" and winlog.event_data.RelativeTargetName : \"winreg\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the creation of symbolic links to a shadow copy. Symbolic links can be used to access files in the shadow\ncopy, including sensitive files s...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (\n    (?process.pe.original_file_name in (\"Cmd.Exe\",\"PowerShell.EXE\")) or\n    (process.name : (\"cmd.exe\", \"powershell.exe\"))\n ) and\n\n /* Create Symbolic Link to Shadow Copies */\n process.args : (\"*mklink*\", \"*SymbolicLink*\") and process.command_line : (\"*HarddiskVolumeShadowCopy*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies potential credential decrypt operations by PowerShell or unsigned processes using the Veeam.Backup.Common.dll\nlibrary. Attackers can use Ve...", "output": "library where host.os.type == \"windows\" and event.action == \"load\" and\n  (dll.name : \"Veeam.Backup.Common.dll\" or dll.pe.original_file_name : \"Veeam.Backup.Common.dll\") and\n  (\n    process.code_signature.trusted == false or\n    process.code_signature.exists == false or\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies commands that can access and decrypt Veeam credentials stored in MSSQL databases. Attackers can use Veeam\nCredentials to target backups as ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    (process.name : \"sqlcmd.exe\" or ?process.pe.original_file_name : \"sqlcmd.exe\") or\n    process.args : (\"Invoke-Sqlcmd\", \"Invoke-SqlExecute\", \"Invoke-DbaQuery\", \"Invoke-SqlQuery\")\n  ) and\n  process.args : \"*[VeeamBackup].[dbo].[Credentials]*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS\nprocess instance. This may indi...", "output": "process where host.os.type == \"windows\" and event.code:\"4688\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the execution of wbadmin to access the NTDS.dit file in a domain controller. Attackers with privileges from\ngroups like Backup Operators ca...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"wbadmin.exe\" or ?process.pe.original_file_name : \"wbadmin.exe\") and\n     process.args : \"recovery\" and process.command_line : \"*ntds.dit*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to dump Wireless saved access keys in clear text using the Windows built-in utility Netsh.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"netsh.exe\" or ?process.pe.original_file_name == \"netsh.exe\") and\n  process.args : \"wlan\" and process.args : \"key*clear\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Adversaries can add the 'hidden' attribute to files to hide them from the user in an attempt to evade detection.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"attrib.exe\" or ?process.pe.original_file_name == \"ATTRIB.EXE\") and process.args : \"+h\" and\n  not (process.parent.name: \"cmd.exe\" and process.command_line: \"attrib  +R +H +S +A *.cui\") and\n\n  not (\n    process.parent.name: \"draw.io.exe\" and\n    (\n      process.command_line : (\"*drawio.bkp*\", \"*drawio.dtmp*\")\n    )\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of the Antimalware Scan Interface (AMSI) DLL in an unusual location. This may indicate an\nattempt to bypass AMSI by loading a ...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.path != null and\n  file.name : (\"amsi.dll\", \"amsi\") and \n  event.action != \"A process changed a file creation time\" and \n  not file.path : (\n    \"?:\\\\$SysReset\\\\CloudImage\\\\Package_for_RollupFix*\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\system32\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\Syswow64\\\\amsi.dll\",\n    \"?:\\\\$WINDOWS.~BT\\\\*\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\CbsTemp\\\\*\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*\",\n    \"?:\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\", \n    \"?:\\\\Windows\\\\servicing\\\\*\\\\amsi.dll\",\n    \"\\\\\\\\?\\\\Volume{*}\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\", \n    \"\\\\\\\\?\\\\Volume{*}\\\\Windows\\\\system32\\\\amsi.dll\", \n    \"\\\\\\\\?\\\\Volume{*}\\\\Windows\\\\syswow64\\\\amsi.dll\",\n\n    /* Crowdstrike specific exclusion as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\system32\\\\amsi.dll\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\syswow64\\\\amsi.dll\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\$SysReset\\\\CloudImage\\\\Package_for_RollupFix*\\\\amsi.dll\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\$WINDOWS.~BT\\\\*\\\\amsi.dll\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*\\\\amsi.dll\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\CbsTemp\\\\*\\\\amsi.dll\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\servicing\\\\*\\\\amsi.dll\"\n  ) \n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies modifications of the AmsiEnable registry key to 0, which disables the Antimalware Scan Interface (AMSI). An\nadversary can modify this key t...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"AmsiEnable\" and registry.data.strings: (\"0\", \"0x00000000\")\n\n  /*\n    Full registry key path omitted due to data source variations:\n    HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows Script\\\\Settings\\\\AmsiEnable\"\n  */\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised\naccount to conceal the actions u...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\")\n  ) and\n  (\n    process.args : \"*Clear-History*\" or\n    (process.args : (\"*Remove-Item*\", \"rm\") and process.args : (\"*ConsoleHost_history.txt*\", \"*(Get-PSReadlineOption).HistorySavePath*\")) or\n    (process.args : \"*Set-PSReadlineOption*\" and process.args : \"*SaveNothing*\")\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to clear or disable Windows event log stores using Windows wevetutil command. This is often done by\nattackers in an attempt to eva...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (process.name : \"wevtutil.exe\" or ?process.pe.original_file_name == \"wevtutil.exe\") and\n    process.args : (\"/e:false\", \"cl\", \"clear-log\")\n  ) or\n  (\n    (\n      process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n      ?process.pe.original_file_name in (\"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\")\n    ) and\n    process.args : \"Clear-EventLog\"\n  )\n)\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies attempts to disable/modify the code signing policy through system native utilities. Code signing provides\nauthenticity on a program, and gr...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name: \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and process.args: (\"-set\", \"/set\") and \n  process.args: (\"TESTSIGNING\", \"nointegritychecks\", \"loadoptions\", \"DISABLE_INTEGRITY_CHECKS\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to disable the code signing policy through the registry. Code signing provides authenticity on a\nprogram, and grants the user with...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value: \"BehaviorOnFailedVerify\" and registry.data.strings : (\"0\", \"0x00000000\", \"1\", \"0x00000001\") and \n  not process.executable : \n                      (\"?:\\\\Windows\\\\System32\\\\svchost.exe\", \n                       \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n                       \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\system32\\\\svchost.exe\", \n                       \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\CCM\\\\CcmExec.exe\")\n  /*\n    Full registry key path omitted due to data source variations:\n    \"HKEY_USERS\\\\*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Driver Signing\\\\BehaviorOnFailedVerify\"\n  */\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious child processes of communications apps, which can indicate a potential masquerading as the\ncommunication app or the exploitation...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n not process.executable : \n             (\"?:\\\\Program Files\\\\*.exe\", \n              \"?:\\\\Program Files (x86)\\\\*.exe\", \n              \"?:\\\\Windows\\\\System32\\\\WerFault.exe\", \n              \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\") and \n  (\n    /* Slack */\n    (process.parent.name : \"slack.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Island\\\\Island\\\\Application\\\\Island.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Zoom\\\\bin*\\\\Zoom.exe\",\n            \"?:\\\\Windows\\\\System32\\\\rundll32.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Windows\\\\System32\\\\notepad.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\opera.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Slack Technologies, Inc.\",\n            \"Slack Technologies, LLC\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"powershell.exe\" and process.command_line : \"powershell.exe -c Invoke-WebRequest -Uri https://slackb.com/*\") or\n          (process.name : \"cmd.exe\" and process.command_line : \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /d /s /c \\\"%windir%\\\\System32\\\\rundll32.exe User32.dll,SetFocus 0\\\"\")\n        )\n      )\n    ) or\n\n    /* WebEx */\n    (process.parent.name : (\"CiscoCollabHost.exe\", \"WebexHost.exe\") and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\opera.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Cisco Systems, Inc.\",\n            \"Cisco WebEx LLC\",\n            \"Cisco Systems Inc.\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Teams */\n    (process.parent.name : \"Teams.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Windows\\\\BrowserCore\\\\BrowserCore.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\", \n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\current\\\\Teams.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Microsoft Corporation\",\n            \"Microsoft 3rd Party Application Component\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"taskkill.exe\" and process.args : \"Teams.exe\")\n        )\n      )\n    ) or\n\n    /* Discord */\n    (process.parent.name : \"Discord.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Windows\\\\System32\\\\reg.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\reg.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Discord Inc.\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.name : \"cmd.exe\" and\n          (\n            process.command_line : (\n              \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /d /s /c \\\"chcp\\\"\",\n              \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /q /d /s /c \\\"C:\\\\Program^ Files\\\\NVIDIA^ Corporation\\\\NVSMI\\\\nvidia-smi.exe\\\"\"\"            ) or\n            process.args : (\n              \"C:\\\\WINDOWS/System32/nvidia-smi.exe\",\n              \"C:\\\\WINDOWS\\\\System32\\\\nvidia-smi.exe\",\n              \"C:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository/*/nvidia-smi.exe*\"\n            )\n          )\n        )\n      )\n    ) or\n\n    /* WhatsApp */\n    (process.parent.name : \"Whatsapp.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Windows\\\\System32\\\\reg.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\reg.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"WhatsApp LLC\",\n            \"WhatsApp, Inc\",\n            \"24803D75-212C-471A-BC57-9EF86AB91435\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"cmd.exe\" and process.command_line : \"C:\\\\Windows\\\\system32\\\\cmd.exe /d /s /c \\\"C:\\\\Windows\\\\system32\\\\wbem\\\\wmic.exe*\")\n        )\n      )\n    ) or\n\n    /* Zoom */\n    (process.parent.name : \"Zoom.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Island\\\\Island\\\\Application\\\\Island.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Zoom Video Communications, Inc.\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Thunderbird */\n    (process.parent.name : \"thunderbird.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Windows\\\\splwow64.exe\", \n            \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*.EXE\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Mozilla Corporation\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation or modification of a local trusted root certificate in Windows. The install of a malicious root\ncertificate would allow an att...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Blob\" and\n  registry.path :\n    (\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\"\n    ) and\n  not process.executable : (\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\ProgramData\\\\bomgar-*\\\\*\\\\sra-pin.exe\",\n          \"?:\\\\ProgramData\\\\bomgar-*\\\\*\\\\bomgar-scc.exe\",\n          \"?:\\\\ProgramData\\\\CTES\\\\Ctes.exe\",\n          \"?:\\\\ProgramData\\\\CTES\\\\Components\\\\SNG\\\\AbtSngSvc.exe\",\n          \"?:\\\\ProgramData\\\\CTES\\\\Components\\\\SVC\\\\CtesHostSvc.exe\",\n          \"?:\\\\ProgramData\\\\Lenovo\\\\Vantage\\\\Addins\\\\LenovoHardwareScanAddin\\\\*\\\\LdeApi.Server.exe\",\n          \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptionsPlus\\\\Plugins\\\\64\\\\certmgr.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\*.exe\",\n          \"?:\\\\ProgramData\\\\Quest\\\\KACE\\\\modules\\\\clientidentifier\\\\clientidentifier.exe\",\n          \"?:\\\\ProgramData\\\\Sophos\\\\AutoUpdate\\\\Cache\\\\sophos_autoupdate1.dir\\\\*.exe\",\n          \"?:\\\\ProgramData\\\\tychoncloud\\\\bin\\\\OVAL\\\\tvs.exe\",\n          \"?:\\\\Windows\\\\CCM\\\\CcmEval.exe\",\n          \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n          \"?:\\\\Windows\\\\ccmsetup\\\\autoupgrade\\\\ccmsetup*.exe\",\n          \"?:\\\\Windows\\\\ccmsetup\\\\cache\\\\ccmsetup.exe\",\n          \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\",\n          \"?:\\\\Windows\\\\Cluster\\\\clussvc.exe\",\n          \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe\",\n          \"?:\\\\Windows\\\\Lenovo\\\\ImController\\\\PluginHost86\\\\Lenovo.Modern.ImController.PluginHost.Device.exe\",\n          \"?:\\\\Windows\\\\Lenovo\\\\ImController\\\\Service\\\\Lenovo.Modern.ImController.exe\",\n          \"?:\\\\Windows\\\\Sysmon.exe\",\n          \"?:\\\\Windows\\\\Sysmon64.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\WaaSMedicAgent.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\Packages\\\\Preview\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*.exe\"\n  ) and\n  not\n  (\n    process.executable : (\n      \"?:\\\\Windows\\\\System32\\\\*.exe\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\*.exe\"\n    ) and\n    not process.name : (\n        \"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\", \"cmd.exe\", \"expand.exe\",\n        \"regsvr32.exe\", \"cscript.exe\", \"wscript.exe\", \"wmiprvse.exe\", \"certutil.exe\", \"xcopy.exe\"\n    )\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies modifications to the Windows Defender registry settings to disable the service or set the service to be\nstarted manually.\n", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  (\n    (\n      registry.path: (\n        \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\"\n      ) and\n      registry.data.strings: (\"1\", \"0x00000001\")\n   ) or\n   (\n      registry.path: (\n        \"HKLM\\\\System\\\\*ControlSet*\\\\Services\\\\WinDefend\\\\Start\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\System\\\\*ControlSet*\\\\Services\\\\WinDefend\\\\Start\"\n      ) and\n      registry.data.strings in (\"3\", \"4\", \"0x00000003\", \"0x00000004\")\n   )\n  ) and\n\n  not\n    (\n      process.executable : (\n          \"?:\\\\WINDOWS\\\\system32\\\\services.exe\",\n          \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n          \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\NTRmv.exe\"\n      ) and user.id : \"S-1-5-18\"\n    )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies modifications to the Windows Defender configuration settings using PowerShell to add exclusions at the folder\ndirectory or process level.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or ?process.pe.original_file_name in (\"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\")) and\n  process.args : (\"*Add-MpPreference*\", \"*Set-MpPreference*\") and\n  process.args : (\"*-Exclusion*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies use of the fsutil.exe to delete the volume USNJRNL. This technique is used by attackers to eliminate evidence\nof files created during post-...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or ?process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"deletejournal\" and process.args : \"usn\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the attempt to disable Network-Level Authentication (NLA) via registry modification. Network Level\nAuthentication (NLA) is a feature on Win...", "output": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and registry.value : \"UserAuthentication\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\"\n  ) and registry.data.strings :  (\"0\", \"0x00000000\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to disable PowerShell Script Block Logging via registry modification. Attackers may disable this\nlogging to conceal their activiti...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n    registry.value : \"EnableScriptBlockLogging\" and\n    registry.data.strings : (\"0\", \"0x00000000\") and\n    not process.executable : (\n          \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\DeviceEnroller.exe\",\n          \"?:\\\\Windows\\\\system32\\\\omadmclient.exe\",\n          \"?:\\\\Program Files (x86)\\\\N-able Technologies\\\\AutomationManagerAgent\\\\AutomationManager.AgentService.exe\",\n          \n          /* Crowdstrike specific exclusion as it uses NT Object paths */\n          \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\svchost.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\DeviceEnroller.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\system32\\\\omadmclient.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\N-able Technologies\\\\AutomationManagerAgent\\\\AutomationManager.AgentService.exe\"\n    )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies use of the netsh.exe to disable or weaken the local firewall. Attackers will use this command line tool to\ndisable the firewall during trou...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"netsh.exe\" and\n  (\n    (process.args : \"disable\" and process.args : \"firewall\" and process.args : \"set\") or\n    (process.args : \"advfirewall\" and process.args : \"off\" and process.args : \"state\")\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies use of the Set-MpPreference PowerShell command to disable or weaken certain Windows Defender settings.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\")\n  ) and\n  process.args : \"Set-MpPreference\" and process.args : (\"-Disable*\", \"Disabled\", \"NeverSend\", \"-Exclusion*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies attempts to disable EventLog via the logman Windows utility, PowerShell, or auditpol. This is often done by\nattackers in an attempt to evad...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (process.name:\"logman.exe\" or ?process.pe.original_file_name == \"Logman.exe\") and\n    process.args : \"EventLog-*\" and process.args : (\"stop\", \"delete\")\n  ) or\n  (\n    (\n      process.name : (\"pwsh.exe\", \"powershell.exe\", \"powershell_ise.exe\") or\n      ?process.pe.original_file_name in (\"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\")\n    ) and\n\t  process.args : \"Set-Service\" and process.args: \"EventLog\" and process.args : \"Disabled\"\n  )  or\n  (\n    (process.name:\"auditpol.exe\" or ?process.pe.original_file_name == \"AUDITPOL.EXE\") and process.args : \"/success:disable\"\n  )\n)\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies when a user enables DNS-over-HTTPS. This can be used to hide internet activity or the process of exfiltrating\ndata. With this enabled, an o...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Edge\\\\BuiltInDnsClientEnabled\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"*\\\\SOFTWARE\\\\Google\\\\Chrome\\\\DnsOverHttpsMode\" and\n  registry.data.strings : \"secure\") or\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Mozilla\\\\Firefox\\\\DNSOverHTTPS\" and\n  registry.data.strings : (\"1\", \"0x00000001\"))\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies executions of .NET compilers with suspicious parent processes, which can indicate an attacker's attempt to\ncompile code after delivery in o...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"csc.exe\", \"vbc.exe\") and\n  process.parent.name : (\"wscript.exe\", \"mshta.exe\", \"cscript.exe\", \"wmic.exe\", \"svchost.exe\", \"rundll32.exe\", \"cmstp.exe\", \"regsvr32.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies use of the network shell utility (netsh.exe) to enable inbound Remote Desktop Protocol (RDP) connections in\nthe Windows Firewall.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"netsh.exe\" or ?process.pe.original_file_name == \"netsh.exe\") and\n process.args : (\"localport=3389\", \"RemoteDesktop\", \"group=\\\"remote desktop\\\"\") and\n process.args : (\"action=allow\", \"enable=Yes\", \"enable\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies use of the netsh.exe program to enable host discovery via the network. Attackers can use this command-line\ntool to weaken the host firewall...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.name : \"netsh.exe\" and\nprocess.args : (\"firewall\", \"advfirewall\") and process.args : \"group=Network Discovery\" and process.args : \"enable=Yes\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies unusual instances of Control Panel with suspicious keywords or paths in the process command line value.\nAdversaries may abuse control.exe t...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and\n  process.command_line : (\n    \"*.jpg*\", \"*.png*\",\n    \"*.gif*\", \"*.bmp*\",\n    \"*.jpeg*\", \"*.TIFF*\",\n    \"*.inf*\", \"*.cpl:*/*\",\n    \"*../../..*\",\n    \"*/AppData/Local/*\",\n    \"*:\\\\Users\\\\Public\\\\*\",\n    \"*\\\\AppData\\\\Local\\\\*\"\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies abuse of the Windows Update Auto Update Client (wuauclt.exe) to load an arbitrary DLL. This behavior is used\nas a defense evasion technique...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name == \"wuauclt.exe\" or process.name : \"wuauclt.exe\") and\n   /* necessary windows update client args to load a dll */\n   process.args : \"/RunHandlerComServer\" and process.args : \"/UpdateDeploymentProvider\" and\n   /* common paths writeable by a standard user where the target DLL can be placed */\n   process.args : (\"C:\\\\Users\\\\*.dll\", \"C:\\\\ProgramData\\\\*.dll\", \"C:\\\\Windows\\\\Temp\\\\*.dll\", \"C:\\\\Windows\\\\Tasks\\\\*.dll\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: An instance of MSBuild, the Microsoft Build Engine, was started by Excel or Word. This is unusual behavior for the Build\nEngine and could have been ca...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"eqnedt32.exe\",\n                         \"excel.exe\",\n                         \"fltldr.exe\",\n                         \"msaccess.exe\",\n                         \"mspub.exe\",\n                         \"outlook.exe\",\n                         \"powerpnt.exe\",\n                         \"winword.exe\" )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows Management\nInstrumentation) subsystem. This behavior i...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"explorer.exe\", \"wmiprvse.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: An instance of MSBuild, the Microsoft Build Engine, was started after being renamed. This is uncommon behavior and may\nindicate an attempt to run unno...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name == \"MSBuild.exe\" and\n  not process.name : \"MSBuild.exe\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies an instance of a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking\nstarting after being renamed or from ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"WinWord.exe\", \"EXPLORER.EXE\", \"w3wp.exe\", \"DISM.EXE\") or\n    ?process.pe.original_file_name : (\"WinWord.exe\", \"EXPLORER.EXE\", \"w3wp.exe\", \"DISM.EXE\")\n  ) and\n  not process.executable : (\n          \"\\\\\\\\?\\\\Volume{????????-????-????-????-????????????}\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n          \"?:\\\\PROGRA~?\\\\MICROS~?\\\\Office??\\\\winword.exe\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\*\\\\winword.exe\",\n          \"?:\\\\Program Files\\\\Microsoft Office ??\\\\*\\\\winword.exe\",\n          \"?:\\\\Program Files\\\\WindowsApps\\\\Microsoft.Office.Desktop.*\\\\Office??\\\\winword.exe\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\*\\\\winword.exe\",\n          \"?:\\\\Program Files (x86)\\\\Windows Kits\\\\*Assessment and Deployment Kit\\\\Deployment Tools\\\\amd64\\\\DISM\\\\dism.exe\",\n          \"?:\\\\Windows\\\\explorer.exe\",\n          \"?:\\\\Windows\\\\System32\\\\Dism.exe\",\n          \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\Dism.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\explorer.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\"\n  ) and\n  /* Crowdstrike specific exclusion as it uses NT Object paths */\n  not\n  (\n    data_stream.dataset == \"crowdstrike.fdr\" and\n    process.executable : (\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Microsoft Office\\\\*\\\\winword.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Microsoft Office ??\\\\*\\\\winword.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\WindowsApps\\\\Microsoft.Office.Desktop.*\\\\Office??\\\\winword.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Microsoft Office\\\\*\\\\winword.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Windows Kits\\\\10\\\\Assessment and Deployment Kit\\\\Deployment Tools\\\\amd64\\\\DISM\\\\dism.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\explorer.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\Dism.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\Dism.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\explorer.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\"\n    )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious execution of the Microsoft Antimalware Service Executable (MsMpEng.exe) from non-standard paths or\nrenamed instances. This may i...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (process.pe.original_file_name == \"MsMpEng.exe\" and not process.name : \"MsMpEng.exe\") or\n  (\n    process.name : \"MsMpEng.exe\" and\n    not process.executable : (\n            \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n            \"?:\\\\Program Files\\\\Windows Defender\\\\*.exe\",\n            \"?:\\\\Program Files (x86)\\\\Windows Defender\\\\*.exe\",\n            \"?:\\\\Program Files\\\\Microsoft Security Client\\\\*.exe\",\n            \"?:\\\\Program Files (x86)\\\\Microsoft Security Client\\\\*.exe\",\n\n            /* Crowdstrike specific exclusion as it uses NT Object paths */\n            \"\\\\Device\\\\HarddiskVolume*\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n            \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Windows Defender\\\\*.exe\",\n            \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Windows Defender\\\\*.exe\",\n            \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Microsoft Security Client\\\\*.exe\",\n            \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Microsoft Security Client\\\\*.exe\"\n    )\n  )\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Masquerading can allow an adversary to evade defenses and better blend in with the environment. One way it occurs is\nwhen the name or location of a fi...", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : \"exe\" and\n  file.name regex~ \"\"\".*\\.(vbs|vbe|bat|js|cmd|wsh|ps1|pdf|docx?|xlsx?|pptx?|txt|rtf|gif|jpg|png|bmp|hta|txt|img|iso)\\.exe\"\"\" and\n  not (\n      process.executable : (\n          \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\msiexec.exe\",\n          \"*\\\\Users\\\\*\\\\QGIS_SCCM\\\\Files\\\\QGIS-OSGeo4W-*-Setup-x86_64.exe\"\n      ) and\n      file.path : (\"?:\\\\Program Files\\\\QGIS *\\\\apps\\\\grass\\\\*.exe\", \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\QGIS *\\\\apps\\\\grass\\\\*.exe\")\n  ) and \n  not process.executable : \n                             (\"C:\\\\Program Files\\\\dotnet\\\\dotnet.exe\", \n                              \"C:\\\\Program Files\\\\Microsoft Visual Studio\\\\*.exe\",\n                              \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\dotnet\\\\dotnet.exe\", \n                              \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Microsoft Visual Studio\\\\*.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies process execution from suspicious default Windows directories. This is sometimes done by adversaries to hide\nmalware in trusted paths.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* add suspicious execution paths here */\n  process.executable : (\n    \"?:\\\\PerfLogs\\\\*.exe\", \"?:\\\\Users\\\\Public\\\\*.exe\", \"?:\\\\Windows\\\\Tasks\\\\*.exe\",\n    \"?:\\\\Intel\\\\*.exe\", \"?:\\\\AMD\\\\Temp\\\\*.exe\", \"?:\\\\Windows\\\\AppReadiness\\\\*.exe\",\n    \"?:\\\\Windows\\\\ServiceState\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\IdentityCRL\\\\*.exe\",\n    \"?:\\\\Windows\\\\Branding\\\\*.exe\", \"?:\\\\Windows\\\\csc\\\\*.exe\", \"?:\\\\Windows\\\\DigitalLocker\\\\*.exe\",\n    \"?:\\\\Windows\\\\en-US\\\\*.exe\", \"?:\\\\Windows\\\\wlansvc\\\\*.exe\", \"?:\\\\Windows\\\\Prefetch\\\\*.exe\",\n    \"?:\\\\Windows\\\\Fonts\\\\*.exe\", \"?:\\\\Windows\\\\diagnostics\\\\*.exe\", \"?:\\\\Windows\\\\TAPI\\\\*.exe\",\n    \"?:\\\\Windows\\\\INF\\\\*.exe\", \"?:\\\\Windows\\\\System32\\\\Speech\\\\*.exe\", \"?:\\\\windows\\\\tracing\\\\*.exe\",\n    \"?:\\\\windows\\\\IME\\\\*.exe\", \"?:\\\\Windows\\\\Performance\\\\*.exe\", \"?:\\\\windows\\\\intel\\\\*.exe\",\n    \"?:\\\\windows\\\\ms\\\\*.exe\", \"?:\\\\Windows\\\\dot3svc\\\\*.exe\", \"?:\\\\Windows\\\\panther\\\\*.exe\",\n    \"?:\\\\Windows\\\\RemotePackages\\\\*.exe\", \"?:\\\\Windows\\\\OCR\\\\*.exe\", \"?:\\\\Windows\\\\appcompat\\\\*.exe\",\n    \"?:\\\\Windows\\\\apppatch\\\\*.exe\", \"?:\\\\Windows\\\\addins\\\\*.exe\", \"?:\\\\Windows\\\\Setup\\\\*.exe\",\n    \"?:\\\\Windows\\\\Help\\\\*.exe\", \"?:\\\\Windows\\\\SKB\\\\*.exe\", \"?:\\\\Windows\\\\Vss\\\\*.exe\",\n    \"?:\\\\Windows\\\\Web\\\\*.exe\", \"?:\\\\Windows\\\\servicing\\\\*.exe\", \"?:\\\\Windows\\\\CbsTemp\\\\*.exe\",\n    \"?:\\\\Windows\\\\Logs\\\\*.exe\", \"?:\\\\Windows\\\\WaaS\\\\*.exe\", \"?:\\\\Windows\\\\ShellExperiences\\\\*.exe\",\n    \"?:\\\\Windows\\\\ShellComponents\\\\*.exe\", \"?:\\\\Windows\\\\PLA\\\\*.exe\", \"?:\\\\Windows\\\\Migration\\\\*.exe\",\n    \"?:\\\\Windows\\\\debug\\\\*.exe\", \"?:\\\\Windows\\\\Cursors\\\\*.exe\", \"?:\\\\Windows\\\\Containers\\\\*.exe\",\n    \"?:\\\\Windows\\\\Boot\\\\*.exe\", \"?:\\\\Windows\\\\bcastdvr\\\\*.exe\", \"?:\\\\Windows\\\\assembly\\\\*.exe\",\n    \"?:\\\\Windows\\\\TextInput\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\SchCache\\\\*.exe\", \"?:\\\\Windows\\\\Resources\\\\*.exe\", \"?:\\\\Windows\\\\rescache\\\\*.exe\",\n    \"?:\\\\Windows\\\\Provisioning\\\\*.exe\", \"?:\\\\Windows\\\\PrintDialog\\\\*.exe\", \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.exe\",\n    \"?:\\\\Windows\\\\media\\\\*.exe\", \"?:\\\\Windows\\\\Globalization\\\\*.exe\", \"?:\\\\Windows\\\\L2Schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\LiveKernelReports\\\\*.exe\", \"?:\\\\Windows\\\\ModemLogs\\\\*.exe\",\n    \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.exe\"\n  ) and\n  \n  not process.name : (\n    \"SpeechUXWiz.exe\", \"SystemSettings.exe\", \"TrustedInstaller.exe\",\n    \"PrintDialog.exe\", \"MpSigStub.exe\", \"LMS.exe\", \"mpam-*.exe\"\n  ) and\n  not process.executable :\n            (\"?:\\\\Intel\\\\Wireless\\\\WUSetupLauncher.exe\",\n             \"?:\\\\Intel\\\\Wireless\\\\Setup.exe\",\n             \"?:\\\\Intel\\\\Move Mouse.exe\",\n             \"?:\\\\windows\\\\Panther\\\\DiagTrackRunner.exe\",\n             \"?:\\\\Windows\\\\servicing\\\\GC64\\\\tzupd.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\RemoteLite.exe\",\n             \"?:\\\\Users\\\\Public\\\\IBM\\\\ClientSolutions\\\\*.exe\",\n             \"?:\\\\Users\\\\Public\\\\Documents\\\\syspin.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\FileWatcher.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies registry write modifications to hide an encoded portable executable. This could be indicative of adversary\ndefense evasion by avoiding the ...", "output": "registry where host.os.type == \"windows\" and\n/* update here with encoding combinations */\n registry.data.strings : \"TVqQAAMAAAAEAAAA*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies when Internet Information Services (IIS) HTTP Logging is disabled on a server. An attacker with IIS server\naccess via a webshell or other m...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"appcmd.exe\" or ?process.pe.original_file_name == \"appcmd.exe\") and\n  process.args : \"/dontLog*:*True\" and\n  not process.parent.name : \"iissetup.exe\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies abuse of the Console Window Host (conhost.exe) to execute commands via proxy. This behavior is used as a defense\nevasion technique to blend...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : \"conhost.exe\" and process.args : \"--headless\" and\n  process.command_line : (\"*powershell*\", \"*cmd *\", \"*cmd.exe *\", \"*script*\", \"*mshta*\", \"*curl *\", \"*curl.exe *\", \"*^*^*^*\", \"*.bat*\", \"*.cmd*\", \"*schtasks*\", \"*@SSL*\", \"*http*\", \"* \\\\\\\\*\", \"*.vbs*\", \"*.js*\", \"*mhsta*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects attempts to execute a command via the forfiles Windows utility. Adversaries may use this utility to proxy\nexecution via a trusted parent proce...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"forfiles.exe\" or ?process.pe.original_file_name == \"forfiles.exe\") and process.args : (\"/c\", \"-c\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies attempts to execute commands via proxy using the Windows OpenSSH client. This may indicate an attempt to bypass\napplication control via tru...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : (\"ssh.exe\", \"sftp.exe\") and\n process.command_line : (\"*Command=*powershell*\", \"*schtasks*\", \"*Command=*@echo off*\", \"*Command=*http*\", \"*Command=*mshta*\",  \"*Command=*msiexec*\",\n                          \"*Command=*cmd /c*\", \"*Command=*cmd.exe*\", \"*Command=\\\"cmd /c*\", \"*LocalCommand=scp*&&*\", \"*LocalCommand=?scp*&&*\", \"*Command=*script*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "An instance of MSBuild, the Microsoft Build Engine, created a thread in another process. This technique is sometimes\nused to evade detection or elevat...", "output": "process where host.os.type == \"windows\" and\n  event.provider == \"Microsoft-Windows-Sysmon\" and\n  /* CreateRemoteThread */\n  event.code == \"8\" and process.name: \"MSBuild.exe\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil is\noften leveraged by adversarie...", "output": "/* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */\n\nsequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"installutil.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"installutil.exe\" and network.direction : (\"outgoing\", \"egress\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "An adversary can use the Windows command line debugging utility cdb.exe to execute commands or shellcode. This rule\nlooks for those instances and wher...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"CDB.Exe\" or process.name : \"cdb.exe\") and\n  process.args : (\"-cf\", \"-c\", \"-pd\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"?:\\\\Program Files\\\\*\\\\cdb.exe\",\n\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\*\\\\cdb.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "LSA protecton is provided to prevent nonprotected processes from reading memory and injecting code. This feature provides added security for the crede...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.data.strings != null and registry.value : \"RunAsPPL\" and\n  registry.path : \"*\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\RunAsPPL\" and\n  not registry.data.strings : (\"1\", \"0x00000001\", \"2\", \"0x00000002\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "A suspicious Endpoint Security parent process was detected. This may indicate a process hollowing or other form of code\ninjection.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"esensor.exe\", \"elastic-endpoint.exe\") and\n  process.parent.executable != null and\n  process.args != null and\n  /* add FPs here */\n  not process.parent.executable : (\n        \"?:\\\\Program Files\\\\Elastic\\\\*\",\n        \"?:\\\\Windows\\\\System32\\\\services.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n        \"?:\\\\Windows\\\\explorer.exe\"\n  ) and\n  not (\n    process.parent.executable : (\n        \"?:\\\\Windows\\\\System32\\\\cmd.exe\",\n        \"?:\\\\Windows\\\\System32\\\\SecurityHealthHost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\SecurityHealth\\\\*\\\\SecurityHealthHost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\"\n    ) and\n    process.args : (\n        \"test\", \"version\",\n        \"top\", \"run\",\n        \"*help\", \"status\",\n        \"upgrade\", \"/launch\",\n        \"/enable\", \"/av\"\n    )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies executables with names resembling legitimate business applications but lacking signatures from the original\ndeveloper. Attackers may trick ...", "output": "process where host.os.type == \"windows\" and\n  event.type == \"start\" and process.executable : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\" and\n  not process.code_signature.status : (\"errorCode_endpoint*\", \"errorUntrustedRoot\", \"errorChaining\") and\n  (\n    /* Slack */\n    (process.name : \"*slack*.exe\" and not\n      (process.code_signature.subject_name in (\n        \"Slack Technologies, Inc.\",\n        \"Slack Technologies, LLC\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* WebEx */\n    (process.name : \"*webex*.exe\" and not\n      (process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Teams */\n    (process.name : \"teams*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Discord */\n    (process.name : \"*discord*.exe\" and not\n      (process.code_signature.subject_name == \"Discord Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* WhatsApp */\n    (process.name : \"*whatsapp*.exe\" and not\n      (process.code_signature.subject_name in (\n        \"WhatsApp LLC\",\n        \"WhatsApp, Inc\",\n        \"24803D75-212C-471A-BC57-9EF86AB91435\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* Zoom */\n    (process.name : (\"*zoom*installer*.exe\", \"*zoom*setup*.exe\", \"zoom.exe\")  and not\n      (process.code_signature.subject_name == \"Zoom Video Communications, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Outlook */\n    (process.name : \"*outlook*.exe\" and not\n      (\n        (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) or\n        (\n          process.name: \"MSOutlookHelp-PST-Viewer.exe\" and process.code_signature.subject_name == \"Aryson Technologies Pvt. Ltd\" and\n          process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Thunderbird */\n    (process.name : \"*thunderbird*.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Grammarly */\n    (process.name : \"*grammarly*.exe\" and not\n      (process.code_signature.subject_name == \"Grammarly, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Dropbox */\n    (process.name : \"*dropbox*.exe\" and not\n      (process.code_signature.subject_name == \"Dropbox, Inc\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Tableau */\n    (process.name : \"*tableau*.exe\" and not\n      (process.code_signature.subject_name == \"Tableau Software LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Google Drive */\n    (process.name : \"*googledrive*.exe\" and not\n      (process.code_signature.subject_name == \"Google LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* MSOffice */\n    (process.name : \"*office*setup*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Okta */\n    (process.name : \"*okta*.exe\" and not\n      (process.code_signature.subject_name == \"Okta, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* OneDrive */\n    (process.name : \"*onedrive*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Chrome */\n    (process.name : \"*chrome*.exe\" and not\n      (process.code_signature.subject_name in (\"Google LLC\", \"Google Inc\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Firefox */\n    (process.name : \"*firefox*.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Edge */\n    (process.name : (\"*microsoftedge*.exe\", \"*msedge*.exe\") and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Brave */\n    (process.name : \"*brave*.exe\" and not\n      (process.code_signature.subject_name == \"Brave Software, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* GoogleCloud Related Tools */\n    (process.name : \"*GoogleCloud*.exe\" and not\n      (process.code_signature.subject_name == \"Google LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Github Related Tools */\n    (process.name : \"*github*.exe\" and not\n      (process.code_signature.subject_name == \"GitHub, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Notion */\n    (process.name : \"*notion*.exe\" and not\n      (process.code_signature.subject_name == \"Notion Labs, Inc.\" and process.code_signature.trusted == true)\n    )\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious instances of communications apps, both unsigned and renamed ones, that can indicate an attempt to\nconceal malicious activity, by...", "output": "process where host.os.type == \"windows\" and\n  event.type == \"start\" and\n  (\n    /* Slack */\n    (process.name : \"slack.exe\" and not\n      (process.code_signature.subject_name : (\n        \"Slack Technologies, Inc.\",\n        \"Slack Technologies, LLC\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* WebEx */\n    (process.name : \"WebexHost.exe\" and not\n      (process.code_signature.subject_name : (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Teams */\n    (process.name : \"Teams.exe\" and not\n      (process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Discord */\n    (process.name : \"Discord.exe\" and not\n      (process.code_signature.subject_name : \"Discord Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* RocketChat */\n    (process.name : \"Rocket.Chat.exe\" and not\n      (process.code_signature.subject_name : \"Rocket.Chat Technologies Corp.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Mattermost */\n    (process.name : \"Mattermost.exe\" and not\n      (process.code_signature.subject_name : \"Mattermost, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* WhatsApp */\n    (process.name : \"WhatsApp.exe\" and not\n      (process.code_signature.subject_name : (\n        \"WhatsApp LLC\",\n        \"WhatsApp, Inc\",\n        \"24803D75-212C-471A-BC57-9EF86AB91435\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* Zoom */\n    (process.name : \"Zoom.exe\" and not\n      (process.code_signature.subject_name : \"Zoom Video Communications, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Outlook */\n    (process.name : \"outlook.exe\" and not\n      (process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Thunderbird */\n    (process.name : \"thunderbird.exe\" and not\n      (process.code_signature.subject_name : \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies renamed Automation Script Interpreter process. Malware written as an AutoIt/AutoHotKey script tends to rename\nthe main executable to avoid ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   (process.pe.original_file_name : \"AutoIt*.exe\" and not process.name : \"AutoIt*.exe\") or\n   (process.pe.original_file_name == \"AutoHotkey.exe\" and not process.name : (\"AutoHotkey*.exe\", \"InternalAHK.exe\")) or\n   (process.pe.original_file_name == \"KIX32.EXE\" and not process.name : \"KIX*.exe\" and process.executable : (\"?:\\\\Users\\\\*.exe\", \"?:\\\\ProgramData\\\\*.exe\", \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*.exe\", \"\\\\Device\\\\HarddiskVolume*\\\\ProgramData\\\\*.exe\"))\n   )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "A suspicious WerFault child process was detected, which may indicate an attempt to run via the SilentProcessExit\nregistry key manipulation. Verify pro...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n\n  process.parent.name : \"WerFault.exe\" and\n\n  /* args -s and -t used to execute a process via SilentProcessExit mechanism */\n  (process.parent.args : \"-s\" and process.parent.args : \"-t\" and process.parent.args : \"-c\") and\n\n  not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\Initcrypt.exe\", \"?:\\\\Program Files (x86)\\\\Heimdal\\\\Heimdal.Guard.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies execution from a directory masquerading as the Windows Program Files directories. These paths are trusted and\nusually host trusted third pa...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"C:\\\\*Program*Files*\\\\*.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\*Program*Files*\\\\*.exe\"\n  ) and\n  not process.executable : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Users\\\\*.exe\",\n        \"?:\\\\ProgramData\\\\*.exe\",\n        \"?:\\\\Windows\\\\Downloaded Program Files\\\\*.exe\",\n        \"?:\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?FilesOpera*\\\\*.exe\",\n        \"?:\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?Files?(x86)Opera*\\\\*.exe\"\n  ) and\n  not (\n    /* Crowdstrike specific exclusion as it uses NT Object paths */\n    event.dataset == \"crowdstrike.fdr\" and\n      process.executable : (\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\ProgramData\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\Downloaded Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?FilesOpera*\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?Files?(x86)Opera*\\\\*.exe\"\n      )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious instances of the Windows Error Reporting process (WerFault.exe or Wermgr.exe) with matching\ncommand-line and process executable ...", "output": "sequence by host.id, process.entity_id with maxspan = 5s\n  [process where host.os.type == \"windows\" and event.type:\"start\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and\n    (process.args_count == 1 and\n      /* Excludes bug where a missing closing quote sets args_count to 1 despite extra args */\n      not process.command_line regex~ \"\"\"\\\".*\\.exe[^\\\"].*\"\"\")]\n  [network where host.os.type == \"windows\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and network.protocol != \"dns\" and\n    network.direction : (\"outgoing\", \"egress\") and destination.ip !=\"::1\" and destination.ip !=\"127.0.0.1\"\n  ]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies when one or more features on Microsoft Defender are disabled. Adversaries may disable or tamper with\nMicrosoft Defender features to evade d...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and process.executable != null and\n  (\n    (\n      registry.value : (\n        \"PUAProtection\", \"DisallowExploitProtectionOverride\", \"TamperProtection\", \"EnableControlledFolderAccess\",\n        \"SpynetReporting\", \"SubmitSamplesConsent\"\n      ) and registry.data.strings : (\"0\", \"0x00000000\")\n    ) or\n    (\n      registry.value : (\n        \"DisableAntiSpyware\", \"DisableRealtimeMonitoring\", \"DisableIntrusionPreventionSystem\", \"DisableScriptScanning\",\n        \"DisableIOAVProtection\", \"DisableEnhancedNotifications\", \"DisableBlockAtFirstSeen\", \"DisableBehaviorMonitoring\"\n      ) and registry.data.strings : (\"1\", \"0x00000001\")\n    )\n  ) and\n  not process.executable : (\n    \"?:\\\\Windows\\\\system32\\\\svchost.exe\", \n    \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\", \n    \"?:\\\\Windows\\\\System32\\\\DeviceEnroller.exe\", \n    \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\tmuninst.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\system32\\\\svchost.exe\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\CCM\\\\CcmExec.exe\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\DeviceEnroller.exe\", \n    \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\tmuninst.exe\"\n  )\n\n/*\n    Full registry key paths omitted due to data source variations:\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableRealtimeMonitoring\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIntrusionPreventionSystem\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableScriptScanning\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIOAVProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Reporting\\\\DisableEnhancedNotifications\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\DisableBlockAtFirstSeen\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableBehaviorMonitoring\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\PUAProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender Security Center\\\\App and Browser protection\\\\DisallowExploitProtectionOverride\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Features\\\\TamperProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Windows Defender Exploit Guard\\\\Controlled Folder Access\\\\EnableControlledFolderAccess\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SpynetReporting\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SubmitSamplesConsent\"\n*/\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Binaries signed with trusted digital certificates can execute on Windows systems protected by digital signature\nvalidation. Adversaries may use these ...", "output": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n                 event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n    not cidrmatch(destination.ip,\n      \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\",\n      \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\",\n      \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n      \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\", \"FF00::/8\")]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Adversaries may modify file or directory ownership to evade access control lists (ACLs) and access protected files.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   (process.name : \"icacls.exe\" and process.args : \"/reset\") or\n   (process.name : \"takeown.exe\" and process.args : \"/f\") or\n   (process.name : \"icacls.exe\" and process.args : \"/grant\" and process.args : \"Everyone:F\")\n   ) and\n   process.command_line : \"*.exe *C:\\\\Windows\\\\*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Microsoft Office Products offer options for users and developers to control the security settings for running and using\nMacros. Adversaries may abuse ...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n    registry.value : (\"AccessVBOM\", \"VbaWarnings\") and\n    registry.data.strings : (\"0x00000001\", \"1\")\n\n/*\n    Full registry key paths omitted due to data source variations:\n    \"HKCU\\\\S-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\"\n    \"HKCU\\\\S-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\"\n*/\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies MsBuild.exe making outbound network connections. This may indicate adversarial activity as MsBuild is often\nleveraged by adversaries to exe...", "output": "sequence by process.entity_id with maxspan=30s\n\n  /* Look for MSBuild.exe process execution */\n  /* The events for this first sequence may be noisy, consider adding exceptions */\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    (\n      process.pe.original_file_name: \"MSBuild.exe\" or\n      process.name: \"MSBuild.exe\"\n    ) and\n    not user.id == \"S-1-5-18\"]\n\n  /* Followed by a network connection to an external address */\n  /* Exclude domains that are known to be benign */\n  [network where host.os.type == \"windows\" and\n    event.action: (\"connection_attempted\", \"lookup_requested\") and\n    (\n      process.pe.original_file_name: \"MSBuild.exe\" or\n      process.name: \"MSBuild.exe\"\n    ) and\n    not user.id == \"S-1-5-18\" and\n    not cidrmatch(destination.ip, \"127.0.0.1\", \"::1\") and\n    not dns.question.name : (\n      \"localhost\",\n      \"dc.services.visualstudio.com\",\n      \"vortex.data.microsoft.com\",\n      \"api.nuget.org\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies Mshta.exe making outbound network connections. This may indicate adversarial activity, as Mshta is often\nleveraged by adversaries to execut...", "output": "sequence by process.entity_id with maxspan=10m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     not process.parent.name : \"Microsoft.ConfigurationManagement.exe\" and\n     not (process.parent.executable : \"C:\\\\Amazon\\\\Amazon Assistant\\\\amazonAssistantService.exe\" or\n          process.parent.executable : \"C:\\\\TeamViewer\\\\TeamViewer.exe\") and\n     not process.args : \"ADSelfService_Enroll.hta\"]\n  [network where host.os.type == \"windows\" and process.name : \"mshta.exe\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies Mshta.exe spawning a suspicious child process. This may indicate adversarial activity, as Mshta is often\nleveraged by adversaries to execut...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"mshta.exe\" and\n (\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"certutil.exe\", \"bitsadmin.exe\", \"curl.exe\", \"msiexec.exe\", \"schtasks.exe\", \"reg.exe\", \"wscript.exe\", \"rundll32.exe\") or\n  process.executable : (\"C:\\\\Users\\\\*\\\\*.exe\", \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\*.exe\")\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of an MsiExec service child process followed by network or dns lookup activity. Adversaries may\nabuse Windows Installers for ...", "output": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type == \"windows\" and event.type : \"start\" and\n  process.parent.name : \"msiexec.exe\" and process.parent.args : \"/v\" and\n  not process.executable :\n        (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n         \"?:\\\\Windows\\\\sysWOW64\\\\msiexec.exe\",\n         \"?:\\\\Windows\\\\system32\\\\srtasks.exe\",\n         \"?:\\\\Windows\\\\syswow64\\\\srtasks.exe\",\n         \"?:\\\\Windows\\\\sys*\\\\taskkill.exe\",\n         \"?:\\\\Program Files\\\\*.exe\",\n         \"?:\\\\Program Files (x86)\\\\*.exe\",\n         \"?:\\\\Windows\\\\Installer\\\\MSI*.tmp\",\n         \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\RegSvcs.exe\",\n         \"C:\\\\Windows\\\\System32\\\\regsvr32.exe\",\n         \"C:\\\\Windows\\\\Sys?????\\\\certutil.exe\",\n         \"C:\\\\Windows\\\\System32\\\\WerFault.exe\",\n         \"C:\\\\Windows\\\\System32\\\\wevtutil.exe\",\n         \"C:\\\\Windows\\\\SysWOW64\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\") and\n not (process.name : (\"rundll32.exe\", \"regsvr32.exe\", \"powershell.exe\", \"regasm.exe\", \"wscript.exe\") and process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\")) and\n not (?process.code_signature.subject_name : (\"Bruno Software Inc\", \"Proton AG\", \"Axis Communications AB\", \"Citrix Systems, Inc.\", \"NSUS Limited\", \"Action1 Corporation\", \"Solarwinds Worldwide, LLC\") and\n      ?process.code_signature.trusted == true) and\n not (?process.pe.original_file_name in (\"dxsetup.exe\", \"MofCompiler.exe\", \"ShellApp.exe\") and\n      ?process.code_signature.subject_name : \"Microsoft Corporation\" and ?process.code_signature.trusted == true) and\n not ?process.hash.sha256 in (\"cfaef8c711db04d6c4a4381c66ac21b9e234e57febedb77fedc9316898b214bc\",\n                              \"2f26f37cce780ca76f0dbac0de233f4c8d84c31b3f37380b9d5faacc3ee2d03e\",\n                              \"7d9c691bfbf3beb78919dfd940fa6d325c3437425d5b0371df39aef6accf858d\")\n ]\n[network where host.os.type == \"windows\" and process.name != null and\n not dns.question.name : (\"core.bdec.microsoft.com\", \"go.microsoft.com\", \"ocsp.digicert.com\", \"localhost\", \"www.google-analytics.com\",\n                          \"ocsp.verisign.com\", \"*.symcb.com\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to install a file from a remote server using MsiExec. Adversaries may abuse Windows Installers for initial access and delivery of ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"msiexec.exe\" and process.args : (\"-i\", \"/i\") and process.command_line : \"*http*\" and\n  process.args : (\"/qn\", \"-qn\", \"-q\", \"/q\", \"/quiet\") and\n  process.parent.name : (\"sihost.exe\", \"explorer.exe\", \"cmd.exe\", \"wscript.exe\", \"mshta.exe\", \"powershell.exe\", \"wmiprvse.exe\", \"pcalua.exe\", \"forfiles.exe\", \"conhost.exe\") and\n  not process.command_line : (\"*--set-server=*\", \"*UPGRADEADD=*\" , \"*--url=*\",\n                              \"*USESERVERCONFIG=*\", \"*RCTENTERPRISESERVER=*\", \"*app.ninjarmm.com*\", \"*zoom.us/client*\",\n                              \"*SUPPORTSERVERSTSURI=*\", \"*START_URL=*\", \"*AUTOCONFIG=*\", \"*awscli.amazonaws.com*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveraged\nby adversaries to execute mal...", "output": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies network activity from unexpected system applications. This may indicate adversarial activity as these\napplications are often leveraged by a...", "output": "sequence by process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n\n     /* known applocker bypasses */\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      process.name : \"MSBuild.exe\" or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      process.name : \"wscript.exe\" or\n      process.name : \"msiexec.exe\" or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\") and\n\n  not (process.name : \"mshta.exe\" and\n       process.parent.executable : (\"C:\\\\Program Files (x86)\\\\Bentley\\\\*.exe\",\n                                    \"C:\\\\Program Files\\\\Bentley\\\\*.exe\",\n                                    \"C:\\\\Program Files (x86)\\\\Amazon\\\\Amazon Assistant\\\\amazonAssistantService.exe\",\n                                    \"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\TeamViewer\\\\TeamViewer.exe\"))\n  ]\n  [network where dns.question.name != null and\n      not dns.question.name : (\"localhost\", \"setup.officetimeline.com\", \"us.deployment.endpoint.ingress.rapid7.com\", \n        \"ctldl.windowsupdate.com\", \"crl?.digicert.com\", \"ocsp.digicert.com\", \"addon-cms-asl.eu.goskope.com\", \"crls.ssl.com\", \n        \"evcs-ocsp.ws.symantec.com\", \"s.symcd.com\", \"s?.symcb.com\", \"crl.verisign.com\", \"oneocsp.microsoft.com\", \"crl.verisign.com\", \n        \"aka.ms\", \"crl.comodoca.com\", \"acroipm2.adobe.com\", \"sv.symcd.com\", \"_ldap._tcp.*\", \"..localmachine\", \"secure.globalsign.com\",\n        \"acroipm2.adobe.com\", \"www.ssl.com\", \"ocsp.digicert.com\", \"ocsp.verisign.com\", \"ocsp.comodoca.com\", \"ocsp.entrust.net\", \"ocsp.usertrust.com\",\n        \"ocsp.godaddy.com\", \"ocsp.camerfirma.com\", \"ocsp.globalsign.com\", \"ocsp.sectigo.com\", \"*.local\") and\n\n      not (process.name : \"mshta.exe\" and\n           dns.question.name : (\"client.teamviewer.com\", \"www.teamviewer.com\", \"images-na.ssl-images-amazon.com\", \"searcherbar.tilda.ws\")) and\n\n      /* host query itself */\n      not startswith~(dns.question.name, host.name)\n      ]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies registry modification to force the system to fall back to NTLMv1 for authentication. This modification is\npossible with local administrator...", "output": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and\n registry.value == \"LmCompatibilityLevel\" and registry.data.strings in (\"2\", \"1\", \"0\", \"0x00000002\", \"0x00000001\", \"0x00000000\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies registry modification to the LocalAccountTokenFilterPolicy policy. If this value exists (which doesn't by\ndefault) and is set to 1, then re...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"LocalAccountTokenFilterPolicy\" and\n  registry.path : (\n    \"HKLM\\\\*\\\\LocalAccountTokenFilterPolicy\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\*\\\\LocalAccountTokenFilterPolicy\",\n    \"MACHINE\\\\*\\\\LocalAccountTokenFilterPolicy\"\n  ) and registry.data.strings : (\"1\", \"0x00000001\") and\n  not process.executable : (\n    /* Intune */\n    \"C:\\\\Windows\\\\system32\\\\deviceenroller.exe\",\n    \"C:\\\\Windows\\\\system32\\\\omadmclient.exe\",\n\n    /* Crowdstrike specific exclusion as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\system32\\\\deviceenroller.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\system32\\\\omadmclient.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies when the Windows Firewall is disabled using PowerShell cmdlets, which can help attackers evade network\nconstraints, like internet and netwo...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\")\n  ) and\n  process.args : \"*Set-NetFirewallProfile*\" and\n  process.args : \"*-Enabled*\" and process.args : \"*False*\" and\n  process.args : (\"*-All*\", \"*Public*\", \"*Domain*\", \"*Private*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and other\nnon-native files dropped or cr...", "output": "sequence by host.id with maxspan=5s\n   [process where host.os.type == \"windows\" and event.type == \"end\" and\n    process.code_signature.trusted != true and\n    not process.executable like\n             (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\",\n              \"C:\\\\Windows\\\\WinSxS\\\\*.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not (\n      process.name : \"infinst.exe\" and process.parent.name: \"dxsetup.exe\" and\n      process.parent.code_signature.subject_name == \"NVIDIA Corporation\" and\n      process.parent.code_signature.status == \"trusted\"\n    )\n   ] by process.executable\n   [file where host.os.type == \"windows\" and event.type == \"deletion\" and file.extension in~ (\"exe\", \"scr\", \"com\") and\n    not process.executable like\n             (\"?:\\\\Program Files\\\\*.exe\",\n              \"?:\\\\Program Files (x86)\\\\*.exe\",\n              \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n              \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not file.path like (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\Temp\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WinREAgent\\\\Scratch\\\\*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\tenable_mw_scan_*.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\LogiUI\\\\Pak\\\\uninstall.exe\",\n          \"?:\\\\ProgramData\\\\chocolatey\\\\*.exe\"\n    ) and\n    not (process.name : \"OktaVerifySetup-*.exe\" and process.code_signature.subject_name == \"Okta, Inc.\") and\n    not (\n      process.executable : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\" and\n      process.code_signature.subject_name == \"Citrix Systems, Inc.\" and\n      file.path : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\\\\bootstrapperhelper.exe\"\n    )\n   ] by file.path\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies potential abuse of the Microsoft Diagnostics Troubleshooting Wizard (MSDT) to proxy malicious command or\nbinary execution via malicious pro...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name == \"msdt.exe\" or process.name : \"msdt.exe\") and\n  (\n    process.args : (\"IT_RebrowseForFile=*\", \"*FromBase64*\", \"*/../../../*\", \"*PCWDiagnostic*\") or\n    (\n      process.args : \"-af\" and process.args : \"/skip\" and\n      process.parent.name : (\"explorer.exe\", \"cmd.exe\", \"powershell.exe\", \"cscript.exe\", \"wscript.exe\", \"mshta.exe\", \"rundll32.exe\", \"regsvr32.exe\") and\n      process.args : (\"?:\\\\WINDOWS\\\\diagnostics\\\\index\\\\PCWDiagnostic.xml\", \"PCWDiagnostic.xml\", \"?:\\\\Users\\\\Public\\\\*\", \"?:\\\\Windows\\\\Temp\\\\*\")\n    ) or\n\n    (process.pe.original_file_name == \"msdt.exe\" and not process.name : \"msdt.exe\" and process.name != null) or\n\n    (\n      ?process.pe.original_file_name == \"msdt.exe\" and\n      not process.executable : (\n        \"?:\\\\Windows\\\\system32\\\\msdt.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\msdt.exe\",\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\system32\\\\msdt.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\msdt.exe\"\n      )\n    )\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies changes to the DNS Global Query Block List (GQBL), a security feature that prevents the resolution of certain\nDNS names often exploited in ...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.data.strings != null and\n(\n  (registry.value : \"EnableGlobalQueryBlockList\" and registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.value : \"GlobalQueryBlockList\" and not registry.data.strings : \"wpad\")\n)\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies attempt to perform session hijack via COM object registry modification by setting the RunAs value to\nInteractive User.\n", "output": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and\n  registry.value == \"RunAs\" and registry.data.strings : \"Interactive User\" and\n\n  not \n  (\n    (\n      process.executable : (\n        \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\4.*\\\\MsMpEng.exe\",\n        \"C:\\\\Program Files\\\\Windows Defender\\\\MsMpEng.exe\"\n      ) and\n      registry.path : \"*\\\\SOFTWARE\\\\Classes\\\\AppID\\\\{1111A26D-EF95-4A45-9F55-21E52ADF9887}\\\\RunAs\"\n    ) or\n    (\n      process.executable : (\n        \"C:\\\\Program Files\\\\TeamViewer\\\\TeamViewer.exe\",\n        \"C:\\\\Program Files (x86)\\\\TeamViewer\\\\TeamViewer.exe\"\n      ) and\n      registry.path : \"*\\\\SOFTWARE\\\\Classes\\\\AppID\\\\{850A928D-5456-4865-BBE5-42635F1EBCA1}\\\\RunAs\"\n    ) or\n    (\n      process.executable : \"C:\\\\Windows\\\\System32\\\\svchost.exe\" and\n      registry.path : \"*\\\\S-1-*Classes\\\\AppID\\\\{D3E34B21-9D75-101A-8C3D-00AA001A1652}\\\\RunAs\"\n    ) or\n    (\n      process.executable : \"C:\\\\Windows\\\\System32\\\\SecurityHealthService.exe\" and\n      registry.path : (\n        \"*\\\\SOFTWARE\\\\Classes\\\\AppID\\\\{1D278EEF-5C38-4F2A-8C7D-D5C13B662567}\\\\RunAs\",\n        \"*\\\\SOFTWARE\\\\Classes\\\\AppID\\\\{7E55A26D-EF95-4A45-9F55-21E52ADF9878}\\\\RunAs\"\n      )\n    ) or\n    (\n      process.executable : \"C:\\\\Windows\\\\System32\\\\SecurityHealthService.exe\" and\n      registry.path : (\n        \"*\\\\SOFTWARE\\\\Classes\\\\AppID\\\\{1D278EEF-5C38-4F2A-8C7D-D5C13B662567}\\\\RunAs\",\n        \"*\\\\SOFTWARE\\\\Classes\\\\AppID\\\\{7E55A26D-EF95-4A45-9F55-21E52ADF9878}\\\\RunAs\"\n      )\n    ) or\n    registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\ClickToRun\\\\VREGISTRY_*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\ClickToRun\\\\VREGISTRY_*\"\n    ) or\n    (process.executable : \"C:\\\\windows\\\\System32\\\\msiexec.exe\" and ?user.id : \"S-1-5-18\")\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation or execution of files or processes with names containing the Right-to-Left Override (RTLO)\ncharacter, which can be used to dis...", "output": "any where host.os.type == \"windows\" and event.category in (\"file\", \"process\") and\n  (\n    (event.type == \"creation\" and file.path : \"*\\u{202E}*\") or \n    (event.type == \"start\" and process.name : \"*\\u{202E}*\")\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation of an Alternate Data Stream (ADS) at a volume root directory, which can indicate the attempt to\nhide tools and malware, as ADS...", "output": "any where host.os.type == \"windows\" and event.category in (\"file\", \"process\") and\n  (\n    (event.type == \"creation\" and file.path regex~ \"\"\"[A-Z]:\\\\:.+\"\"\") or\n    (event.type == \"start\" and process.executable regex~ \"\"\"[A-Z]:\\\\:.+\"\"\")\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies Windows sanfbox processes indicating the start of a new container with sensitive configurations like write\naccess to the host file system, ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"wsb.exe\", \"WindowsSandboxClient.exe\") and\n  process.command_line : (\"*<Networking>Enable</Networking>*\",\n                          \"*<HostFolder>C:\\\\*<ReadOnly>false*\",\n                          \"*<LogonCommand>*\",\n                          \"*<NetworkingEnabled>true*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies child processes of unusual instances of RunDLL32 where the command line parameters were suspicious. Misuse of\nRunDLL32 could indicate malic...", "output": "sequence with maxspan=1h\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"rundll32.exe\" or process.pe.original_file_name == \"RUNDLL32.EXE\") and\n      (process.args_count == 1 and\n        /* Excludes bug where a missing closing quote sets args_count to 1 despite extra args */\n        not process.command_line regex~ \"\"\"\\\".*\\.exe[^\\\"].*\"\"\")\n  ] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"rundll32.exe\"\n  ] by process.parent.entity_id\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies DACL modifications to deny access to a service, making it unstoppable, or hide it from system and users.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name : \"sc.exe\") and\n  process.args : \"sdset\" and process.args : \"*D;*\" and\n  process.args : (\"*;IU*\", \"*;SU*\", \"*;BA*\", \"*;SY*\", \"*;WD*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: This detection rule identifies when 'SCNotification.exe' loads an untrusted DLL, which is a potential indicator of an\nattacker attempt to hijack/imper...", "output": "library where host.os.type == \"windows\" and process.name : \"SCNotification.exe\" and\n  (dll.Ext.relative_file_creation_time < 86400 or dll.Ext.relative_file_name_modify_time <= 500) and dll.code_signature.status != \"trusted\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to enable the Windows scheduled tasks AT command via the registry. Attackers may use this method to\nmove laterally or persist loca...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"EnableAt\" and\n  registry.data.strings : (\"1\", \"0x00000001\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the execution of scripts via HTML applications using Windows utilities rundll32.exe or mshta.exe. Adversaries\nmay bypass process and/or sig...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"rundll32.exe\", \"mshta.exe\") and\n  (\n     (process.command_line :\n        (\n        \"*script*eval(*\",\n         \"*script*GetObject*\",\n         \"*.regread(*\",\n         \"*WScript.Shell*\",\n         \"*.run(*\",\n         \"*).Exec()*\",\n         \"*mshta*http*\",\n         \"*mshtml*RunHTMLApplication*\",\n         \"*mshtml*,#135*\",\n         \"*StrReverse*\",\n         \"*.RegWrite*\",\n         /* Issue #379 */\n         \"*window.close(*\",\n         \"* Chr(*\"\n         )\n     and not ?process.parent.executable :\n                  (\"?:\\\\Program Files (x86)\\\\Citrix\\\\System32\\\\wfshell.exe\",\n                   \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\Office*\\\\MSACCESS.EXE\",\n                   \"?:\\\\Program Files\\\\Quokka.Works GTInstaller\\\\GTInstaller.exe\")\n     ) or\n\n    (process.name : \"mshta.exe\" and\n     not process.command_line : (\"*.hta*\", \"*.htm*\", \"-Embedding\") and ?process.args_count >=2) or\n\n     /* Execution of HTA file downloaded from the internet */\n     (process.name : \"mshta.exe\" and process.command_line : \"*\\\\Users\\\\*\\\\Downloads\\\\*.hta*\") or\n\n     /* Execution of HTA file from archive */\n     (process.name : \"mshta.exe\" and\n      process.args : (\"?:\\\\Users\\\\*\\\\Temp\\\\7z*\", \"?:\\\\Users\\\\*\\\\Temp\\\\Rar$*\", \"?:\\\\Users\\\\*\\\\Temp\\\\Temp?_*\", \"?:\\\\Users\\\\*\\\\Temp\\\\BNZ.*\"))\n   )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects file name patterns generated by the use of Sysinternals SDelete utility to securely delete a file via multiple\nfile overwrite and rename opera...", "output": "file where host.os.type == \"windows\" and event.type == \"change\" and file.name : \"*AAA.AAA\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by the\nWindows cryptographic system to va...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : (\"Dll\", \"$Dll\") and\n  registry.path: (\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\"\n    ) and\n  registry.data.strings:\"*.dll\" and\n  not (process.name : \"msiexec.exe\" and registry.data.strings : \"mso.dll\") and\n  not (process.name : \"regsvr32.exe\" and registry.data.strings == \"WINTRUST.DLL\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies a SolarWinds binary modifying the start type of a service to be disabled. An adversary may abuse this\ntechnique to manipulate relevant secu...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Start\" and\n  process.name : (\n      \"SolarWinds.BusinessLayerHost*.exe\",\n      \"ConfigurationWizard*.exe\",\n      \"NetflowDatabaseMaintenance*.exe\",\n      \"NetFlowService*.exe\",\n      \"SolarWinds.Administration*.exe\",\n      \"SolarWinds.Collector.Service*.exe\",\n      \"SolarwindsDiagnostics*.exe\"\n  ) and\n  registry.path : \"*\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\" and\n  registry.data.strings : (\"4\", \"0x00000004\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious commands being used with certutil.exe. CertUtil is a native Windows component which is part of\nCertificate Services. CertUtil is...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"certutil.exe\" or ?process.pe.original_file_name == \"CertUtil.exe\") and\n  process.args : (\"?decode\", \"?encode\", \"?urlcache\", \"?verifyctl\", \"?encodehex\", \"?decodehex\", \"?exportPFX\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies when a script interpreter or signed binary is launched via a non-standard working directory. An attacker may\nuse this technique to evade de...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.executable : \"C:\\\\*\" and\n  (process.working_directory : \"?:\\\\\" and not process.working_directory: \"C:\\\\\") and\n  process.parent.name : \"explorer.exe\" and\n  process.name : (\"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\", \"cmd.exe\", \"regsvr32.exe\",\n                  \"cscript.exe\", \"wscript.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspicious\ncode execution.\n", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.name : (\"wscript.exe.log\",\n               \"cscript.exe.log\",\n               \"mshta.exe.log\",\n               \"wmic.exe.log\",\n               \"svchost.exe.log\",\n               \"dllhost.exe.log\",\n               \"cmstp.exe.log\",\n               \"regsvr32.exe.log\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies suspicious process access events from an unknown memory region. Endpoint security solutions usually hook\nuserland Windows APIs in order to ...", "output": "process where host.os.type == \"windows\" and event.code == \"10\" and\n length(winlog.event_data.CallTrace) > 0 and\n\n /* Sysmon CallTrace starting with unknown memory module instead of ntdll which host Windows NT Syscalls */\n not winlog.event_data.CallTrace :\n            (\"?:\\\\WINDOWS\\\\SYSTEM32\\\\ntdll.dll*\",\n             \"?:\\\\WINDOWS\\\\SysWOW64\\\\ntdll.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\wow64cpu.dll*\",\n             \"?:\\\\WINDOWS\\\\System32\\\\wow64win.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\win32u.dll*\") and\n\n not winlog.event_data.TargetImage :\n            (\"?:\\\\Program Files (x86)\\\\Malwarebytes Anti-Exploit\\\\mbae-svc.exe\",\n             \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n             \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\*\\\\AcroCEF.exe\") and\n\n not (process.executable : (\"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n                            \"?:\\\\Program Files (x86)\\\\World of Warcraft\\\\_classic_\\\\WowClassic.exe\") and\n      not winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies when a process is created and immediately accessed from an unknown memory code region and by the same parent\nprocess. This may indicate a c...", "output": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.code == \"1\" and\n   /* sysmon process creation */\n   process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\", \"eqnedt32.exe\", \"fltldr.exe\",\n                          \"mspub.exe\", \"msaccess.exe\",\"cscript.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                          \"mshta.exe\", \"wmic.exe\", \"cmstp.exe\", \"msxsl.exe\") and\n\n   /* noisy FP patterns */\n   not (process.parent.name : \"EXCEL.EXE\" and process.executable : \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\ADDINS\\\\*.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\splwow64.exe\" and process.args in (\"8192\", \"12288\") and process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"rundll32.exe\" and process.parent.args : (\"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\", \"--no-sandbox\")) and\n   not (process.executable :\n            (\"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\DWWIN.EXE\") and\n        process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"regsvr32.exe\" and process.parent.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))\n   ] by process.parent.entity_id, process.entity_id\n  [process where host.os.type == \"windows\" and event.code == \"10\" and\n   /* Sysmon process access event from unknown module */\n   winlog.event_data.CallTrace : \"*UNKNOWN*\"] by process.entity_id, winlog.event_data.TargetProcessGUID\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies scrobj.dll loaded into unusual Microsoft processes. This usually means a malicious scriptlet is being\nexecuted in the target process.\n", "output": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : \"scrobj.dll\" or ?file.name : \"scrobj.dll\") and\n process.executable : (\"?:\\\\Windows\\\\System32\\\\*.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\*.exe\") and\n not process.executable : (\n       \"?:\\\\Windows\\\\System32\\\\cscript.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\cscript.exe\",\n       \"?:\\\\Windows\\\\system32\\\\msiexec.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n       \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n       \"?:\\\\Windows\\\\system32\\\\taskhostw.exe\",\n       \"?:\\\\windows\\\\system32\\\\inetsrv\\\\w3wp.exe\",\n       \"?:\\\\windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\",\n       \"?:\\\\Windows\\\\system32\\\\wscript.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\wscript.exe\",\n       \"?:\\\\Windows\\\\System32\\\\mshta.exe\",\n       \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\",\n       \"?:\\\\Windows\\\\System32\\\\cmd.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\cmd.exe\",\n       \"?:\\\\Windows\\\\System32\\\\OpenWith.exe\",\n       \"?:\\\\Windows\\\\System32\\\\wbem\\\\WMIADAP.exe\",\n       \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of a process with a single character process name, differing from the original file name. This\nis often done by adversaries w...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and length(process.name) > 0 and\n length(process.name) == 5 and length(process.pe.original_file_name) > 5\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies WMIC allowlist bypass techniques by alerting on suspicious execution of scripts. When WMIC loads scripting\nlibraries it may be indicative o...", "output": "sequence by process.entity_id with maxspan = 2m\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.name : \"WMIC.exe\" or process.pe.original_file_name : \"wmic.exe\") and\n   process.args : (\"format*:*\", \"/format*:*\", \"*-format*:*\") and\n   not process.command_line : (\"* /format:table *\", \"* /format:table\")]\n[any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : (\"jscript.dll\", \"vbscript.dll\") or file.name : (\"jscript.dll\", \"vbscript.dll\"))]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details\nsuch as command line, network con...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Zoom.exe\" and process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies an unexpected executable file being created or modified by a Windows system critical process, which may\nindicate activity related to remote...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : (\"exe\", \"dll\") and\n  process.name : (\"smss.exe\",\n                  \"autochk.exe\",\n                  \"csrss.exe\",\n                  \"wininit.exe\",\n                  \"services.exe\",\n                  \"lsass.exe\",\n                  \"winlogon.exe\",\n                  \"userinit.exe\",\n                  \"LogonUI.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies modification of a file creation time. Adversaries may modify file time attributes to blend malicious content\nwith existing files. Timestomp...", "output": "file where host.os.type == \"windows\" and\n  event.provider == \"Microsoft-Windows-Sysmon\" and\n  /* File creation time change */\n  event.code == \"2\" and\n  not process.executable :\n           (\"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\system32\\\\cleanmgr.exe\",\n            \"?:\\\\Windows\\\\system32\\\\msiexec.exe\",\n            \"?:\\\\Windows\\\\syswow64\\\\msiexec.exe\",\n            \"?:\\\\Windows\\\\system32\\\\svchost.exe\",\n            \"?:\\\\WINDOWS\\\\system32\\\\backgroundTaskHost.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\slack\\\\app-*\\\\slack.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\GitHubDesktop\\\\app-*\\\\GitHubDesktop.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\current\\\\Teams.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\") and\n  not file.extension : (\"temp\", \"tmp\", \"~tmp\", \"xml\", \"newcfg\") and not user.name : (\"SYSTEM\", \"Local Service\", \"Network Service\") and\n  not file.name : (\"LOG\", \"temp-index\", \"license.rtf\", \"iconcache_*.db\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a Windows trusted program running from locations often abused by adversaries to masquerade as a trusted\nprogram and loading a recently drop...", "output": "library where host.os.type == \"windows\" and\n\n process.code_signature.trusted == true and\n\n (dll.Ext.relative_file_creation_time <= 500 or dll.Ext.relative_file_name_modify_time <= 500) and\n\n  not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\", \"errorChaining\") and\n\n      /* Suspicious Paths */\n      dll.path : (\"?:\\\\PerfLogs\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Pictures\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Music\\\\*.dll\",\n                  \"?:\\\\Users\\\\Public\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Documents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Windows\\\\System32\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Intel\\\\*.dll\",\n                  \"?:\\\\AMD\\\\Temp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*.dll\",\n                  \"?:\\\\Windows\\\\security\\\\*.dll\",\n\t\t  \"?:\\\\Windows\\\\System\\\\*.dll\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Branding\\\\*.dll\",\n                  \"?:\\\\Windows\\\\csc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*.dll\",\n                  \"?:\\\\Windows\\\\en-US\\\\*.dll\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*.dll\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*.dll\",\n                  \"?:\\\\Windows\\\\INF\\\\*.dll\",\n                  \"?:\\\\windows\\\\tracing\\\\*.dll\",\n                  \"?:\\\\windows\\\\IME\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Performance\\\\*.dll\",\n                  \"?:\\\\windows\\\\intel\\\\*.dll\",\n                  \"?:\\\\windows\\\\ms\\\\*.dll\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceProfiles\\\\*.dll\",\n                  \"?:\\\\Windows\\\\panther\\\\*.dll\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*.dll\",\n                  \"?:\\\\Windows\\\\OCR\\\\*.dll\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*.dll\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\addins\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Setup\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Help\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SKB\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Vss\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Web\\\\*.dll\",\n                  \"?:\\\\Windows\\\\servicing\\\\*.dll\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Logs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*.dll\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PLA\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Migration\\\\*.dll\",\n                  \"?:\\\\Windows\\\\debug\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Containers\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Boot\\\\*.dll\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*.dll\",\n                  \"?:\\\\Windows\\\\schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Resources\\\\*.dll\",\n                  \"?:\\\\Windows\\\\rescache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.dll\",\n                  \"?:\\\\Windows\\\\media\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*.dll\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.dll\",\n                  \"?:\\\\$Recycle.Bin\\\\*.dll\") and\n\n\t /* DLL loaded from the process.executable current directory */\n\t endswith~(substring(dll.path, 0, length(dll.path) - (length(dll.name) + 1)), substring(process.executable, 0, length(process.executable) - (length(process.name) + 1)))\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies attempt to load an untrusted driver. Adversaries may modify code signing policies to enable execution of\nunsigned or self-signed code.\n", "output": "driver where host.os.type == \"windows\" and process.pid == 4 and\n  (dll.code_signature.trusted == false or dll.code_signature.exists == false) and\n  not dll.code_signature.status : (\"errorExpired\", \"errorRevoked\", \"errorCode_endpoint:*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious creation of Alternate Data Streams on highly targeted files. This is uncommon for legitimate files\nand sometimes done by adversa...", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n\n  file.path : \"C:\\\\*:*\" and file.extension in~ (\n    \"pdf\", \"dll\", \"exe\", \"dat\", \"com\", \"bat\", \"cmd\", \"sys\", \"vbs\", \"ps1\", \"hta\", \"txt\", \"vbe\", \"js\",\n    \"wsh\", \"docx\", \"doc\", \"xlsx\", \"xls\", \"pptx\", \"ppt\", \"rtf\", \"gif\", \"jpg\", \"png\", \"bmp\", \"img\", \"iso\"\n  ) and\n\n  not file.path : \n          (\"C:\\\\*:zone.identifier*\",\n           \"C:\\\\users\\\\*\\\\appdata\\\\roaming\\\\microsoft\\\\teams\\\\old_weblogs_*:$DATA\",\n           \"C:\\\\Windows\\\\CSC\\\\*:CscBitmapStream\") and\n\n  not process.executable : (\n          \"?:\\\\Program Files (x86)\\\\Dropbox\\\\Client\\\\Dropbox.exe\",\n          \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n          \"?:\\\\Program Files\\\\ExpressConnect\\\\ExpressConnectNetworkService.exe\",\n          \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n          \"?:\\\\Program Files\\\\Windows Defender Advanced Threat Protection\\\\MsSense.exe\",\n          \"?:\\\\Program Files\\\\Rivet Networks\\\\SmartByte\\\\SmartByteNetworkService.exe\",\n          \"?:\\\\Windows\\\\explorer.exe\",\n          \"?:\\\\Windows\\\\System32\\\\DataExchangeHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\Intel\\\\ICPS\\\\IntelConnectivityNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\RivetNetworks\\\\Killer\\\\KillerNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n          \"?:\\\\Windows\\\\System32\\\\PickerHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\RuntimeBroker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\SearchProtocolHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\sihost.exe\",\n          \"?:\\\\windows\\\\System32\\\\svchost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WFS.exe\"\n  ) and\n  \n  not (\n    ?process.code_signature.trusted == true and\n    file.name : \"*:sec.endpointdlp:$DATA\"\n  )\n\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies processes running from an Alternate Data Stream. This is uncommon for legitimate processes and sometimes done\nby adversaries to hide malwar...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : \"?:\\\\*:*\" and\n  (\n    process.args_count == 1 and\n\n    /* Excludes bug where a missing closing quote sets args_count to 1 despite extra args */\n    not process.command_line regex~ \"\"\"\\\".*\\.exe[^\\\"].* \"\"\"  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies unusual instances of dllhost.exe making outbound network connections. This may indicate adversarial Command\nand Control activity.\n", "output": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"dllhost.exe\" and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n    \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n    \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n    \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n    \"FF00::/8\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies unusual instances of rundll32.exe making outbound network connections. This may indicate adversarial Command\nand Control activity.\n", "output": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"rundll32.exe\" and\n  (\n    process.args_count == 1 and\n\n    /* Excludes bug where a missing closing quote sets args_count to 1 despite extra args */\n    not process.command_line regex~ \"\"\"\\\".*\\.exe[^\\\"].* \"\"\"  )]\n  [network where host.os.type == \"windows\" and process.name : \"rundll32.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies network activity from unexpected system applications. This may indicate adversarial activity as these\napplications are often leveraged by a...", "output": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\") and\n     event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\")]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a suspicious child process of the Windows virtual system process, which could indicate code injection.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.pid == 4 and process.executable : \"?*\" and\n  not process.executable : (\"Registry\", \"MemCompression\", \"?:\\\\Windows\\\\System32\\\\smss.exe\", \"HotPatch\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: The Filter Manager Control Program (fltMC.exe) binary may be abused by adversaries to unload a filter driver and evade\ndefenses.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"fltMC.exe\" and process.args : \"unload\" and\n  not process.parent.executable : \n                   (\"?:\\\\Program Files (x86)\\\\ManageEngine\\\\UEMS_Agent\\\\bin\\\\DCFAService64.exe\", \n                    \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Endpoint Security\\\\installer\\\\installer.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Endpoint Security\\\\EPSecurityService.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Bitdefender Security\\\\productcfg.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Bitdefender Security\\\\bdservicehost.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\EndpointSetupInformation\\\\{*}\\\\Installer.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of a Windows Defender Application Control (WDAC) policy file by an unusual process. Adversaries\nmay use a secially crafted WDA...", "output": "file where host.os.type == \"windows\" and event.action != \"deletion\" and\n  file.extension : (\"p7b\", \"cip\") and\n  file.path : (\n    \"?:\\\\Windows\\\\System32\\\\CodeIntegrity\\\\*.p7b\",\n    \"?:\\\\Windows\\\\System32\\\\CodeIntegrity\\\\CiPolicies\\\\Active\\\\*.cip\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\CodeIntegrity\\\\*.p7b\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\CodeIntegrity\\\\CiPolicies\\\\Active\\\\*.cip\"\n  ) and\n  not process.executable : (\n    \"C:\\\\Windows\\\\System32\\\\poqexec.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\poqexec.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies multiple Windows Filtering Platform block events and where the process name is related to an endpoint\nsecurity software. Adversaries may ad...", "output": "sequence by winlog.computer_name with maxspan=1m\n [network where host.os.type == \"windows\" and\n  event.action : (\"windows-firewall-packet-block\", \"windows-firewall-packet-drop\") and\n  process.name : (\n        \"bdagent.exe\", \"bdreinit.exe\", \"pdscan.exe\", \"pdiface.exe\", \"BDSubWiz.exe\", \"ProductAgentService.exe\",\n        \"ProductAgentUI.exe\", \"WatchDog.exe\", \"CarbonBlackClientSetup.exe\", \"TrGUI.exe\", \"TracCAPI.exe\", \"cpmsi_tool.exe\",\n        \"trac.exe\", \"vna_install64.exe\", \"vna_utils.exe\", \"TracSrvWrapper.exe\", \"vsmon.exe\", \"p95tray.exe\",\n        \"CybereasonRansomFreeServiceHost.exe\", \"CrAmTray.exe\", \"minionhost.exe\", \"CybereasonSensor.exe\", \"CylanceUI.exe\",\n        \"CylanceProtectSetup.exe\", \"cylancesvc.exe\", \"cyupdate.exe\", \"elastic-agent.exe\", \"elastic-endpoint.exe\",\n        \"egui.exe\", \"minodlogin.exe\", \"emu-rep.exe\", \"emu_install.exe\", \"emu-cci.exe\", \"emu-gui.exe\", \"emu-uninstall.exe\",\n        \"ndep.exe\", \"spike.exe\", \"ecls.exe\", \"ecmd.exe\", \"ecomserver.exe\", \"eeclnt.exe\", \"eh64.exe\", \"EHttpSrv.exe\",\n        \"xagt.exe\", \"collectoragent.exe\", \"FSAEConfig.exe\", \"uninstalldcagent.exe\", \"rmon.exe\", \"fccomint.exe\",\n        \"fclanguageselector.exe\", \"fortifw.exe\", \"fcreg.exe\", \"fortitray.exe\", \"fcappdb.exe\", \"fcwizard.exe\", \"submitv.exe\",\n        \"av_task.exe\", \"fortiwf.exe\", \"fortiwadbd.exe\", \"fcauth.exe\", \"fcdblog.exe\", \"fcmgr.exe\", \"fortiwad.exe\",\n        \"fortiproxy.exe\", \"fortiscand.exe\", \"fortivpnst.exe\", \"ipsec.exe\", \"fcwscd7.exe\", \"fcasc.exe\", \"fchelper.exe\",\n        \"forticlient.exe\",\"fcwsc.exe\", \"FortiClient.exe\", \"fmon.exe\", \"FSSOMA.exe\", \"FCVbltScan.exe\", \"FortiESNAC.exe\",\n        \"EPCUserAvatar.exe\", \"FortiAvatar.exe\", \"FortiClient_Diagnostic_Tool.exe\", \"FortiSSLVPNdaemon.exe\", \"avp.exe\",\n        \"FCConfig.exe\", \"avpsus.exe\", \"klnagent.exe\", \"klnsacwsrv.exe\", \"kl_platf.exe\", \"stpass.exe\", \"klnagwds.exe\",\n        \"mbae.exe\", \"mbae64.exe\", \"mbae-svc.exe\", \"mbae-uninstaller.exe\", \"mbaeLoader32.exe\", \"mbaeloader64.exe\",\n        \"mbam-dor.exe\", \"mbamgui.exe\", \"mbamservice.exe\", \"mbamtrayctrl.exe\", \"mbampt.exe\", \"mbamscheduler.exe\",\n        \"Coreinst.exe\", \"mbae-setup.exe\", \"mcupdate.exe\", \"ProtectedModuleHost.exe\", \"ESConfigTool.exe\", \"FWInstCheck.exe\",\n        \"FwWindowsFirewallHandler.exe\", \"mfeesp.exe\", \"mfefw.exe\", \"mfeProvisionModeUtility.exe\", \"mfetp.exe\", \"avpui.exe\",\n        \"WscAVExe.exe\", \"mcshield.exe\", \"McChHost.exe\", \"mfewc.exe\", \"mfewch.exe\", \"mfewcui.exe\", \"fwinfo.exe\",\n        \"mfecanary.exe\", \"mfefire.exe\", \"mfehidin.exe\", \"mfemms.exe\", \"mfevtps.exe\", \"mmsinfo.exe\", \"vtpinfo.exe\",\n        \"MarSetup.exe\", \"mctray.exe\", \"masvc.exe\", \"macmnsvc.exe\", \"McAPExe.exe\", \"McPvTray.exe\", \"mcods.exe\",\n        \"mcuicnt.exe\", \"mcuihost.exe\", \"xtray.exe\", \"McpService.exe\", \"epefprtrainer.exe\", \"mfeffcoreservice.exe\",\n        \"MfeEpeSvc.exe\", \"qualysagent.exe\", \"QualysProxy.exe\", \"QualysAgentUI.exe\", \"SVRTgui.exe\", \"SVRTcli.exe\",\n        \"SVRTcli.exe\", \"SVRTgui.exe\", \"SCTCleanupService.exe\", \"SVRTservice.exe\", \"native.exe\", \"SCTBootTasks.exe\",\n        \"ALMon.exe\", \"SAA.exe\", \"SUMService.exe\", \"ssp.exe\", \"SCFService.exe\", \"SCFManager.exe\", \"spa.exe\", \"cabarc.exe\",\n        \"sargui.exe\", \"sntpservice.exe\", \"McsClient.exe\", \"McsAgent.exe\", \"McsHeartbeat.exe\", \"SAVAdminService.exe\",\n        \"sav32cli.exe\", \"ForceUpdateAlongSideSGN.exe\", \"SAVCleanupService.exe\", \"SavMain.exe\", \"SavProgress.exe\",\n        \"SavProxy.exe\", \"SavService.exe\", \"swc_service.exe\", \"swi_di.exe\", \"swi_service.exe\", \"swi_filter.exe\",\n        \"ALUpdate.exe\", \"SophosUpdate.exe\", \"ALsvc.exe\", \"SophosAlert.exe\", \"osCheck.exe\", \"N360Downloader.exe\",\n        \"InstWrap.exe\", \"symbos.exe\", \"nss.exe\", \"symcorpui.exe\", \"isPwdSvc.exe\", \"ccsvchst.exe\", \"ntrmv.exe\",\n        \"pccntmon.exe\", \"AosUImanager.exe\", \"NTRTScan.exe\", \"TMAS_OL.exe\", \"TMAS_OLImp.exe\", \"TMAS_OLSentry.exe\",\n        \"ufnavi.exe\", \"Clnrbin.exe\", \"vizorhtmldialog.exe\", \"pwmConsole.exe\", \"PwmSvc.exe\", \"coreServiceShell.exe\",\n        \"ds_agent.exe\", \"SfCtlCom.exe\", \"MBAMHelper.exe\", \"cb.exe\", \"smc.exe\", \"tda.exe\", \"xagtnotif.exe\", \"ekrn.exe\",\n        \"dsa.exe\", \"Notifier.exe\", \"rphcp.exe\", \"lc_sensor.exe\", \"CSFalconService.exe\", \"CSFalconController.exe\",\n        \"SenseSampleUploader.exe\", \"windefend.exe\", \"MSASCui.exe\", \"MSASCuiL.exe\", \"msmpeng.exe\", \"msmpsvc.exe\",\n        \"MsSense.exe\", \"esensor.exe\", \"sentinelone.exe\", \"tmccsf.exe\", \"csfalconcontainer.exe\", \"sensecncproxy.exe\",\n        \"splunk.exe\", \"sysmon.exe\", \"sysmon64.exe\", \"taniumclient.exe\"\n    )] with runs=5\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current working\ndirectory. Misuse of Windows W...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and process.parent.name : \"WorkFolders.exe\" and\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\control.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\control.exe\",\n\n    /* Crowdstrike specific condition as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\control.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detects Linux Bash commands from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to\navoid detection.\n", "output": "process where host.os.type == \"windows\" and event.type : \"start\" and\n  (\n    (\n      (process.executable : \"?:\\\\Windows\\\\System32\\\\bash.exe\" or ?process.pe.original_file_name == \"Bash.exe\") and\n      not process.command_line : (\"bash\", \"bash.exe\")\n    ) or\n    process.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Packages\\\\*\\\\rootfs\\\\usr\\\\bin\\\\bash\" or\n    (\n      process.parent.name : \"wsl.exe\" and process.parent.command_line : \"bash*\" and not process.name : \"wslhost.exe\"\n    ) or\n    (\n      process.name : \"wsl.exe\" and process.args : (\n        \"curl\", \"/etc/shadow\", \"/etc/passwd\", \"cat\", \"--system\", \"root\", \"-e\", \"--exec\", \"bash\", \"/mnt/c/*\"\n      ) and not process.args : (\"wsl-bootstrap\", \"docker-desktop-data\", \"*.vscode-server*\")\n    )\n  ) and\n    not process.parent.executable : (\"?:\\\\Program Files\\\\Docker\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\Docker\\\\*.exe\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detects attempts to execute a program on the host from the Windows Subsystem for Linux. Adversaries may enable and use\nWSL for Linux to avoid detectio...", "output": "process where host.os.type == \"windows\" and event.type : \"start\" and\n  process.parent.name : (\"wsl.exe\", \"wslhost.exe\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n  ) and\n  not (\n    /* Crowdstrike specific exclusion as it uses NT Object paths */\n    event.dataset == \"crowdstrike.fdr\" and\n      process.executable : (\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n      )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects attempts to enable the Windows Subsystem for Linux using Microsoft Dism utility. Adversaries may enable and use\nWSL for Linux to avoid detecti...", "output": "process where host.os.type == \"windows\" and event.type : \"start\" and\n (process.name : \"Dism.exe\" or ?process.pe.original_file_name == \"DISM.EXE\") and \n process.command_line : \"*Microsoft-Windows-Subsystem-Linux*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects files creation and modification on the host system from the the Windows Subsystem for Linux. Adversaries may\nenable and use WSL for Linux to a...", "output": "sequence by process.entity_id with maxspan=5m\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"dllhost.exe\" and\n   /* Plan9FileSystem CLSID - WSL Host File System Worker */\n  process.command_line : \"*{DFB65C4C-B34F-435D-AFE9-A86218684AA8}*\"]\n [file where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and not file.path : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects attempts to install or use Kali Linux via Windows Subsystem for Linux. Adversaries may enable and use WSL for\nLinux to avoid detection.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (process.name : \"wsl.exe\" and process.args : (\"-d\", \"--distribution\", \"-i\", \"--install\") and process.args : \"kali*\") or\n  process.executable : (\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"?:\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\",\n\n    /* Crowdstrike specific exclusion as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\"\n  )\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects changes to the registry that indicates the install of a new Windows Subsystem for Linux distribution by name.\nAdversaries may enable and use W...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"PackageFamilyName\" and\n registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Lxss\\\\*\\\\PackageFamilyName\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies processes loading Active Directory related modules followed by a network connection to the ADWS dedicated TCP\nport. Adversaries may abuse t...", "output": "sequence by process.entity_id with maxspan=3m\n [library where host.os.type == \"windows\" and\n  dll.name : (\"System.DirectoryServices*.dll\", \"System.IdentityModel*.dll\") and\n  not user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  not process.executable :\n                (\"?:\\\\windows\\\\system32\\\\dsac.exe\",\n                 \"?:\\\\program files\\\\powershell\\\\?\\\\pwsh.exe\",\n                 \"?:\\\\windows\\\\system32\\\\windowspowershell\\\\*.exe\",\n                 \"?:\\\\windows\\\\syswow64\\\\windowspowershell\\\\*.exe\",\n                 \"?:\\\\program files\\\\microsoft monitoring agent\\\\*.exe\",\n                 \"?:\\\\windows\\\\adws\\\\microsoft.activedirectory.webservices.exe\")]\n [network where host.os.type == \"windows\" and destination.port == 9389 and source.port >= 49152 and\n  network.direction == \"egress\" and network.transport == \"tcp\" and not cidrmatch(destination.ip, \"127.0.0.0/8\", \"::1/128\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the use of ADExplorer utility. Active Directory Explorer (AD Explorer) is an advanced Active Directory (AD)\nviewer and editor. AD Ex...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"ADExplorer*.exe\" or ?process.pe.original_file_name == \"AdExp\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: This rule detects the Active Directory query tool, AdFind.exe. AdFind has legitimate purposes, but it is frequently\nleveraged by threat actors to perf...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"AdFind*.exe\" or ?process.pe.original_file_name == \"AdFind.exe\") and\n  process.args : (\"objectcategory=computer\", \"(objectcategory=computer)\",\n                  \"objectcategory=person\", \"(objectcategory=person)\",\n                  \"objectcategory=subnet\", \"(objectcategory=subnet)\",\n                  \"objectcategory=group\", \"(objectcategory=group)\",\n                  \"objectcategory=organizationalunit\", \"(objectcategory=organizationalunit)\",\n                  \"objectcategory=attributeschema\", \"(objectcategory=attributeschema)\",\n                  \"domainlist\", \"dcmodes\", \"adinfo\", \"dclist\", \"computers_pwnotreqd\", \"trustdmp\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies instances of lower privilege accounts enumerating Administrator accounts or groups using built-in Windows\ntools.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      (process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or\n      ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and not process.parent.name : \"net.exe\")\n    ) and\n    process.args : (\"group\", \"user\", \"localgroup\") and\n    process.args : (\"*admin*\", \"Domain Admins\", \"Remote Desktop Users\", \"Enterprise Admins\", \"Organization Management\")\n    and not process.args : (\"/add\", \"/delete\")\n  ) or\n  (\n    (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n    process.args : (\"group\", \"useraccount\")\n  )\n) and not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies the use of dsquery.exe for domain trust discovery purposes. Adversaries may use this command-line utility to\nenumerate trust relationships ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"dsquery.exe\" or ?process.pe.original_file_name: \"dsquery.exe\") and \n    process.args : \"*objectClass=trustedDomain*\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility to\nenumerate domain trusts and gai...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.name : \"nltest.exe\" and process.args : (\n        \"/DCLIST:*\", \"/DCNAME:*\", \"/DSGET*\",\n        \"/LSAQUERYFTI:*\", \"/PARENTDOMAIN\",\n        \"/DOMAIN_TRUSTS\", \"/BDC_QUERY:*\"\n        ) and \nnot process.parent.name : \"PDQInventoryScanner.exe\" and\nnot (\n  user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  /* Don't apply the user.id exclusion to Sysmon for compatibility */\n  not event.dataset : (\"windows.sysmon_operational\", \"windows.sysmon\")\n)\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the usage of gpresult.exe to query group policy objects. Attackers may query group policy objects during the\nreconnaissance phase after compro...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(process.name: \"gpresult.exe\" or ?process.pe.original_file_name == \"gprslt.exe\") and process.args: (\"/z\", \"/v\", \"/r\", \"/x\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identify read access to a high number of Active Directory object attributes. The knowledge of objects properties can\nhelp adversaries find vulnerabili...", "output": "any where event.code == \"4662\" and not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n winlog.event_data.AccessMaskDescription == \"Read Property\" and length(winlog.event_data.Properties) >= 2000\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies DNS queries to known public IP address lookup web services. Malwares tend to perform this action to assess potential targets.\n", "output": "network where host.os.type == \"windows\" and dns.question.name != null and process.name != null and\n(\n  process.name : (\"MSBuild.exe\", \"mshta.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"msiexec.exe\", \"rundll32.exe\",\n  \"bitsadmin.exe\", \"InstallUtil.exe\", \"RegAsm.exe\", \"vbc.exe\", \"RegSvcs.exe\", \"python.exe\", \"regsvr32.exe\", \"dllhost.exe\",\n  \"node.exe\", \"javaw.exe\", \"java.exe\", \"*.pif\", \"*.com\") or\n\n  (?process.code_signature.trusted == false or ?process.code_signature.exists == false) or\n\n  ?process.code_signature.subject_name : (\"AutoIt Consulting Ltd\", \"OpenJS Foundation\", \"Python Software Foundation\") or\n\n  ?process.executable : (\"?:\\\\Users\\\\*.exe\", \"?:\\\\ProgramData\\\\*.exe\")\n ) and\n dns.question.name :\n         (\n          \"ip-api.com\",\n          \"checkip.dyndns.org\",\n          \"api.ipify.org\",\n          \"api.ipify.com\",\n          \"whatismyip.akamai.com\",\n          \"bot.whatismyipaddress.com\",\n          \"ifcfg.me\",\n          \"ident.me\",\n          \"ipof.in\",\n          \"ip.tyk.nu\",\n          \"icanhazip.com\",\n          \"curlmyip.com\",\n          \"wgetip.com\",\n          \"eth0.me\",\n          \"ipecho.net\",\n          \"ip.appspot.com\",\n          \"api.myip.com\",\n          \"geoiptool.com\",\n          \"api.2ip.ua\",\n          \"api.ip.sb\",\n          \"ipinfo.io\",\n          \"checkip.amazonaws.com\",\n          \"wtfismyip.com\",\n          \"iplogger.*\",\n          \"freegeoip.net\",\n          \"freegeoip.app\",\n          \"ipinfo.io\",\n          \"geoplugin.net\",\n          \"myip.dnsomatic.com\",\n          \"www.geoplugin.net\",\n          \"api64.ipify.org\",\n          \"ip4.seeip.org\",\n          \"*.geojs.io\",\n          \"*portmap.io\",\n          \"api.2ip.ua\",\n          \"api.db-ip.com\",\n          \"geolocation-db.com\",\n          \"httpbin.org\",\n          \"myip.opendns.com\"\n         )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies use of the Windows file system utility (fsutil.exe) to gather information about attached peripheral devices\nand components connected to a c...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or ?process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"fsinfo\" and process.args : \"drives\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious use of whoami.exe which displays user, group, and privileges information for the user who is\ncurrently logged on to the local sy...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"whoami.exe\" and\n(\n  (\n    /* scoped for whoami execution under system privileges */\n    (\n      (\n        user.domain : (\"NT *\", \"* NT\", \"IIS APPPOOL\") and\n        user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\", \"S-1-5-82-*\") and\n        not ?winlog.event_data.SubjectUserName : \"*$\" and\n\n        /* Sysmon will always populate user.id as S-1-5-18, leading to FPs */\n        not event.dataset : (\"windows.sysmon_operational\", \"windows.sysmon\")\n      ) or\n      (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n    ) and\n    not (\n      process.parent.name : \"cmd.exe\" and\n      process.parent.args : (\n          \"chcp 437>nul 2>&1 & C:\\\\WINDOWS\\\\System32\\\\whoami.exe  /groups\",\n          \"chcp 437>nul 2>&1 & %systemroot%\\\\system32\\\\whoami /user\",\n          \"C:\\\\WINDOWS\\\\System32\\\\whoami.exe /groups\",\n          \"*WINDOWS\\\\system32\\\\config\\\\systemprofile*\"\n      )\n    ) and\n    not (process.parent.executable : \"C:\\\\Windows\\\\system32\\\\inetsrv\\\\appcmd.exe\" and process.parent.args : \"LIST\") and\n    not process.parent.executable : (\n        \"C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\MonitoringHost.exe\",\n        \"C:\\\\Program Files\\\\Cohesity\\\\cohesity_windows_agent_service.exe\"\n    )\n  ) or\n  process.parent.name : (\"wsmprovhost.exe\", \"w3wp.exe\", \"wmiprvse.exe\", \"rundll32.exe\", \"regsvr32.exe\")\n)\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: A suspicious SolarWinds child process (Cmd.exe or Powershell.exe) was detected.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name: (\"cmd.exe\", \"powershell.exe\") and\nprocess.parent.name: (\n     \"ConfigurationWizard*.exe\",\n     \"NetflowDatabaseMaintenance*.exe\",\n     \"NetFlowService*.exe\",\n     \"SolarWinds.Administration*.exe\",\n     \"SolarWinds.Collector.Service*.exe\",\n     \"SolarwindsDiagnostics*.exe\"\n     )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "A suspicious SolarWinds child process was detected, which may indicate an attempt to execute malicious programs.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name: (\"SolarWinds.BusinessLayerHost.exe\", \"SolarWinds.BusinessLayerHostx64.exe\") and\n not (\n    process.name : (\n        \"APMServiceControl*.exe\",\n        \"ExportToPDFCmd*.Exe\",\n        \"SolarWinds.Credentials.Orion.WebApi*.exe\",\n        \"SolarWinds.Orion.Topology.Calculator*.exe\",\n        \"Database-Maint.exe\",\n        \"SolarWinds.Orion.ApiPoller.Service.exe\",\n        \"WerFault.exe\",\n        \"WerMgr.exe\",\n        \"SolarWinds.BusinessLayerHost.exe\",\n        \"SolarWinds.BusinessLayerHostx64.exe\",\n        \"SolarWinds.Topology.Calculator.exe\",\n        \"SolarWinds.Topology.Calculatorx64.exe\",\n        \"SolarWinds.APM.RealTimeProcessPoller.exe\") and\n    process.code_signature.trusted == true\n ) and\n not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\ARP.EXE\", \"?:\\\\Windows\\\\SysWOW64\\\\lodctr.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\unlodctr.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Windows Component Object Model (COM) is an inter-process communication (IPC) component of the native Windows application\nprogramming interface (API) t...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"xwizard.exe\" or ?process.pe.original_file_name : \"xwizard.exe\") and\n (\n   (process.args : \"RunWizard\" and process.args : \"{*}\") or\n   (process.executable != null and\n     not process.executable : (\n        \"C:\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"C:\\\\Windows\\\\System32\\\\xwizard.exe\",\n\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\xwizard.exe\"\n     )\n   )\n )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies cmd.exe making a network connection. Adversaries could abuse cmd.exe to download or execute malware from a\nremote URL.\n", "output": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"cmd.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"cmd.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n                                  \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\",\n                                  \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\",\n                                  \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n                                  \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n                                  \"FE80::/10\", \"FF00::/8\") and\n    not dns.question.name : (\n          \"wpad\", \"localhost\", \"ocsp.comodoca.com\", \"ocsp.digicert.com\", \"ocsp.sectigo.com\", \"crl.comodoca.com\"\n    )]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies a suspicious parent child process relationship with cmd.exe descending from an unusual process.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and\n  process.parent.name : (\"lsass.exe\",\n                         \"csrss.exe\",\n                         \"epad.exe\",\n                         \"regsvr32.exe\",\n                         \"dllhost.exe\",\n                         \"LogonUI.exe\",\n                         \"wermgr.exe\",\n                         \"spoolsv.exe\",\n                         \"jucheck.exe\",\n                         \"jusched.exe\",\n                         \"ctfmon.exe\",\n                         \"taskhostw.exe\",\n                         \"GoogleUpdate.exe\",\n                         \"sppsvc.exe\",\n                         \"sihost.exe\",\n                         \"slui.exe\",\n                         \"SIHClient.exe\",\n                         \"SearchIndexer.exe\",\n                         \"SearchProtocolHost.exe\",\n                         \"FlashPlayerUpdateService.exe\",\n                         \"WerFault.exe\",\n                         \"WUDFHost.exe\",\n                         \"unsecapp.exe\",\n                         \"wlanext.exe\" ) and\n  not (process.parent.name : \"dllhost.exe\" and process.parent.args : \"/Processid:{CA8C87C1-929D-45BA-94DB-EF8E6CB346AD}\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies command shell activity started via RunDLL32, which is commonly abused by attackers to host malicious code.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"cmd.exe\", \"powershell.exe\") and\n  process.parent.name : \"rundll32.exe\" and process.parent.command_line != null and\n  /* common FPs can be added here */\n  not process.parent.args : (\"C:\\\\Windows\\\\System32\\\\SHELL32.dll,RunAsNewUser_RunDLL\",\n                             \"C:\\\\WINDOWS\\\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the execution of commonly abused Windows utilities via a delayed Ping execution. This behavior is often\nobserved during malware installatio...", "output": "sequence by process.parent.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.action == \"start\" and process.name : \"ping.exe\" and\n   process.args : \"-n\" and process.parent.name : \"cmd.exe\" and not user.id : \"S-1-5-18\"]\n  [process where host.os.type == \"windows\" and event.action == \"start\" and\n   process.parent.name : \"cmd.exe\" and\n   (\n        process.name : (\n            \"rundll32.exe\", \"powershell.exe\",\n            \"mshta.exe\", \"msbuild.exe\",\n            \"certutil.exe\", \"regsvr32.exe\",\n            \"powershell.exe\", \"cscript.exe\",\n            \"wscript.exe\", \"wmic.exe\",\n            \"installutil.exe\", \"msxsl.exe\",\n            \"Microsoft.Workflow.Compiler.exe\",\n            \"ieexec.exe\", \"iexpress.exe\",\n            \"RegAsm.exe\", \"installutil.exe\",\n            \"RegSvcs.exe\", \"RegAsm.exe\"\n        ) or\n        (process.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\*.exe\" and not process.code_signature.trusted == true)\n    ) and\n\n    not process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\") and\n    not (process.name : (\"openssl.exe\", \"httpcfg.exe\", \"certutil.exe\") and process.parent.command_line : \"*ScreenConnectConfigurator.cmd*\") and\n    not (process.pe.original_file_name : \"DPInst.exe\" and process.command_line : \"driver\\\\DPInst_x64  /f \") and\n    not (process.name : \"powershell.exe\" and process.args : \"Write-Host ======*\") and\n    not (process.name : \"wscript.exe\" and process.args : \"launchquiet_args.vbs\" and process.parent.args : \"?:\\\\Windows\\\\TempInst\\\\7z*\") and\n    not (process.name : \"regsvr32.exe\" and process.args : (\"?:\\\\windows\\\\syswow64\\\\msxml?.dll\", \"msxml?.dll\", \"?:\\\\Windows\\\\SysWOW64\\\\mschrt20.ocx\")) and\n    not (process.name : \"wscript.exe\" and\n         process.working_directory :\n                    (\"?:\\\\Windows\\\\TempInst\\\\*\",\n                     \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\BackupBootstrapper\\\\Logs\\\\\",\n                     \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\QBTools\\\\\"))\n    ]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies .lnk shortcut file downloaded from outside the local network. These shortcut files are commonly used in\nphishing campaigns.\n", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension == \"lnk\" and file.Ext.windows.zone_identifier > 1\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies .url shortcut files downloaded from outside the local network. These shortcut files are commonly used in\nphishing campaigns.\n", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension == \"url\"\n   and file.Ext.windows.zone_identifier == 3 \n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies native Windows host and network enumeration commands spawned by the Windows Management Instrumentation\nProvider Service (WMIPrvSE).\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.command_line != null and\n  process.name:\n  (\n    \"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n    \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\", \"quser.exe\",\n    \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\"\n  ) and\n  process.parent.name:\"wmiprvse.exe\" and\n  not (\n    process.name : \"sc.exe\" and process.args : \"RemoteRegistry\" and process.args : \"start=\" and\n    process.args : (\"demand\", \"disabled\")\n  ) and\n  not process.args : \"tenable_mw_scan\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies process execution from suspicious default Windows directories. This may be abused by adversaries to hide\nmalware in trusted paths.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"wscript.exe\",\n                  \"cscript.exe\",\n                  \"rundll32.exe\",\n                  \"regsvr32.exe\",\n                  \"cmstp.exe\",\n                  \"RegAsm.exe\",\n                  \"installutil.exe\",\n                  \"mshta.exe\",\n                  \"RegSvcs.exe\",\n                  \"powershell.exe\",\n                  \"pwsh.exe\",\n                  \"cmd.exe\") and\n\n  /* add suspicious execution paths here */\n  process.args : (\"C:\\\\PerfLogs\\\\*\",\n                  \"C:\\\\Users\\\\Public\\\\*\",\n                  \"C:\\\\Windows\\\\Tasks\\\\*\",\n                  \"C:\\\\Intel\\\\*\",\n                  \"C:\\\\AMD\\\\Temp\\\\*\",\n                  \"C:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"C:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"C:\\\\Windows\\\\Branding\\\\*\",\n                  \"C:\\\\Windows\\\\csc\\\\*\",\n                  \"C:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"C:\\\\Windows\\\\en-US\\\\*\",\n                  \"C:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"C:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"C:\\\\Windows\\\\Fonts\\\\*\",\n                  \"C:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"C:\\\\Windows\\\\TAPI\\\\*\",\n                  \"C:\\\\Windows\\\\INF\\\\*\",\n                  \"C:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"C:\\\\windows\\\\tracing\\\\*\",\n                  \"c:\\\\windows\\\\IME\\\\*\",\n                  \"c:\\\\Windows\\\\Performance\\\\*\",\n                  \"c:\\\\windows\\\\intel\\\\*\",\n                  \"c:\\\\windows\\\\ms\\\\*\",\n                  \"C:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"C:\\\\Windows\\\\panther\\\\*\",\n                  \"C:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"C:\\\\Windows\\\\OCR\\\\*\",\n                  \"C:\\\\Windows\\\\appcompat\\\\*\",\n                  \"C:\\\\Windows\\\\apppatch\\\\*\",\n                  \"C:\\\\Windows\\\\addins\\\\*\",\n                  \"C:\\\\Windows\\\\Setup\\\\*\",\n                  \"C:\\\\Windows\\\\Help\\\\*\",\n                  \"C:\\\\Windows\\\\SKB\\\\*\",\n                  \"C:\\\\Windows\\\\Vss\\\\*\",\n                  \"C:\\\\Windows\\\\servicing\\\\*\",\n                  \"C:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"C:\\\\Windows\\\\Logs\\\\*\",\n                  \"C:\\\\Windows\\\\WaaS\\\\*\",\n                  \"C:\\\\Windows\\\\twain_32\\\\*\",\n                  \"C:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"C:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"C:\\\\Windows\\\\PLA\\\\*\",\n                  \"C:\\\\Windows\\\\Migration\\\\*\",\n                  \"C:\\\\Windows\\\\debug\\\\*\",\n                  \"C:\\\\Windows\\\\Cursors\\\\*\",\n                  \"C:\\\\Windows\\\\Containers\\\\*\",\n                  \"C:\\\\Windows\\\\Boot\\\\*\",\n                  \"C:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"C:\\\\Windows\\\\TextInput\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\schemas\\\\*\",\n                  \"C:\\\\Windows\\\\SchCache\\\\*\",\n                  \"C:\\\\Windows\\\\Resources\\\\*\",\n                  \"C:\\\\Windows\\\\rescache\\\\*\",\n                  \"C:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"C:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"C:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"C:\\\\Windows\\\\media\\\\*\",\n                  \"C:\\\\Windows\\\\Globalization\\\\*\",\n                  \"C:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"C:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"C:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"C:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"C:\\\\$Recycle.Bin\\\\*\") and\n\n  /* noisy FP patterns */\n\n  not process.parent.executable : (\"C:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\igfxCUIService*.exe\",\n                                   \"C:\\\\Windows\\\\System32\\\\spacedeskService.exe\",\n                                   \"C:\\\\Program Files\\\\Dell\\\\SupportAssistAgent\\\\SRE\\\\SRE.exe\") and\n  not (process.name : \"rundll32.exe\" and\n       process.args : (\"uxtheme.dll,#64\",\n                       \"PRINTUI.DLL,PrintUIEntry\",\n                       \"?:\\\\Windows\\\\System32\\\\FirewallControlPanel.dll,ShowNotificationDialog\",\n                       \"?:\\\\WINDOWS\\\\system32\\\\Speech\\\\SpeechUX\\\\sapi.cpl\",\n                       \"?:\\\\Windows\\\\system32\\\\shell32.dll,OpenAs_RunDLL\")) and\n\n  not (process.name : \"cscript.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\calluxxprovider.vbs\") and\n\n  not (process.name : \"cmd.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\powercfg.exe\" and process.args : \"?:\\\\WINDOWS\\\\inf\\\\PowerPlan.log\") and\n\n  not (process.name : \"regsvr32.exe\" and process.args : \"?:\\\\Windows\\\\Help\\\\OEM\\\\scripts\\\\checkmui.dll\") and\n\n  not (process.name : \"cmd.exe\" and\n       process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\oobe\\\\windeploy.exe\",\n                                    \"?:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe\",\n                                    \"?:\\\\Windows\\\\System32\\\\igfxCUIService.exe\",\n                                    \"?:\\\\Windows\\\\Temp\\\\IE*.tmp\\\\IE*-support\\\\ienrcore.exe\"))\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal\nmalicious code in a CHM file an...", "output": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"hh.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"hh.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and\n     not dns.question.name : \"localhost\"]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies the Foxmail client spawning a child process with argument pointing to the Foxmail temp directory. This may\nindicate the successful exploita...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Foxmail.exe\" and process.args : (\"?:\\\\Users\\\\*\\\\AppData\\\\*\", \"\\\\\\\\*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the execution of a child process from a Microsoft Common Console file. Adversaries may embed a malicious\ncommand in an MSC file in order to...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\mmc.exe\" and endswith~(process.parent.args, \".msc\") and\n  not (\n    process.parent.args : (\n      \"?:\\\\Windows\\\\System32\\\\*.msc\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\*.msc\",\n      \"?:\\\\Program files\\\\*.msc\",\n      \"?:\\\\Program Files (x86)\\\\*.msc\"\n    ) or\n    (\n      process.executable : \"?:\\\\Windows\\\\System32\\\\mmc.exe\" and\n      process.command_line : \"\\\"C:\\\\WINDOWS\\\\system32\\\\mmc.exe\\\" \\\"C:\\\\Windows\\\\System32\\\\gpme.msc\\\" /s /gpobject:\\\"LDAP://*\"\n    ) or\n    (\n      process.executable : (\n        \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n        \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n        \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n        \"?:\\\\Program Files\\\\internet explorer\\\\iexplore.exe\"\n      ) and\n      process.args : \"http*://go.microsoft.com/fwlink/*\"\n    ) or\n    process.executable : (\n      \"?:\\\\Windows\\\\System32\\\\vmconnect.exe\",\n      \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n      \"?:\\\\Windows\\\\System32\\\\wermgr.exe\"\n    )\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the load of a remote library by the WPS Office promecefpluginhost.exe executable. This may indicate the\nsuccessful exploitation of CVE-2024...", "output": "any where host.os.type == \"windows\" and process.name : \"promecefpluginhost.exe\" and\n(\n (event.category == \"library\" and\n  ?dll.path :\n     (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\wps\\\\INetCache\\\\*\",\n      \"\\\\Device\\\\Mup\\\\**\", \"\\\\\\\\*\")) or\n\n  ((event.category == \"process\" and event.action : \"Image loaded*\") and\n  ?file.path :\n     (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\wps\\\\INetCache\\\\*\",\n      \"\\\\Device\\\\Mup\\\\**\", \"\\\\\\\\*\"))\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Managed Object Format (MOF) files can be compiled locally or remotely through mofcomp.exe. Attackers may leverage MOF\nfiles to build their own namespa...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"mofcomp.exe\" and process.args : \"*.mof\" and\n  not user.id : \"S-1-5-18\" and\n  not\n  (\n    process.parent.name : \"ScenarioEngine.exe\" and\n    process.args : (\n      \"*\\\\MSSQL\\\\Binn\\\\*.mof\",\n      \"*\\\\Microsoft SQL Server\\\\???\\\\Shared\\\\*.mof\",\n      \"*\\\\OLAP\\\\bin\\\\*.mof\"\n    )\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies an executable created by a Microsoft Office application and subsequently executed. These processes are often\nlaunched via scripts inside do...", "output": "sequence with maxspan=2h\n  [file where host.os.type == \"windows\" and event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"WINWORD.EXE\" or\n      process.name : \"EXCEL.EXE\" or\n      process.name : \"OUTLOOK.EXE\" or\n      process.name : \"POWERPNT.EXE\" or\n      process.name : \"eqnedt32.exe\" or\n      process.name : \"fltldr.exe\" or\n      process.name : \"MSPUB.EXE\" or\n      process.name : \"MSACCESS.EXE\")\n  ] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\" and \n   not (process.name : \"NewOutlookInstaller.exe\" and process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true) and \n   not (process.name : \"ShareFileForOutlook-v*.exe\" and process.code_signature.subject_name : \"Citrix Systems, Inc.\" and process.code_signature.trusted == true)\n  ] by host.id, process.executable\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious execution patterns using NodeJS interpeter like process path and arguments.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n\n(process.name : \"node.exe\" or ?process.pe.original_file_name == \"node.exe\" or ?process.code_signature.subject_name : \"OpenJS Foundation\") and\n\n(\n  (process.executable : (\"?:\\\\Users\\\\*\\\\AppData\\\\*\\\\node.exe\", \"\\\\Device\\\\HarddiskVolume?\\\\\\\\Users\\\\*\\\\AppData\\\\*\\\\node.exe\") and process.args : \"*.js\") or\n\n  (process.args : \"-r\" and process.parent.name : \"powershell.exe\") or\n\n   process.command_line : (\"*eval(*\", \"*atob(*\", \"*require*child_process*\")\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies a suspicious file that was written by a PDF reader application and subsequently executed. These processes are\noften launched via exploitati...", "output": "sequence with maxspan=2h\n  [file where host.os.type == \"windows\" and event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"AcroRd32.exe\" or\n      process.name : \"rdrcef.exe\" or\n      process.name : \"FoxitPhantomPDF.exe\" or\n      process.name : \"FoxitReader.exe\") and\n     not (file.name : \"FoxitPhantomPDF.exe\" or\n          file.name : \"FoxitPhantomPDFUpdater.exe\" or\n          file.name : \"FoxitReader.exe\" or\n          file.name : \"FoxitReaderUpdater.exe\" or\n          file.name : \"AcroRd32.exe\" or\n          file.name : \"rdrcef.exe\")\n  ] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\"] by host.id, process.executable\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies PowerShell.exe or Cmd.exe execution spawning from Windows Script Host processes Wscript.exe.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.command_line != null and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"cmd.exe\") or\n    ?process.pe.original_file_name : (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\", \"Cmd.Exe\")\n  ) and\n  process.parent.name : (\"wscript.exe\", \"mshta.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies use of the SysInternals tool PsExec.exe making a network connection. This could be an indication of lateral\nmovement.\n", "output": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"PsExec.exe\" and event.type == \"start\" and\n\n   /* This flag suppresses the display of the license dialog and may\n      indicate that psexec executed for the first time in the machine */\n   process.args : \"-accepteula\" and\n\n   not process.executable : (\"?:\\\\ProgramData\\\\Docusnap\\\\Discovery\\\\discovery\\\\plugins\\\\17\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Docusnap 11\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Tools\\\\dsDNS.exe\") and\n   not process.parent.executable : \"?:\\\\Program Files (x86)\\\\Cynet\\\\Cynet Scanner\\\\CynetScanner.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"PsExec.exe\"]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the native Windows tools regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a network connection.\nThis may be indicative of an a...", "output": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n   process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\") and\n   not (\n         (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n         (process.parent.name : \"msiexec.exe\" or process.parent.executable : (\"C:\\\\Program Files (x86)\\\\*.exe\", \"C:\\\\Program Files\\\\*.exe\"))\n       )\n   ]\n  [network where host.os.type == \"windows\" and process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\")  and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and network.protocol != \"dns\"]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies potential attempt to execute via a reverse shell using the netcat utility to execute Windows commands using\nthe default interpreters like C...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.name : (\"cmd.exe\", \"powershell.exe\") and process.parent.args : \"-e\" and\n (\n  (process.parent.args_count == 5 and process.parent.command_line regex~ \"\"\".*[0-9]{1,3}(\\.[0-9]{1,3}){3}.*\"\"\") or\n  (process.parent.args : \"-*l*\" and process.parent.args : \"-*p*\" and process.parent.args : (\"cmd.exe\", \"powershell.exe\"))\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the PowerShell process loading the Task Scheduler COM DLL followed by an outbound RPC network connection\nwithin a short time period. This m...", "output": "sequence by host.id, process.entity_id with maxspan = 5s\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n [network where host.os.type == \"windows\" and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and destination.port == 135 and not destination.address in (\"127.0.0.1\", \"::1\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies attempt to execute Windows scripts from a remote WebDav Share. Adversaries may abuse this method to evade\ndropping malicious files to victi...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"cmd.exe\", \"powershell.exe\", \"conhost.exe\", \"wscript.exe\", \"mshta.exe\", \"curl.exe\", \"msiexec.exe\", \"bitsadmin.exe\", \"net.exe\") and\n process.command_line : (\"*trycloudflare.com*\", \"*@SSL\\\\*\", \"*\\\\webdav\\\\*\", \"*\\\\DavWWWRoot\\\\*\", \"*\\\\\\\\*.*@8080\\\\*\", \"*\\\\\\\\*.*@80\\\\*\", \"*\\\\\\\\*.*@8443\\\\*\", \"*\\\\\\\\*.*@443\\\\*\") and\n not (process.name : \"cmd.exe\" and process.args : \"\\\\\\\\?\\\\UNC\\\\*.sharepoint.com@SSL\\\\DavWWWRoot\\\\*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to execute Jscript/Vbscript files from an archive file. The use of archives is a common delivery method\nof malicious scripts.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"wscript.exe\" and\n process.parent.name : (\"explorer.exe\", \"winrar.exe\", \"7zFM.exe\") and\n process.args :\n        (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*\\\\*\",\n         \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*.zip.*\\\\*\",\n         \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\\\\*\",\n         \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*\\\\*\",\n         \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\BNZ.*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the creation, change, or deletion of a DLL module within a Windows SxS local folder. Adversaries may abuse\nshared modules to execute malici...", "output": "file where host.os.type == \"windows\" and file.extension : \"dll\" and\n  file.path : (\n    \"C:\\\\*\\\\*.exe.local\\\\*.dll\",\n    /* Crowdstrike specific condition as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\*\\\\*.exe.local\\\\*.dll\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious command execution (cmd) via Windows Management Instrumentation (WMI) on a remote host. This could\nbe indicative of adversary lat...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"WmiPrvSE.exe\" and process.name : \"cmd.exe\" and process.args : \"/c\" and process.args:\"/Q\" and \n process.args : \"2>&1\" and process.args: \"1>\"  and \n process.args : (\"C:\\\\windows\\\\temp\\\\*.txt\", \"\\\\Windows\\\\Temp\\\\*\", \"-encodehex\", \"\\\\\\\\127.0.0.1\\\\C$\\\\Windows\\\\Temp\\\\*\", \"\\\\\\\\127.0.0.1\\\\ADMIN$\\\\__*.*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies a suspicious image load (wmiutils.dll) from Microsoft Office processes. This behavior may indicate\nadversarial activity where child process...", "output": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious child processes of PDF reader applications. These child processes are often launched via\nexploitation of PDF applications or soc...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"AcroRd32.exe\",\n                         \"Acrobat.exe\",\n                         \"FoxitPhantomPDF.exe\",\n                         \"FoxitReader.exe\") and\n  process.name : (\"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n                  \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\",\n                  \"quser.exe\", \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\",\n                  \"whoami.exe\", \"bginfo.exe\", \"cdb.exe\", \"cmstp.exe\", \"csi.exe\", \"dnx.exe\", \"fsi.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"Microsoft.Workflow.Compiler.exe\", \"msbuild.exe\", \"mshta.exe\",\n                  \"msxsl.exe\", \"odbcconf.exe\", \"rcsi.exe\", \"regsvr32.exe\", \"xwizard.exe\", \"atbroker.exe\",\n                  \"forfiles.exe\", \"schtasks.exe\", \"regasm.exe\", \"regsvcs.exe\", \"cmd.exe\", \"cscript.exe\",\n                  \"powershell.exe\", \"pwsh.exe\", \"wmic.exe\", \"wscript.exe\", \"bitsadmin.exe\", \"certutil.exe\", \"ftp.exe\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious psexec activity which is executing from the psexec service that has been renamed, possibly to\nevade detection.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name : \"psexesvc.exe\" and not process.name : \"PSEXESVC.exe\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal\nmalicious code in a CHM file an...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"hh.exe\" and\n process.name : (\"mshta.exe\", \"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"cscript.exe\", \"wscript.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects when the Console Window Host (conhost.exe) process is spawned by a suspicious parent process, which could be\nindicative of code injection.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"conhost.exe\" and\n  process.parent.name : (\"lsass.exe\", \"services.exe\", \"smss.exe\", \"winlogon.exe\", \"explorer.exe\", \"dllhost.exe\", \"rundll32.exe\",\n                         \"regsvr32.exe\", \"userinit.exe\", \"wininit.exe\", \"spoolsv.exe\", \"ctfmon.exe\") and\n  not (process.parent.name : \"rundll32.exe\" and\n       process.parent.args : (\"?:\\\\Windows\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\",\n                              \"?:\\\\WINDOWS\\\\system32\\\\PcaSvc.dll,PcaPatchSdbTask\",\n                              \"?:\\\\WINDOWS\\\\system32\\\\davclnt.dll,DavSetCookie\"))\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to open a Microsoft Management Console File from untrusted paths. Adversaries may use MSC files for\ninitial access and execution.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n\n    /* Crowdstrike specific condition as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\mmc.exe\"\n  ) and\n  process.args : \"*.msc\" and\n  not process.args : (\n        \"?:\\\\Windows\\\\System32\\\\*.msc\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\*.msc\",\n        \"?:\\\\Program files\\\\*.msc\",\n        \"?:\\\\Program Files (x86)\\\\*.msc\",\n        \"?:\\\\Windows\\\\ADFS\\\\Microsoft.IdentityServer.msc\"\n  ) and\n  not process.command_line : (\n    \"C:\\\\Windows\\\\system32\\\\mmc.exe eventvwr.msc /s\",\n    \"mmc.exe eventvwr.msc /s\",\n    \"\\\"C:\\\\Windows\\\\System32\\\\mmc.exe\\\" CompMgmt.msc*\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the execution of the Windows Command Shell process (cmd.exe) with suspicious argument values. This behavior\nis often observed during malwar...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and\n  (\n    process.command_line : (\n        \"*).Run(*\", \"*GetObject*\", \"* curl*regsvr32*\", \"*echo*wscript*\", \"*echo*ZONE.identifier*\",\n        \"*ActiveXObject*\", \"*dir /s /b *echo*\", \"*unescape(*\",  \"*findstr*TVNDRgAAAA*\", \"*findstr*passw*\", \"*start*\\\\\\\\*\\\\DavWWWRoot\\\\*\",\n        \"* explorer*%CD%*\", \"*%cd%\\\\*.js*\", \"*attrib*%CD%*\", \"*/?cMD<*\", \"*/AutoIt3ExecuteScript*..*\", \"*&cls&cls&cls&cls&cls&*\",\n        \"*&#*;&#*;&#*;&#*;*\", \"* &&s^eT*\", \"*& ChrW(*\", \"*&explorer /root*\", \"*start __ & __\\\\*\", \"*findstr /V /L *forfiles*\",\n        \"*=wscri& set *\", \"*http*!COmpUternaME!*\", \"*start *.pdf * start /min cmd.exe /c *\\\\\\\\*\", \"*pip install*System.Net.WebClient*\",\n        \"*Invoke-WebReques*Start-Process*\", \"*-command (Invoke-webrequest*\", \"*copy /b *\\\\\\\\* ping *-n*\", \"*echo*.ToCharArray*\"\n    ) or\n\n    (process.args : \"echo\" and process.parent.name : (\"wscript.exe\", \"mshta.exe\")) or\n    \n    process.args : (\"1>?:\\\\*.vbs\", \"1>?:\\\\*.js\") or\n\n    (process.args : \"explorer.exe\" and process.args : \"type\" and process.args : \">\" and process.args : \"start\") or\n\n    (\n      process.parent.name : \"explorer.exe\" and\n      process.command_line : (\n        \"*&&S^eT *\",\n        \"*&& set *&& set *&& set *&& set *&& set *&& call*\",\n        \"**\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??*\"\n      )\n    ) or\n\n    (process.parent.name : \"explorer.exe\" and process.args : \"copy\" and process.args : \"&&\" and process.args : \"\\\\\\\\*@*\\\\*\")\n  ) and\n\n  /* false positives */\n  not (process.args : \"%TEMP%\\\\Spiceworks\\\\*\" and process.parent.name : \"wmiprvse.exe\") and\n  not ?process.parent.executable : (\n        \"?:\\\\Perl64\\\\bin\\\\perl.exe\",\n        \"?:\\\\Program Files\\\\nodejs\\\\node.exe\",\n        \"?:\\\\Program Files\\\\HP\\\\RS\\\\pgsql\\\\bin\\\\pg_dumpall.exe\",\n        \"?:\\\\Program Files (x86)\\\\PRTG Network Monitor\\\\64 bit\\\\PRTG Server.exe\",\n        \"?:\\\\Program Files (x86)\\\\Spiceworks\\\\bin\\\\spiceworks-finder.exe\",\n        \"?:\\\\Program Files (x86)\\\\Zuercher Suite\\\\production\\\\leds\\\\leds.exe\",\n        \"?:\\\\Program Files\\\\Tripwire\\\\Agent\\\\Plugins\\\\twexec\\\\twexec.exe\",\n        \"D:\\\\Agents\\\\?\\\\_work\\\\_tasks\\\\*\\\\SonarScanner.MSBuild.exe\",\n        \"?:\\\\Program Files\\\\Microsoft VS Code\\\\Code.exe\",\n        \"?:\\\\programmiweb\\\\NetBeans-*\\\\netbeans\\\\bin\\\\netbeans64.exe\",\n        \"?:\\\\Program Files (x86)\\\\Public Safety Suite Professional\\\\production\\\\leds\\\\leds.exe\",\n        \"?:\\\\Program Files (x86)\\\\Tier2Tickets\\\\button_gui.exe\",\n        \"?:\\\\Program Files\\\\NetBeans-*\\\\netbeans\\\\bin\\\\netbeans*.exe\",\n        \"?:\\\\Program Files (x86)\\\\Public Safety Suite Professional\\\\production\\\\leds\\\\leds.exe\",\n        \"?:\\\\Program Files (x86)\\\\Tier2Tickets\\\\button_gui.exe\",\n        \"?:\\\\Program Files (x86)\\\\Helpdesk Button\\\\button_gui.exe\",\n        \"?:\\\\VTSPortable\\\\VTS\\\\jre\\\\bin\\\\javaw.exe\",\n        \"?:\\\\Program Files\\\\Bot Framework Composer\\\\Bot Framework Composer.exe\",\n        \"?:\\\\Program Files\\\\KMSYS Worldwide\\\\eQuate\\\\*\\\\SessionMgr.exe\",\n        \"?:\\\\Program Files (x86)\\\\Craneware\\\\Pricing Analyzer\\\\Craneware.Pricing.Shell.exe\",\n        \"?:\\\\Program Files (x86)\\\\jumpcloud-agent-app\\\\jumpcloud-agent-app.exe\",\n        \"?:\\\\Program Files\\\\PostgreSQL\\\\*\\\\bin\\\\pg_dumpall.exe\",\n        \"?:\\\\Program Files (x86)\\\\Vim\\\\vim*\\\\vimrun.exe\") and\n  not (\n        /* Crowdstrike doesn't populate process.parent.executable */\n        event.dataset == \"crowdstrike.fdr\" and\n        process.parent.name : (\n          \"perl.exe\", \"node.exe\", \"pg_dumpall.exe\", \"PRTG Server.exe\", \"spiceworks-finder.exe\", \"leds.exe\", \"twexec.exe\",\n          \"SonarScanner.MSBuild.exe\", \"Code.exe\", \"netbeans64.exe\", \"javaw.exe\", \"Bot Framework Composer.exe\", \"SessionMgr.exe\",\n          \"Craneware.Pricing.Shell.exe\", \"jumpcloud-agent-app.exe\", \"vimrun.exe\"\n        )\n      ) and\n  not (process.args :  \"?:\\\\Program Files\\\\Citrix\\\\Secure Access Client\\\\nsauto.exe\" and process.parent.name : \"userinit.exe\") and\n  not process.args : (\n        \"?:\\\\Program Files (x86)\\\\PCMatic\\\\PCPitstopScheduleService.exe\",\n        \"?:\\\\Program Files (x86)\\\\AllesTechnologyAgent\\\\*\",\n        \"https://auth.axis.com/oauth2/oauth-authorize*\"\n  ) and\n  not process.command_line : (\n    \"\\\"cmd\\\" /c %NETBEANS_MAVEN_COMMAND_LINE%\",\n    \"?:\\\\Windows\\\\system32\\\\cmd.exe /q /d /s /c \\\"npm.cmd ^\\\"install^\\\" ^\\\"--no-bin-links^\\\" ^\\\"--production^\\\"\\\"\"\"  ) and\n  not (process.name : \"cmd.exe\" and process.args : \"%TEMP%\\\\Spiceworks\\\\*\" and process.args : \"http*/dataloader/persist_netstat_data\") and\n  not (process.args == \"echo\" and process.args == \"GEQ\" and process.args == \"1073741824\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies potential fake CAPTCHA phishing attack based on PowerShell or Cmd argument values. Adversaries employ this\ntechnique via compromised websit...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"powershell.exe\", \"cmd.exe\", \"mshta.exe\") and process.parent.name : \"explorer.exe\" and\n process.command_line : (\"*recaptcha *\", \"*CAPTCHA Verif*\", \"*complete verification*\", \"*Verification ID*\", \"*Verification Code*\", \"*Verification UID*\",\n                         \"*hmn vldtin*\", \"*human ID*\", \"*Action Identificator*\", \"*not a robot*\", \"*Click OK to*\", \"*anti-robot test*\",\n                         \"*Cloudflare ID*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the execution of Windows commands or downloaded files via the browser's dialog box. Adversaries may use phishing\nto instruct the victim to ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.args == \"--message-loop-type-ui\" and process.parent.args == \"--service-sandbox-type=none\" and\n (\n  process.name : (\"pwsh.exe\", \"powershell.exe\", \"curl.exe\", \"msiexec.exe\", \"mshta.exe\", \"wscript.exe\", \"cscript.exe\", \"rundll32.exe\", \"certutil.exe\", \"certreq.exe\") or\n  process.executable : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\"\n  ) and\nnot (process.name : \"rundll32.exe\" and process.args : (\"ndfapi.dll,NdfRunDllDiagnoseWithAnswerFile\", \"shwebsvc.dll,AddNetPlaceRunDll\"))\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation of a Windows script downloaded from the internet followed by the execution of a scripting utility.\nAdversaries may use Windows...", "output": "sequence by host.id, user.id with maxspan=3m\n[file where host.os.type == \"windows\" and event.action == \"creation\" and user.id != \"S-1-5-18\" and\n  process.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"explorer.exe\", \"winrar.exe\", \"7zFM.exe\", \"7zG.exe\", \"Bandizip.exe\") and\n  file.extension in~ (\"js\", \"jse\", \"vbs\", \"vbe\", \"wsh\", \"hta\", \"cmd\", \"bat\") and\n  (file.origin_url != null or file.origin_referrer_url != null)]\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"firefox.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"explorer.exe\", \"winrar.exe\", \"7zFM.exe\", \"7zG.exe\", \"Bandizip.exe\") and \n process.args_count >= 2 and\n (\n  process.name in~ (\"wscript.exe\", \"mshta.exe\") or\n  (process.name : \"cmd.exe\" and process.command_line : (\"*.cmd*\", \"*.bat*\"))\n  )]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the deletion of backup files, saved using third-party software, by a process outside of the backup suite.\nAdversaries may delete Backup fil...", "output": "file where host.os.type == \"windows\" and event.type == \"deletion\" and\n  (\n    /* Veeam Related Backup Files */\n    (\n      file.extension : (\"VBK\", \"VIB\", \"VBM\") and\n      not (\n        process.executable : (\"?:\\\\Windows\\\\*\", \"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\") and\n        (process.code_signature.trusted == true and process.code_signature.subject_name : (\"Veeam Software Group GmbH\", \"Veeam Software AG\"))\n      )\n    ) or\n    /* Veritas Backup Exec Related Backup File */\n    (\n      file.extension : \"BKF\" and\n        not process.executable : (\n          \"?:\\\\Program Files\\\\Veritas\\\\Backup Exec\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\Veritas\\\\Backup Exec\\\\*\"\n        )\n    )\n  ) and\n  not (\n    process.name : (\"MSExchangeMailboxAssistants.exe\", \"Microsoft.PowerBI.EnterpriseGateway.exe\") and\n      (process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true)\n  ) and\n  not file.path : (\n    \"?:\\\\ProgramData\\\\Trend Micro\\\\*\",\n    \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*\",\n    \"?:\\\\$RECYCLE.BIN\\\\*\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects use of wbadmin.exe to delete backup catalogs, system state backups, or other backup data. Ransomware and other\nmalware may do this to prevent ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wbadmin.exe\" or ?process.pe.original_file_name == \"WBADMIN.EXE\") and\n  process.args : (\"catalog\", \"backup\", \"systemstatebackup\") and process.args : \"delete\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to delete or modify critical files used during the boot process to prevent the system from booting.\nThis may indicate a destructiv...", "output": "file where host.os.type == \"windows\" and event.type in (\"change\", \"deletion\") and\n file.name : (\"winload.exe\", \"winlod.efi\", \"ntoskrnl.exe\", \"bootmgr\") and\n file.path : (\"?:\\\\Windows\\\\*\", \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\*\") and\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\poqexec.exe\", \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\poqexec.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or an\nattacker as a destructive technique...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and\n    (\n      (process.args : \"/set\" and process.args : \"bootstatuspolicy\" and process.args : \"ignoreallfailures\") or\n      (process.args : \"no\" and process.args : \"recoveryenabled\")\n    )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies an incoming SMB connection followed by a suspicious file rename operation. This may indicate a remote\nransomware attack via the SMB protoco...", "output": "sequence by host.id with maxspan=1s\n [network where host.os.type == \"windows\" and\n  event.action == \"connection_accepted\" and destination.port == 445 and source.port >= 49152 and process.pid == 4 and\n  source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.type == \"ipv4\" and not endswith(source.address, destination.address)]\n [file where host.os.type == \"windows\" and\n  event.action == \"rename\" and process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-*\") and\n  file.extension != null and file.Ext.entropy >= 6 and file.path : \"C:\\\\Users\\\\*\" and\n  file.Ext.original.name : (\"*.jpg\", \"*.bmp\", \"*.png\", \"*.pdf\", \"*.doc\", \"*.docx\", \"*.xls\", \"*.xlsx\", \"*.ppt\", \"*.pptx\", \"*.lnk\") and\n  not file.extension : (\"jpg\", \"bmp\", \"png\", \"pdf\", \"doc\", \"docx\", \"xls\", \"xlsx\", \"ppt\", \"pptx\", \"*.lnk\")] with runs=3\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies an incoming SMB connection followed by the creation of a file with a name similar to ransomware note files.\nThis may indicate a remote rans...", "output": "sequence by host.id with maxspan=1s\n [network where host.os.type == \"windows\" and\n  event.action == \"connection_accepted\" and destination.port == 445 and source.port >= 49152 and process.pid == 4 and\n  source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.type == \"ipv4\" and not endswith(source.address, destination.address)]\n [file where host.os.type == \"windows\" and event.action == \"creation\" and\n  process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-*\") and file.extension : (\"hta\", \"txt\", \"readme\", \"htm*\") and\n  file.path : \"C:\\\\Users\\\\*\" and\n   /* ransom file name keywords */\n    file.name : (\"*read*me*\", \"*lock*\", \"*@*\", \"*RECOVER*\", \"*decrypt*\", \"*restore*file*\", \"*FILES_BACK*\", \"*how*to*\")] with runs=3\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem with\nransomware or other destructive ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"vssadmin.exe\" or ?process.pe.original_file_name == \"VSSADMIN.EXE\") and\n  process.args : (\"delete\", \"resize\") and process.args : \"shadows*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the use of the Win32_ShadowCopy class and related cmdlets to achieve shadow copy deletion. This commonly\noccurs in tandem with ransomware o...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.args : (\"*Get-WmiObject*\", \"*gwmi*\", \"*Get-CimInstance*\", \"*gcim*\") and\n  process.args : (\"*Win32_ShadowCopy*\") and\n  process.args : (\"*.Delete()*\", \"*Remove-WmiObject*\", \"*rwmi*\", \"*Remove-CimInstance*\", \"*rcim*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies use of wmic.exe for shadow copy deletion on endpoints. This commonly occurs in tandem with ransomware or\nother destructive attacks.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"WMIC.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"delete\" and process.args : \"shadowcopy\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the execution of a browser process to open an HTML file with high entropy and size. Adversaries may smuggle\ndata and files past content fil...", "output": "sequence by user.id with maxspan=2m\n\n [file where host.os.type == \"windows\" and event.action in (\"creation\", \"rename\") and\n\n  /* Check for HTML files with high entropy and size */\n  file.extension : (\"htm\", \"html\") and ((file.Ext.entropy >= 5 and file.size >= 150000) or file.size >= 1000000) and\n\n  /* Check for file paths in common download and temporary directories */\n  file.path : (\n    \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n    \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\")]\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n  (\n   /* Check for browser processes opening HTML files with single argument */\n   (process.name in (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\")\n    and process.args == \"--single-argument\") or\n\n   /* Optionally, check for browser processes opening HTML files with two arguments */\n   (process.name == \"iexplore.exe\" and process.args_count == 2) or\n\n   /* Optionally, check for browser processes opening HTML files with URL argument */\n   (process.name in (\"firefox.exe\", \"waterfox.exe\") and process.args == \"-url\")\n  )\n  /* Check for file paths in common download and temporary directories targeted in the process arguments */\n  and process.args : (\"?:\\\\Users\\\\*\\\\Downloads\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*.htm*\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the execution of a process with arguments pointing to the INetCache Folder. Adversaries may deliver malicious\ncontent via WININET during in...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"explorer.exe\", \"winrar.exe\", \"7zFM.exe\", \"Bandizip.exe\") and\n  (\n    process.args : \"*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\" or\n    process.executable : (\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\",\n\n      /* Crowdstrike specific condition as it uses NT Object paths */\n      \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\"\n    )\n  ) and\n  not process.executable : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\mspaint.exe\",\n        \"?:\\\\Windows\\\\System32\\\\notepad.exe\",\n\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\mspaint.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\notepad.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies process execution from a removable media and by an unusual process. Adversaries may move onto systems,\npossibly those on disconnected or ai...", "output": "sequence by process.entity_id with maxspan=5m\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n\n  /* Direct Exec from USB */\n  (process.Ext.device.bus_type : \"usb\" or process.Ext.device.product_id : \"USB *\") and\n  (process.code_signature.trusted == false or process.code_signature.exists == false) and\n\n  not process.code_signature.status : (\"errorExpired\", \"errorCode_endpoint*\")]\n [network where host.os.type == \"windows\" and event.action == \"connection_attempted\"]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the execution of the built-in Windows Installer, msiexec.exe, to install a remote package. Adversaries may\nabuse msiexec.exe to launch loca...", "output": "sequence with maxspan=1m\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n    process.name : \"msiexec.exe\" and process.args : \"/V\"] by process.entity_id\n [network where host.os.type == \"windows\" and process.name : \"msiexec.exe\" and\n    event.action == \"connection_attempted\"] by process.entity_id\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.parent.name : \"msiexec.exe\" and user.id : (\"S-1-5-21-*\", \"S-1-5-12-1-*\") and\n  not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\srtasks.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\srtasks.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\taskkill.exe\",\n                            \"?:\\\\Windows\\\\Installer\\\\MSI*.tmp\",\n                            \"?:\\\\Program Files\\\\*.exe\",\n                            \"?:\\\\Program Files (x86)\\\\*.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\ie4uinit.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\ie4uinit.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\sc.exe\",\n                            \"?:\\\\Windows\\\\system32\\\\Wbem\\\\mofcomp.exe\",\n                            \"?:\\\\Windows\\\\twain_32\\\\fjscan32\\\\SOP\\\\crtdmprc.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\taskkill.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\schtasks.exe\",\n                            \"?:\\\\Windows\\\\system32\\\\schtasks.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\sdbinst.exe\") and\n  not (process.code_signature.subject_name == \"Citrix Systems, Inc.\" and process.code_signature.trusted == true) and\n  not (process.name : (\"regsvr32.exe\", \"powershell.exe\", \"rundll32.exe\", \"wscript.exe\") and\n       process.Ext.token.integrity_level_name == \"high\" and\n       process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\")) and\n  not (process.executable : (\"?:\\\\Program Files\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\*.exe\") and process.code_signature.trusted == true) and\n  not (process.name : \"rundll32.exe\" and process.args : \"printui.dll,PrintUIEntry\")\n  ] by process.parent.entity_id\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies execution of common Microsoft Office applications to launch an Office Add-In from a suspicious path or with\nan unusual parent process. This...", "output": "process where\n\n    host.os.type == \"windows\" and event.type == \"start\" and\n\n    process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSACCESS.EXE\", \"VSTOInstaller.exe\") and\n\n    process.args regex~ \"\"\".+\\.(wll|xll|ppa|ppam|xla|xlam|vsto)\"\"\" and\n\n    /* Office Add-In from suspicious paths */\n    (process.args :\n             (\"?:\\\\Users\\\\*\\\\Temp\\\\7z*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Rar$*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Temp?_*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\BNZ.*\",\n              \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n              \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\*\",\n              \"?:\\\\Users\\\\Public\\\\*\",\n              \"?:\\\\ProgramData\\\\*\",\n              \"?:\\\\Windows\\\\Temp\\\\*\",\n              \"\\\\Device\\\\*\",\n              \"http*\") or\n\n    process.parent.name : (\"explorer.exe\", \"OpenWith.exe\") or\n\n    /* Office Add-In from suspicious parent */\n    process.parent.name : (\"cmd.exe\", \"powershell.exe\")) and\n\n    /* False Positives */\n    not (process.args : \"*.vsto\" and\n         process.parent.executable :\n                   (\"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptions\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility.exe\",\n                    \"?:\\\\Program Files\\\\LogiOptionsPlus\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptionsPlus\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\VSTO\\\\*\\\\VSTOInstaller.exe\")) and\n    not (process.args : \"/Uninstall\" and process.name : \"VSTOInstaller.exe\") and\n    not (process.parent.name : \"rundll32.exe\" and\n         process.parent.args : \"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\") and\n    not (process.name : \"VSTOInstaller.exe\" and process.args : \"https://dl.getsidekick.com/outlook/vsto/Sidekick.vsto\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious processes being spawned by the JetBrain TeamCity process. This activity could be related to\nJetBrains remote code execution vuln...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable :\n                 (\"?:\\\\TeamCity\\\\jre\\\\bin\\\\java.exe\",\n                  \"?:\\\\Program Files\\\\TeamCity\\\\jre\\\\bin\\\\java.exe\",\n                  \"?:\\\\Program Files (x86)\\\\TeamCity\\\\jre\\\\bin\\\\java.exe\",\n                  \"?:\\\\TeamCity\\\\BuildAgent\\\\jre\\\\bin\\\\java.exe\") and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"msiexec.exe\", \"certutil.exe\", \"bitsadmin.exe\", \"wmic.exe\", \"curl.exe\", \"ssh.exe\",\n                   \"rundll32.exe\", \"regsvr32.exe\", \"mshta.exe\", \"certreq.exe\", \"net.exe\", \"nltest.exe\", \"whoami.exe\", \"hostname.exe\",\n                   \"tasklist.exe\", \"arp.exe\", \"nbtstat.exe\", \"netstat.exe\", \"reg.exe\", \"tasklist.exe\", \"Microsoft.Workflow.Compiler.exe\",\n                   \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\",\n                   \"dnx.exe\", \"dsget.exe\", \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"ieexec.exe\", \"iexpress.exe\",\n                   \"installutil.exe\", \"ipconfig.exe\",\"msxsl.exe\", \"netsh.exe\", \"odbcconf.exe\", \"ping.exe\", \"pwsh.exe\", \"qprocess.exe\",\n                   \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"regasm.exe\", \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\",\n                   \"systeminfo.exe\", \"tracert.exe\", \"wmic.exe\", \"wscript.exe\",\"xwizard.exe\", \"explorer.exe\", \"msdt.exe\") and\n not (process.name : \"powershell.exe\" and process.args : \"-ExecutionPolicy\" and process.args : \"?:\\\\TeamCity\\\\buildAgent\\\\work\\\\*.ps1\") and\n not (process.name : \"cmd.exe\" and process.args : \"dir\" and process.args : \"/-c\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies attempts to open a remote desktop file from suspicious paths. Adversaries may abuse RDP files for initial\naccess.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : \"mstsc.exe\" and\n process.args : (\"?:\\\\Users\\\\*\\\\Downloads\\\\*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\\\\*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\BNZ.*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\Content.Outlook\\\\*.rdp\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a PowerShell process launched by either cscript.exe or wscript.exe. Observing Windows scripting processes\nexecuting a PowerShell script, ma...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"cscript.exe\", \"wscript.exe\") and process.name : \"powershell.exe\" and\n  not (\n    process.parent.name : \"wscript.exe\" and\n    process.parent.args : \"?:\\\\ProgramData\\\\intune-drive-mapping-generator\\\\IntuneDriveMapping-VBSHelper.vbs\" and\n    process.parent.args : \"?:\\\\ProgramData\\\\intune-drive-mapping-generator\\\\DriveMapping.ps1\"\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a process\nvia Windows Management Instrum...", "output": "sequence by host.id with maxspan = 5s\n    [any where host.os.type == \"windows\" and\n     (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n     (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\") and process.name : (\"wscript.exe\", \"cscript.exe\")]\n    [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.parent.name : \"wmiprvse.exe\" and\n     user.domain != \"NT AUTHORITY\" and\n     (process.pe.original_file_name :\n        (\n          \"cscript.exe\",\n          \"wscript.exe\",\n          \"PowerShell.EXE\",\n          \"Cmd.Exe\",\n          \"MSHTA.EXE\",\n          \"RUNDLL32.EXE\",\n          \"REGSVR32.EXE\",\n          \"MSBuild.exe\",\n          \"InstallUtil.exe\",\n          \"RegAsm.exe\",\n          \"RegSvcs.exe\",\n          \"msxsl.exe\",\n          \"CONTROL.EXE\",\n          \"EXPLORER.EXE\",\n          \"Microsoft.Workflow.Compiler.exe\",\n          \"msiexec.exe\"\n        ) or\n      process.executable : (\"C:\\\\Users\\\\*.exe\", \"C:\\\\ProgramData\\\\*.exe\")\n     )\n    ]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious files being written by the Microsoft Exchange Server Unified Messaging (UM) service. This activity\nhas been observed exploiting ...", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  process.name : (\"UMWorkerProcess.exe\", \"umservice.exe\") and\n  file.extension : (\"php\", \"jsp\", \"js\", \"aspx\", \"asmx\", \"asax\", \"cfm\", \"shtml\") and\n  (\n    file.path : \"?:\\\\inetpub\\\\wwwroot\\\\aspnet_client\\\\*\" or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\*\" and\n       not (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\version\\\\*\" or\n            file.name : (\"errorFE.aspx\", \"expiredpassword.aspx\", \"frowny.aspx\", \"GetIdToken.htm\", \"logoff.aspx\",\n                        \"logon.aspx\", \"OutlookCN.aspx\", \"RedirSuiteServiceProxy.aspx\", \"signout.aspx\"))) or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\ecp\\\\auth\\\\*\" and\n       not file.name : \"TimeoutLogoff.aspx\")\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious processes being spawned by the Microsoft Exchange Server Unified Messaging (UM) service. This\nactivity has been observed exploit...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"UMService.exe\", \"UMWorkerProcess.exe\") and\n    not process.executable : (\n          \"?:\\\\Windows\\\\System32\\\\werfault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n          \"?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V??\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange 2016\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"E:\\\\ExchangeServer\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"E:\\\\Exchange Server\\\\V15\\\\Bin\\\\UMWorkerProcess.exe\",\n\n          /* Crowdstrike specific exclusion as it uses NT Object paths */\n          \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\werfault.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\wermgr.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V??\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Exchange 2016\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\ExchangeServer\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Exchange\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume*\\\\Exchange Server\\\\V15\\\\Bin\\\\UMWorkerProcess.exe\"\n    )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious processes being spawned by the Microsoft Exchange Server worker process (w3wp). This activity may\nindicate exploitation activity...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"w3wp.exe\" and process.parent.args : \"MSExchange*AppPool\" and\n  (\n    (process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\"))\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel).\nThese child processes are often ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\n      \"eqnedt32.exe\", \"excel.exe\", \"fltldr.exe\", \"msaccess.exe\",\n      \"mspub.exe\", \"powerpnt.exe\", \"winword.exe\", \"outlook.exe\"\n  ) and\n  process.name : (\n      \"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\",\n      \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n      \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\", \"iexpress.exe\",\n      \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\", \"net1.exe\", \"netsh.exe\",\n      \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\", \"pwsh.exe\", \"qprocess.exe\",\n      \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\", \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\",\n      \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\",\n      \"xwizard.exe\", \"explorer.exe\", \"rundll32.exe\", \"hh.exe\", \"msdt.exe\"\n  ) and\n  not (\n    process.parent.name : \"outlook.exe\" and\n    process.name : \"rundll32.exe\" and\n    process.args : \"shell32.dll,Control_RunDLL\" and\n    process.args : \"srchadmin.dll\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious child processes of Microsoft Outlook. These child processes are often associated with spear\nphishing activity.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"outlook.exe\" and\n  process.name : (\"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\",\n                  \"cdb.exe\", \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n                  \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\",\n                  \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\",\n                  \"pwsh.exe\", \"qprocess.exe\", \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\",\n                  \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\",\n                  \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\", \"xwizard.exe\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies a suspicious Diagnostics Utility for Internet Explorer child process. This may indicate the successful exploitation of the vulnerability CV...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable : \"C:\\\\Program Files\\\\Internet Explorer\\\\iediagcmd.exe\" and\n  process.name : (\"route.exe\", \"netsh.exe\", \"ipconfig.exe\", \"dxdiag.exe\", \"conhost.exe\", \"makecab.exe\") and\n  process.executable != null and\n  not process.executable : (\"C:\\\\Windows\\\\System32\\\\route.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\netsh.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\ipconfig.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\dxdiag.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\conhost.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\makecab.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies a suspicious Windows explorer child process. Explorer.exe can be abused to launch malicious scripts or\nexecutables from a trusted parent pr...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"rundll32.exe\", \"cmd.exe\", \"mshta.exe\", \"regsvr32.exe\") or\n   ?process.pe.original_file_name in (\"cscript.exe\", \"wscript.exe\", \"PowerShell.EXE\", \"RUNDLL32.EXE\", \"Cmd.Exe\", \"MSHTA.EXE\", \"REGSVR32.EXE\")\n  ) and\n  /* Explorer started via DCOM */\n  process.parent.name : \"explorer.exe\" and process.parent.args : \"-Embedding\" and\n  not process.parent.args:\n          (\n            /* Noisy CLSID_SeparateSingleProcessExplorerHost Explorer COM Class IDs   */\n            \"/factory,{5BD95610-9434-43C2-886C-57852CC8A120}\",\n            \"/factory,{ceff45ee-c862-41de-aee2-a022c81eda92}\"\n          )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies suspicious processes being spawned by the ScreenConnect server process (ScreenConnect.Service.exe). This\nactivity may indicate exploitation...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"ScreenConnect.Service.exe\" and\n  (process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"csc.exe\") or\n  ?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\", \"pwsh.dll\", \"powershell_ise.EXE\"))\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the execution of a hosted XSL script using the Microsoft.XMLDOM COM interface via Microsoft Office processes.\nThis behavior may indicate ad...", "output": "sequence with maxspan=1m\n [library where host.os.type == \"windows\" and dll.name : \"msxml3.dll\" and\n  process.name : (\"winword.exe\", \"excel.exe\", \"powerpnt.exe\", \"mspub.exe\")] by process.entity_id\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.parent.name : (\"winword.exe\", \"excel.exe\", \"powerpnt.exe\", \"mspub.exe\") and\n  not process.executable :\n        (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n         \"?:\\\\Windows\\\\SysWoW64\\\\WerFault.exe\",\n         \"?:\\\\windows\\\\splwow64.exe\",\n         \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n         \"?:\\\\Program Files\\\\*.exe\",\n         \"?:\\\\Program Files (x86)\\\\*exe\")] by process.parent.entity_id\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies use of sc.exe to create, modify, or start services on remote hosts. This could be indicative of adversary\nlateral movement but will be nois...", "output": "sequence by process.entity_id with maxspan = 1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"sc.exe\" or process.pe.original_file_name : \"sc.exe\") and\n      process.args : \"\\\\\\\\*\" and process.args : (\"binPath=*\", \"binpath=*\") and\n      process.args : (\"create\", \"config\", \"failure\", \"start\")]\n  [network where host.os.type == \"windows\" and process.name : \"sc.exe\" and destination.ip != \"127.0.0.1\"]\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Correlates network connections to the standard Kerberos port by an unusual process from the source machine with a Kerberos\nauthentication ticket reque...", "output": "sequence by source.port, source.ip with maxspan=3s\n [network where host.os.type == \"windows\" and destination.port == 88 and\n  process.executable != null and\n  not process.executable : (\"?:\\\\Windows\\\\system32\\\\lsass.exe\", \"\\\\device\\\\harddiskvolume*\\\\windows\\\\system32\\\\lsass.exe\") and\n  source.ip != \"127.0.0.1\" and destination.ip != \"::1\" and destination.ip != \"127.0.0.1\"]\n [authentication where host.os.type == \"windows\" and event.code in (\"4768\", \"4769\")]\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the use of Distributed Component Object Model (DCOM) to execute commands from a remote host, which are\nlaunched via the HTA Application COM...", "output": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.name : \"mshta.exe\" and process.args : \"-Embedding\"\n  ] by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n     source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by host.id, process.entity_id\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched\nvia the MMC20 Application COM O...", "output": "sequence by host.id with maxspan=1m\n [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mmc.exe\" and source.port >= 49152 and\n destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\"\n ] by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"mmc.exe\"\n ] by process.parent.entity_id\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via\nthe ShellBrowserWindow or Shell...", "output": "sequence by host.id with maxspan=5s\n [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n  source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n ] by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"explorer.exe\"\n ] by process.parent.entity_id\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies NullSessionPipe registry modifications that specify which pipes can be accessed anonymously. This could be\nindicative of adversary lateral ...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"NullSessionPipes\" and\n  length(registry.data.strings) > 0 and\n  not registry.data.strings : \"(empty)\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies potentially suspicious processes that are not trusted or living-off-the-land binaries (LOLBin) making Server\nMessage Block (SMB) network co...", "output": "sequence by process.entity_id with maxspan=1m\n\n  /* first sequence to capture the start of Windows processes */\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.pid != 4 and\n\n    /* ignore NT Authority and Network Service accounts */\n    not user.id in (\"S-1-5-19\", \"S-1-5-20\") and\n\n    /* filter out anything trusted but not from Microsoft */\n    /* LOLBins will be inherently trusted and signed, so ignore everything else trusted */\n    not (process.code_signature.trusted == true and not startsWith(process.code_signature.subject_name, \"Microsoft\")) and\n\n    /* filter out PowerShell scripts from Windows Defender ATP */\n    not (\n      process.name : \"powershell.exe\" and\n      process.args :\"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\PSScript_*.ps1\")]\n\n  /* second sequence to capture network connections over port 445 related to SMB */\n  [network where host.os.type == \"windows\" and destination.port == 445 and process.pid != 4]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the modification of the Remote Desktop Protocol (RDP) Shadow registry or the execution of processes\nindicative of an active RDP shadowing s...", "output": "/* Identifies the modification of RDP Shadow registry or\n  the execution of processes indicative of active shadow RDP session */\n\nany where host.os.type == \"windows\" and\n(\n  (event.category == \"registry\" and event.type == \"change\" and\n    registry.value : \"Shadow\" and\n    registry.path : (\n      \"*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\"\n    ) and\n    registry.data.strings : (\"1\", \"0x00000001\", \"2\", \"0x00000002\", \"3\", \"0x00000003\", \"4\", \"0x00000004\")\n\n  ) or\n  (event.category == \"process\" and event.type == \"start\" and\n     (process.name : (\"RdpSaUacHelper.exe\", \"RdpSaProxy.exe\") and process.parent.name : \"svchost.exe\") or\n     (?process.pe.original_file_name : \"mstsc.exe\" and process.args : \"/shadow:*\")\n  )\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation or change of a Windows executable file over network shares. Adversaries may transfer tools or\nother files between systems in a...", "output": "sequence by host.id with maxspan=30s\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.pid == 4 and destination.port == 445 and\n   network.direction : (\"incoming\", \"ingress\") and\n   network.transport == \"tcp\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by process.entity_id\n  /* add more executable extensions here if they are not noisy in your environment */\n  [file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and process.pid == 4 and \n   (file.Ext.header_bytes : \"4d5a*\" or file.extension : (\"exe\", \"scr\", \"pif\", \"com\", \"dll\"))] by process.entity_id\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies execution from the Remote Desktop Protocol (RDP) shared mountpoint tsclient on the target host. This may\nindicate a lateral movement attemp...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.executable : \"\\\\Device\\\\Mup\\\\tsclient\\\\*.exe\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the execution of a file that was created by the virtual system process. This may indicate lateral movement\nvia network file shares.\n", "output": "sequence with maxspan=1m\n  [file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and \n   process.pid == 4 and (file.extension : \"exe\" or file.Ext.header_bytes : \"4d5a*\")] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    not (\n      (\n        process.code_signature.trusted == true and\n        process.code_signature.subject_name : (\n              \"Veeam Software Group GmbH\",\n              \"Elasticsearch, Inc.\",\n              \"PDQ.com Corporation\",\n              \"CrowdStrike, Inc.\",\n              \"Microsoft Windows Hardware Compatibility Publisher\",\n              \"ZOHO Corporation Private Limited\",\n              \"BeyondTrust Corporation\", \n              \"CyberArk Software Ltd.\", \n              \"Sophos Ltd\"\n        )\n      ) or\n      (\n        process.executable : (\n          \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\",\n          \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\AM_Delta*.exe\",\n          \"?:\\\\Windows\\\\CAInvokerService.exe\"\n        ) and process.code_signature.trusted == true\n      ) or\n      (\n        process.executable : \"G:\\\\SMS_*\\\\srvboot.exe\" and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"Microsoft Corporation\"\n      )\n    )\n  ] by host.id, process.executable\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies remote execution via Windows Remote Management (WinRM) remote shell on a target host. This could be an\nindication of lateral movement.\n", "output": "sequence by host.id with maxspan=30s\n   [network where host.os.type == \"windows\" and process.pid == 4 and network.direction : (\"incoming\", \"ingress\") and\n    destination.port in (5985, 5986) and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and\n    event.type == \"start\" and process.parent.name : \"winrshost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the use of net.exe to mount a WebDav or hidden remote share. This may indicate lateral movement or\npreparation for data exfiltration.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n ((process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and\n not process.parent.name : \"net.exe\")) and\n process.args : \"use\" and\n /* including hidden and webdav based online shares such as onedrive  */\n process.args : (\"\\\\\\\\*\\\\*$*\", \"\\\\\\\\*@SSL\\\\*\", \"http*\") and\n /* excluding shares deletion operation */\n not process.args : \"/d*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies remote execution via Windows PowerShell remoting. Windows PowerShell remoting allows a user to run any\nWindows PowerShell command on one or...", "output": "sequence by host.id with maxspan = 30s\n   [network where host.os.type == \"windows\" and network.direction : (\"incoming\", \"ingress\") and destination.port in (5985, 5986) and\n    source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and\n    event.type == \"start\" and process.parent.name : \"wsmprovhost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies registry write modifications to enable Remote Desktop Protocol (RDP) access. This could be indicative of\nadversary lateral movement prepara...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"fDenyTSConnections\" and\n  registry.data.strings : (\"0\", \"0x00000000\") and\n  not process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\SystemPropertiesRemote.exe\",\n        \"?:\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe\",\n        \"?:\\\\Windows\\\\System32\\\\SystemPropertiesAdvanced.exe\",\n        \"?:\\\\Windows\\\\System32\\\\SystemSettingsAdminFlows.exe\",\n        \"?:\\\\Windows\\\\WinSxS\\\\*\\\\TiWorker.exe\",\n        \"?:\\\\Windows\\\\system32\\\\svchost.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\SystemPropertiesRemote.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\SystemPropertiesAdvanced.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\SystemSettingsAdminFlows.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\WinSxS\\\\*\\\\TiWorker.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\system32\\\\svchost.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies potential behavior of SharpRDP, which is a tool that can be used to perform authenticated command execution\nagainst a remote target via Rem...", "output": "/* Incoming RDP followed by a new RunMRU string value set to cmd, powershell, taskmgr or tsclient, followed by process execution within 1m */\n\nsequence by host.id with maxspan=1m\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"svchost.exe\" and destination.port == 3389 and\n   network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ]\n\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and process.name : \"explorer.exe\" and\n   registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\RunMRU\\\\*\") and\n   registry.data.strings : (\"cmd.exe*\", \"powershell.exe*\", \"taskmgr*\", \"\\\\\\\\tsclient\\\\*.exe\\\\*\")\n  ]\n\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.parent.name : (\"cmd.exe\", \"powershell.exe\", \"taskmgr.exe\") or process.args : (\"\\\\\\\\tsclient\\\\*.exe\")) and\n   not process.name : \"conhost.exe\"\n   ]\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies a remote file copy attempt to a hidden network share. This may indicate lateral movement or data staging\nactivity.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"xcopy.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and \n  process.command_line : \"*\\\\\\\\*\\\\*$*\" and process.command_line : (\"*copy*\", \"*move*\", \"* cp *\", \"* mv *\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies a network logon followed by Windows service creation with same LogonId. This could be indicative of lateral\nmovement, but will be noisy if ...", "output": "sequence by winlog.logon.id, winlog.computer_name with maxspan=1m\n[authentication where event.action == \"logged-in\" and winlog.logon.type : \"Network\" and\nevent.outcome==\"success\" and source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n[iam where event.action == \"service-installed\" and\n not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n not winlog.event_data.ServiceFileName :\n               (\"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\WINDOWS\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\")]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateral\nmovement, but will be noisy if c...", "output": "sequence with maxspan=1s\n   [network where host.os.type == \"windows\" and process.name : \"services.exe\" and\n      network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n      source.port >= 49152 and destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ] by host.id, process.entity_id\n   [process where host.os.type == \"windows\" and \n       event.type == \"start\" and process.parent.name : \"services.exe\" and\n       not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"/V\") and\n       not process.executable : (\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\srmhost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\"\n       )] by host.id, process.parent.entity_id\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies scheduled task creation from a remote source. This could be indicative of adversary lateral movement.\n", "output": "iam where event.action == \"scheduled-task-created\" and\n winlog.event_data.RpcCallClientLocality : \"0\" and winlog.event_data.ClientProcessId : \"0\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies remote scheduled task creations on a target host. This could be indicative of adversary lateral movement.", "output": "/* Task Scheduler service incoming connection followed by TaskCache registry modification  */\n\nsequence by host.id, process.entity_id with maxspan = 1m\n   [network where host.os.type == \"windows\" and process.name : \"svchost.exe\" and\n   network.direction : (\"incoming\", \"ingress\") and source.port >= 49152 and destination.port >= 49152 and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ]\n   [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies suspicious Image Loading of the Remote Desktop Services ActiveX Client (mstscax), this may indicate the\npresence of RDP lateral movement ca...", "output": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : \"mstscax.dll\" or file.name : \"mstscax.dll\") and\n   /* depending on noise in your env add here extra paths  */\n  process.executable : (\n    \"C:\\\\Windows\\\\*\",\n    \"C:\\\\Users\\\\Public\\\\*\",\n    \"C:\\\\Users\\\\Default\\\\*\",\n    \"C:\\\\Intel\\\\*\",\n    \"C:\\\\PerfLogs\\\\*\",\n    \"C:\\\\ProgramData\\\\*\",\n    \"\\\\Device\\\\Mup\\\\*\",\n    \"\\\\\\\\*\"\n  ) and\n  /* add here FPs */\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\System32\\\\vmconnect.exe\",\n    \"?:\\\\Windows\\\\System32\\\\WindowsSandboxClient.exe\",\n    \"?:\\\\Windows\\\\System32\\\\hvsirdpclient.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies an unexpected process spawning from dns.exe, the process responsible for Windows DNS server services, which\nmay indicate activity related t...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"dns.exe\" and\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n\n    /* Crowdstrike specific exclusion as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\conhost.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\ReasonLabs\\\\*\"\n  ) and\n  not ?process.parent.executable : \"?:\\\\Program Files\\\\ReasonLabs\\\\DNS\\\\ui\\\\DNS.exe\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious file creations in the startup folder of a remote system. An adversary could abuse this to move\nlaterally by dropping a malicious...", "output": "file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and\n\n /* via RDP TSClient mounted share or SMB */\n  (process.name : \"mstsc.exe\" or process.pid == 4) and\n\n   file.path : (\"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n                \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies a potential Windows Server Update Services (WSUS) abuse to execute psexec to enable for lateral movement.\nWSUS is limited to executing Micr...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"wuauclt.exe\" and\nprocess.executable : (\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\"\n) and\n(process.name : \"psexec64.exe\" or ?process.pe.original_file_name : \"psexec.c\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects writing executable files that will be automatically launched by Adobe on launch.", "output": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.path : (\n    \"?:\\\\Program Files (x86)\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\",\n    \"?:\\\\Program Files\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\",\n\n    /* Crowdstrike specific condition as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\"\n  ) and\n  not process.name : (\"msiexec.exe\", \"AdobeARM.exe\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies the installation of custom Application Compatibility Shim databases. This Windows functionality has been\nabused by attackers to stealthily ...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\" and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\*\\\\Setup\\\\NwSapSetup.exe\",\n        \"?:\\\\$WINDOWS.~BT\\\\Sources\\\\SetupPlatform.exe\",\n        \"?:\\\\Program Files (x86)\\\\SAP\\\\SAPsetup\\\\setup\\\\NwSapSetup.exe\",\n        \"?:\\\\Program Files (x86)\\\\SAP\\\\SapSetup\\\\OnRebootSvc\\\\NWSAPSetupOnRebootInstSvc.exe\",\n        \"?:\\\\Program Files (x86)\\\\Kaspersky Lab\\\\Kaspersky Security for Windows Server\\\\kavfs.exe\",\n\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\*\\\\Setup\\\\NwSapSetup.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\$WINDOWS.~BT\\\\Sources\\\\SetupPlatform.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\SAP\\\\SAPsetup\\\\setup\\\\NwSapSetup.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\SAP\\\\SapSetup\\\\OnRebootSvc\\\\NWSAPSetupOnRebootInstSvc.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Kaspersky Lab\\\\Kaspersky Security for Windows Server\\\\kavfs.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects attempts to maintain persistence by creating registry keys using AppCert DLLs. AppCert DLLs are loaded by every\nprocess using the common API f...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : \"*\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: AppInit DLLs are dynamic-link libraries (DLLs) that are loaded into every process that creates a user interface (loads\nuser32.dll) on Microsoft Window...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"AppInit_Dlls\" and\n  not process.executable : (\n     \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\Display.NvContainer\\\\NVDisplay.Container.exe\",\n     \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n     \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n     \"?:\\\\Program Files\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files (x86)\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files (x86)\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files\\\\NVIDIA Corporation\\\\Display.NvContainer\\\\NVDisplay.Container.exe\",\n\n     /* Crowdstrike specific condition as it uses NT Object paths */\n     \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\Display.NvContainer\\\\NVDisplay.Container.exe\",\n     \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\msiexec.exe\",\n     \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n     \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"\\\\Device\\\\HarddiskVolume*\\\\Program Files\\\\NVIDIA Corporation\\\\Display.NvContainer\\\\NVDisplay.Container.exe\"\n  )\n  /*\n    Full registry key path omitted due to data source variations:\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\"\n    \"HKLM\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\"\n  */\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the install of browser extensions. Malicious browser extensions can be installed via app store downloads\nmasquerading as legitimate extensi...", "output": "file where host.os.type == \"windows\" and event.type : \"creation\" and\n(\n  /* Firefox-Based Browsers */\n  (\n    file.name : \"*.xpi\" and\n    file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\*\\\\Profiles\\\\*\\\\Extensions\\\\*.xpi\" and\n    not\n    (\n      process.name : \"firefox.exe\" and\n      file.name : (\"langpack-*@firefox.mozilla.org.xpi\", \"*@dictionaries.addons.mozilla.org.xpi\")\n    )\n  ) or\n  /* Chromium-Based Browsers */\n  (\n    file.name : \"*.crx\" and\n    file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\*\\\\*\\\\User Data\\\\Webstore Downloads\\\\*\"\n  )\n)\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of a hidden local user account by appending the dollar sign to the account name. This is\nsometimes done by attackers to increa...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\\\\Names\\\\*$\\\\\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\\\\Names\\\\*$\\\\\",\n    \"MACHINE\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\\\\Names\\\\*$\\\\\"\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: The Debugger and SilentProcessExit registry keys can allow an adversary to intercept the execution of files, causing a\ndifferent process to be execute...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : (\"Debugger\", \"MonitorProcess\") and length(registry.data.strings) > 0 and\n  registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\"\n  ) and\n    /* add FPs here */\n  not registry.data.strings regex~ (\"\"\"C:\\\\Program Files( \\(x86\\))?\\\\ThinKiosk\\\\thinkiosk\\.exe\"\"\", \"\"\".*\\\\PSAppDeployToolkit\\\\.*\"\"\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies suspicious startup shell folder modifications to change the default Startup directory in order to bypass\ndetections monitoring file creatio...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.value : (\"Common Startup\", \"Startup\") and\n registry.path : (\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"HKCU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKCU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\"\n     ) and\n  registry.data.strings != null and\n  /* Normal Startup Folder Paths */\n  not registry.data.strings : (\n           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%ProgramData%\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%USERPROFILE%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%%USERPROFILE%%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"\\\\\\\\*\"\n           )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies a user being added to an active directory group by the SYSTEM (S-1-5-18) user. This behavior can indicate\nthat the attacker has achieved SY...", "output": "iam where host.os.type == \"windows\" and event.code == \"4728\" and\nwinlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n/* DOMAIN_USERS and local groups */\nnot group.id : \"S-1-5-21-*-513\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: A job can be used to schedule programs or scripts to be executed at a specified date and time. Adversaries may abuse\ntask scheduling functionality to ...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.path : \"?:\\\\Windows\\\\Tasks\\\\*\" and file.extension : \"job\" and\n  not (\n    (\n      process.executable : \"?:\\\\Program Files\\\\CCleaner\\\\CCleaner64.exe\" and\n      file.path : \"?:\\\\Windows\\\\Tasks\\\\CCleanerCrashReporting.job\"\n    ) or\n    (\n      process.executable : (\n        \"?:\\\\Program Files (x86)\\\\ManageEngine\\\\UEMS_Agent\\\\bin\\\\dcagentregister.exe\",\n        \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\bin\\\\dcagentregister.exe\"\n      ) and\n      file.path : \"?:\\\\Windows\\\\Tasks\\\\DCAgentUpdater.job\"\n    )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/or\nescalate privileges.\n", "output": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    ((process.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                      \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") or\n    process.pe.original_file_name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                                     \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\",\n                                     \"winrshost.exe\")) or\n    ?process.code_signature.trusted == false)] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"schtasks.exe\" or process.pe.original_file_name == \"schtasks.exe\") and\n    process.args : (\"/create\", \"-create\") and process.args : (\"/RU\", \"/SC\", \"/TN\", \"/TR\", \"/F\", \"/XML\") and\n    /* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */\n    not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n  ] by process.parent.entity_id\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused by\nan adversary to establish persi...", "output": "sequence by host.id with maxspan = 30s\n  [any where host.os.type == \"windows\" and \n    (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n    (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and\n    process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"\n  )]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects attempts to establish persistence on an endpoint by abusing Microsoft Office add-ins.", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n file.extension : (\"wll\",\"xll\",\"ppa\",\"ppam\",\"xla\",\"xlam\") and\n file.path : (\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Word\\\\Startup\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\AddIns\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Excel\\\\XLSTART\\\\*\",\n\n    /* Crowdstrike specific condition as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Word\\\\Startup\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\AddIns\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Excel\\\\XLSTART\\\\*\"\n )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects attempts to establish persistence on an endpoint by installing a rogue Microsoft Outlook VBA Template.", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.name : \"VbaProject.OTM\" and\n  file.path : (\"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Outlook\\\\VbaProject.OTM\", \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Outlook\\\\VbaProject.OTM\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the modification of the msDS-AllowedToDelegateTo attribute to KRBTGT. Attackers can use this technique to\nmaintain persistence to the domai...", "output": "iam where event.code == \"4738\" and winlog.event_data.AllowedToDelegateTo : \"*krbtgt*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies when the Windows installer process msiexec.exe creates a new persistence entry via scheduled tasks or startup.\n", "output": "any where host.os.type == \"windows\" and\n (process.name : \"msiexec.exe\" or Effective_process.name : \"msiexec.exe\") and\n (\n  (event.category == \"file\" and event.action == \"creation\" and\n   file.path : (\"?:\\\\Windows\\\\System32\\\\Tasks\\\\*\",\n                \"?:\\\\programdata\\\\microsoft\\\\windows\\\\start menu\\\\programs\\\\startup\\\\*\",\n                \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\")) or\n\n  (event.category == \"registry\" and event.action == \"modification\" and\n   registry.path : (\"H*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                    \"H*\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                    \"H*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                    \"H*\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\"))\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the modification of the Microsoft Office \"Office Test\" Registry key, a registry location that can be used to\nspecify a DLL which will be ex...", "output": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and\n    registry.path : \"*\\\\Software\\\\Microsoft\\\\Office Test\\\\Special\\\\Perf\\\\*\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the addition of a Netsh Helper DLL, netsh.exe supports the addition of these DLLs to extend its\nfunctionality. Attackers may abuse this mec...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\Software\\\\Microsoft\\\\netsh\\\\*\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\netsh\\\\*\",\n    \"MACHINE\\\\Software\\\\Microsoft\\\\netsh\\\\*\"\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies the use of the Exchange PowerShell cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device.\nAdversaries may target user email to col...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and process.args : \"Set-CASMailbox*ActiveSyncAllowedDeviceIDs*\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation or modification of a PowerShell profile. PowerShell profile is a script that is executed when\nPowerShell starts to customize t...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.name : (\"profile.ps1\", \"Microsoft.Powershell_profile.ps1\") and\n  file.path : (\"?:\\\\Users\\\\*\\\\Documents\\\\WindowsPowerShell\\\\*.ps1\", \n                    \"?:\\\\Users\\\\*\\\\Documents\\\\PowerShell\\\\*.ps1\", \n                    \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\*.ps1\", \n                    \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\Documents\\\\WindowsPowerShell\\\\*.ps1\", \n                    \"\\\\Device\\\\HarddiskVolume*\\\\Users\\\\*\\\\Documents\\\\PowerShell\\\\*.ps1\", \n                    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\*.ps1\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Windows contains accessibility features that may be launched with a key combination before a user has logged in. An\nadversary can modify the way these...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : (\"Utilman.exe\", \"winlogon.exe\") and user.name == \"SYSTEM\" and\n process.pe.original_file_name : \"?*\" and\n process.args :\n    (\n    \"C:\\\\Windows\\\\System32\\\\osk.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Magnify.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Narrator.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Sethc.exe\",\n    \"utilman.exe\",\n    \"ATBroker.exe\",\n    \"DisplaySwitch.exe\",\n    \"sethc.exe\"\n    )\n and not process.pe.original_file_name in\n    (\n    \"osk.exe\",\n    \"sethc.exe\",\n    \"utilman2.exe\",\n    \"DisplaySwitch.exe\",\n    \"atbroker.exe\",\n    \"ATBroker.exe\",\n    \"ScreenMagnifier.exe\",\n    \"SR.exe\",\n    \"Narrator.exe\",\n    \"magnify.exe\",\n    \"MAGNIFY.EXE\"\n    )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This could\nbe an indication of an adversar...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n length(registry.data.strings) > 0 and\n registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Runonce\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Run\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\IconServiceLib\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\AppSetup\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Taskman\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\VmApplet\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Active Setup\\\\Installed Components\\\\*\\\\ShellComponent\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnConnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnDisconnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\Control Panel\\\\Desktop\\\\scrnsave.exe\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\VerifierDlls\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\GpExtensions\\\\*\\\\DllName\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\SafeBoot\\\\AlternateShell\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\Wds\\\\rdpwd\\\\StartupPrograms\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\InitialProgram\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecuteNoPnpSync\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecuteNoPnpSync\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\PlatformExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\Execute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\S0InitialCommand\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\ServiceControlManagerExtension\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\BootVerificationProgram\\\\ImagePath\",\n      \"HKLM\\\\SYSTEM\\\\Setup\\\\CmdLine\",\n      \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\") and\n\n not registry.data.strings : (\"C:\\\\Windows\\\\system32\\\\userinit.exe\", \"cmd.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\",\n                              \"C:\\\\Program Files\\\\*.exe\") and\n not (process.name : \"rundll32.exe\" and registry.path : \"*\\\\Software\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\") and\n not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                           \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n                           \"C:\\\\Program Files\\\\*.exe\",\n                           \"C:\\\\Program Files (x86)\\\\*.exe\") and\n not (process.name : (\"TiWorker.exe\", \"poqexec.exe\") and registry.value : \"SetupExecute\" and\n      registry.data.strings : (\n        \"C:\\\\windows\\\\System32\\\\poqexec.exe /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\",\n        \"C:\\\\Windows\\\\System32\\\\poqexec.exe /skip_critical_poq /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\"\n      )\n     ) and\n not (process.name : \"svchost.exe\" and registry.value : \"SCRNSAVE.EXE\" and\n      registry.data.strings : (\n        \"%windir%\\\\system32\\\\rundll32.exe user32.dll,LockWorkStation\",\n        \"scrnsave.scr\",\n        \"%windir%\\\\system32\\\\Ribbons.scr\"\n      )\n     )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies an attempt to reset a potentially privileged account password remotely. Adversaries may manipulate account\npasswords to maintain access or ...", "output": "sequence by winlog.computer_name with maxspan=1m\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and event.outcome == \"success\" and source.ip != null and\n    source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not winlog.event_data.TargetUserName : (\"svc*\", \"PIM_*\", \"_*_\", \"*-*-*\", \"*$\")] by winlog.event_data.TargetLogonId\n   /* event 4724 need to be logged */\n  [iam where event.action == \"reset-password\" and\n   (\n    /*\n       This rule is very noisy if not scoped to privileged accounts, duplicate the\n       rule and add your own naming convention and accounts of interest here.\n     */\n    winlog.event_data.TargetUserName: (\"*Admin*\", \"*super*\", \"*SVC*\", \"*DC0*\", \"*service*\", \"*DMZ*\", \"*ADM*\") or\n    winlog.event_data.TargetSid : (\"S-1-5-21-*-500\", \"S-1-12-1-*-500\")\n    )\n  ] by winlog.event_data.SubjectLogonId\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies run key or startup key registry modifications. In order to survive reboots and other system interrupts,\nattackers will modify run keys with...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.data.strings != null and registry.hive : (\"HKEY_USERS\", \"HKLM\") and\n registry.path : (\n     /* Machine Hive */\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n     /* Users Hive */\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\"\n     ) and\n  /* add common legitimate changes without being too restrictive as this is one of the most abused AESPs */\n  not registry.data.strings : \"ctfmon.exe /n\" and\n  not (registry.value : \"Application Restart #*\" and process.name : \"csrss.exe\") and\n  not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  not registry.data.strings : (\"*:\\\\Program Files\\\\*\",\n                               \"*:\\\\Program Files (x86)\\\\*\",\n                               \"*:\\\\Users\\\\*\\\\AppData\\\\Local\\\\*\",\n                               \"* --processStart *\",\n                               \"* --process-start-args *\",\n                               \"ms-teamsupdate.exe -UninstallT20\",\n                               \" \",\n                               \"grpconv -o\", \"* /burn.runonce*\", \"* /startup\",\n                               \"?:\\\\WINDOWS\\\\SysWOW64\\\\Macromed\\\\Flash\\\\FlashUtil32_*_Plugin.exe -update plugin\") and\n  not process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                            \"D:\\\\*\",\n                            \"\\\\Device\\\\Mup*\",\n                            \"C:\\\\Windows\\\\SysWOW64\\\\reg.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\changepk.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\netsh.exe\",\n                            \"C:\\\\$WINDOWS.~BT\\\\Sources\\\\SetupPlatform.exe\",\n                            \"C:\\\\$WINDOWS.~BT\\\\Sources\\\\SetupHost.exe\",\n                            \"C:\\\\Program Files\\\\Cisco Spark\\\\CiscoCollabHost.exe\",\n                            \"C:\\\\Sistemas\\\\Programas MP\\\\CCleaner\\\\CCleaner64.exe\",\n                            \"C:\\\\Program Files (x86)\\\\FastTrack Software\\\\Admin By Request\\\\AdminByRequest.exe\",\n                            \"C:\\\\Program Files (x86)\\\\Exclaimer Ltd\\\\Cloud Signature Update Agent\\\\Exclaimer.CloudSignatureAgent.exe\",\n                            \"C:\\\\ProgramData\\\\Lenovo\\\\Vantage\\\\AddinData\\\\LenovoBatteryGaugeAddin\\\\x64\\\\QSHelper.exe\",\n                            \"C:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\*\\\\Installer\\\\setup.exe\",\n                            \"C:\\\\ProgramData\\\\bomgar-scc-*\\\\bomgar-scc.exe\",\n                            \"C:\\\\Windows\\\\SysWOW64\\\\Macromed\\\\Flash\\\\FlashUtil*_pepper.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*.EXE\",\n                            \"C:\\\\Program Files (x86)\\\\Common Files\\\\Adobe\\\\ARM\\\\*\\\\AdobeARM.exe\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies execution of suspicious persistent programs (scripts, rundll32, etc.) by looking at process lineage and\ncommand line usage.\n", "output": "/* userinit followed by explorer followed by early child process of explorer (unlikely to be launched interactively) within 1m */\nsequence by host.id, user.name with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"userinit.exe\" and process.parent.name : \"winlogon.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"explorer.exe\" and\n   /* add suspicious programs here */\n   process.pe.original_file_name in (\"cscript.exe\",\n                                     \"wscript.exe\",\n                                     \"PowerShell.EXE\",\n                                     \"MSHTA.EXE\",\n                                     \"RUNDLL32.EXE\",\n                                     \"REGSVR32.EXE\",\n                                     \"RegAsm.exe\",\n                                     \"MSBuild.exe\",\n                                     \"InstallUtil.exe\") and\n    /* add potential suspicious paths here */\n    process.args : (\"C:\\\\Users\\\\*\", \"C:\\\\ProgramData\\\\*\", \"C:\\\\Windows\\\\Temp\\\\*\", \"C:\\\\Windows\\\\Tasks\\\\*\", \"C:\\\\PerfLogs\\\\*\", \"C:\\\\Intel\\\\*\")\n   ]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Indicates the creation of a scheduled task using Windows event logs. Adversaries can use these to establish persistence,\nmove laterally, and/or escala...", "output": "iam where event.action == \"scheduled-task-created\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and\n\n /* TaskContent is not parsed, exclude by full taskname noisy ones */\n not winlog.event_data.TaskName : (\n              \"\\\\CreateExplorerShellUnelevatedTask\",\n              \"\\\\Hewlett-Packard\\\\HPDeviceCheck\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker_backup\",\n              \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n              \"\\\\Microsoft\\\\VisualStudio\\\\Updates\\\\BackgroundDownload\",\n              \"\\\\OneDrive Standalone Update Task-S-1-5-21*\",\n              \"\\\\OneDrive Standalone Update Task-S-1-12-1-*\"\n )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded from\nthe SDProp process. The SDProp...", "output": "any where event.code == \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName : \"dSHeuristics\" and\n  length(winlog.event_data.AttributeValue) > 15 and\n  winlog.event_data.AttributeValue regex~ \"[0-9]{15}([1-9a-f]).*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies an unsigned library created in the last 5 minutes and subsequently loaded by a shared windows service\n(svchost). Adversaries may use this t...", "output": "library where host.os.type == \"windows\" and\n\n process.executable :\n     (\"?:\\\\Windows\\\\System32\\\\svchost.exe\", \"?:\\\\Windows\\\\Syswow64\\\\svchost.exe\") and\n\n dll.code_signature.trusted != true and\n\n not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\") and\n\n dll.hash.sha256 != null and\n\n (\n       /* DLL created within 5 minutes of the library load event - compatible with Elastic Endpoint 8.4+ */\n       dll.Ext.relative_file_creation_time <= 300 or\n\n       /* unusual paths */\n       dll.path :(\"?:\\\\ProgramData\\\\*\",\n                  \"?:\\\\Users\\\\*\",\n                  \"?:\\\\PerfLogs\\\\*\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*\",\n                  \"?:\\\\Intel\\\\*\",\n                  \"?:\\\\AMD\\\\Temp\\\\*\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"?:\\\\Windows\\\\Branding\\\\*\",\n                  \"?:\\\\Windows\\\\csc\\\\*\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"?:\\\\Windows\\\\en-US\\\\*\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*\",\n                  \"?:\\\\Windows\\\\INF\\\\*\",\n                  \"?:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"?:\\\\windows\\\\tracing\\\\*\",\n                  \"?:\\\\windows\\\\IME\\\\*\",\n                  \"?:\\\\Windows\\\\Performance\\\\*\",\n                  \"?:\\\\windows\\\\intel\\\\*\",\n                  \"?:\\\\windows\\\\ms\\\\*\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"?:\\\\Windows\\\\panther\\\\*\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"?:\\\\Windows\\\\OCR\\\\*\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*\",\n                  \"?:\\\\Windows\\\\addins\\\\*\",\n                  \"?:\\\\Windows\\\\Setup\\\\*\",\n                  \"?:\\\\Windows\\\\Help\\\\*\",\n                  \"?:\\\\Windows\\\\SKB\\\\*\",\n                  \"?:\\\\Windows\\\\Vss\\\\*\",\n                  \"?:\\\\Windows\\\\servicing\\\\*\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"?:\\\\Windows\\\\Logs\\\\*\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"?:\\\\Windows\\\\PLA\\\\*\",\n                  \"?:\\\\Windows\\\\Migration\\\\*\",\n                  \"?:\\\\Windows\\\\debug\\\\*\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*\",\n                  \"?:\\\\Windows\\\\Containers\\\\*\",\n                  \"?:\\\\Windows\\\\Boot\\\\*\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\schemas\\\\*\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*\",\n                  \"?:\\\\Windows\\\\Resources\\\\*\",\n                  \"?:\\\\Windows\\\\rescache\\\\*\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"?:\\\\Windows\\\\media\\\\*\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"?:\\\\$Recycle.Bin\\\\*\")\n  ) and\n\n  not dll.hash.sha256 :\n            (\"3ed33e71641645367442e65dca6dab0d326b22b48ef9a4c2a2488e67383aa9a6\",\n             \"b4db053f6032964df1b254ac44cb995ffaeb4f3ade09597670aba4f172cf65e4\",\n             \"214c75f678bc596bbe667a3b520aaaf09a0e50c364a28ac738a02f867a085eba\",\n             \"23aa95b637a1bf6188b386c21c4e87967ede80242327c55447a5bb70d9439244\",\n             \"5050b025909e81ae5481db37beb807a80c52fc6dd30c8aa47c9f7841e2a31be7\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the creation of a new Windows service with suspicious Service command values. Windows services typically run\nas SYSTEM and can be used for ...", "output": "any where\n  (event.code : \"4697\" and\n   (winlog.event_data.ServiceFileName : \n           (\"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\", \n            \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\", \n            \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n            \"*regsvr32*\", \"*msbuild*\") or\n   winlog.event_data.ServiceFileName regex~ \"\"\"%systemroot%\\\\[a-z0-9]+\\.exe\"\"\")) or\n\n  (event.code : \"7045\" and\n   winlog.event_data.ImagePath : (\n       \"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\",\n       \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\",\n       \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n       \"*regsvr32*\", \"*msbuild*\"))\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies processes modifying the services registry key directly, instead of through the expected Windows APIs. This\ncould be an indication of an adv...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.data.strings != null and registry.value : (\"ServiceDLL\", \"ImagePath\") and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n      \"MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n      \"MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\"\n  ) and not registry.data.strings : (\n      \"?:\\\\windows\\\\system32\\\\Drivers\\\\*.sys\",\n      \"\\\\SystemRoot\\\\System32\\\\drivers\\\\*.sys\",\n      \"\\\\??\\\\?:\\\\Windows\\\\system32\\\\Drivers\\\\*.SYS\",\n      \"\\\\??\\\\?:\\\\Windows\\\\syswow64\\\\*.sys\",\n      \"system32\\\\DRIVERS\\\\USBSTOR\", \n      \"system32\\\\drivers\\\\*.sys\", \n      \"C:\\\\WindowsAzure\\\\GuestAgent*.exe\", \n      \"\\\"C:\\\\Program Files\\\\Common Files\\\\McAfee\\\\*\", \n      \"C:\\\\Program Files (x86)\\\\VERITAS\\\\VxPBX\\\\bin\\\\pbx_exchange.exe\", \n      \"\\\"C:\\\\Program Files (x86)\\\\VERITAS\\\\VxPBX\\\\bin\\\\pbx_exchange.exe\\\"\",\n      \"\\\"C:\\\\ProgramData\\\\McAfee\\\\Agent\\\\Current\\\\*\") and\n  not (process.name : \"procexp??.exe\" and registry.data.strings : \"?:\\\\*\\\\procexp*.sys\") and\n  not process.executable : (\n      \"?:\\\\Program Files\\\\*.exe\",\n      \"?:\\\\Program Files (x86)\\\\*.exe\",\n      \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n      \"?:\\\\Windows\\\\winsxs\\\\*\\\\TiWorker.exe\",\n      \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n      \"?:\\\\Windows\\\\System32\\\\services.exe\",\n      \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n      \"?:\\\\Windows\\\\System32\\\\regsvr32.exe\",\n      \"?:\\\\Windows\\\\System32\\\\WaaSMedicAgent.exe\", \n      \"?:\\\\Windows\\\\UUS\\\\amd64\\\\WaaSMedicAgent.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies files written to or modified in the startup folder by commonly abused processes. Adversaries may use this\ntechnique to maintain persistence...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  user.domain != \"NT AUTHORITY\" and\n  file.path : (\"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n               \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\") and\n  process.name : (\"cmd.exe\",\n                  \"powershell.exe\",\n                  \"wmic.exe\",\n                  \"mshta.exe\",\n                  \"pwsh.exe\",\n                  \"cscript.exe\",\n                  \"wscript.exe\",\n                  \"regsvr32.exe\",\n                  \"RegAsm.exe\",\n                  \"rundll32.exe\",\n                  \"EQNEDT32.EXE\",\n                  \"WINWORD.EXE\",\n                  \"EXCEL.EXE\",\n                  \"POWERPNT.EXE\",\n                  \"MSPUB.EXE\",\n                  \"MSACCESS.EXE\",\n                  \"iexplore.exe\",\n                  \"InstallUtil.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies files written or modified in the startup folder by unsigned processes. Adversaries may abuse this technique\nto maintain persistence in an e...", "output": "sequence by host.id, process.entity_id with maxspan=5s\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.code_signature.trusted == false and\n  /* suspicious paths can be added here  */\n   process.executable : (\"C:\\\\Users\\\\*.exe\",\n                         \"C:\\\\ProgramData\\\\*.exe\",\n                         \"C:\\\\Windows\\\\Temp\\\\*.exe\",\n                         \"C:\\\\Windows\\\\Tasks\\\\*.exe\",\n                         \"C:\\\\Intel\\\\*.exe\",\n                         \"C:\\\\PerfLogs\\\\*.exe\")\n   ]\n   [file where host.os.type == \"windows\" and event.type != \"deletion\" and user.domain != \"NT AUTHORITY\" and\n    file.path : (\"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n                 \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\")\n   ]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies script engines creating files in the Startup folder, or the creation of script files in the Startup folder.\nAdversaries may abuse this tech...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n\n  /* Call attention to file extensions that may be used for malicious purposes */\n  /* Optionally, Windows scripting engine processes targeting shortcut files */\n  (\n    file.extension : (\"vbs\", \"vbe\", \"wsh\", \"wsf\", \"js\") or\n    process.name : (\"wscript.exe\", \"cscript.exe\")\n  ) and not (startsWith(user.domain, \"NT\") or endsWith(user.domain, \"NT\"))\n\n  /* Identify files created or changed in the startup folder */\n  and file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies Component Object Model (COM) hijacking via registry modification. Adversaries may establish persistence by\nexecuting malicious content trig...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  /* not necessary but good for filtering privileged installations */\n  user.domain != \"NT AUTHORITY\" and process.executable != null and \n  (\n    (\n      registry.path : \"HK*\\\\InprocServer32\\\\\" and\n      registry.data.strings: (\"scrobj.dll\", \"?:\\\\*\\\\scrobj.dll\") and\n      not registry.path : \"*\\\\{06290BD*-48AA-11D2-8432-006008C3FBFC}\\\\*\"\n    ) or\n\n    (\n      registry.path : \"HKLM\\\\*\\\\InProcServer32\\\\*\" and\n        registry.data.strings : (\"*\\\\Users\\\\*\", \"*\\\\ProgramData\\\\*\")\n    ) or\n\n    /* in general COM Registry changes on Users Hive is less noisy and worth alerting */\n    (\n      registry.path : (\n        \"HKEY_USERS\\\\*\\\\InprocServer32\\\\\",\n        \"HKEY_USERS\\\\*\\\\LocalServer32\\\\\",\n        \"HKEY_USERS\\\\*\\\\DelegateExecute\",\n        \"HKEY_USERS\\\\*\\\\TreatAs\\\\\",\n        \"HKEY_USERS\\\\*\\\\ScriptletURL*\"\n      ) and\n      not registry.data.strings : (\n            /* COM related to Windows Spotlight feature */\n            \"{4813071a-41ad-44a2-9835-886d2f63ca30}\",\n\n            /* AppX/MSIX DelegateExecute handlers: execute, protocol, file */\n            \"{A56A841F-E974-45C1-8001-7E3F8A085917}\",\n            \"{4ED3A719-CEA8-4BD9-910D-E252F997AFC2}\",\n            \"{BFEC0C93-0B7D-4F2C-B09C-AFFFC4BDAE78}\"\n      )\n    )\n  ) and \n  \n  not (\n    process.code_signature.trusted == true and\n    process.code_signature.subject_name in (\n        \"Island Technology Inc.\", \"Google LLC\", \"Grammarly, Inc.\", \"Dropbox, Inc\", \"REFINITIV US LLC\", \"HP Inc.\", \"Adobe Inc.\",\n        \"Citrix Systems, Inc.\", \"Veeam Software Group GmbH\", \"Zhuhai Kingsoft Office Software Co., Ltd.\", \"Oracle America, Inc.\",\n        \"Brave Software, Inc.\", \"DeepL SE\", \"Opera Norway AS\"\n    )\n  ) and \n\n  /* excludes Microsoft signed noisy processes */\n  not\n  (\n    process.name : (\n      \"OneDrive.exe\", \"OneDriveSetup.exe\", \"FileSyncConfig.exe\", \"Teams.exe\", \"MicrosoftEdgeUpdate.exe\", \"msrdcw.exe\",\n      \"MicrosoftEdgeUpdateComRegisterShell64.exe\", \"setup.exe\"\n    ) and\n    process.code_signature.trusted == true and process.code_signature.subject_name in (\"Microsoft Windows\", \"Microsoft Corporation\")\n  ) and\n  \n  not process.executable : (\n        \"?:\\\\$WINDOWS.~BT\\\\Sources\\\\SetupHost.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\ProgramData\\\\4Team\\\\4Team-Updater\\\\4Team-Updater-Helper.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Wondershare\\\\Wondershare NativePush\\\\WsToastNotification.exe\",\n        \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\regsvr32.exe\",\n        \"?:\\\\Windows\\\\System32\\\\regsvr32.exe\",\n        \"\\\\Device\\\\Mup\\\\*\\\\Kufer\\\\KuferSQL\\\\BasysSQL.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicate\nadversarial activity where a scheduled t...", "output": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Identifies execution of a suspicious program via scheduled tasks by looking at process lineage and command line usage.", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    /* Schedule service cmdline on Win10+ */\n    process.parent.name : \"svchost.exe\" and process.parent.args : \"Schedule\" and\n    /* add suspicious programs here */\n    process.pe.original_file_name in\n                                (\n                                  \"cscript.exe\",\n                                  \"wscript.exe\",\n                                  \"PowerShell.EXE\",\n                                  \"Cmd.Exe\",\n                                  \"MSHTA.EXE\",\n                                  \"RUNDLL32.EXE\",\n                                  \"REGSVR32.EXE\",\n                                  \"MSBuild.exe\",\n                                  \"InstallUtil.exe\",\n                                  \"RegAsm.exe\",\n                                  \"RegSvcs.exe\",\n                                  \"msxsl.exe\",\n                                  \"CONTROL.EXE\",\n                                  \"EXPLORER.EXE\",\n                                  \"Microsoft.Workflow.Compiler.exe\",\n                                  \"msiexec.exe\"\n                                  ) and\n    /* add suspicious paths here */\n    process.args : (\n       \"C:\\\\Users\\\\*\",\n       \"C:\\\\ProgramData\\\\*\",\n       \"C:\\\\Windows\\\\Temp\\\\*\",\n       \"C:\\\\Windows\\\\Tasks\\\\*\",\n       \"C:\\\\PerfLogs\\\\*\",\n       \"C:\\\\Intel\\\\*\",\n       \"C:\\\\Windows\\\\Debug\\\\*\",\n       \"C:\\\\HP\\\\*\") and\n\n    not (process.name : \"cmd.exe\" and process.args : \"?:\\\\*.bat\" and process.working_directory : \"?:\\\\Windows\\\\System32\\\\\") and\n    not (process.name : \"cscript.exe\" and process.args : \"?:\\\\Windows\\\\system32\\\\calluxxprovider.vbs\") and\n    not (\n       process.name : \"powershell.exe\" and\n       process.args : (\n           \"-File\", \"-PSConsoleFile\",\n           \"C:\\\\ProgramData\\\\Microsoft\\\\AutopatchSetupScheduled\\\\SetupAutopatchClientV2Package.ps1\",\n           \"C:\\\\ProgramData\\\\Microsoft\\\\AutopatchSetupScheduled\\\\SetupAutopatchClientPackage.ps1\"                \n       ) and user.id : \"S-1-5-18\"\n    ) and\n    not (process.name : \"msiexec.exe\" and user.id : \"S-1-5-18\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of a suspicious ImagePath value. This could be an indication of an adversary attempting to\nstealthily persist or escalate priv...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"ImagePath\" and\n  registry.path : \"*\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\" and\n  /* add suspicious registry ImagePath values here */\n  registry.data.strings : (\"%COMSPEC%*\", \"*\\\\.\\\\pipe\\\\*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the creation of a WMI Event Subscription. Attackers can abuse this mechanism for persistence or to elevate to\nSYSTEM privileges.\n", "output": "any where\n (\n   (event.dataset == \"windows.sysmon_operational\" and event.code == \"21\" and\n    ?winlog.event_data.Operation : \"Created\" and ?winlog.event_data.Consumer : (\"*subscription:CommandLineEventConsumer*\", \"*subscription:ActiveScriptEventConsumer*\")) or\n\n   (event.dataset == \"endpoint.events.api\" and event.provider == \"Microsoft-Windows-WMI-Activity\" and ?process.Ext.api.name == \"IWbemServices::PutInstance\" and\n    ?process.Ext.api.parameters.consumer_type in (\"ActiveScriptEventConsumer\", \"CommandLineEventConsumer\"))\n )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Windows services typically run as SYSTEM and can be used as a privilege escalation opportunity. Malware or penetration\ntesters may run a shell as a se...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"services.exe\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n\n  /* Third party FP's */\n  not process.args : \"NVDisplay.ContainerLocalSystem\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Indicates the creation and deletion of a scheduled task within a short time interval. Adversaries can use these to proxy\nmalicious execution via the s...", "output": "sequence by winlog.computer_name, winlog.event_data.TaskName with maxspan=5m\n   [iam where event.action == \"scheduled-task-created\" and not user.name : \"*$\"]\n   [iam where event.action == \"scheduled-task-deleted\" and not user.name : \"*$\"]\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies modification of the Time Provider. Adversaries may establish persistence by registering and enabling a\nmalicious DLL as a time provider. Wi...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path: \"*\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\" and\n  registry.data.strings:\"*.dll\" and\n  not\n  (\n    process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\msiexec.exe\") and\n    registry.data.strings : \"?:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmwTimeProvider\\\\vmwTimeProvider.dll\"\n  ) and\n  not registry.data.strings : \"C:\\\\Windows\\\\SYSTEM32\\\\w32time.DLL\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a user being added to a privileged group in Active Directory. Privileged accounts and groups in Active\nDirectory are those to which powerfu...", "output": "iam where host.os.type == \"windows\" and event.action == \"added-member-to-group\" and\n(\n    group.id : \"S-1-5-21*\" and\n    (\n        group.name : (\n            \"Admin*\",\n            \"Domain Admins\",\n            \"Enterprise Admins\",\n            \"Backup Admins\",\n            \"Schema Admins\",\n            \"DnsAdmins\",\n            \"Exchange Organization Administrators\",\n            \"Print Operators\",\n            \"Server Operators\",\n            \"Account Operators\"\n        )\n    ) or\n    (\n        group.id : (\n            \"S-1-5-21-*-544\",\n            \"S-1-5-21-*-512\",\n            \"S-1-5-21-*-519\",\n            \"S-1-5-21-*-551\",\n            \"S-1-5-21-*-518\",\n            \"S-1-5-21-*-1101\",\n            \"S-1-5-21-*-1102\",\n            \"S-1-5-21-*-550\",\n            \"S-1-5-21-*-549\",\n            \"S-1-5-21-*-548\"\n        )\n    )\n)\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to create new users. This is sometimes done by attackers to increase access or establish persistence\non a system or domain.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : (\"net.exe\", \"net1.exe\") and not process.parent.name : \"net.exe\") and\n  (process.args : \"user\" and process.args : (\"/ad\", \"/add\"))\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: The Application Shim was created to allow for backward compatibility of software as the operating system codebase\nchanges over time. This Windows func...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"sdbinst.exe\" and\n  process.args : \"?*\" and\n  not (process.args : \"-m\" and process.args : \"-bg\") and\n  not process.args : \"-mm\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: An adversary can use the Background Intelligent Transfer Service (BITS) SetNotifyCmdLine method to execute a program\nthat runs after a job finishes tr...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and process.parent.args : \"BITS\" and\n  not process.executable :\n              (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n               \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n               \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n               \"?:\\\\WINDOWS\\\\system32\\\\directxdatabaseupdater.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated)\nregistry key. An adversary may use ...", "output": "/* Registry Path ends with backslash */\nregistry where host.os.type == \"windows\" and event.type == \"change\" and length(registry.data.strings) > 0 and\n  registry.path : \"*\\\\Run\\\\\" and\n  registry.path : (\n    \"*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n    \"*\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n    \"*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\"\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies registry modifications related to the Windows Security Support Provider (SSP) configuration. Adversaries may\nabuse this to establish persis...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"Security Packages\" and\n  registry.path : (\n      \"*\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages\",\n      \"*\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages\"\n  ) and\n  not process.executable : (\n        \"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\msiexec.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with an\nintegrity level of system.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"CompatTelRunner.exe\" and process.args : \"-cv*\" and\n  not process.name : (\"conhost.exe\",\n                      \"DeviceCensus.exe\",\n                      \"CompatTelRunner.exe\",\n                      \"DismHost.exe\",\n                      \"rundll32.exe\",\n                      \"powershell.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies potential hijacking of the Microsoft Update Orchestrator Service to establish persistence with an integrity\nlevel of SYSTEM.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable : \"C:\\\\Windows\\\\System32\\\\svchost.exe\" and\n  process.parent.args : \"UsoSvc\" and\n  not process.executable :\n          (\"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\Packages\\\\*\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoClient.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotification.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotificationUx.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotifyIcon.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerMgr.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\ClickToRun\\\\OfficeC2RClient.exe\") and\n  not process.name : (\"MoUsoCoreWorker.exe\", \"OfficeC2RClient.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: An adversary can use Windows Management Instrumentation (WMI) to install event filters, providers, consumers, and\nbindings that execute code when a de...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"create\" and\n  process.args : (\"ActiveScriptEventConsumer\", \"CommandLineEventConsumer\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies use of the Windows Management Instrumentation StdRegProv (registry provider) to modify commonly abused\nregistry locations for persistence.\n", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.data.strings != null and process.name : \"WmiPrvSe.exe\" and\n registry.path : (\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Environment\\\\UserInitMprLogonScript\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\"\n                  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies the creation of ASPX files in specific directories that are commonly targeted by attackers to deploy web shells.\n", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : \"aspx\" and\n  file.path : \"?:\\\\Program Files\\\\Common Files\\\\Microsoft Shared\\\\Web Server Extensions\\\\*\" and\n  not process.executable: \"?:\\\\Windows\\\\System32\\\\msiexec.exe\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the registration of a Werfault Debugger. Attackers may abuse this mechanism to execute malicious payloads\nevery time the utility is execute...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"ReflectDebugger\"\n\n  /*\n    Full registry key path omitted due to data source variations:\n    HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\Hangs\\\\ReflectDebugger\n  */\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies process creation with alternate credentials. Adversaries may create a new process with a different token to\nescalate privileges and bypass ...", "output": "sequence by winlog.computer_name with maxspan=1m\n\n[authentication where event.action:\"logged-in\" and\n event.outcome == \"success\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n /* seclogon service */\n process.name == \"svchost.exe\" and\n winlog.event_data.LogonProcessName : \"seclogo*\" and source.ip == \"::1\" ] by winlog.event_data.TargetLogonId\n\n[process where event.type == \"start\"] by winlog.event_data.TargetLogonId\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation of a process impersonating the token of another user logon session. Adversaries may create a new\nprocess with a different toke...", "output": "/* This rule is only compatible with Elastic Endpoint 8.4+ */\n\nprocess where host.os.type == \"windows\" and event.action == \"start\" and\n\n user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n (process.Ext.effective_parent.executable regex~ \"\"\"[C-Z]:\\\\Windows\\\\(System32|SysWOW64)\\\\[a-zA-Z0-9\\-\\_\\.]+\\.exe\"\"\" or\n  process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\explorer.exe\") and\n\n (\n  process.name : (\"powershell.exe\", \"cmd.exe\", \"rundll32.exe\", \"notepad.exe\", \"net.exe\", \"ntdsutil.exe\",\n                  \"tasklist.exe\", \"reg.exe\", \"certutil.exe\", \"bitsadmin.exe\", \"msbuild.exe\", \"esentutl.exe\") or\n\n  ((process.Ext.relative_file_creation_time <= 900 or process.Ext.relative_file_name_modify_time <= 900) and\n   not process.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\") and\n   not process.executable : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))\n ) and\n not (process.name : \"rundll32.exe\" and\n      process.command_line : (\"*davclnt.dll,DavSetCookie*\", \"*?:\\\\Program Files*\",\n                              \"*\\\\Windows\\\\System32\\\\winethc.dll*\", \"*\\\\Windows\\\\SYSTEM32\\\\EDGEHTML.dll*\",\n                              \"*shell32.dll,SHCreateLocalServerRunDll*\")) and\n not startswith~(process.Ext.effective_parent.name, process.parent.name) and\n not (process.name : \"powershell.exe\" and process.parent.name : \"wmiprvse.exe\" and process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\wsmprovhost.exe\") and\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\RuntimeBroker.exe\" and process.parent.executable : \"?:\\\\Windows\\\\System32\\\\sihost.exe\") and\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\sethc.exe\" and process.parent.executable : \"?:\\\\Windows\\\\System32\\\\svchost.exe\") and\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\explorer.exe\" and\n      process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\svchost.exe\", \"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"?:\\\\Windows\\\\twain_32\\\\*.exe\"))\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: User Account Control (UAC) can help mitigate the impact of malware on Windows hosts. With UAC, apps and tasks always run\nin the security context of a ...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : (\"EnableLUA\", \"ConsentPromptBehaviorAdmin\", \"PromptOnSecureDesktop\") and\n  registry.data.strings : (\"0\", \"0x00000000\")\n\n  /*\n    Full registry key path omitted due to data source variations:\n    HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\n    HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\n    HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\n  */\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies unusual DLLs loaded by the DNS Server process, potentially indicating the abuse of the ServerLevelPluginDll\nfunctionality. This can lead to...", "output": "any where host.os.type == \"windows\" and event.category : (\"library\", \"process\") and\n  event.type : (\"start\", \"change\") and event.action : (\"load\", \"Image loaded*\") and\n  process.executable : \"?:\\\\windows\\\\system32\\\\dns.exe\" and\n  not ?dll.code_signature.trusted == true and\n  not file.code_signature.status == \"Valid\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies an attempt to load a revoked or expired driver. Adversaries may bring outdated drivers with vulnerabilities\nto gain code execution in kerne...", "output": "driver where host.os.type == \"windows\" and process.pid == 4 and\n  dll.code_signature.status : (\"errorExpired\", \"errorRevoked\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a privilege escalation attempt via exploiting CVE-2022-38028 to hijack the print spooler service execution.\n", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n    file.name : \"MPDW-constraints.js\" and\n    file.path : (\n        \"?:\\\\*\\\\Windows\\\\system32\\\\DriverStore\\\\FileRepository\\\\*\\\\MPDW-constraints.js\",\n        \"?:\\\\*\\\\Windows\\\\WinSxS\\\\amd64_microsoft-windows-printing-printtopdf_*\\\\MPDW-constraints.js\", \n        \"\\\\Device\\\\HarddiskVolume*\\\\*\\\\Windows\\\\system32\\\\DriverStore\\\\FileRepository\\\\*\\\\MPDW-constraints.js\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\*\\\\Windows\\\\WinSxS\\\\amd64_microsoft-windows-printing-printtopdf_*\\\\MPDW-constraints.js\"\n    ) and\n    not process.executable : (\n          \"?:\\\\$WINDOWS.~BT\\\\Sources\\\\SetupHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\"\n    ) and\n    not file.path : (\n        \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\WinSxS\\\\*\\\\MPDW-constraints.js\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\WinSxS\\\\*\\\\MPDW-constraints.js\"\n    )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the creation or modification of a new Group Policy based scheduled task or service. These methods are used for\nlegitimate system administratio...", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and event.action != \"open\" and\n file.name : (\"ScheduledTasks.xml\", \"Services.xml\") and\n  file.path : (\n    \"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\ScheduledTasks\\\\ScheduledTasks.xml\",\n    \"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\Services\\\\Services.xml\"\n  ) and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\dfsrs.exe\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects.", "output": "any where host.os.type == \"windows\" and event.code in (\"5136\", \"5145\") and\n(\n  (\n    winlog.event_data.AttributeLDAPDisplayName : (\n      \"gPCMachineExtensionNames\",\n      \"gPCUserExtensionNames\"\n    ) and\n    winlog.event_data.AttributeValue : \"*42B5FAAE-6536-11D2-AE5A-0000F87571E3*\" and\n    winlog.event_data.AttributeValue : (\n      \"*40B66650-4972-11D1-A7CA-0000F87571E3*\",\n      \"*40B6664F-4972-11D1-A7CA-0000F87571E3*\"\n    )\n  ) or\n  (\n    winlog.event_data.ShareName : \"\\\\\\\\*\\\\SYSVOL\" and\n    winlog.event_data.RelativeTargetName : (\"*\\\\scripts.ini\", \"*\\\\psscripts.ini\") and\n    winlog.event_data.AccessList:\"*%%4417*\"\n  )\n)\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts or\nuse them to add users as local ...", "output": "any where host.os.type == \"windows\" and event.code: \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName: \"gPCMachineExtensionNames\" and\n  winlog.event_data.AttributeValue: \"*827D319E-6EAC-11D2-A4EA-00C04F79F83A*\" and\n  winlog.event_data.AttributeValue: \"*803E14A0-B4FB-11D0-A0D0-00A0C90F574B*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects the modification of Group Policy Object attributes to execute a scheduled task in the objects controlled by the\nGPO.\n", "output": "any where host.os.type == \"windows\" and event.code in (\"5136\", \"5145\") and\n(\n  (\n    winlog.event_data.AttributeLDAPDisplayName : (\n      \"gPCMachineExtensionNames\",\n      \"gPCUserExtensionNames\"\n    ) and\n    winlog.event_data.AttributeValue : \"*CAB54552-DEEA-4691-817E-ED4A4D1AFC72*\" and\n    winlog.event_data.AttributeValue : \"*AADCED64-746C-4633-A97C-D61349046527*\"\n  ) or\n  (\n    winlog.event_data.ShareName : \"\\\\\\\\*\\\\SYSVOL\" and\n    winlog.event_data.RelativeTargetName : \"*ScheduledTasks.xml\" and\n    winlog.event_data.AccessList:\"*%%4417*\"\n  )\n)\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a potential exploitation of InstallerTakeOver (CVE-2021-41379) default PoC execution. Successful exploitation\nallows an unprivileged user t...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.Ext.token.integrity_level_name : \"System\" and\n    (\n      (process.name : \"elevation_service.exe\" and\n       not process.pe.original_file_name == \"elevation_service.exe\") or\n      \n      (process.name : \"elevation_service.exe\" and\n       not process.code_signature.trusted == true) or\n\n      (process.parent.name : \"elevation_service.exe\" and\n       process.name : (\"rundll32.exe\", \"cmd.exe\", \"powershell.exe\"))\n    ) and\n    not\n    (\n      process.name : \"elevation_service.exe\" and process.code_signature.trusted == true and\n      process.pe.original_file_name == null\n    )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to\nlocalhost, followed by a sevice...", "output": "sequence by winlog.computer_name with maxspan=5m\n [authentication where\n\n  /* event 4624 need to be logged */\n  event.action == \"logged-in\" and event.outcome == \"success\" and winlog.event_data.ElevatedToken == \"%%1843\" and process.pid == 0 and \n\n  /* authenticate locally using relayed kerberos Ticket */\n  winlog.event_data.AuthenticationPackageName :\"Kerberos\" and winlog.logon.type == \"Network\" and cidrmatch(source.ip, \"127.0.0.0/8\", \"::1\")] by winlog.event_data.TargetLogonId\n\n  [any where\n   /* event 4697 need to be logged */\n   event.action : \"service-installed\"] by winlog.event_data.SubjectLogonId\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Adversaries can use the autostart mechanism provided by the Local Security Authority (LSA) authentication packages for\nprivilege escalation or persist...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Authentication Packages\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Authentication Packages\"\n  ) and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies interactive logon attempt with alternate credentials and by an unusual process. Adversaries may create a new\ntoken to escalate privileges a...", "output": "authentication where\n host.os.type : \"windows\" and winlog.event_data.LogonProcessName : \"Advapi*\" and\n winlog.logon.type == \"Interactive\" and winlog.event_data.SubjectUserSid : (\"S-1-5-21*\", \"S-1-12-*\") and\n winlog.event_data.TargetUserSid : (\"S-1-5-21*\", \"S-1-12-*\")  and process.executable : \"C:\\\\*\" and\n not startswith~(winlog.event_data.SubjectUserSid, winlog.event_data.TargetUserSid) and\n not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\winlogon.exe\",\n             \"?:\\\\Windows\\\\System32\\\\wininit.exe\",\n             \"?:\\\\Program Files\\\\*.exe\",\n             \"?:\\\\Program Files (x86)\\\\*.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\",\n             \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies when a browser process navigates to the Microsoft Help page followed by spawning an elevated process. This\nmay indicate a successful exploi...", "output": "process where event.type == \"start\" and host.os.type == \"windows\" and\n user.domain : (\"NT AUTHORITY\", \"AUTORITE NT\", \"AUTORIDADE NT\") and\n process.parent.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\",\n                        \"opera.exe\", \"iexplore\", \"firefox.exe\", \"waterfox.exe\", \"iexplore.exe\", \"tor.exe\", \"safari.exe\") and\n process.parent.command_line : \"*go.microsoft.com*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies a privilege escalation attempt via named pipe impersonation. An adversary may abuse this technique by\nutilizing a framework such Metasploit...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : (\"Cmd.Exe\", \"PowerShell.EXE\") or ?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\")) and\n process.args : \"echo\" and process.args : \">\" and process.args : \"\\\\\\\\.\\\\pipe\\\\*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the loading of a non Microsoft signed DLL that is missing on a default Windows install (phantom DLL) or one\nthat can be loaded from a diffe...", "output": "any where host.os.type == \"windows\" and\n(event.category : (\"driver\", \"library\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n(\n  /* compatible with Elastic Endpoint Library Events */\n  (\n    ?dll.name : (\n        \"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n        \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n        \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n        \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\"\n    )\n    and (\n      ?dll.code_signature.trusted != true or\n      ?dll.code_signature.exists != true or\n      (\n        ?dll.code_signature.trusted == true and\n          not ?dll.code_signature.subject_name : (\"Microsoft Windows\", \"Microsoft Corporation\", \"Microsoft Windows Publisher\")\n      )\n  ) or\n   /* oci.dll is too noisy due to unsigned Oracle related DLL loaded from random dirs */\n  (\n   (?dll.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and process.executable : \"?:\\\\Windows\\\\*.exe\" and \n    (?dll.code_signature.trusted != true or ?dll.code_signature.exists != true)) or \n    \n   (file.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and not file.code_signature.status == \"Valid\" and process.executable : \"?:\\\\Windows\\\\*.exe\")\n   ) or \n\n  /* compatible with Sysmon EventID 7 - Image Load */\n  (file.name : (\"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n               \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n               \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n               \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\") and \n   not file.hash.sha256 : \n            (\"6e837794fc282446906c36d681958f2f6212043fc117c716936920be166a700f\", \n             \"b14e4954e8cca060ffeb57f2458b6a3a39c7d2f27e94391cbcea5387652f21a4\", \n             \"c258d90acd006fa109dc6b748008edbb196d6168bc75ace0de0de54a4db46662\") and \n   not file.code_signature.status == \"Valid\")\n  ) and\n  not\n  (\n    ?dll.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    ) or\n    file.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    )\n  )\n)\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies port monitor and print processor registry modifications. Adversaries may abuse port monitor and print\nprocessors to run malicious DLLs duri...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Monitors\\\\*\",\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Print Processors\\\\*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Monitors\\\\*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Print Processors\\\\*\"\n  ) and registry.data.strings : \"*.dll\" and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service.\nExploitation involves chaining ...", "output": "sequence by host.id with maxspan=30s\n[registry where host.os.type == \"windows\" and\n   registry.value : \"SpoolDirectory\" and\n   registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\" and\n   registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\"]\n[registry where host.os.type == \"windows\" and\n   registry.value : \"Module\" and\n   registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\" and\n   registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\\\\*\"]\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detects deletion of print driver files by an unusual process. This may indicate a clean up attempt post successful\nprivilege escalation via Print Spoo...", "output": "file where host.os.type == \"windows\" and event.type == \"deletion\" and\n  file.extension : \"dll\" and file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*.dll\" and\n  not process.name : (\"spoolsv.exe\", \"dllhost.exe\", \"explorer.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service including\nCVE-2020-1048 and CVE-2020-1337.\n", "output": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : \"spl\" and\n  file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\PRINTERS\\\\*\" and\n  not process.name : (\"spoolsv.exe\",\n                      \"printfilterpipelinesvc.exe\",\n                      \"PrintIsolationHost.exe\",\n                      \"splwow64.exe\",\n                      \"msiexec.exe\",\n                      \"poqexec.exe\",\n                      \"System\") and\n  not user.id : \"S-1-5-18\" and\n  not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"\\\\Device\\\\Mup\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\printui.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\spool\\\\*.exe\",\n             \"?:\\\\Program Files\\\\*.exe\",\n             \"?:\\\\Program Files (x86)\\\\*.exe\",\n             \"?:\\\\PROGRA~1\\\\*.exe\",\n             \"?:\\\\PROGRA~2\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\rundll32.exe\")\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies registry modifications to default services that could enable privilege escalation to SYSTEM. Attackers with\nprivileges from groups like Ser...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and process.executable != null and\n  registry.data.strings != null and registry.value == \"ImagePath\" and\n  registry.key : (\n    \"*\\\\ADWS\", \"*\\\\AppHostSvc\", \"*\\\\AppReadiness\", \"*\\\\AudioEndpointBuilder\", \"*\\\\AxInstSV\", \"*\\\\camsvc\", \"*\\\\CertSvc\",\n    \"*\\\\COMSysApp\", \"*\\\\CscService\", \"*\\\\defragsvc\", \"*\\\\DeviceAssociationService\", \"*\\\\DeviceInstall\", \"*\\\\DevQueryBroker\",\n    \"*\\\\Dfs\", \"*\\\\DFSR\", \"*\\\\diagnosticshub.standardcollector.service\", \"*\\\\DiagTrack\", \"*\\\\DmEnrollmentSvc\", \"*\\\\DNS\",\n    \"*\\\\dot3svc\", \"*\\\\Eaphost\", \"*\\\\GraphicsPerfSvc\", \"*\\\\hidserv\", \"*\\\\HvHost\", \"*\\\\IISADMIN\", \"*\\\\IKEEXT\",\n    \"*\\\\InstallService\", \"*\\\\iphlpsvc\", \"*\\\\IsmServ\", \"*\\\\LanmanServer\", \"*\\\\MSiSCSI\", \"*\\\\NcbService\", \"*\\\\Netlogon\",\n    \"*\\\\Netman\", \"*\\\\NtFrs\", \"*\\\\PlugPlay\", \"*\\\\Power\", \"*\\\\PrintNotify\", \"*\\\\ProfSvc\", \"*\\\\PushToInstall\", \"*\\\\RSoPProv\",\n    \"*\\\\sacsvr\", \"*\\\\SENS\", \"*\\\\SensorDataService\", \"*\\\\SgrmBroker\", \"*\\\\ShellHWDetection\", \"*\\\\shpamsvc\", \"*\\\\StorSvc\",\n    \"*\\\\svsvc\", \"*\\\\swprv\", \"*\\\\SysMain\", \"*\\\\Themes\", \"*\\\\TieringEngineService\", \"*\\\\TokenBroker\", \"*\\\\TrkWks\",\n    \"*\\\\UALSVC\", \"*\\\\UserManager\", \"*\\\\vm3dservice\", \"*\\\\vmicguestinterface\", \"*\\\\vmicheartbeat\", \"*\\\\vmickvpexchange\",\n    \"*\\\\vmicrdv\", \"*\\\\vmicshutdown\", \"*\\\\vmicvmsession\", \"*\\\\vmicvss\", \"*\\\\vmvss\", \"*\\\\VSS\", \"*\\\\w3logsvc\", \"*\\\\W3SVC\",\n    \"*\\\\WalletService\", \"*\\\\WAS\", \"*\\\\wercplsupport\", \"*\\\\WerSvc\", \"*\\\\Winmgmt\", \"*\\\\wisvc\", \"*\\\\wmiApSrv\",\n    \"*\\\\WPDBusEnum\", \"*\\\\WSearch\"\n  ) and\n  not (\n    registry.data.strings : (\n        \"?:\\\\Windows\\\\system32\\\\*.exe\",\n        \"%systemroot%\\\\system32\\\\*.exe\",\n        \"%windir%\\\\system32\\\\*.exe\",\n        \"%SystemRoot%\\\\system32\\\\svchost.exe -k *\",\n        \"%windir%\\\\system32\\\\svchost.exe -k *\"\n    ) and\n        not registry.data.strings : (\n            \"*\\\\cmd.exe\",\n            \"*\\\\cscript.exe\",\n            \"*\\\\ieexec.exe\",\n            \"*\\\\iexpress.exe\",\n            \"*\\\\installutil.exe\",\n            \"*\\\\Microsoft.Workflow.Compiler.exe\",\n            \"*\\\\msbuild.exe\",\n            \"*\\\\mshta.exe\",\n            \"*\\\\msiexec.exe\",\n            \"*\\\\msxsl.exe\",\n            \"*\\\\net.exe\",\n            \"*\\\\powershell.exe\",\n            \"*\\\\pwsh.exe\",\n            \"*\\\\reg.exe\",\n            \"*\\\\RegAsm.exe\",\n            \"*\\\\RegSvcs.exe\",\n            \"*\\\\regsvr32.exe\",\n            \"*\\\\rundll32.exe\",\n            \"*\\\\vssadmin.exe\",\n            \"*\\\\wbadmin.exe\",\n            \"*\\\\wmic.exe\",\n            \"*\\\\wscript.exe\"\n        )\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies a privilege escalation attempt via a rogue Windows directory (Windir) environment variable. This is a known\nprimitive that is often combine...", "output": "registry where host.os.type == \"windows\" and event.type == \"change\" and\nregistry.value : (\"windir\", \"systemroot\") and registry.data.strings != null and\nregistry.path : (\n    \"*\\\\Environment\\\\windir\",\n    \"*\\\\Environment\\\\systemroot\"\n    ) and\n not registry.data.strings : (\"C:\\\\windows\", \"%SystemRoot%\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 to\nelevate privileges from a stand...", "output": "iam where event.action == \"renamed-user-account\" and\n  /* machine account name renamed to user like account name */\n  winlog.event_data.OldTargetUserName : \"*$\" and not winlog.event_data.NewTargetUserName : \"*$\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies Service Control (sc.exe) spawning from script interpreter processes to create, modify, or start services.\nThis can potentially indicate an ...", "output": "/* This rule is not compatible with Sysmon due to user.id issues */\n\nprocess where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name == \"sc.exe\") and\n  process.parent.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                         \"wmic.exe\", \"mshta.exe\",\"powershell.exe\", \"pwsh.exe\") and\n  process.args:(\"config\", \"create\", \"start\", \"delete\", \"stop\", \"pause\") and\n  /* exclude SYSTEM SID - look for service creations by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain\ncontroller DNS hostname and the sub...", "output": "iam where event.action == \"changed-computer-account\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n    /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */\n    winlog.event_data.DnsHostName : \"??*\" and\n\n    /* exclude FPs where DnsHostName starts with the ComputerName that was changed */\n    not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries\nmay create a new process with a...", "output": "any where host.os.type == \"windows\" and event.provider: \"Microsoft-Windows-Security-Auditing\" and\n event.action : \"Token Right Adjusted Events\" and\n\n winlog.event_data.EnabledPrivilegeList : \"SeDebugPrivilege\" and\n\n /* exclude processes with System Integrity  */\n not winlog.event_data.SubjectUserSid : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n\n not winlog.event_data.ProcessName :\n         (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Program Files\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n          \"?:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n          \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n          \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*-*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\auditpol.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSe.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSe.exe\")\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to bypass User Account Control (UAC) by abusing an elevated COM Interface to launch a rogue Windows\nClipUp program. Attackers may ...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"Clipup.exe\" and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\ClipUp.exe\" and process.parent.name : \"dllhost.exe\" and\n  /* CLSID of the Elevated COM Interface IEditionUpgradeManager */\n  process.parent.args : \"/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies User Account Control (UAC) bypass attempts by abusing an elevated COM Interface to launch a malicious\nprogram. Attackers may attempt to byp...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.executable : \"C:\\\\*\\\\AppData\\\\*\\\\Temp\\\\IDC*.tmp\\\\*.exe\" and\n process.parent.name : \"ieinstal.exe\" and process.parent.args : \"-Embedding\"\n\n /* uncomment once in winlogbeat */\n /* and not (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) */\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies User Account Control (UAC) bypass attempts via the ICMLuaUtil Elevated COM interface. Attackers may attempt\nto bypass UAC to stealthily exe...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name == \"dllhost.exe\" and\n process.parent.args in (\"/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}\", \"/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}\") and\n process.pe.original_file_name != \"WerFault.exe\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies User Account Control (UAC) bypass via hijacking DiskCleanup Scheduled Task. Attackers bypass UAC to\nstealthily execute code with elevated p...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.args : \"/autoclean\" and process.args : \"/d\" and process.executable != null and\n not process.executable : (\n        \"C:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\System32\\\\taskhostw.exe\"\n)\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Create EQL query to detect: Identifies attempts to bypass User Account Control (UAC) via DLL side-loading. Attackers may attempt to bypass UAC to\nstealthily execute code with ele...", "output": "file where host.os.type == \"windows\" and event.type : \"change\" and process.name : \"dllhost.exe\" and\n  /* Known modules names side loaded into process running with high or system integrity level for UAC Bypass, update here for new modules */\n  file.name : (\"wow64log.dll\", \"comctl32.dll\", \"DismCore.dll\", \"OskSupport.dll\", \"duser.dll\", \"Accessibility.ni.dll\") and\n  /* has no impact on rule logic just to avoid OS install related FPs */\n  not file.path : (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*\", \"C:\\\\Windows\\\\WinSxS\\\\*\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies User Account Control (UAC) bypass via eventvwr.exe. Attackers bypass UAC to stealthily execute code with\nelevated permissions.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"eventvwr.exe\" and\n  not process.executable : (\n        \"?:\\\\Windows\\\\SysWOW64\\\\mmc.exe\",\n        \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n\n        /* Crowdstrike specific exclusion as it uses NT Object paths */\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\Sys?????\\\\mmc.exe\",\n        \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\Sys?????\\\\WerFault.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory.\nAttackers may bypass UAC to steal...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : (\"C:\\\\Windows \\\\system32\\\\*.exe\", \"C:\\\\Windows \\\\SysWOW64\\\\*.exe\")\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows\nFirewall snap-in. Attackers bypas...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name == \"mmc.exe\" and\n /* process.Ext.token.integrity_level_name == \"high\" can be added in future for tuning */\n /* args of the Windows Firewall SnapIn */\n  process.parent.args == \"WF.msc\" and process.name != \"WerFault.exe\"\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Write an EQL sequence query for: Adversaries may leverage unquoted service path vulnerabilities to escalate privileges. By placing an executable in a\nhigher-level directory within the...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.executable : \"?:\\\\Program.exe\" or\n    process.executable regex \"\"\"(C:\\\\Program Files \\(x86\\)\\\\|C:\\\\Program Files\\\\)\\w+.exe \"\"\"  )\n", "source": "detection-rules/windows", "severity": "low", "risk_score": 21}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies Windows programs run from unexpected parent processes. This could indicate masquerading or other strange\nactivity on a system.\n", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.parent.name != null and\n (\n   /* suspicious parent processes */\n   (process.name:\"autochk.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"fontdrvhost.exe\", \"dwm.exe\") and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\", \"dwm.exe\")) or\n   (process.name:(\"consent.exe\", \"RuntimeBroker.exe\", \"TiWorker.exe\") and not process.parent.name:(\"svchost.exe\", \"Workplace Container Helper.exe\")) or\n   (process.name:\"SearchIndexer.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"SearchProtocolHost.exe\" and not process.parent.name:(\"SearchIndexer.exe\", \"dllhost.exe\")) or\n   (process.name:\"dllhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"smss.exe\" and not process.parent.name:(\"System\", \"smss.exe\")) or\n   (process.name:\"csrss.exe\" and not process.parent.name:(\"smss.exe\", \"svchost.exe\")) or\n   (process.name:\"wininit.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:\"winlogon.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"lsass.exe\", \"LsaIso.exe\") and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"LogonUI.exe\" and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:\"services.exe\" and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"svchost.exe\" and not process.parent.name:(\"MsMpEng.exe\", \"services.exe\", \"svchost.exe\")) or\n   (process.name:\"spoolsv.exe\" and not process.parent.name:(\"services.exe\", \"Workplace Starter.exe\")) or\n   (process.name:\"taskhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\", \"ngentask.exe\")) or\n   (process.name:\"taskhostw.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"userinit.exe\" and not process.parent.name:(\"dwm.exe\", \"winlogon.exe\", \"KUsrInit.exe\")) or\n   (process.name:(\"wmiprvse.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") and not process.parent.name:\"svchost.exe\") or\n   /* suspicious child processes */\n   (process.parent.name:(\"SearchProtocolHost.exe\", \"taskhost.exe\", \"csrss.exe\") and not process.name:(\"werfault.exe\", \"wermgr.exe\", \"WerFaultSecure.exe\", \"conhost.exe\", \"ngentask.exe\")) or\n   (process.parent.name:\"autochk.exe\" and not process.name:(\"chkdsk.exe\", \"doskey.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"smss.exe\" and not process.name:(\"autochk.exe\", \"smss.exe\", \"csrss.exe\", \"wininit.exe\", \"winlogon.exe\", \"setupcl.exe\", \"WerFault.exe\", \"wpbbin.exe\", \"PvsVmBoot.exe\", \"SophosNA.exe\", \"omnissa-ic-nga.exe\", \"icarus_rvrt.exe\", \"poqexec.exe\")) or\n   (process.parent.name:\"wermgr.exe\" and not process.name:(\"WerFaultSecure.exe\", \"wermgr.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"conhost.exe\" and not process.name:(\"mscorsvw.exe\", \"wermgr.exe\", \"WerFault.exe\", \"WerFaultSecure.exe\"))\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilege\nescalation vulnerabilities rela...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"spoolsv.exe\" and process.command_line != null and\n (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n\n /* exclusions for FP control below */\n not process.name : (\"splwow64.exe\", \"PDFCreator.exe\", \"acrodist.exe\", \"spoolsv.exe\", \"msiexec.exe\", \"route.exe\", \"WerFault.exe\") and\n not process.command_line : \"*\\\\WINDOWS\\\\system32\\\\spool\\\\DRIVERS*\" and\n not (process.name : \"net.exe\" and process.command_line : (\"*stop*\", \"*start*\")) and\n not (process.name : (\"cmd.exe\", \"powershell.exe\") and process.command_line : (\"*.spl*\", \"*\\\\program files*\", \"*route add*\")) and\n not (process.name : \"netsh.exe\" and process.command_line : (\"*add portopening*\", \"*rule name*\")) and\n not (process.name : \"regsvr32.exe\" and process.command_line : \"*PrintConfig.dll*\") and\n not process.executable : (\n    \"?:\\\\Program Files (x86)\\\\CutePDF Writer\\\\CPWriter2.exe\",\n    \"?:\\\\Program Files (x86)\\\\GPLGS\\\\gswin32c.exe\",\n\n    /* Crowdstrike specific condition as it uses NT Object paths */\n    \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\CutePDF Writer\\\\CPWriter2.exe\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Program Files (x86)\\\\GPLGS\\\\gswin32c.exe\"\n )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Identifies unusual child processes of Service Host (svchost.exe) that traditionally do not spawn any child processes.\nThis may indicate a code injecti...", "output": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and\n\n  /* based on svchost service arguments -s svcname where the service is known to be childless */\n  process.parent.args : (\n    \"WdiSystemHost\", \"LicenseManager\", \"StorSvc\", \"CDPSvc\", \"cdbhsvc\", \"BthAvctpSvc\", \"SstpSvc\", \"WdiServiceHost\",\n    \"imgsvc\", \"TrkWks\", \"WpnService\", \"IKEEXT\", \"PolicyAgent\", \"CryptSvc\", \"netprofm\", \"ProfSvc\", \"StateRepository\",\n    \"camsvc\", \"LanmanWorkstation\", \"NlaSvc\", \"EventLog\", \"hidserv\", \"DisplayEnhancementService\", \"ShellHWDetection\",\n    \"AppHostSvc\", \"fhsvc\", \"CscService\", \"PushToInstall\"\n  ) and\n\n  /* unknown FPs can be added here */\n  not process.name : (\"WerFault.exe\", \"WerFaultSecure.exe\", \"wermgr.exe\") and\n  not (process.executable : \"?:\\\\Windows\\\\System32\\\\RelPost.exe\" and process.parent.args : \"WdiSystemHost\") and\n  not (\n    process.name : \"rundll32.exe\" and\n    process.args : \"?:\\\\WINDOWS\\\\System32\\\\winethc.dll,ForceProxyDetectionOnNextRun\" and\n    process.parent.args : \"WdiServiceHost\"\n  ) and\n  not (\n    process.executable : (\n      \"?:\\\\Program Files\\\\*\",\n      \"?:\\\\Program Files (x86)\\\\*\",\n      \"?:\\\\Windows\\\\System32\\\\Kodak\\\\kds_?????\\\\lib\\\\lexexe.exe\"\n    ) and process.parent.args : \"imgsvc\"\n  )\n", "source": "detection-rules/windows", "severity": "medium", "risk_score": 47}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies parent process spoofing used to create an elevated child process. Adversaries may spoof the parent process\nidentifier (PPID) of a new proce...", "output": "/* This rule is compatible with Elastic Endpoint only */\n\nprocess where host.os.type == \"windows\" and event.action == \"start\" and\n\n /* process creation via seclogon */\n process.parent.Ext.real.pid > 0 and\n\n /* PrivEsc to SYSTEM */\n user.id : \"S-1-5-18\"  and\n\n /* Common FPs - evasion via hollowing is possible, should be covered by code injection */\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\securityhealthsetup.exe\") and\n /* Logon Utilities */\n not (process.parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and\n     process.executable : (\"?:\\\\Windows\\\\System32\\\\osk.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Narrator.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Magnify.exe\")) and\n\n not process.parent.executable : \"?:\\\\Windows\\\\System32\\\\AtBroker.exe\" and\n\n not (process.code_signature.subject_name in\n           (\"philandro Software GmbH\", \"Freedom Scientific Inc.\", \"TeamViewer Germany GmbH\", \"Projector.is, Inc.\",\n            \"TeamViewer GmbH\", \"Cisco WebEx LLC\", \"Dell Inc\") and process.code_signature.trusted == true) and\n\n /* AM_Delta_Patch Windows Update */\n not (process.executable : (\"?:\\\\Windows\\\\System32\\\\MpSigStub.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\MpSigStub.exe\") and\n      process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\wuauclt.exe\",\n                                   \"?:\\\\Windows\\\\SysWOW64\\\\wuauclt.exe\",\n                                   \"?:\\\\Windows\\\\UUS\\\\Packages\\\\Preview\\\\*\\\\wuaucltcore.exe\",\n                                   \"?:\\\\Windows\\\\UUS\\\\amd64\\\\wuauclt.exe\",\n                                   \"?:\\\\Windows\\\\UUS\\\\amd64\\\\wuaucltcore.exe\",\n                                   \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\*\\\\wuaucltcore.exe\")) and\n not (process.executable : (\"?:\\\\Windows\\\\System32\\\\MpSigStub.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\MpSigStub.exe\") and process.parent.executable == null) and\n\n /* Other third party SW */\n not process.parent.executable :\n                   (\"?:\\\\Program Files (x86)\\\\HEAT Software\\\\HEAT Remote\\\\HEATRemoteServer.exe\",\n                    \"?:\\\\Program Files (x86)\\\\VisualCron\\\\VisualCronService.exe\",\n                    \"?:\\\\Program Files\\\\BinaryDefense\\\\Vision\\\\Agent\\\\bds-vision-agent-app.exe\",\n                    \"?:\\\\Program Files\\\\Tablet\\\\Wacom\\\\WacomHost.exe\",\n                    \"?:\\\\Program Files (x86)\\\\LogMeIn\\\\x64\\\\LogMeIn.exe\",\n                    \"?:\\\\Program Files (x86)\\\\EMC Captiva\\\\Captiva Cloud Runtime\\\\Emc.Captiva.WebCaptureRunner.exe\",\n                    \"?:\\\\Program Files\\\\Freedom Scientific\\\\*.exe\",\n                    \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome Remote Desktop\\\\*\\\\remoting_host.exe\",\n                    \"?:\\\\Program Files (x86)\\\\GoToAssist Remote Support Customer\\\\*\\\\g2ax_comm_customer.exe\") and\n not (\n    process.code_signature.trusted == true and process.code_signature.subject_name == \"Netwrix Corporation\" and\n    process.name : \"adcrcpy.exe\" and process.parent.executable : (\n      \"?:\\\\Program Files (x86)\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.EventCollector.exe\",\n      \"?:\\\\Program Files (x86)\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.Analyzer.exe\",\n      \"?:\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.EventCollector.exe\"\n    )\n )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Detect event sequence: Identifies a privilege escalation attempt via rogue named pipe impersonation. An adversary may abuse this technique by\nmasquerading as a known named p...", "output": "file where host.os.type == \"windows\" and\n  event.provider == \"Microsoft-Windows-Sysmon\" and\n  \n  /* Named Pipe Creation */\n  event.code == \"17\" and\n  \n  /* Sysmon truncates the \"Pipe\" keyword in normal named pipe creation events */\n  file.name : \"\\\\*\\\\Pipe\\\\*\"\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries\nmay create a new process with a...", "output": "/* This rule is only compatible with Elastic Endpoint 8.4+ */\n\nprocess where host.os.type == \"windows\" and event.action == \"start\" and\n\n /* CreateProcessWithToken and effective parent is a privileged MS native binary used as a target for token theft */\n user.id : \"S-1-5-18\"  and\n\n /* Token Theft target process usually running as service are located in one of the following paths */\n process.Ext.effective_parent.executable :\n                (\"?:\\\\Windows\\\\*.exe\",\n                 \"?:\\\\Program Files\\\\*.exe\",\n                 \"?:\\\\Program Files (x86)\\\\*.exe\",\n                 \"?:\\\\ProgramData\\\\*\") and\n\n/* Ignores Utility Manager in Windows running in debug mode */\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and\n      process.parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and process.parent.args : \"/debug\") and\n\n/* Ignores Windows print spooler service with correlation to Access Intelligent Form */\nnot (process.parent.executable : \"?\\\\Windows\\\\System32\\\\spoolsv.exe\" and\n     process.executable: \"?:\\\\Program Files*\\\\Access\\\\Intelligent Form\\\\*\\\\LaunchCreate.exe\") and\n\n/* Ignores Windows error reporting executables */\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n                           \"?:\\\\windows\\\\system32\\\\WerMgr.exe\",\n                           \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\securityhealthsetup.exe\")  and\n\n /* Ignores Windows updates from TiWorker.exe that runs with elevated privileges */\n not (process.parent.executable : \"?:\\\\Windows\\\\WinSxS\\\\*\\\\TiWorker.exe\" and\n      process.executable : (\"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*.exe\",\n                            \"?:\\\\Windows\\\\WinSxS\\\\*.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\iissetup.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\iissetup.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\aspnetca.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\aspnetca.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\lodctr.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\lodctr.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\netcfg.exe\",\n                            \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*\\\\ngen.exe\",\n                            \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*\\\\aspnet_regiis.exe\")) and\n\n\n/* Ignores additional parent executables that run with elevated privileges */\n not process.parent.executable :\n               (\"?:\\\\Windows\\\\System32\\\\AtBroker.exe\",\n                \"?:\\\\Windows\\\\system32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\*\") and\n\n/* Ignores Windows binaries with a trusted signature and specific signature name */\n not (process.code_signature.trusted == true and\n      process.code_signature.subject_name :\n                (\"philandro Software GmbH\",\n                 \"Freedom Scientific Inc.\",\n                 \"TeamViewer Germany GmbH\",\n                 \"Projector.is, Inc.\",\n                 \"TeamViewer GmbH\",\n                 \"Cisco WebEx LLC\",\n                 \"Dell Inc\"))\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
{"task": "eql", "domain": "security", "instruction": "Identifies the creation of a Windows service by an unusual client process. Services may be created with administrator\nprivileges but are executed unde...", "output": "configuration where host.os.type == \"windows\" and\n  event.action == \"service-installed\" and\n  (winlog.event_data.ClientProcessId == \"0\" or winlog.event_data.ParentProcessId == \"0\") and\n  startswith~(user.domain, winlog.computer_name) and winlog.event_data.ServiceAccount == \"LocalSystem\" and \n  not winlog.event_data.ServiceFileName : (\n    \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n    \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n    \"%SystemRoot%\\\\system32\\\\Drivers\\\\Crowdstrike\\\\*-CsInstallerService.exe\",\n    \"\\\"%windir%\\\\AdminArsenal\\\\PDQInventory-Scanner\\\\service-1\\\\PDQInventory-Scanner-1.exe\\\" \",\n    \"\\\"%windir%\\\\AdminArsenal\\\\PDQDeployRunner\\\\service-1\\\\PDQDeployRunner-1.exe\\\" \",\n    \"\\\"%windir%\\\\AdminArsenal\\\\PDQInventoryWakeCommand\\\\service-1\\\\PDQInventoryWakeCommand-1.exe\\\" \",\n    \"\\\"%SystemRoot%\\\\nsnetpush.exe\\\"\",\n    \"\\\"C:\\\\WINDOWS\\\\ccmsetup\\\\ccmsetup.exe\\\" /runservice /ignoreskipupgrade /config:MobileClient.tcf\",\n    \"\\\"?:\\\\SMS\\\\bin\\\\x64\\\\srvboot.exe\\\"\",\n    \"%SystemRoot%\\\\pbpsdeploy.exe\"\n  )\n", "source": "detection-rules/windows", "severity": "high", "risk_score": 73}
